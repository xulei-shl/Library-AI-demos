# 项目设计方案：墨迹与边界 (v2.0 - 叙事版)

**Project Name: Ink & Coordinates: The Living Literary Atlas**

---

## 1. 项目愿景与核心概念

### 1.1 项目定位
**“墨迹与边界”** 不仅仅是一个文学地理数据库，它是一个**生成式的数据艺术装置**。
它捕捉文学作品在时空中的“流动性”。我们不再展示静态的结果，而是重演“传播的过程”。

### 1.2 核心隐喻：墨迹 (The Ink)
-   **流动 (Flow)**：文学传播不是瞬间发生的，而是像墨水在纸纤维中扩散一样，有方向、有速度、有先后。
-   **晕染 (Bloom)**：当作品抵达一座城市，它会像墨滴入水一样产生涟漪，留下永久的印记。
-   **交融 (Blend)**：不同作者的轨迹在同一时空交汇（如巴黎、纽约），形成文化的叠加。

---

## 2. 视觉与交互设计 (UI/UX)

### 2.1 视觉风格：会呼吸的地图
界面采用“沉浸式画布”设计，移除多余的边框和分割线。

-   **底图质感**：使用浅米色 (`#F5F5F0`) 或深炭灰 (`#1a1a1a`) 的纸张纹理。
-   **线条美学**：
    -   **墨迹轨迹**：不再是单一的实线。线条具有**方向性渐变**（起点深 -> 终点浅，模拟墨水变干的过程）和**圆润端点**（Stroke Linecap: Round）。
    -   **动态阴影**：线条下方带有微弱的模糊投影，营造悬浮于纸面的层次感。

### 2.2 核心动态交互 (The Narrative Mechanics)

#### A. 墨迹生长 (The Ink Trace)
当加载一位作者或拖动时间轴时，轨迹线并非瞬间出现，而是**实时生长**。
-   **逻辑**：基于 `stroke-dasharray` 和 `stroke-dashoffset`。
-   **速度**：生长速度与现实中的“年份跨度”成正比。1980年到1981年的传播很快，而跨越10年的传播则线条画得更慢，体现时间的重量。

#### B. 涟漪节点 (Ripple Markers)
城市节点不再是静态圆点，而是**事件触发器**。
-   **触发机制**：当“墨迹”线条的前端触碰到目标城市坐标时，立即触发节点动画。
-   **动画阶段**：
    1.  **冲击 (Impact)**：一道涟漪向外扩散并消失（类似雨滴落水）。
    2.  **定格 (Settle)**：涟漪散去，留下一个实心墨点。
    3.  **呼吸 (Breathe)**：如果该点包含**实体馆藏**（如上海图书馆），墨点周围会保留一个微弱的、周期性的光晕（呼吸灯效果），诱导用户点击。

#### C. 动态视口 (Smart FlyTo)
切换作者时的转场不再生硬跳变。
-   **算法**：系统计算该作者所有足迹点的 **Bounding Box (最小外接矩形)**。
-   **运镜**：地图摄像机平滑地飞行、旋转、缩放，最终停留在能完美容纳该作者所有轨迹的最佳视角（Padding 留白 20%）。

---

## 3. 技术架构方案 (Refined)

为了支撑高频率的动画和复杂的时序逻辑，技术栈在原基础上进行了针对性强化。

### 3.1 核心技术栈
-   **框架**：Next.js (App Router)
-   **状态/时序管理**：**Zustand** + **RxJS** (可选，用于处理复杂的动画流事件)。
-   **地图引擎**：**React-Simple-Maps** (SVG) + **D3-Geo** (用于计算投影和路径)。
-   **动画引擎**：**Framer Motion** (UI 进出) + **React-Spring** (地图物理平滑缩放) + **CSS Native Animations** (高性能线条绘制)。

### 3.2 关键渲染逻辑：时序调度器 (The Scheduler)

这是 v2.0 的核心技术难点。我们需要一个调度器来保证“线到了，点才亮”。

**逻辑流程：**
1.  **数据解析**：将 JSON 中的 `routes` 按年份排序。
2.  **队列构建**：生成一个动画队列 `AnimationQueue`。
    *   `[T=0ms]`: Start drawing Line A (Tokyo -> NY)
    *   `[T=1000ms]`: Line A finishes -> Trigger Ripple at NY -> Start drawing Line B (NY -> London)
3.  **执行循环**：前端组件订阅这个队列，依次执行 SVG 动画。

### 3.3 性能优化策略
-   **GPU 加速**：所有线条生长和涟漪动画强制开启 `will-change: stroke-dashoffset, transform`，确保在 GPU 层渲染，不阻塞主线程。
-   **虚拟化节点**：如果节点超过 500 个，仅渲染视口内的节点（虽然文学地图通常不会达到此量级，但需为扩展性考虑）。

---

## 4. 功能模块详述

### 4.1 叙事地图画布 (`NarrativeMap.tsx`)
这是主舞台。

-   **功能**：
    -   承载 GeoJSON 底图。
    -   监听 `currentAuthor` 变化，触发 `Smart FlyTo`。
    -   管理 `Zoom/Pan` 交互。
-   **交互细节**：支持鼠标滚轮缩放，双击聚焦。但在“自动播放”模式下，暂停用户交互，保证叙事流畅性。

### 4.2 墨迹线条组件 (`InkLine.tsx`)
-   **输入**：`from: [lat, lng]`, `to: [lat, lng]`, `delay: number`, `duration: number`, `color: string`。
-   **样式实现**：
    -   使用 `d3.geoCurve` (贝塞尔曲线) 或 `d3.geoAiry` 模拟大圆航线，使跨洋连线呈现优美的弧度。
    -   **渐变色填充**：SVG `<linearGradient>`，定义 `stop-color` 从透明到实色，模拟墨水拖尾。

### 4.3 智能节点组件 (`RippleNode.tsx`)
-   **状态机**：`Hidden` -> `Rippling` (动画中) -> `Static` (已定格) -> `Breathing` (有馆藏/可交互)。
-   **交互**：
    -   **Hover**：节点放大，显示 Tooltip。
    -   **Click**：如果 `has_collection: true`，侧边栏滑出书籍详情或图书馆索书号。

### 4.4 播放控制栏 (`PlaybackControl.tsx`)
替代原有的简单 Slider。

-   **UI**：类似于视频播放器的进度条。
-   **功能**：
    -   **Play/Pause**：开始/暂停墨迹生长。
    -   **Scrubbing**：拖动进度条，墨迹随之“倒流”或“快进”。
    -   **年份指示器**：大号字体动态显示当前渲染的年份（如 **1987**）。

---

## 5. 数据结构规范 (微调)

为了支持动效，我们需要在前端计算或在 JSON 中预置一些“时序权重”。建议保持 JSON 纯净，由前端计算时序。

**`/public/data/authors/murakami.json` (保持结构，逻辑在前端)**

```json
{
  "meta": {
    "id": "murakami",
    "theme_color": "#2C3E50",
    "default_view": { "center": [135, 35], "zoom": 4 } // 初始建议，会被 Smart FlyTo 覆盖
  },
  "works": [
    {
      "work_id": "norwegian_wood",
      "routes": [
        {
          "target_city": "Shanghai",
          "coordinates": [121.4737, 31.2304],
          "year": 2001,
          "has_collection": true,
          "collection_meta": { "call_number": "I313.45/442" } // 新增：馆藏元数据
        }
      ]
    }
  ]
}
```

---

## 6. 开发路线图 (Revised Roadmap)

-   **Phase 1: 骨架与数据 (Week 1)**
    -   搭建 Next.js + Zustand。
    -   实现基础地图渲染。
    -   完成 `Smart FlyTo` 逻辑（计算 Bounding Box 并平滑移动）。

-   **Phase 2: 墨迹引擎 (Week 2 - 核心攻坚)**
    -   开发 `InkLine` 组件：实现基于 `stroke-dashoffset` 的生长动画。
    -   开发 `RippleNode` 组件：实现 CSS 涟漪与呼吸效果。
    -   编写 **Scheduler (调度器)**：将 JSON 数据转化为带时间戳的动画队列，确保线与点的同步。

-   **Phase 3: 交互与叙事 (Week 3)**
    -   实现 `PlaybackControl` (时间轴控制器) 与地图动画的双向绑定。
    -   开发 **对比模式 (Overlay Mode)**：
        -   允许选择两个作者。
        -   地图层叠加两组 SVG Layer。
        -   处理颜色冲突（混合模式 `mix-blend-mode: multiply`）。

-   **Phase 4: 润色与发布 (Week 4)**
    -   Tooltip 动效优化（Framer Motion）。
    -   移动端手势适配。
    -   性能调优（React.memo, 减少重绘）。

---

## 7. 扩展性设计

### 7.1 对比模式 (Versus Mode) - 同图叠加
采用 **Overlay** 方案以增强对比感。
-   **场景**：选中“村上春树 (蓝)” vs “马尔克斯 (黄)”。
-   **视觉**：
    -   两条墨迹同时从东京和哥伦比亚出发。
    -   当两者都抵达“纽约”时，纽约节点变成**绿色**（蓝黄叠加色），直观展示文化交集。

### 7.2 个人星图 (My Constellation)
-   用户功能。利用 `localStorage`。
-   用户点击某个节点（如“我读过这本译本”），该节点被永久点亮为“金色”。
-   最终生成一张属于用户的“阅读版图”，可导出为图片分享。

---

### 结语

通过引入 **Proposal B** 的动态理念，**《墨迹与边界》** 将从一个冷冰冰的地理工具进化为一部**活着的文学编年史**。每一次点击作者，都是一次对文字漂流历史的实时重建。

**技术关键点提示：**
1.  **曲线算法**：优先使用 `d3.geoPath` 配合 `d3.geoAiry` 或 `geoNaturalEarth1` 投影，以获得最自然的连线视觉。
2.  **动画同步**：务必使用 `useRef` 存储动画状态，避免 React 渲染周期导致的动画卡顿。