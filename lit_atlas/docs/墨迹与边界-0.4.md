# 项目设计方案：墨迹与边界 (Ink & Boundaries) v0.4.0
**定位：基于 OpenLayers 的流动式文学地理叙事装置**

---

## 1. 视觉语言：水墨余韵 (Visual Identity)

当前的黑白底图提供了极佳的“纸张”感。为了打破单调并突出文学属性，动效将引入**中国传统色**作为点睛之笔。

*   **底图风格**：保留当前的灰阶地图（高对比度、去除琐碎标注）。
*   **核心强调色 (Accent Colors)**：
    *   **朱砂 (Cinnabar #b03d46ff)**：用于当前活跃的作品路径、正在生长的节点。
    *   **黛蓝 (Indigo #1D3557)**：用于已完成的历史路径、经典馆藏节点。
    *   **松石 (Turquoise #457B9D)**：用于多作者交汇处的“文化涟漪”。
*   **笔触质感**：路径不再是均匀的几何线，而是具有**粗细变化（模拟压感）**和**半透明叠加**效果的“墨迹”。

---

## 2. 核心动态交互设计 (OL-Based Motion)

利用 OpenLayers 的 `postrender` 监听器和 Canvas 原生 API 实现高性能动画。

### 2.1 墨迹生长路径 (Variable Stroke Growth)
*   **视觉逻辑**：线路从起点向终点延伸，模拟毛笔在宣纸上的行笔。
*   **OL 实现**：
    *   利用 `feature.getGeometry().getCoordinateAt(t)` 实时计算当前点。
    *   在 `postrender` 钩子中，使用 Canvas 的 `globalCompositeOperation = 'multiply'` 模拟墨水渗入纸张的重叠感。
    *   **动态线宽**：线条前端尖锐，后端稍圆润，模拟行笔的起承转合。

### 2.2 叙事涟漪节点 (Narrative Ripples)
*   **视觉逻辑**：当路径触达城市，产生一个向外扩散的圆形波纹。
*   **OL 实现**：
    *   使用 `ol/render` 的 `setStyle` 动态改变半径和不透明度。
    *   **多层扩散**：一个节点触发 2-3 层涟漪，每一层具有不同的衰减速度。
    *   **状态切换**：扩散结束后，节点转化为一个带有微弱“呼吸灯”效果的实心墨点。

### 2.3 路径流动特效 (Flowing Pulse)
*   **视觉逻辑**：对于已存在的长距离跨国航线（如鲁迅赴日），线条内部会有微小的粒子感或光点流动，暗示“思想的传播”。
*   **OL 实现**：利用 `setLineDash` 的偏移量动画 (`lineDashOffset`)，结合 `requestAnimationFrame` 实现丝滑的流动感。

---

## 3. 技术架构重构 (Architecture v0.4.0)

由于从 SVG 转向了 Canvas (OpenLayers)，架构逻辑从“组件状态驱动”转向了“**帧循环驱动**”。

### 3.1 渲染管线 (The Rendering Pipeline)
1.  **数据转换层 (`featureConverter.ts`)**：将作品 JSON 转化为带有 `startTime` 和 `duration` 属性的 OpenLayers Features。
2.  **动画调度器 (`AnimationController.ts`)**：
    *   接管全局时间轴。
    *   根据当前时间戳，计算哪些 Feature 处于“生长”状态，哪些处于“常亮”状态。
3.  **自定义渲染层 (`InkLayer.tsx`)**：
    *   继承 `ol/layer/Vector`。
    *   在 `on('postrender')` 中执行自定义的 Canvas 绘图逻辑，绕过标准的 OpenLayers 静态样式，实现笔触效果。

### 3.2 空间交互优化 (Spatial UX)
*   **智能聚焦 (Smart Zooming)**：
    *   使用 `view.fit(extent, { duration: 1500, easing: easeOut })`。
    *   当切换作者时，地图会像航拍镜头一样平滑移动到新的文学疆域。
*   **覆盖层管理 (Overlays)**：
    *   城市名称使用 `ol/Overlay`（HTML/React 组件），而非 Vector 文本，以保证在高缩放级别下的清晰度和交互性（如点击城市弹出书籍详情）。

---

## 4. 关键功能模块

### 4.1 动态时间轴控制器 (`ChronosBar.tsx`)
*   **功能**：控制文学地理的时间跨度（如 1900-1930）。
*   **联动**：拖动滑块时，OpenLayers 地图上的线条会同步“回退”或“延伸”。
*   **视觉**：滑块轨迹呈现淡灰色墨迹，经过的年份变黑加粗。

### 4.2 文学实体侧边栏 (`EntityPanel.tsx`)
*   **内容**：展示当前选中点的书籍封面、图书馆索书号、作者简介。
*   **动效**：采用 Framer Motion 的 `AnimatePresence`，实现从地图侧边平滑滑入，不遮挡地图核心视口。

---

## 5. 实施路线图 (Updated Roadmap)

### Phase 2: 高级渲染渲染 (当前阶段)
*   [ ] **墨迹笔触实现**：编写自定义 Style Function，实现线条的动态生长。
*   [ ] **颜色系统集成**：引入朱砂/黛蓝配色方案。
*   [ ] **标签层优化**：实现城市名称在不同缩放级别下的智能显隐（Avoid Overlap）。

### Phase 3: 交互叙事增强
*   [ ] **Overlay 弹窗**：点击 Feature 弹出基于 React 的美化 Tooltip。
*   [ ] **多作者对比模式**：实现两个作者路径在同一地图上的颜色混叠效果。

### Phase 4: 性能与打磨
*   [ ] **Canvas 预渲染优化**：针对大量路径进行离屏渲染处理。
*   [ ] **手势适配**：优化移动端双指缩放的平滑度。

---

## 6. 设计哲学：从“地图”到“书卷”

通过 OpenLayers 的重构，我们不再仅仅是在展示坐标，而是在**数字宣纸上重绘文学的传播路径**。

*   **黑白底图** = 纸张与环境。
*   **彩色动效** = 思想的火花与文字的流转。
*   **交互** = 读者在时空中的翻阅。

这种设计将确保《墨迹与边界》不仅是一个工具，更是一个具有审美价值的数字艺术品。