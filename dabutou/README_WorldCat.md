# WorldCat爬虫使用说明

## 概述

本项目新增了WorldCat全球图书馆联合目录爬虫功能，与原有的CiNii爬虫保持独立，避免相互干扰。

## 主要特性

### 1. 独立的爬虫系统
- **WorldCat爬虫**：完全独立的爬虫模块，不影响原有CiNii爬虫
- **独立的Excel处理**：专门处理WorldCat结果的Excel读写
- **独立的结果输出**：生成单独的WorldCat结果文件

### 2. 交互式菜单系统
- **选项1**：运行CiNii爬虫（原有功能）
- **选项2**：运行WorldCat爬虫（新功能）
- **选项3**：运行全部爬虫（依次执行CiNii和WorldCat）

### 3. 灵活的输出模式
- **separate**：生成独立的WorldCat结果文件
- **update**：在原Excel文件基础上添加WorldCat结果列
- **both**：同时生成独立文件和更新原文件（推荐）

## 文件结构

```
src/
├── scrapers/
│   └── worldcat_scraper.py      # WorldCat爬虫核心模块
├── core/
│   └── worldcat_app.py          # WorldCat应用程序
├── utils/
│   └── worldcat_excel_handler.py # WorldCat专用Excel处理器
└── ...

main.py                           # 主程序（支持交互式菜单）
```

## 使用方法

### 交互式模式（推荐）

```bash
python main.py
```

运行后会显示菜单：
```
============================================================
           图书馆藏信息爬虫系统
============================================================
支持的爬虫:
  1. CiNii (日本学术信息检索系统)
  2. WorldCat (全球图书馆联合目录)
  3. 全部爬虫 (依次运行CiNii和WorldCat)
============================================================

请选择要运行的爬虫 (1/2/3, 输入 'q' 退出):
```

### 命令行模式

```bash
# 只运行CiNii爬虫
python main.py --mode cli --scraper cinii your_excel_file.xlsx

# 只运行WorldCat爬虫
python main.py --mode cli --scraper worldcat your_excel_file.xlsx

# 运行全部爬虫
python main.py --mode cli --scraper all your_excel_file.xlsx
```

## WorldCat爬虫详细说明

### 搜索策略
1. **自动识别**：自动判断输入是ISBN还是题名关键词
2. **ISBN搜索**：使用 `bn: isbn` 格式
3. **题名搜索**：使用 `ti: 题名关键词` 格式
4. **结果筛选**：只保留非CN（中国大陆）地区的图书馆

### 输出文件格式

WorldCat爬虫会生成包含以下工作表的Excel文件：

1. **原始数据**：从原始Excel文件复制的数据
2. **WorldCat结果**：详细的爬取结果
   - 检索词
   - 海外图书馆
   - 检索成功状态
   - 图书馆数量
   - 错误信息
   - 检索时间
3. **统计汇总**：
   - 总搜索词数
   - 成功搜索数
   - 成功率
   - 总图书馆数
   - 平均每个搜索词的图书馆数

### 输出文件命名

- 独立结果文件：`原文件名_worldcat_results_时间戳.xlsx`
- 更新原文件：`原文件名_with_worldcat_results.xlsx`

## 技术实现

### 核心组件

1. **WorldCatScraper类**
   - 负责WorldCat网站的爬取逻辑
   - 处理登录、搜索、结果提取
   - 支持单次搜索和批量搜索

2. **WorldCatApp类**
   - 应用程序主控制器
   - 集成Excel处理和爬虫功能
   - 支持多种运行模式

3. **WorldCatExcelHandler类**
   - 专门处理WorldCat结果的Excel读写
   - 避免与CiNii结果冲突
   - 生成多工作表的输出文件

### 关键特性

1. **登录处理**
   - 支持手动登录和Cookie保存
   - 有头浏览器模式便于调试

2. **结果处理**
   - 自动识别无结果、单结果、多结果情况
   - 智能选择图书馆数量最多的结果
   - 过滤和去重海外图书馆

3. **错误处理**
   - 完善的异常处理机制
   - 详细的日志记录
   - 断点续传支持

## 配置参数

```python
config = {
    'worldcat': {
        'headless': False,           # 是否无头模式（调试建议False）
        'timeout': 30000,           # 页面超时时间（毫秒）
        'delay_range': [2, 5],      # 请求间隔范围（秒）
        'max_retries': 3            # 最大重试次数
    }
}
```

## 使用注意事项

1. **首次使用**建议用有头模式，程序会引导您完成登录
2. **自动登录**：程序会保存登录状态，下次运行时可自动登录
3. **批量处理**时注意设置合理的延时，避免被反爬
4. **结果文件**会包含时间戳，避免覆盖
5. **日志文件**保存在 `logs` 目录下

## 交互式登录功能

### 登录流程
1. 程序启动时会自动检查是否有保存的登录状态
2. 如果没有或状态已过期，会进入交互式登录模式
3. 用户需要在浏览器中完成登录操作
4. 登录完成后输入 `y` 继续执行爬取

### 登录选项
```
请选择操作:
  y - 我已完成登录，继续执行
  r - 重新检查登录状态
  c - 清理保存的登录状态，重新登录
  s - 跳过本次登录，使用离线模式
  q - 退出程序
```

### 状态管理
- **自动保存**：登录成功后自动保存Cookie和状态
- **自动恢复**：下次启动时自动尝试使用保存的状态
- **手动清理**：可通过选项 `c` 清理保存的状态
- **状态文件**：
  - `worldcat_cookies.json` - 保存的Cookie
  - `worldcat_state.json` - 其他状态信息

## 与CiNii爬虫的区别

| 特性 | CiNii爬虫 | WorldCat爬虫 |
|------|-----------|--------------|
| 目标网站 | 日本CiNii | 全球WorldCat |
| 搜索方式 | 题名/ISBN | ISBN/题名/关键词 |
| 结果筛选 | 保留所有图书馆 | 只保留海外（非CN）图书馆 |
| 输出格式 | 更新原Excel | 独立文件 + 可选更新 |
| 登录要求 | 无需登录 | 需要通过图书馆代理登录 |

## 故障排除

1. **登录失败**：检查网络连接，使用有头模式手动登录
2. **搜索无结果**：确认搜索词格式，检查题名或ISBN是否正确
3. **程序崩溃**：查看日志文件，检查网络稳定性
4. **Excel文件冲突**：确保文件没有被其他程序占用