# 新功能开发计划：Python代码处理

本文档旨在为“Python代码处理”新功能的开发提供详细的规划和设计指导，以便于大模型理解和执行后续的编码任务。

## 1. 功能概述

“Python代码处理”功能允许用户通过自然语言描述数据处理需求，系统将自动生成、测试、并执行Python脚本来处理用户指定的Excel数据。核心流程包括：**提示词生成 -> 代码生成 -> 自动测试与修复 -> 正式数据处理 -> 结果与文档生成**。

此功能在界面和部分后端逻辑上参考现有的“公式生成”功能，但核心增加了代码执行、自动测试和迭代修复的闭环。

## 2. 需求分析

### 2.1. 界面 (UI)

- **布局**: 采用与“公式生成”一致的左右布局。
- **左侧（输入区）**:
    1.  **Excel文件和Sheet选择**: 复用 `multi_excel_selector` 组件，用于选择一个或多个Excel文件及其工作表和列。
    2.  **需求描述**: 一个多行文本框，供用户输入数据处理的自然语言需求。
    3.  **结果保存路径**:
        -   一个单行文本框（设为只读），显示用户选择的路径。
        -   一个“选择路径”按钮，用于打开文件对话框选择一个文件夹。此路径将作为本次任务的工作目录，用于存放生成的代码、结果文件、依赖项和日志。
    4.  **生成配置**: 复用“公式生成”中的LLM配置组件（如模型选择、温度等）。
    5.  **执行按钮**: 一个主按钮，如“生成并执行Python代码”。
- **右侧（输出区）**:
    1.  **日志信息**: 一个多行文本框，实时显示整个流程的状态、生成的代码、测试结果、错误信息和最终报告。
    2.  **辅助按钮**: “清空日志”和“下载日志”按钮。

### 2.2. 后端 (Backend)

1.  **输入处理与提示词生成**:
    -   获取用户选择的Excel列的样例数据（与`formula_generator`相同）。
    -   将用户的“excel文件和sheet选择”，“需求描述”与“样例数据”拼接成初始用户提示词（Initial Prompt）。

2.  **代码生成**:
    -   调用大模型（LLM），传入初始用户提示词。系统提示词则从`生成配置`提示词中获取，默认值为“python代码编写”。
    -   要求模型生成两个文件内容：
        -   `main.py`: 核心数据处理逻辑的Python脚本。
        -   `requirements.txt`: 脚本所需的依赖库。

3.  **自动测试与修复循环 (Auto-Test & Self-Correction Loop)**:
    -   **环境准备**: 在用户指定的“结果保存路径”下，创建一个Python虚拟环境（如 `.venv`）。
    -   **依赖安装**: 激活虚拟环境，并使用 `pip install -r requirements.txt` 安装依赖。
    -   **测试执行**:
        -   使用初始的“样例数据”作为输入，执行 `main.py`。注意：样例数据是md表格形式，有H级标题的区分不同文件不同sheet数据。
        -   捕获脚本的 `stdout` 和 `stderr`。
    -   **结果判断**:
        -   **如果执行成功**: 脚本正确，跳出循环，进入下一步。
        -   **如果执行失败**:
            -   提取 `stderr` 中的关键错误信息。
            -   **归档**: 将当前错误的 `main.py` 和错误日志（`error.log`）移动到结果路径下的 `changelogs` 子目录中，并以时间戳或版本号命名。
            -   **构建修复提示词**: 组合“初始用户提示词” + “出错的Python代码” + “错误信息”，形成一个新的用户提示词。
            -   **重新生成代码**: 调用LLM，传入修复用户提示词，系统提示词则使用默认的 name为“python代码修复”从promtps.json中获取获取新版本的 `main.py` 和 `requirements.txt`。
            -   返回循环的“环境准备”步骤，使用新代码进行下一次测试。

4.  **正式数据处理**:
    -   测试通过后，使用用户在UI上选择的**完整Excel文件**作为输入。
    -   执行最终验证通过的 `main.py` 脚本。
    -   将处理结果（如新的Excel文件或CSV文件）保存在用户指定的“结果保存路径”下。

5.  **文档生成**:
    -   调用LLM，提供“初始用户提示词”、“最终的Python代码”和“执行结果概述”。
    -   生成一份 `README.md` 文件，内容包括：
        -   原始需求
        -   代码主要功能与逻辑说明
        -   如何运行
        -   产出文件说明
    -   将 `README.md` 保存在“结果保存路径”下。

## 3. 模块设计与技术选型

### 3.1. 新建模块

1.  **`ui/python_processing_tab.py`**:
    -   负责新功能的UI布局和组件管理。
    -   将借鉴 `ui/formula_generation_tab.py` 的结构。
    -   处理用户输入，并调用后端逻辑。

2.  **`modules/python_code_processor.py`**:
    -   作为此功能的后端总控制器（Orchestrator）。
    -   实现从提示词生成到最终文档生成的完整工作流。
    -   管理和调用其他模块。

3.  **`modules/python_code_executor.py`**:
    -   **核心工具模块**，封装Python代码的执行环境和过程。这将是一个独立的、可重用的类或函数集合。
    -   **职责**:
        -   在指定路径创建和管理Python虚拟环境。
        -   安装 `requirements.txt` 中的依赖。
        -   以子进程方式执行Python脚本。
        -   捕获并返回脚本的 `stdout`, `stderr`, 和 `exit_code`。
        -   处理文件IO，例如将输入数据（样例或完整数据）传递给脚本。

### 3.2. 技术选型建议

-   **代码执行**: 使用Python内置的 `subprocess` 和 `venv` 模块来构建 `python_code_executor.py`。这避免了复杂的外部依赖。
-   **LLM调用链**: 针对“自动测试与修复循环”，可以考虑使用 `LangChain` 或一个简单的自定义循环逻辑来管理状态（初始提示词、代码、错误、重试次数）。`LangChain` 的 `LCEL` (LangChain Expression Language) 对于构建这种“输入 -> LLM -> 解析 -> 工具 -> LLM”的链条非常有用。如果想保持简单，一个 `while` 循环也能实现。
-   **文件操作**: 使用 `os` 和 `shutil` 模块进行路径操作、文件移动和目录创建。

## 4. 开发步骤

1.  **步骤一：创建新模块文件**
    -   创建 `ui/python_processing_tab.py`。
    -   创建 `modules/python_code_processor.py`。
    -   创建 `modules/python_code_executor.py`。

2.  **步骤二：UI开发**
    -   在 `python_processing_tab.py` 中，复制并修改 `formula_generation_tab.py` 的UI布局，添加“结果保存路径”组件。
    -   在 `main.py` 中集成新的UI Tab。

3.  **步骤三：开发核心执行工具**
    -   在 `python_code_executor.py` 中，实现一个 `PythonExecutor` 类，包含 `setup_environment()` 和 `run_script()` 等方法。
    -   编写单元测试以确保该执行器能够正确地创建环境、安装依赖、执行代码并捕获输出。

4.  **步骤四：开发后端主逻辑**
    -   在 `python_code_processor.py` 中，实现主控制函数 `process_python_code()`。
    -   实现提示词生成逻辑。
    -   构建自动测试与修复的循环，该循环将调用 `PythonExecutor`。
    -   集成LLM调用，用于代码生成和修复。

5.  **步骤五：集成与端到端测试**
    -   将UI的“执行”按钮连接到 `python_code_processor.py` 的主函数。
    -   进行完整的端到端测试：选择Excel -> 输入需求 -> 选择路径 -> 执行 -> 验证结果路径下的文件是否正确（代码、结果、changelogs、README）。

6.  **步骤六：实现文档生成**
    -   在 `python_code_processor.py` 的最后一步，添加调用LLM生成 `README.md` 的逻辑。

## 5. 总结

此计划将新功能分解为独立的、可管理的模块和清晰的开发步骤。通过优先开发核心的 `PythonCodeExecutor` 工具，可以确保最复杂部分的健壮性。复用现有UI和逻辑将加快开发速度，同时保持项目风格的一致性。
