# 列映射规则逻辑分析

本文档详细分析了 `src/config/settings.py` 文件中定义的列映射规则，旨在阐明其工作逻辑与优先级。

## 总体目标

该配置系统的核心目标是处理来自不同部门（一部、二部、三部等）的、结构与命名各异的Excel文件，将它们的数据进行标准化处理，最终合并到一个统一格式的目标Excel文件中。

## 映射逻辑详解

系统通过三层配置来实现数据标准化：

### 1. `COLUMN_MAPPINGS` (静态列映射)

- **作用**: 处理固定的列名或列位置。
- **逻辑**:
    - **别名转标准名**: 将 "统计员" 等别名统一为 "统计人"。
    - **结构化映射**: 将特定文件的固定列（如二部的 `H` 列）数据，映射到目标文件的指定列（`I` 列）。

### 2. `DYNAMIC_COLUMN_PATTERNS` (动态列映射)

- **作用**: 处理名称不固定但有规律的列，如包含数字或公式的列头。
- **逻辑**: 使用正则表达式匹配列名。例如，匹配 `[12345]` 或 `=SUM(...)` 这样的列名，并将它们的数据统一映射到目标文件的 `I` 列。

### 3. `DEFAULT_VALUES` (缺失列默认值)

- **作用**: 作为数据完整性的保障。
- **逻辑**: 如果源文件缺少目标文件必需的列，此配置会为该列提供一个预设的默认值（如为三部文件缺失的“统计人”列填充“孙超”）。

## 核心优先级

系统在处理每一列数据时，遵循以下优先级顺序，一旦匹配成功则停止后续查找：

1.  **特定文件静态映射**: 首先查找针对特定文件类型（如 `erbu`）的精确列名/列字母映射。
2.  **全局静态映射**: 若上一条未匹配，则查找全局（`*`）的精确列名映射。
3.  **特定文件动态映射**: 若静态映射均失败，则尝试特定文件类型的正则表达式匹配。
4.  **全局动态映射**: 最后，尝试全局的正则表达式匹配。
5.  **应用默认值**: 所有列映射完成后，对缺失的目标列，根据“特定 > 全局”的原则填充默认值。

## 总结

该映射系统的核心逻辑可以概括为 **“特定规则优先于全局规则，静态精确匹配优先于动态模式匹配”**。这种分层策略确保了系统在拥有强大通用性的同时，也能灵活处理各种特殊和意外情况。
