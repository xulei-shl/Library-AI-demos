

# 图书语义检索功能集成方案

## 1. 项目现状

### 1.1 技术栈
- 前端框架：Next.js
- 数据组织：按月份文件夹结构（content/YYYY-MM）
- 数据展示：画布形式展示图书图片和信息
- 数据规模：少于1万本图书

### 1.2 现有功能
- 用户点击月份链接进入对应月份的图书画布
- 每个月份文件夹包含图书JSON和图片
- 点击图片显示图书详情信息

### 1.3 数据结构
```
content/
  2025-09/
    books.json
    图片文件...
  2025-10/
    books.json
    图片文件...
```

## 2. 新增需求

### 2.1 核心需求
- 实现自然语言语义检索功能
- 用户输入关键词或句子，返回相关图书
- 检索结果在画布上展示，复用现有展示组件

### 2.2 期望体验
- 语义匹配（如"人工智能入门"可匹配"AI基础教程"）
- 支持模糊查询和句子级检索
- 检索结果与月份画布展示样式一致

## 3. 技术方案

### 3.1 核心架构

采用"统一数据源和画布组件，分离筛选/检索逻辑"的架构：

```
┌─────────────────┐  统一数据源  ┌───────────────────────┐
│  全局图书索引   │◄────────────►│ public/global-books.json │
│  (向量库+脚本)  │              └───────────────────────┘
└────────┬────────┘                          ▲
         │                                   │
         ▼                                   │
┌─────────────────┐  统一画布组件  ┌───────────────────────┐
│  检索API接口    │◄────────────►│    BookCanvas组件      │◄─────┐
│  (语义匹配)     │              └───────────────────────┘      │
└────────┬────────┘                          ▲                  │
         │                                   │                  │
         ▼                                   │                  │
┌─────────────────┐                          │                  │
│  检索页面       │──────────────────────────┘                  │
│  (输入查询)     │                                             │
└─────────────────┘                                             │
                                                                │
┌─────────────────┐  静态筛选逻辑  ┌───────────────────────┐    │
│  月份路由页面   │◄────────────►│ 按month字段筛选数据    │─────┘
│  (点击月份进入) │              └───────────────────────┘
└─────────────────┘
```

### 3.2 统一数据源方案

#### 3.2.1 全局索引生成
- 创建脚本遍历所有月份文件夹，聚合图书数据
- 补充图片路径和月份标识
- 生成`public/global-books.json`作为统一数据源

#### 3.2.2 向量索引构建
- 基于全局数据生成向量索引
- 使用轻量模型`all-MiniLM-L6-v2`（384维向量）
- 通过FAISS构建本地向量索引

### 3.3 逻辑分离方案

#### 3.3.1 统一部分
1. **数据源统一**
   - 所有页面共用`public/global-books.json`
   - 废除按月份单独读取JSON的逻辑

2. **画布组件统一**
   - 复用同一个`BookCanvas`组件
   - 接收统一格式的books数组（含imagePath、title、author等）

3. **基础逻辑统一**
   - 图片加载、元数据展示、详情弹窗等通用逻辑统一封装

#### 3.3.2 分离部分
1. **数据筛选/检索规则分离**
   - 月份场景：按`month`字段精准匹配
   - 检索场景：按语义相似度匹配（向量化→向量库检索）

2. **接口/数据获取方式分离**
   - 月份场景：静态生成（Next.js getStaticProps）
   - 检索场景：动态接口（Next.js API Routes）

## 4. 实施步骤

### 4.1 数据预处理
1. 创建`scripts/build-book-index.js`脚本
2. 遍历content下所有月份文件夹
3. 聚合图书数据并补充图片路径和月份标识
4. 生成`public/global-books.json`

### 4.2 向量索引构建
1. 安装必要依赖：`sentence-transformers`, `faiss-node`
2. 创建向量生成脚本
3. 使用`all-MiniLM-L6-v2`模型生成向量
4. 构建FAISS索引并保存

### 4.3 API接口开发
1. 创建`pages/api/search.js`检索接口
2. 加载全局数据和向量索引
3. 实现查询向量和相似度计算
4. 返回包含完整元数据的结果

### 4.4 页面改造
1. 创建`pages/search.js`检索页面
2. 改造`pages/month/[month].js`月份页面
3. 统一使用`BookCanvas`组件渲染结果
4. 实现检索表单和结果展示

## 5. 优势与风险规避

### 5.1 核心优势
- **维护高效**：数据源、画布组件只改一处，所有页面同步生效
- **性能适配**：月份页面静态生成（快），检索页面动态接口（灵活）
- **用户体验一致**：两种场景的图书展示、交互完全相同
- **代码复用**：减少冗余，降低维护成本

### 5.2 风险规避
- **数据量增长**：≤1万数据无压力，可添加缓存提升性能
- **图片路径**：确保Next.js public目录下的文件可直接访问
- **数据更新**：新增月份/图书时，只需执行脚本更新全局索引

## 6. 总结

本方案通过统一数据源和画布组件，同时分离筛选/检索逻辑，实现了在现有Next.js项目中高效集成语义检索功能。该架构既保证了代码复用和维护效率，又能满足不同场景的核心需求，为用户提供了统一的体验。

实施后，用户可以通过两种方式访问图书：
1. 点击月份链接查看特定月份的图书（静态生成，快速访问）
2. 使用语义检索功能查找相关图书（动态查询，智能匹配）

这种设计既保留了原有功能，又新增了智能检索能力，提升了用户体验和系统价值。