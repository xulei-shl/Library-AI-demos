# 模块1/2 数据过滤规则详细说明

本文档详细说明了图书推荐系统中模块1（借阅数据分析）和模块2（智能筛选）的核心数据过滤规则。

## 概述

项目采用模块化筛选器架构，包含以下核心筛选规则：
- **规则A**：热门图书筛选（排除顶流热门）
- **规则B**：题名关键词筛选（基于关键词排除）
- **规则B**：索书号/CLC号筛选（基于分类号的保留/排除策略）
- **规则C**：列值筛选（Excel列值过滤）

## 架构设计

### 基础抽象类（BaseFilter）
所有筛选器都继承自 `BaseFilter` 基类，提供统一的接口和通用功能：

```python
class BaseFilter(ABC):
    """基础筛选器抽象类"""
    
    def apply(self, data: pd.DataFrame) -> Tuple[pd.DataFrame, Dict[str, Any]]:
        """应用筛选规则，返回（筛选后数据，统计信息）"""
        
    def _validate_columns(self, data: pd.DataFrame) -> List[str]:
        """验证目标列是否存在，支持自动列名映射"""
        
    def _auto_map_column(self, target: str, available: List[str]) -> str:
        """自动映射列名（支持多种命名变体）"""
        
    def _match_pattern(self, text_series: pd.Series, pattern: str, match_type: str):
        """统一匹配算法（contains/starts_with/ends_with/regex）"""
```

### 智能列名映射
系统自动识别多种列名变体：
- `索书号` ↔ `分类号` ↔ `CallNumber` ↔ `CallNo`
- `题名` ↔ `书名` ↔ `图书名称` ↔ `Title`
- `CLC号` ↔ `分类号` ↔ `分类号码` ↔ `CLC`

## 详细规则说明

### 规则A：热门图书筛选（HotBooksFilter）

#### 功能目标
排除图书馆中借阅次数过高的热门图书，确保推荐结果的多样性和长尾价值。

#### 核心逻辑
1. **动态阈值计算**：根据实际借阅数据动态计算排除阈值
2. **分位数方法**（默认）：排除前15%借阅次数最高的图书
3. **绝对次数方法**：设置固定借阅次数作为阈值
4. **后备机制**：如果没有足够数据，使用默认阈值

#### 算法实现
```python
def _calculate_dynamic_threshold(self, borrowing_counts: pd.Series) -> int:
    """动态计算借阅次数阈值"""
    non_zero_data = borrowing_counts[borrowing_counts > 0]
    
    if len(non_zero_data) == 0:
        return self.config['methods']['percentile']['fallback_count']
    
    if self.config['methods']['percentile']['enabled']:
        percentile = self.config['methods']['percentile']['threshold_percentile']
        threshold = np.percentile(non_zero_data, 100 - percentile)
        
        # 如果分位数结果过小，使用75%分位数
        if threshold < 5:
            threshold = np.percentile(non_zero_data, 75)
        
        return int(threshold)
    
    elif self.config['methods']['absolute_count']['enabled']:
        return self.config['methods']['absolute_count']['threshold_borrowing_count']
    
    else:
        threshold = np.percentile(non_zero_data, 85)  # 默认排除前15%
        return int(threshold)
```

#### 输出统计信息
```python
{
    'description': '规则A - 排除顶流热门（前15%借阅次数最高的图书）',
    'target_column': '借阅次数列',
    'threshold': 动态计算的阈值,
    'threshold_method': 'percentile',
    'excluded_count': 被排除的记录数,
    'excluded_ratio': 排除比例,
    'excluded_books': 被排除的图书数,
    'unique_call_numbers_excluded': 被排除的唯一索书号数
}
```

### 规则B：题名关键词筛选（TitleKeywordsFilter）

#### 功能目标
通过识别图书题名中的特定关键词，自动排除不符合推荐策略的图书类型。

#### 关键词分类系统
系统按以下12个主要类别组织关键词：

1. **技术类**（约90个关键词）
   - 编程语言：Python, Java, JavaScript, C++, R语言, MATLAB
   - 开发框架：Django, Flask, Vue, Spring, PyTorch, TensorFlow
   - 工具软件：Photoshop, Blender, SPSS, WPS
   - 技术概念：机器学习, 深度学习, 算法, 数据库, 微服务

2. **教辅类**（约60个关键词）
   - 考试类型：考试, 教程, 教材, 习题, 答案, 考研, 雅思, 四级, 六级
   - 学习材料：真题, 模拟题, 考前冲刺, 辅导教材, 资格考核
   - 学科教育：高中, 小学, 初中, 职业学校, 语法, 作文

3. **工程工业**（约20个关键词）
   - 工程技术：电池, 矿床, 热力学, 光伏, 工程咨询, 工程制图
   - 工业应用：洗涤剂, 城市污泥

4. **经管类**（约80个关键词）
   - 金融投资：股票, 股市, 期货, K线, 证券, 保险, 股权, 信托
   - 财务会计：会计, 财务, 审计, 票据, 预算, 绩效
   - 管理专业：营销, MBA, MPA, 公司治理, 产业集群

5. **医药类**（约70个关键词）
   - 医疗专业：临床, 诊断, 诊疗, 治疗, 康复, 护理, 制药
   - 专科领域：中医, 西医, 妇科, 儿科, 眼科, 口腔, 心血管
   - 医疗器械：内镜, 医疗器械

6. **法律类**（约20个关键词）
   - 法律条文：民法, 保险法, 司法解释, 行政处罚
   - 司法程序：诉讼, 庭审, 司法鉴定, 职务犯罪

7. **政治类**（约5个关键词）
   - 政府采购, 纪检, 监察, 市场监管

8. **军事类**（约1个关键词）
   - 弹药

9. **工具类**（约150个关键词）
   - 参考资料：资料汇编, 年鉴, 词典, 字典, 县志, 工业志
   - 操作指南：用户手册, 入门手册, 实验指导, 实操手册
   - 版本标识：普及版, 视频课, 高教版, 案例版, 实战版

10. **红色类**（约25个关键词）
    - 政治理论：一带一路, 习近平, 马克思主义, 党建
    - 组织机构：党员, 干部, 共青团, 中国共产党

11. **专业类**（约60个关键词）
    - 技术专业：发动机, 维修, 机械设计, 核聚变, 电气自动化
    - 科学研究：微积分, 核磁共振, 遥感, 细胞工程
    - 心理教育：儿童成长, 儿童心理, 自闭症, 瑜伽, 冥想

12. **国学类**（约35个关键词）
    - 经典文献：易经, 道德经, 资治通鉴, 二十四史, 黄帝内经
    - 传统文化：太极拳, 竹简, 甲骨文, 碑帖, 拓本

#### 匹配策略
- **contains**（默认）：关键词出现在题名任意位置
- **starts_with**：关键词位于题名开头
- **ends_with**：关键词位于题名结尾
- **regex**：使用正则表达式进行复杂匹配

#### 处理逻辑
```python
def apply(self, data: pd.DataFrame) -> Tuple[pd.DataFrame, Dict[str, Any]]:
    """应用题名关键词筛选"""
    patterns = self._load_patterns(self.config['file'])
    
    excluded_mask = pd.Series(False, index=data.index)
    for pattern in patterns:
        excluded_mask |= self._match_pattern(
            data[target_column].astype(str), pattern, match_type
        )
    
    result_data = data[~excluded_mask]
    
    return result_data, {
        'patterns_count': len(patterns),
        'excluded_count': excluded_count,
        'excluded_ratio': excluded_count / len(data),
        'patterns_used': patterns[:10]  # 记录前10个使用的关键词
    }
```

### 规则B：索书号/CLC号筛选（CallNumberFilter）

#### 功能目标
基于图书的索书号和CLC分类号码进行精确的分类筛选，确保推荐结果符合特定的学科领域要求。

#### 分类体系
系统使用中国图书馆分类法（CLC）和索书号系统，主要涉及：

1. **哲学类（D类）**
   - D0：哲学理论
   - D1：世界哲学
   - D4：中国哲学
   - D5：其他各国哲学
   - D61：D7、D8系列特定哲学主题

2. **经济类（F类）**
   - F1：世界各国经济概况、经济史、经济地理
   - F12：中国经济
   - F13/14：其他各国经济
   - F2：经济计划与管理
   - F3：农业经济
   - F4：工业经济
   - F5：交通运输经济
   - F6：邮电通信经济
   - F7：贸易经济
   - F8：财政、金融

3. **文化、科学、教育、体育类（G类）**
   - G0：文化理论
   - G1：世界各国文化与文化事业
   - G2：信息与知识传播
   - G3：科学、科学研究
   - G4：教育
   - G5：体育

4. **语言、文字类（H类）**
   - H0：语言学
   - H1：汉语
   - H2：中国少数民族语言
   - H3：常用外国语
   - H4：其他语系语言

5. **文学类（I类）**
   - I0：文学理论
   - I1：世界文学
   - I2：中国文学
   - I3/4：其他国家文学

6. **艺术类（J类）**
   - J0：艺术理论
   - J1：世界各国艺术概况
   - J2：中国艺术
   - J3/4：其他各国艺术
   - J5：工艺美术

7. **综合性图书（Z类）**
   - Z1：丛书
   - Z2：百科全书、类书
   - Z3：辞典
   - Z4：论文集、全集、选集
   - Z5：年鉴、年刊
   - Z6：期刊、连续性出版物
   - Z8：目录、文摘、索引

#### 保留策略（KEEP规则）
```regex
# 保留特定段号
^(?![TR]).*?(?:-64|-49|-0\d)\d*(?=.*\/).*(?=\/)

# 保留D类哲学类（排除D35）
KEEP ^D[0-1](?!35).*
KEEP ^D[4-5].*
KEEP ^D61.*
KEEP ^D69.*
KEEP ^D7.*
KEEP ^D829.*

# 保留F类经济类
KEEP ^F11.*
KEEP ^F129.*
KEEP ^F1[3-7](?:\d+\.?\d*|\.\d+)+9/.*
KEEP ^F2[4-9]9.(?:\d+\.?\d*|\.\d+)+9/.*

# 保留G类文化教育类
KEEP ^G210.9.*
KEEP ^G20.*
KEEP ^G0.*
KEEP ^G1.*
KEEP ^G219.19.*
KEEP ^G229.19.*

# 保留I类文学类
KEEP ^I0.*
KEEP ^I10.*
KEEP ^I206.7.*
KEEP ^I209.*
KEEP ^I253.7.*

# 保留J类艺术类
KEEP ^J0.*
KEEP ^J11.*
KEEP ^J120.9.*
KEEP ^J[2-5]0-.*

# 保留N类自然科学总论
KEEP ^N0.*
KEEP ^N49.*
KEEP ^N91.*

# 保留TS类技术科学（排除TS1）
KEEP ^TS(?!1).*

# 保留TU类建筑科学
KEEP ^TU22.*
KEEP ^TU23.*
KEEP ^TU24(?!4\.5).*
KEEP ^TU25.*

# 保留Z类综合性图书（特定段号）
KEEP ^Z228.*
KEEP ^Z2[3-7].*
```

#### 排除策略（DROP规则）
```regex
# 排除A类马克思主义
DROP ^A.*

# 排除B类哲学
DROP ^B2.*
DROP ^B81.*
DROP ^B841.*
DROP ^B844.*
DROP ^B9[4-9].*

# 排除C类社会科学总论
DROP ^C[5-8].*
DROP ^C9[6-7].*

# 排除N类非指定段号
DROP ^N(?!(?:91|0|49)).*

# 排除其他主要分类
DROP ^[EFGHJKOPQRUVX].*  # 排除大部分经济、语言、文学、艺术、自然科学等
```

#### 匹配优先级逻辑
```python
def apply(self, data: pd.DataFrame) -> Tuple[pd.DataFrame, Dict[str, Any]]:
    """应用索书号筛选"""
    # 加载保留和排除模式
    include_patterns = pattern_groups['include']
    exclude_patterns = pattern_groups['exclude']
    
    # 构建掩码
    include_mask = self._build_mask(data, valid_columns, include_patterns, match_type)
    exclude_mask = self._build_mask(data, valid_columns, exclude_patterns, match_type)
    
    # 逻辑：仅当命中排除且未命中保留时才剔除
    to_exclude_mask = (~include_mask) & exclude_mask
    result_data = data[~to_exclude_mask]
    
    return result_data, {
        'include_patterns_count': len(include_patterns),
        'exclude_patterns_count': len(exclude_patterns),
        'excluded_count': excluded_count,
        'excluded_ratio': excluded_count / len(data),
        'include_patterns_preview': include_patterns[:10],
        'exclude_patterns_preview': exclude_patterns[:10]
    }
```

### 规则C：列值筛选（ColumnValueFilter）

#### 功能目标
提供基于Excel列值的灵活筛选功能，支持正则表达式和关键词匹配。

#### 筛选类型

1. **正则表达式筛选（regex）**
   ```python
   def _regex_filter(self, text_series: pd.Series, pattern: str, action: str):
       if action == 'keep_only':
           return ~text_series.astype(str).str.match(pattern, na=False)
       else:  # exclude
           return text_series.astype(str).str.match(pattern, na=False)
   ```

2. **关键词排除筛选（exclude_contains）**
   ```python
   def _exclude_contains_filter(self, text_series: pd.Series, exclude_patterns: list):
       excluded_mask = pd.Series(False, index=text_series.index)
       for pattern in exclude_patterns:
           excluded_mask |= text_series.astype(str).str.contains(
               pattern, na=False, case=False
           )
       return excluded_mask
   ```

#### 配置示例
```python
# 正则表达式配置
config = {
    'filter_type': 'regex',
    'pattern': r'^(?=.*教辅)(?=.*教材).*$',  # 同时包含教辅和教材
    'action': 'exclude'  # 或 'keep_only'
}

# 关键词排除配置
config = {
    'filter_type': 'exclude_contains',
    'exclude_patterns': ['考试', '习题', '答案'],
    'action': 'exclude'
}
```

## 配置管理

### 筛选器注册表（FilterRegistry）
支持动态注册和创建筛选器：

```python
class FilterRegistry:
    _filters = {}
    
    @classmethod
    def register(cls, filter_type: str, filter_class: Type[BaseFilter]):
        """注册新的筛选器类型"""
        
    @classmethod
    def create_filter(cls, filter_type: str, config: Dict[str, Any]) -> BaseFilter:
        """根据类型创建筛选器实例"""
        
    @classmethod
    def get_available_filters(cls) -> List[str]:
        """获取所有可用的筛选器类型"""
```

### 默认筛选器
系统预注册了四种内置筛选器：
- `hot_books`：热门图书筛选器
- `title_keywords`：题名关键词筛选器
- `call_number`：索书号/CLC号筛选器
- `column_value`：列值筛选器

## 性能优化

### 1. 批量处理
- 所有筛选器都基于 pandas 的向量化操作
- 支持大批量数据的并行处理

### 2. 缓存机制
- 筛选模式文件一次性加载，避免重复读取
- 支持中间结果的缓存和复用

### 3. 内存管理
- 使用视图操作避免不必要的数据复制
- 及时释放大型中间变量

## 错误处理和容错

### 1. 智能列名映射
如果目标列不存在，自动尝试映射到相似的列名：
```python
def _auto_map_column(self, target: str, available: List[str]) -> str:
    mapping = {
        '索书号': ['索书号', '分类号', 'CallNumber', 'CallNo'],
        '题名': ['题名', '书名', '图书名称', 'Title'],
        # ...
    }
```

### 2. 模式文件容错
- 自动跳过注释行（# 开头）
- 忽略空行和无效格式
- 提供详细的学习日志

### 3. 数据类型安全
- 强制转换为字符串类型避免类型错误
- 使用 na=False 处理空值情况
- 提供异常捕获和优雅降级

## 统计和监控

### 筛选结果统计
每个筛选器都返回详细的统计信息：
- `excluded_count`：被排除的记录数
- `excluded_ratio`：排除比例
- `status`：筛选状态（completed/skipped）
- `reason`：跳过原因（如适用）

### 日志记录
系统提供完整的筛选过程日志：
```python
logger.info(f"规则A - 热门图书筛选: 排除 {excluded_count} 条记录 (阈值: {threshold}次)")
logger.info(f"规则B - 题名关键词筛选: 排除 {excluded_count} 条记录 (关键词数: {len(patterns)})")
logger.info(f"规则B - 索书号/CLC号筛选: 排除 {excluded_count} 条记录")
```

## 使用示例

### 1. 单独使用筛选器
```python
from src.core.filters import HotBooksFilter, TitleKeywordsFilter

# 热门图书筛选
hot_books_config = {
    'enabled': True,
    'description': '排除前15%热门图书',
    'target_column': '借阅次数',
    'methods': {
        'percentile': {
            'enabled': True,
            'threshold_percentile': 15
        }
    }
}

hot_filter = HotBooksFilter(hot_books_config)
filtered_data, stats = hot_filter.apply(original_data)

# 题名关键词筛选
keywords_config = {
    'enabled': True,
    'description': '排除技术教辅类图书',
    'target_column': '题名',
    'file': 'config/filters/title_keywords.txt',
    'match_type': 'contains'
}

keyword_filter = TitleKeywordsFilter(keywords_config)
filtered_data, stats = keyword_filter.apply(filtered_data)
```

### 2. 链式筛选
```python
from src.core.filters import FilterRegistry

# 创建筛选器链
filters = [
    FilterRegistry.create_filter('hot_books', hot_books_config),
    FilterRegistry.create_filter('title_keywords', keywords_config),
    FilterRegistry.create_filter('call_number', call_number_config),
    FilterRegistry.create_filter('column_value', column_config)
]

# 顺序执行筛选
current_data = original_data
all_stats = []

for filter_instance in filters:
    current_data, stats = filter_instance.apply(current_data)
    all_stats.append(stats)

return current_data, all_stats
```

## 总结

本筛选系统提供了：
1. **模块化设计**：每个筛选规则独立实现，便于维护和扩展
2. **灵活配置**：支持多种筛选方式和参数配置
3. **智能映射**：自动识别列名变体，提高兼容性
4. **完整监控**：提供详细的统计信息和日志记录
5. **高性能**：基于pandas的向量化操作，支持大数据量处理
6. **容错机制**：完善的错误处理和异常恢复能力

通过这套筛选系统，可以实现对图书借阅数据的精确过滤，为后续的推荐算法提供高质量的数据基础。
