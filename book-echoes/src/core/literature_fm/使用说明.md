## 数据初始化

### 1. 将历史数据过滤出文学类图书
```
python src/scripts/data_filter.py --config config/literature_fm.yaml
```

### 2. 豆瓣API和写入DB
```
python main.py
```

### 2.1 csv 导入 db
csv字段与db表完全相同
```
python src/core/literature_fm/import_literary_tags.py <file_path> [--db <db_path>]
```

---

## Phase 2: LLM 打标

### 3. LLM 打标
配置：`config/literature_fm.yaml`
```
python src/core/literature_fm/pipeline.py
```

---

## Phase 2.5: 文学策划主题生成

### 4. 统一 CLI 入口

**交互式菜单模式**：
```bash
python src/core/literature_fm/cli.py
```

```
============================================================
Literature_FM 模块 - 功能菜单
============================================================
1. LLM 打标 (Phase 2)
2. 生成策划主题 (Phase 2.5)
3. 情境主题书架 (Phase 3)
4. 数据库向量化
0. 退出
============================================================
```

### 5. 生成策划主题

**子命令模式**：

```bash
# 随机生成 5 个主题
python src/core/literature_fm/cli.py theme-gen --random --count 5

# 基于关键词生成
python src/core/literature_fm/cli.py theme-gen --direction "冬日治愈" --count 3

# LLM 打标
python src/core/literature_fm/cli.py tag
```

**Python 代码调用**：

```python
from src.core.literature_fm import ThemeGenerator

generator = ThemeGenerator()

# 随机生成
result = generator.generate_themes(direction="", count=5)

# 基于关键词生成
result = generator.generate_themes(direction="冬日治愈", count=3)

print(result['themes'])
```

**输出文件**：`runtime/outputs/theme_shelf/themes_时间戳_方向.json`

```json
{
  "generated_at": "2025-01-29T14:30:22",
  "direction": "冬日治愈",
  "count": 3,
  "themes": [
    {
      "theme_name": "暴雪夜，与伟大的灵魂围炉夜话",
      "slogan": "窗外大雪纷飞，屋内思想温暖",
      "description": "适合在狂风暴雨的恶劣天气里阅读的书...",
      "target_vibe": "安全感、沉浸、与世隔绝"
    }
  ]
}
```

---

## Phase 3: 情境主题书架生成

### 6. 数据库向量化
将已打标的书籍向量化并存入 ChromaDB（用于向量检索）。

配置：`config/literature_fm_vector.yaml`

```bash
# 查看向量化状态
python -m src.core.literature_fm.db_vectorizer --status

# 执行向量化（全部）
python -m src.core.literature_fm.db_vectorizer

# 执行向量化（限制数量）
python -m src.core.literature_fm.db_vectorizer --max 500 --batch-size 50
```

或通过 CLI：
```bash
python src/core/literature_fm/cli.py vectorize
```

输出示例：
```
============================================================
向量化状态
============================================================
  已打标总数: 2400
  已向量化: 1800
  待向量化: 595
  失败: 5
  进度: 75.00%
============================================================
```

### 7. 生成情境主题书架
根据用户输入的情境主题，检索匹配书籍并导出 Excel。

**Python 代码调用**：

```python
from src.core.literature_fm import LiteratureFMPipeline

pipeline = LiteratureFMPipeline()
result = pipeline.generate_theme_shelf(
    theme_text="冬日暖阳，窝在沙发里阅读",  # 用户输入的情境主题
    use_vector=True,                          # 是否使用向量检索
    vector_weight=0.5,                        # 向量检索权重 (0-1)
    randomness=0.2,                           # 随机性因子 (0-1)，增加结果多样性
    min_confidence=0.65,                      # 最小置信度
    final_top_k=30,                           # 最终输出数量
    output_dir="runtime/outputs/theme_shelf", # 输出目录
    config_path="config/literature_fm_vector.yaml"  # 配置文件
)

print(result)
# {
#     "success": True,
#     "theme": "冬日暖阳，窝在沙发里阅读",
#     "conditions": {"reading_context": [...], ...},
#     "books": [...],                    # 推荐书籍列表
#     "output_file": "xxx.xlsx",         # 导出文件路径
#     "stats": {...}                     # 统计信息
# }
```

**通过 CLI 调用**：

```bash
python src/core/literature_fm/cli.py shelf --theme "深夜独处，需要治愈"
```

### 8. 配置参数说明

#### literature_fm_vector.yaml
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `vector_db.persist_directory` | ChromaDB 存储路径 | `runtime/vector_db/literature_fm` |
| `vector_db.collection_name` | Collection 名称 | `literature_fm_contexts` |
| `embedding.model` | Embedding 模型 | `Qwen/Qwen3-Embedding-8B` |
| `default.use_vector` | 是否启用向量检索 | `true` |
| `default.vector_weight` | 向量权重 | `0.5` |
| `default.randomness` | 随机性因子 | `0.2` |
| `default.min_confidence` | 最小置信度 | `0.65` |
| `default.final_top_k` | 最终输出数量 | `30` |

#### literature_fm.yaml (主题生成配置)
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `theme_generation.enabled` | 是否启用主题生成 | `true` |
| `theme_generation.default_count` | 默认生成数量 | `5` |
| `theme_generation.output.output_dir` | 输出目录 | `runtime/outputs/theme_shelf` |

---

## 目录结构

```
src/core/literature_fm/
├── __init__.py              # 模块导出
├── cli.py                   # 统一 CLI 入口
├── pipeline.py              # 主流程（LLM打标 + 主题书架）
├── theme_generator.py       # 文学策划主题生成器
├── db_init.py               # 数据库初始化
├── db_vectorizer.py         # 数据库向量化工具
├── llm_tagger.py            # LLM 打标器
├── tag_manager.py           # 标签状态管理
├── import_literary_tags.py  # CSV 导入工具
├── theme_parser.py          # 主题解析器
├── vector_searcher.py       # 向量检索器
├── theme_searcher.py        # 标签检索器
├── theme_merger.py          # 结果融合器
├── theme_deduplicator.py    # 推荐去重器
└── theme_exporter.py        # 结果导出器
```
