## 数据初始化

### 1. 将历史数据过滤出文学类图书
```
python src/scripts/data_filter.py --config config/literature_fm.yaml
```

### 2. 豆瓣API和写入DB
```
python main.py
```

### 2.1 csv 导入 db
csv字段与db表完全相同
```
python src/core/literature_fm/import_literary_tags.py <file_path> [--db <db_path>]
```

### 3. LLM 打标
配置：`config/literature_fm.yaml`
```
python src/core/literature_fm/pipeline.py
```

---

## Phase 3: 情境主题书架生成

### 4. 数据库向量化
将已打标的书籍向量化并存入 ChromaDB（用于向量检索）。

配置：`config/literature_fm_vector.yaml`

```bash
# 查看向量化状态
python -m src.core.literature_fm.db_vectorizer --status

# 执行向量化（全部）
python -m src.core.literature_fm.db_vectorizer

# 执行向量化（限制数量）
python -m src.core.literature_fm.db_vectorizer --max 500 --batch-size 50
```

输出示例：
```
============================================================
向量化状态
============================================================
  已打标总数: 2400
  已向量化: 1800
  待向量化: 595
  失败: 5
  进度: 75.00%
============================================================
```

### 5. 生成情境主题书架
根据用户输入的情境主题，检索匹配书籍并导出 Excel。

```python
from src.core.literature_fm import LiteratureFMPipeline

pipeline = LiteratureFMPipeline()
result = pipeline.generate_theme_shelf(
    theme_text="冬日暖阳，窝在沙发里阅读",  # 用户输入的情境主题
    use_vector=True,                          # 是否使用向量检索
    vector_weight=0.5,                        # 向量检索权重 (0-1)
    randomness=0.2,                           # 随机性因子 (0-1)，增加结果多样性
    min_confidence=0.65,                      # 最小置信度
    final_top_k=30,                           # 最终输出数量
    output_dir="runtime/outputs/theme_shelf", # 输出目录
    config_path="config/literature_fm_vector.yaml"  # 配置文件
)

print(result)
# {
#     "success": True,
#     "theme": "冬日暖阳，窝在沙发里阅读",
#     "conditions": {"reading_context": [...], ...},
#     "books": [...],                    # 推荐书籍列表
#     "output_file": "xxx.xlsx",         # 导出文件路径
#     "stats": {...}                     # 统计信息
# }
```

#### 命令行调用
```bash
# 需要自行编写 CLI 包装脚本，或在 Python 中调用
python -c "
from src.core.literature_fm import LiteratureFMPipeline
pipeline = LiteratureFMPipeline()
result = pipeline.generate_theme_shelf('深夜独处，需要治愈')
print(result)
"
```

### 6. 配置参数说明

#### literature_fm_vector.yaml
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `vector_db.persist_directory` | ChromaDB 存储路径 | `runtime/vector_db/literature_fm` |
| `vector_db.collection_name` | Collection 名称 | `literature_fm_contexts` |
| `embedding.model` | Embedding 模型 | `Qwen/Qwen3-Embedding-8B` |
| `default.use_vector` | 是否启用向量检索 | `true` |
| `default.vector_weight` | 向量权重 | `0.5` |
| `default.randomness` | 随机性因子 | `0.2` |
| `default.min_confidence` | 最小置信度 | `0.65` |
| `default.final_top_k` | 最终输出数量 | `30` |

---

## 目录结构

```
src/core/literature_fm/
├── __init__.py              # 模块导出
├── pipeline.py              # 主流程（LLM打标 + 主题书架）
├── db_init.py               # 数据库初始化
├── db_vectorizer.py         # 数据库向量化工具
├── llm_tagger.py            # LLM 打标器
├── tag_manager.py           # 标签状态管理
├── import_literary_tags.py  # CSV 导入工具
├── theme_parser.py          # 主题解析器
├── vector_searcher.py       # 向量检索器
├── theme_searcher.py        # 标签检索器
├── theme_merger.py          # 结果融合器
├── theme_deduplicator.py    # 推荐去重器
└── theme_exporter.py        # 结果导出器
```