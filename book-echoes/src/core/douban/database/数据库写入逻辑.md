1. **数据库查重阶段的分类问题**：在 [`database_checker.py`](src/core/douban/pipelines/isbn_api_steps/database_checker.py:42) 中，所有记录可能被分类为 `existing_valid`，这意味着数据库中已经存在完整的数据，因此这些记录会被跳过 API 调用和数据库写入。

2. **API 调用阶段的问题**：在 [`api_caller.py`](src/core/douban/pipelines/isbn_api_steps/api_caller.py:106) 中，日志显示"没有需要处理的记录"，这意味着在数据库查重后，没有记录被分类为需要调用 API 的类别（`new`、`existing_stale`、`existing_valid_incomplete`）。

3. **数据库写入阶段的问题**：在 [`database_writer.py`](src/core/douban/pipelines/isbn_api_steps/database_writer.py:87) 中，只有状态为 `ProcessStatus.DONE` 的记录才会被写入数据库。如果所有记录的状态不是 `DONE`，那么不会有数据被写入。

## 具体逻辑

1. **数据库查重阶段**：
   - 在 [`database_checker.py`](src/core/douban/pipelines/isbn_api_steps/database_checker.py:98) 中，记录被分为四类：
     - `existing_valid`：数据库中已有完整数据且未过期，这些记录会被标记为 `ProcessStatus.FROM_DB`，并跳过 API 调用和数据库写入。
     - `existing_valid_incomplete`：数据库中有数据但不完整，这些记录会被标记为需要调用 API 补充。
     - `existing_stale`：数据库中有数据但已过期，这些记录会被标记为需要调用 API 刷新。
     - `new`：数据库中无记录，这些记录会被标记为需要调用 API 获取。

2. **API 调用阶段**：
   - 在 [`api_caller.py`](src/core/douban/pipelines/isbn_api_steps/api_caller.py:104) 中，只有被分类为 `new`、`existing_stale`、`existing_valid_incomplete` 的记录才会被调用 API。
   - 如果所有记录都被分类为 `existing_valid`，那么 API 调用阶段会跳过所有记录。

3. **数据库写入阶段**：
   - 在 [`database_writer.py`](src/core/douban/pipelines/isbn_api_steps/database_writer.py:87) 中，只有状态为 `ProcessStatus.DONE` 的记录才会被写入数据库。
   - 如果所有记录的状态都是 `ProcessStatus.FROM_DB`（来自数据库），那么数据库写入阶段会跳过所有记录。

## 正确的写回逻辑

下表汇总了数据库查重分类与 API 调用、数据库写入、豆瓣数据来源的关系：

| 分类 | DB有数据 | 是否调用API | 是否写回DB | 豆瓣数据来源 | 状态标记 |
|------|---------|-------------|-----------|--------------|----------|
| `existing_valid` | ✅ 完整 | ❌ 不调用 | ❌ 不写回 | `database` | `FROM_DB` / `DONE` |
| `existing_valid_incomplete` | ✅ 不完整 | ✅ 补充调用 | ✅ 写回 | `api,database` | `DONE` |
| `existing_stale` | ✅ 过期 | ✅ 刷新调用 | ✅ 写回 | `api,database` | `DONE` |
| `new` | ❌ 无记录 | ✅ 调用获取 | ✅ 写回 | `api` | `DONE` |

### 关键说明

1. **`existing_valid` 分类**：
   - DB中已有完整且未过期的数据
   - 不调用API，直接从DB回写到Excel
   - 不会写回DB（因为DB中已有数据，无需覆盖）
   - 豆瓣数据来源 = `database`

2. **`existing_valid_incomplete` / `existing_stale` 分类**：
   - DB中有数据但不完整或已过期
   - 先从DB回写基础数据到Excel，然后调用API补充/刷新
   - API调用成功后，**会将完整数据写回DB**（更新旧记录）
   - 豆瓣数据来源 = `api,database`（通过 [`progress_manager.py:146-153`](src/core/douban/progress_manager.py:146) 的 `append_source` 方法累加）

3. **`new` 分类**：
   - DB中无记录
   - 调用API获取新数据
   - API调用成功后，**会将新数据写入DB**
   - 豆瓣数据来源 = `api`

## 结论

根据日志和代码逻辑，最可能的原因是所有记录在数据库查重阶段被分类为 `existing_valid`，这意味着数据库中已经存在完整的数据。因此，这些记录会被标记为 `ProcessStatus.FROM_DB`，并跳过 API 调用和数据库写入。