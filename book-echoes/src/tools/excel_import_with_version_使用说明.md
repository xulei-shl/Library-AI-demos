# Excel导入脚本（带版本控制）使用说明

## 概述

`excel_import_with_version.py` 是一个专门用于将Excel数据导入到books表的脚本，具有以下特性：

- **版本控制**：自动管理data_version字段，每次更新递增版本号（1.0 → 1.1 → 1.2...）
- **去重逻辑**：基于barcode字段进行去重，重复数据覆盖更新
- **时间戳处理**：正确处理created_at和updated_at字段
- **完整日志**：详细的操作日志和错误处理
- **事务安全**：使用数据库事务确保数据一致性
- **数据来源过滤**：只导入豆瓣数据来源为'api'的记录

## 核心功能

### 1. 版本控制逻辑

- **新增记录**：data_version设置为"1.0"
- **更新记录**：在原版本基础上递增0.1
- **版本递增规则**：
  - 1.0 → 1.1 → 1.2 → ... → 1.9 → 2.0
  - 2.0 → 2.1 → 2.2 → ... → 2.9 → 3.0
  - 以此类推

### 2. 去重逻辑

- 基于**barcode（书目条码）**字段进行去重
- 重复数据：覆盖更新现有记录
- 新数据：插入新记录

### 3. 时间戳处理

- **created_at**：新增时设置当前时间，更新时保持原创建时间不变
- **updated_at**：每次更新都设置为当前时间

### 4. 数据来源过滤

脚本会检查Excel文件中的`豆瓣数据来源`列：
- **只导入**：豆瓣数据来源值为`api`（不区分大小写）的记录
- **跳过记录**：豆瓣数据来源为其他值（如`manual`、`crawler`等）或该列不存在

### 5. 字段映射

使用配置文件 `config/setting.yaml` 中的字段映射配置：
```yaml
fields_mapping:
  excel_to_database:
    books:
      "书目条码": "barcode"
      "索书号": "call_no"
      "书名": "book_title"
      # ... 其他字段映射
```

## 使用方法

### 基本用法

```bash
# 导入Excel文件（使用默认数据库配置）
python src/tools/excel_import_with_version.py runtime/outputs/数据筛选结果_20251228_130710_ISBN_API结果_20251228_203237.xlsx

# 指定数据库路径
python src/tools/excel_import_with_version.py path/to/your/excel.xlsx --db-path runtime/outputs/custom.db

# 指定工作表
python src/tools/excel_import_with_version.py path/to/your/excel.xlsx --sheet Sheet1
```

### 命令行参数

- `excel_path`：Excel文件路径（必需）
- `--db-path`：数据库文件路径（可选，默认从配置文件读取）
- `--config`：配置文件路径（可选，默认：config/setting.yaml）
- `--sheet`：工作表名称或索引（可选，默认：第一个工作表）

### 使用示例

```bash
# 导入新书验收数据
python src/tools/excel_import_with_version.py "data/new/验收.xlsx"

# 导入指定工作表
python src/tools/excel_import_with_version.py "data/combined.xlsx" --sheet "新书数据"

# 使用自定义数据库
python src/tools/excel_import_with_version.py "data/books.xlsx" --db-path "runtime/outputs/custom.db"
```

## 输出示例

```
============================================================
开始导入Excel数据（带版本控制）...
============================================================

2025-12-15 09:28:58,585 - INFO - 正在读取Excel文件: data/new/验收.xlsx
2025-12-15 09:28:58,808 - INFO - 成功读取 3 行数据
2025-12-15 09:28:58,809 - INFO - Excel文件包含以下列:
2025-12-15 09:28:58,809 - INFO -    1. 书目条码
2025-12-15 09:28:58,809 - INFO -    2. 索书号
2025-12-15 09:28:58,809 - INFO -    3. 书名
...

2025-12-15 09:28:58,838 - INFO - 新增记录: 条码=1234567890, 版本=1.0
2025-12-15 09:28:58,839 - INFO - 第3行：豆瓣数据来源为'manual'，跳过记录（只导入api来源）
2025-12-15 09:28:58,866 - INFO - 更新记录: 条码=2345678901, 版本=1.0→1.1

2025-12-15 09:28:58,850 - INFO - 导入完成统计:
2025-12-15 09:28:58,850 - INFO -   总记录数: 3
2025-12-15 09:28:58,850 - INFO -   新增记录: 1
2025-12-15 09:28:58,850 - INFO -   更新记录: 2
2025-12-15 09:28:58,850 - INFO -   跳过记录: 1
2025-12-15 09:28:58,850 - INFO -   错误记录: 0

============================================================
导入完成!
============================================================
  成功处理记录数: 3
============================================================
```

## 日志文件

脚本会在 `runtime/logs/` 目录下创建带时间戳的日志文件：
- 文件名格式：`excel_import_YYYYMMDD_HHMMSS.log`
- 包含详细的操作记录和错误信息
- 同时输出到控制台和日志文件

## 错误处理

### 常见错误及解决方案

1. **配置文件不存在**
   ```
   [错误] 配置文件不存在: config/setting.yaml
   ```
   解决：确保配置文件存在且路径正确

2. **数据库连接失败**
   ```
   [错误] 数据库连接失败: unable to open database file
   ```
   解决：检查数据库路径和权限，确保目录存在

3. **Excel文件不存在**
   ```
   [错误] 文件不存在: data/books.xlsx
   ```
   解决：检查Excel文件路径是否正确

4. **缺少必要字段**
   ```
   [警告] 条码 1234567890：缺少必要字段，跳过记录
   ```
   解决：确保Excel文件包含书目条码、索书号、书名等必要字段

5. **豆瓣数据来源过滤**
   ```
   [信息] 第3行：豆瓣数据来源为'manual'，跳过记录（只导入api来源）
   ```
   说明：这是正常的过滤行为，只有豆瓣数据来源为'api'的记录才会被导入

## 测试

项目包含测试脚本 `test_excel_import_version.py`，可以验证脚本功能：

```bash
# 运行测试
python src/tools/test_excel_import_version.py
```

测试内容：
- 版本号递增逻辑
- 数据库操作（新增/更新）
- 时间戳处理
- 去重逻辑

## 与原脚本的区别

| 功能 | 原脚本 (excel_import.py) | 新脚本 (excel_import_with_version.py) |
|------|-------------------------|-------------------------------------|
| 版本控制 | 固定设置为"1.0" | 自动递增版本号 |
| 去重逻辑 | INSERT OR REPLACE | 基于barcode的智能更新 |
| 时间戳处理 | 每次都更新 | created_at保持，updated_at更新 |
| 数据来源过滤 | 无 | 只导入豆瓣数据来源为'api'的记录 |
| 日志记录 | 基本输出 | 详细日志+文件记录 |
| 事务处理 | 单条记录提交 | 批量事务处理 |
| 错误处理 | 基本错误捕获 | 详细错误分类和统计 |

## 注意事项

1. **数据备份**：建议在导入大量数据前备份数据库
2. **字段映射**：确保Excel列名与配置文件中的映射一致
3. **必要字段**：书目条码、索书号、书名是必填字段
4. **数据来源列**：必须包含`豆瓣数据来源`列，且值为'api'才会导入
5. **性能考虑**：大量数据导入时可能需要较长时间
6. **并发安全**：避免多个进程同时导入到同一数据库

## 版本信息

- **版本**：2.0
- **创建时间**：2025-12-15
- **作者**：豆瓣评分模块开发组
- **依赖**：pandas, openpyxl, pyyaml, sqlite3