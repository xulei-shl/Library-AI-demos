# 数据库清洗工具使用说明

## 概述

`database_cleaner.py` 是一个专门用于清洗 books 表数据的工具，主要功能包括：

1. **按 call_no 字段去重合并**：如果多条记录具有相同的 call_no，则合并为一条记录，保留最新数据的字段值
2. **清洗 barcode 字段**：去除 barcode 字段末尾的 `.0` 后缀

## 功能特点

### 1. 智能去重合并
- 以 `call_no` 字段作为去重条件
- 保留 `updated_at` 时间最新的记录作为基础
- 对于空字段，从其他记录中补充非空值
- 确保数据完整性

### 2. Barcode 字段清洗
- 自动检测并去除 barcode 字段末尾的 `.0`
- 例如：`54121111478594.0` → `54121111478594`
- 保持其他格式的 barcode 不变

### 3. 安全备份
- 清洗前自动备份数据库
- 支持禁用备份功能（测试环境）
- 备份文件包含时间戳，便于管理

### 4. 详细日志
- 完整的操作日志记录
- 详细的统计信息
- 支持调试模式

## 使用方法

### 基本用法

```bash
# 使用默认配置清洗数据
python src/tools/database_cleaner.py

# 指定数据库路径
python src/tools/database_cleaner.py --db-path runtime/database/custom.db

# 不备份数据库（测试环境）
python src/tools/database_cleaner.py --no-backup
```

### 命令行参数

- `--db-path`: 指定数据库文件路径（可选，默认从配置文件读取）
- `--config`: 指定配置文件路径（默认: config/setting.yaml）
- `--no-backup`: 不备份数据库（默认: 备份）

### 配置文件

工具从 `config/setting.yaml` 读取数据库配置：

```yaml
douban:
  database:
    db_path: "runtime/database/books_history.db"
```

## 执行示例

```bash
$ python src/tools/database_cleaner.py

============================================================
开始数据清洗...
============================================================
2025-12-18 10:05:27,902 - INFO - 成功连接到数据库: runtime/database/books_history.db
2025-12-18 10:05:27,902 - INFO - 开始清洗books表数据...
2025-12-18 10:05:27,903 - INFO - books表结构: 31 个字段
2025-12-18 10:05:27,903 - INFO - 读取到 3 条记录
2025-12-18 10:05:27,903 - INFO - 按call_no分组后，共 1 个不同的call_no
2025-12-18 10:05:27,921 - INFO - 清洗后记录数: 1
2025-12-18 10:05:27,938 - INFO - books表数据清洗完成
2025-12-18 10:05:27,939 - INFO - 数据库已备份到: runtime/database/books_history_backup_20251218_100527.db

============================================================
数据清洗完成!
============================================================
  原始记录数: 3
  最终记录数: 1
  合并记录数: 2
  清洗barcode数: 1
============================================================
```

## 清洗逻辑详解

### 1. 按call_no去重合并

**步骤：**
1. 按 `call_no` 字段分组记录
2. 每组内按 `updated_at` 降序排列
3. 以最新记录为基础
4. 遍历其他记录，补充空字段

**示例：**
```json
[
  {
    "id": 16261,
    "barcode": "54121111478594",
    "call_no": "C912.4/6833",
    "cleaned_call_no": "C912.4/6833",
    "book_title": "再见智人",
    "additional_info": "200642264",
    "douban_rating_count": 50,
    "updated_at": "2025-12-04 11:42:39"
  },
  {
    "id": 41476,
    "barcode": "54121111478594.0",
    "call_no": "C912.4/6833",
    "cleaned_call_no": "",
    "book_title": "再见智人",
    "additional_info": null,
    "douban_rating_count": 52,
    "updated_at": "2025-12-16 23:45:48"
  }
]
```

**合并结果：**
```json
{
  "id": 41476,
  "barcode": "54121111478594",
  "call_no": "C912.4/6833",
  "cleaned_call_no": "C912.4/6833",  // 来自最新记录
  "book_title": "再见智人",
  "additional_info": "200642264",      // 来自第一条记录（最新记录为空）
  "douban_rating_count": 52,          // 来自最新记录
  "updated_at": "2025-12-16 23:45:48"
}
```

### 2. Barcode字段清洗

**规则：**
- 如果 barcode 以 `.0` 结尾，则去除 `.0`
- 其他情况保持不变

**示例：**
- `54121111478594.0` → `54121111478594`
- `54121111478594` → `54121111478594`（不变）
- `9787511745932.0` → `9787511745932`

## 测试工具

项目包含完整的测试工具 `test_database_cleaner.py`：

```bash
# 运行测试
python src/tools/test_database_cleaner.py
```

测试工具会：
1. 创建包含样例数据的测试数据库
2. 执行数据清洗
3. 验证清洗结果
4. 输出详细的测试报告

## 注意事项

### 1. 数据安全
- 默认启用数据库备份
- 备份文件包含时间戳
- 建议在生产环境中始终启用备份

### 2. 性能考虑
- 大数据量时清洗过程可能较慢
- 建议在低峰期执行
- 可以通过日志监控进度

### 3. 数据一致性
- 清洗过程使用事务保证一致性
- 如果失败会自动回滚
- 索引会自动重建

### 4. 字段优先级
- 最新记录的字段优先
- 空字段会从其他记录补充
- 非空字段不会被覆盖

## 错误处理

### 常见错误及解决方案

#### 错误1: "数据库连接失败"
**原因**: 数据库文件路径错误或权限不足
**解决**: 
1. 检查数据库路径是否正确
2. 确保有读写权限
3. 检查配置文件中的路径设置

#### 错误2: "表不存在"
**原因**: 数据库未初始化或表名错误
**解决**: 
1. 运行 `init_database.py` 初始化数据库
2. 检查表名是否正确

#### 错误3: "字段不存在"
**原因**: 表结构不匹配
**解决**: 
1. 检查数据库表结构
2. 更新工具以匹配实际结构

## 技术实现

### 核心算法

1. **分组算法**: 使用字典按 call_no 分组
2. **排序算法**: 按 updated_at 降序排列
3. **合并算法**: 优先最新记录，补充空字段
4. **清洗算法**: 字符串后缀检测和移除

### 数据结构

- 输入: `List[sqlite3.Row]` - 原始记录列表
- 中间: `Dict[str, List[sqlite3.Row]]` - 分组后的记录
- 输出: `List[Dict[str, Any]]` - 清洗后的记录

### 事务处理

- 使用 SQLite 事务确保数据一致性
- 失败时自动回滚
- 临时表 + 重命名的方式确保安全

## 版本信息

- **版本**: 1.0
- **创建时间**: 2025-12-18
- **作者**: 数据库清洗工具开发组

## 技术支持

如遇到问题，请检查：
1. 数据库文件路径和权限
2. 配置文件格式和内容
3. 数据库表结构是否匹配
4. 日志文件中的详细错误信息

更多技术支持，请参考项目文档或联系开发团队。