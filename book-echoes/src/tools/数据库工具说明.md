# 数据库工具使用说明

## 概述

`src/tools` 路径下提供两个数据库相关工具，用于管理豆瓣评分模块的数据存储：

1. **init_database.py** - 数据库初始化工具
2. **excel_import.py** - Excel数据导入工具

这两个工具配合使用，可以快速搭建和填充数据库，实现从Excel数据到SQLite数据库的完整数据迁移流程。

---

## 1. init_database.py - 数据库初始化工具

### 功能说明

`init_database.py` 是一个数据库初始化脚本，用于根据历史数据查重数据库设计文档，创建SQLite数据库的表结构。

#### 核心功能
- 创建三个核心数据表：`books`、`borrow_records`、`borrow_statistics`
- 自动创建索引优化查询性能
- 支持从配置文件读取数据库路径
- 支持命令行参数自定义数据库位置
- 提供数据库验证功能

### 数据库表结构

#### books表（书籍基础信息和豆瓣信息）
存储书籍的基础信息和豆瓣评分相关数据。

**核心字段：**
- `barcode` (TEXT) - 书目条码，唯一键
- `call_no` (TEXT) - 索书号
- `book_title` (TEXT) - 书名
- `isbn` (TEXT) - ISBN号
- `douban_*` 字段 - 豆瓣相关信息（评分、作者、出版社、简介等）
- `data_version` (TEXT) - 数据版本
- `created_at/updated_at` (TEXT) - 创建和更新时间

#### borrow_records表（借阅记录）
存储每本书的借阅历史记录。

**核心字段：**
- `barcode` (TEXT) - 外键，关联books表
- `reader_card_no` (TEXT) - 读者卡号
- `submit_time/return_time` (TEXT) - 提交时间和归还时间
- `storage_time/created_at` (TEXT) - 记录时间

#### borrow_statistics表（统计信息）
存储按月统计的借阅次数数据。

**核心字段：**
- `barcode` (TEXT) - 外键，关联books表
- `stat_period` (TEXT) - 统计周期（如"2024-10"）
- `stat_year/stat_month` (INTEGER) - 统计年月
- `borrow_count_3m` (INTEGER) - 近三个月总次数
- `borrow_count_m1/m2/m3` (INTEGER) - 各月借阅次数
- `period_start/period_end` (TEXT) - 周期范围

### 使用方法

#### 基本用法

```bash
# 使用默认配置初始化数据库
python src/tools/init_database.py

# 指定数据库文件路径
python src/tools/init_database.py --db-path runtime/outputs/custom_books.db

# 强制重新创建已存在的数据库
python src/tools/init_database.py --db-path runtime/outputs/books.db --force
```

#### 命令行参数

- `--db-path`: 指定数据库文件路径（可选，默认从配置文件读取）
- `--force`: 强制重新创建数据库（如果已存在）

#### 配置文件

脚本从 `config/setting.yaml` 读取数据库配置：

```yaml
douban:
  database:
    db_path: 'runtime/outputs/books_history.db'
```

或者分别配置路径和文件名：

```yaml
douban:
  database:
    name: 'books.db'      # 数据库文件名
    path: 'runtime/database/'  # 数据库文件目录
```

#### 执行示例

```bash
# 初始化数据库（使用交互式确认）
$ python src/tools/init_database.py --db-path runtime/outputs/books.db
[信息] 创建数据库目录: runtime/outputs
数据库文件路径: F:\Github\Library-AI-demos\book-echoes\runtime\outputs\books.db

[成功] 连接到数据库: runtime/outputs/books.db

==================================================
开始创建数据库表...
==================================================
[成功] books表创建成功
[成功] borrow_records表创建成功
[成功] borrow_statistics表创建成功

==================================================
[成功] 所有表创建完成！
==================================================

数据库表验证:
--------------------------------------------------
[成功] books - 30 列
   └─ 索引数量: 4
[成功] borrow_records - 6 列
   └─ 索引数量: 3
[成功] borrow_statistics - 11 列
   └─ 索引数量: 3
--------------------------------------------------

==================================================
[成功] 数据库初始化完成！
==================================================

数据库表说明:
  - books: 书籍基础信息和豆瓣信息
  - borrow_records: 借阅记录历史
  - borrow_statistics: 每月统计汇总

现在可以在主程序中使用此数据库了。

[信息] 数据库连接已关闭
```

---

## 2. excel_import.py - Excel数据导入工具

### 功能说明

`excel_import.py` 是一个Excel数据导入脚本，用于将Excel文件中的数据导入到SQLite数据库中。

#### 核心功能
- 支持将Excel数据导入到三个表：`books`、`borrow_records`、`borrow_statistics`
- 自动进行Excel列名到数据库字段的映射
- 智能数据类型转换（文本、整数、浮点数）
- 支持数据验证和错误处理
- 支持预览模式（--dry-run）
- 支持指定工作表导入

### Excel列名映射

#### books表字段映射

| Excel列名 | 数据库字段 | 说明 |
|-----------|-----------|------|
| 书目条码 | barcode | 书目条码（唯一键） |
| 索书号 | call_no | 索书号 |
| 书名 | book_title | 书名 |
| 附加信息 | additional_info | 附加信息 |
| ISBN号 | isbn | ISBN号 |
| 豆瓣链接 | douban_url | 豆瓣链接 |
| 豆瓣评分 | douban_rating | 豆瓣评分 |
| 豆瓣书名 | douban_title | 豆瓣书名 |
| 豆瓣副标题 | douban_subtitle | 豆瓣副标题 |
| 豆瓣原作名 | douban_original_title | 豆瓣原作名 |
| 豆瓣作者 | douban_author | 豆瓣作者 |
| 豆瓣译者 | douban_translator | 豆瓣译者 |
| 豆瓣出版社 | douban_publisher | 豆瓣出版社 |
| 豆瓣出品方 | douban_producer | 豆瓣出品方 |
| 豆瓣丛书 | douban_series | 豆瓣丛书 |
| 豆瓣丛书链接 | douban_series_link | 豆瓣丛书链接 |
| 豆瓣定价 | douban_price | 豆瓣定价 |
| 豆瓣ISBN | douban_isbn | 豆瓣ISBN |
| 豆瓣页数 | douban_pages | 豆瓣页数 |
| 豆瓣装帧 | douban_binding | 豆瓣装帧 |
| 豆瓣出版年 | douban_pub_year | 豆瓣出版年 |
| 豆瓣评价人数 | douban_rating_count | 豆瓣评价人数 |
| 豆瓣封面图片链接 | douban_cover_image | 豆瓣封面图片链接 |
| 豆瓣内容简介 | douban_summary | 豆瓣内容简介 |
| 豆瓣作者简介 | douban_author_intro | 豆瓣作者简介 |
| 豆瓣目录 | douban_catalog | 豆瓣目录 |

#### borrow_records表字段映射

| Excel列名 | 数据库字段 | 说明 |
|-----------|-----------|------|
| 书目条码 | barcode | 外键，关联books表 |
| 读者卡号 | reader_card_no | 读者卡号 |
| 提交时间 | submit_time | 提交时间 |
| 归还时间 | return_time | 归还时间 |
| 入库时间 | storage_time | 入库时间 |

#### borrow_statistics表字段映射

| Excel列名 | 数据库字段 | 说明 |
|-----------|-----------|------|
| 书目条码 | barcode | 外键，关联books表 |
| 近三个月总次数 | borrow_count_3m | 近三个月总次数 |
| 第一个月借阅次数 | borrow_count_m1 | 第一月借阅次数 |
| 第二个月借阅次数 | borrow_count_m2 | 第二月借阅次数 |
| 第三个月借阅次数 | borrow_count_m3 | 第三月借阅次数 |

### 使用方法

#### 基本用法

```bash
# 导入Excel文件（使用默认数据库配置）
python src/tools/excel_import.py path/to/your/excel.xlsx

# 指定数据库路径
python src/tools/excel_import.py path/to/your/excel.xlsx --db-path runtime/outputs/custom.db

# 指定工作表
python src/tools/excel_import.py path/to/your/excel.xlsx --sheet Sheet1

# 预览模式（不实际插入数据）
python src/tools/excel_import.py path/to/your/excel.xlsx --dry-run
```

#### 命令行参数

- `excel_path`: Excel文件路径（必需）
- `--db-path`: 数据库文件路径（可选，默认从配置文件读取）
- `--config`: 配置文件路径（可选，默认: config/setting.yaml）
- `--sheet`: 工作表名称或索引（可选，默认: 第一个工作表）
- `--dry-run`: 预览模式，只显示数据统计，不实际插入

#### 实际示例

```bash
# 导入月归还数据
python src/tools/excel_import.py "data/月归还.xlsx"

# 导入近三月借阅数据，使用自定义数据库
python src/tools/excel_import.py "data/近三月借阅.xlsx" --db-path "runtime/outputs/custom.db"

# 导入特定工作表
python src/tools/excel_import.py "data/combined.xlsx" --sheet "借阅记录"
```

#### 完整执行示例

```bash
$ python src/tools/excel_import.py "data/test.xlsx"
[成功] 连接到数据库: runtime/database/books.db

============================================================
开始导入Excel数据...
============================================================

[信息] 正在读取Excel文件: data/test.xlsx
[信息] 成功读取 3 行数据

[信息] Excel文件包含以下列:
   1. 书目条码
   2. 索书号
   3. 书名
   ...

[信息] 开始导入books表...
[成功] 成功导入 3 条books记录

[信息] 开始导入borrow_records表...
[成功] 成功导入 3 条borrow_records记录

[信息] 开始导入borrow_statistics表...
[成功] 成功导入 3 条borrow_statistics记录

============================================================
导入完成!
============================================================
  books表: 3 条记录
  borrow_records表: 3 条记录
  borrow_statistics表: 3 条记录
  总计: 9 条记录
============================================================

[信息] 数据库连接已关闭
```

### 数据插入策略

#### books表
- **策略**: `INSERT OR REPLACE` - 如果记录已存在则更新
- **必须字段**: 书目条码、索书号、书名
- **自动填充**: 创建时间、更新时间、数据版本

#### borrow_records表
- **策略**: `INSERT` - 新增记录（允许同一本书多次借阅）
- **必须字段**: 书目条码、读者卡号
- **特点**: 允许重复导入，不会更新现有记录

#### borrow_statistics表
- **策略**: `INSERT OR REPLACE` - 如果记录已存在则更新
- **自动计算**: 统计周期（当前年月）
- **必须字段**: 书目条码
- **周期**: 包含最近三个月的数据统计

---

## 3. 完整使用流程

### 场景一：首次使用

```bash
# 步骤1: 初始化数据库
python src/tools/init_database.py --db-path runtime/outputs/books.db

# 步骤2: 导入Excel数据
python src/tools/excel_import.py "data/books_data.xlsx" --db-path runtime/outputs/books.db
```

### 场景二：更新现有数据

```bash
# 重新导入数据（books和statistics表会更新，borrow_records会追加）
python src/tools/excel_import.py "data/updated_data.xlsx" --db-path runtime/outputs/books.db
```

### 场景三：预览数据

```bash
# 预览要导入的数据（不实际插入）
python src/tools/excel_import.py "data/new_data.xlsx" --dry-run
```

---

## 4. 依赖要求

### Python包

```bash
pip install pandas openpyxl xlsxwriter python-dateutil pyyaml sqlite3
```

或在项目根目录下运行：

```bash
pip install -r requirements.txt
```

### 系统要求
- Python 3.7+
- SQLite 3.x（Python内置）
- 足够的磁盘空间存储数据库文件

---

## 5. 注意事项

### 数据验证
1. **必要字段检查**:
   - books表：书目条码、索书号、书名必须存在
   - borrow_records表：书目条码、读者卡号必须存在
   - borrow_statistics表：书目条码必须存在

2. **数据类型转换**:
   - 自动转换数值类型（INTEGER、REAL）
   - 自动处理文本类型（TEXT）
   - 空单元格转换为NULL

### 编码要求
- Excel文件应使用UTF-8编码，避免中文乱码
- 数据库文件使用UTF-8编码存储

### 外键约束
- borrow_records表的barcode字段必须存在于books表中
- borrow_statistics表的barcode字段必须存在于books表中
- 删除books表记录时，相关借阅记录和统计记录会级联删除

### 性能优化
- 数据库表已创建索引，查询性能优化
- 大量数据导入时，建议分批处理
- 使用预览模式（--dry-run）验证数据格式

---

## 6. 错误处理

### 常见错误及解决方案

#### 错误1: "数据库连接失败"
**原因**: 数据库文件路径错误或无写入权限
**解决**:
1. 检查数据库路径是否正确
2. 确保有写入权限
3. 先运行 `init_database.py` 创建数据库

#### 错误2: "缺失必要字段"
**原因**: Excel文件缺少必需列
**解决**:
1. 检查Excel文件是否包含必需列
2. 参考"Excel列名映射"章节，确保列名正确

#### 错误3: "外键约束失败"
**原因**: borrow_records或borrow_statistics表的barcode在books表中不存在
**解决**:
1. 先导入books数据，再导入其他表
2. 检查barcode是否一致

#### 错误4: "数据类型错误"
**原因**: Excel中的数据格式不符合数据库字段类型
**解决**:
1. 检查数值字段是否包含非数字内容
2. 检查日期字段格式是否正确

---

## 7. 配置文件说明

### config/setting.yaml 示例

```yaml
# 数据库配置
douban:
  database:
    # 方式1: 直接指定完整路径
    db_path: 'runtime/outputs/books_history.db'

    # 方式2: 分别指定路径和文件名
    name: 'books.db'
    path: 'runtime/database/'

# 其他配置（如果有）
douban:
  other_settings:
    # ...
```

### 配置优先级
1. 命令行参数指定的路径（最高优先级）
2. 配置文件中的 `db_path` 字段
3. 配置文件中的 `name` + `path` 组合
4. 默认路径（最低优先级）

---

## 8. 维护和备份

### 数据库备份

```bash
# 备份数据库文件
cp runtime/outputs/books.db "backup/books_$(date +%Y%m%d_%H%M%S).db"
```

### 数据清理

```bash
# 清空borrow_records表（保留结构）
sqlite3 runtime/outputs/books.db "DELETE FROM borrow_records;"

# 重置自增ID
sqlite3 runtime/outputs/books.db "DELETE FROM sqlite_sequence WHERE name='borrow_records';"
```

### 数据查看

```bash
# 查看表结构和记录数
sqlite3 runtime/outputs/books.db ".schema"
sqlite3 runtime/outputs/books.db "SELECT COUNT(*) FROM books;"
sqlite3 runtime/outputs/books.db "SELECT COUNT(*) FROM borrow_records;"
sqlite3 runtime/outputs/books.db "SELECT COUNT(*) FROM borrow_statistics;"
```

---

## 9. 常见问题

**Q: 重复导入会怎样？**
A:
- books表和borrow_statistics表：使用"INSERT OR REPLACE"，重复的barcode会更新记录
- borrow_records表：使用"INSERT"，允许同一本书的多条借阅记录

**Q: 如何更新已存在的数据？**
A: 重新运行导入脚本，books表和borrow_statistics表会自动更新，borrow_records表会追加新记录。

**Q: 导入失败，提示"数据库连接失败"怎么办？**
A: 检查数据库文件路径是否正确，确保有写入权限，或者先运行 `init_database.py` 初始化数据库。

**Q: 某些记录没有导入成功？**
A: 检查这些记录是否缺少必要字段（books表需要：书目条码、索书号、书名；borrow_records表需要：书目条码、读者卡号）。

**Q: 支持哪些Excel格式？**
A: 支持 `.xlsx` 和 `.xls` 格式，建议使用 `.xlsx` 格式以获得更好的性能。

**Q: 可以导入多个工作表吗？**
A: 目前一次只能导入一个工作表。如需导入多个工作表，请分别执行多次导入命令。

**Q: 数据量很大时导入很慢怎么办？**
A:
1. 使用预览模式验证数据格式
2. 分批导入数据（按月份或按文件分割）
3. 确保Excel文件格式正确，减少数据转换时间

---

## 10. 版本信息

- **init_database.py**: 版本 1.0，创建时间 2025-11-04
- **excel_import.py**: 版本 1.0，创建时间 2025-11-05
- **作者**: 豆瓣评分模块开发组

---

## 11. 参考资源

- [SQLite 官方文档](https://sqlite.org/docs.html)
- [Pandas Excel 支持](https://pandas.pydata.org/docs/user_guide/io.html#excel-files)
- [Python argparse 文档](https://docs.python.org/3/library/argparse.html)
- [数据库设计文档](./历史数据查重数据库设计文档.md)

---

## 12. 技术支持

如遇到问题，请检查：
1. Python版本是否符合要求
2. 依赖包是否完整安装
3. 文件路径和权限是否正确
4. Excel文件格式和编码是否正确

更多技术支持，请参考项目文档或联系开发团队。
