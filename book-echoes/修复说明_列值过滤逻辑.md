# 列值过滤逻辑修复说明

## 问题描述

用户发现B类图书在豆瓣动态过滤后，候选数为0，但手动在Excel中筛选时应该有17条符合条件的数据（评分≥8.7，评论人数37-679）。

## 根本原因

**逻辑矛盾**：列值过滤器（检查"豆瓣封面图片链接"和"豆瓣内容简介"是否为空）被错误地放在了豆瓣模块的动态过滤阶段执行。

### 问题流程

```
1. 动态过滤阶段（基于评分和评论人数）
   ├─ 筛选出候选图书
   └─ ❌ 在这里检查封面和简介是否为空
      └─ 问题：此时还没有调用API，这些字段还没有数据！
   
2. 调用豆瓣 Subject API
   └─ 获取封面图片链接、内容简介等

结果：所有符合评分和评论人数条件的图书都被过滤掉了
```

### 实际测试结果

- B类图书总数: 185本
- 符合评分≥8.70且评论人数0-408的: 24本
- **通过列值验证的最终候选: 0本** ← 问题所在

原因：这24本图书的"豆瓣封面图片链接"和"豆瓣内容简介"字段都是空的（因为还没调用API）

## 修复方案

### 1. 从豆瓣模块移除列值过滤

**文件**: `src/core/douban/analytics/dynamic_threshold_filter.py`

**修改**: 注释掉第151-154行的列值过滤调用

```python
# 注意：列值验证已移至card_generator模块
# 此处不再进行列值过滤，因为在API调用前这些字段可能还没有数据
# 列值验证应该在获取完整豆瓣数据后，由card_generator模块执行

matched_indexes = candidate_mask[candidate_mask].index.tolist()
candidate_indexes.update(matched_indexes)
candidate_count = int(candidate_mask.sum())
```

### 2. 更新配置文件

**文件**: `config/setting.yaml`

**修改1**: 从豆瓣模块配置中移除 `column_filters`（第228-256行）

**修改2**: 将 `column_filters` 添加到 `card_generator.fields` 配置下（第565-595行）

```yaml
card_generator:
  fields:
    # ... 其他配置 ...
    
    # 列值验证过滤规则
    # 功能: 在生成卡片前检查Excel列值是否满足要求
    # 用途: 排除缺少关键信息(如封面图片、内容简介)的图书
    column_filters:
      enabled: true
      rules:
        - name: "豆瓣封面图片验证"
          enabled: true
          column: "豆瓣封面图片链接"
          filter_type: "not_empty"
          description: "排除没有封面图片的图书"
        
        - name: "豆瓣内容简介验证"
          enabled: true
          column: "豆瓣内容简介"
          filter_type: "not_empty"
          description: "排除没有内容简介的图书"
```

## 正确的流程

修复后的流程：

```
1. 动态过滤阶段（基于评分和评论人数）
   └─ 筛选出候选图书（标记为"待补API"）
   
2. 调用豆瓣 Subject API
   └─ 获取封面图片链接、内容简介等完整数据
   
3. card_generator模块
   ├─ ✓ 在这里检查封面和简介是否为空
   ├─ 过滤掉缺少关键信息的图书
   └─ 只为有完整数据的图书生成卡片
```

## 预期效果

修复后：

1. **豆瓣模块**：
   - B类符合评分和评论人数条件的24本图书会被标记为"待补API"
   - 这些图书会进入API调用阶段，获取完整的豆瓣数据

2. **card_generator模块**：
   - 在生成卡片前检查封面和简介
   - 只为有完整数据的图书生成卡片
   - 缺少封面或简介的图书会被跳过，并记录在失败日志中

## 注意事项

1. **✅ card_generator模块已实现列值验证逻辑**
   - 在 `DataValidator.__init__` 中读取 `column_filters` 配置
   - 在 `filter_passed_books` 方法后调用 `apply_column_filters`
   - 新增方法：
     - `apply_column_filters()` - 应用所有列值过滤规则
     - `_check_row_column_filters()` - 检查单行数据是否通过规则
     - `_check_not_empty()` - 检查值是否非空
     - `_check_regex()` - 检查值是否匹配正则表达式

2. **现有的 `BookCardData.validate()` 方法**
   - 已经检查"豆瓣封面图片链接"是否为空
   - 但不检查"豆瓣内容简介"
   - 可以保持现状，因为封面是必需的，简介可以作为可选项

## 修改文件清单

- [x] `src/core/douban/analytics/dynamic_threshold_filter.py` - 移除列值过滤调用
- [x] `config/setting.yaml` - 移动配置位置
- [x] `src/core/card_generator/validator.py` - 实现列值验证逻辑

## 测试建议

1. 重新运行豆瓣模块，检查B类候选数是否增加
2. 查看生成的统计报告，确认候选数不再为0
3. 运行card_generator模块，检查是否正确过滤缺少数据的图书
4. 查看日志输出，确认列值过滤逻辑正常工作
