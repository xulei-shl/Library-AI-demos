# 第三章 多层降噪筛选 - 模块3详解

## 模块3：新书零借阅筛选模块（对应大纲 3.3 睡美人唤醒机制）

### 1. "新书"的时间限定

#### 📅 新书定义与时间窗口
系统通过 [`ZeroBorrowingFilter`](src/core/new_sleeping/filter.py:14) 类实现新书零借阅筛选，但"新书"的定义主要依赖于数据源：

```python
# 零借阅筛选逻辑 (filter.py:21-39)
def filter_zero_borrowing_books(
    self, 
    new_books_df: pd.DataFrame,    # 新书验收数据
    borrowing_df: pd.DataFrame     # 近四月借阅数据
) -> Tuple[pd.DataFrame, pd.DataFrame, Dict[str, Any]]:
    """
    筛选零借阅图书
    逻辑：筛选出在新书数据中存在，但在借阅数据中不存在的图书
    """
```

#### 📊 数据来源说明
1. **新书验收数据**：来自 [`data/new/验收.xlsx`](data/new/验收.xlsx)
   - 包含图书馆新采购的图书信息
   - 时间范围由图书馆验收流程决定

2. **近四月借阅数据**：来自 [`data/new/近四月借阅.xlsx`](data/new/近四月借阅.xlsx)
   - 包含最近四个月的借阅记录
   - 用于验证新书是否被借阅过

#### 🔍 时间窗口实现
系统通过配置文件指定数据源路径，但时间窗口的精确控制依赖于数据本身：

```yaml
# config/setting.yaml (第11-14行)
excel_files:
  new_books_file: "data/new/验收.xlsx"        # 新书验收数据
  borrowing_4months_file: "data/new/近四月借阅.xlsx"  # 近四月借阅数据
```

### 2. 宽松评分阈值的定量描述

#### 📈 评分阈值对比
新书零借阅筛选采用更宽松的评分阈值，通过 [`NewSleepingRatingFilter`](src/core/new_sleeping/rating_filter.py:45) 实现：

```yaml
# config/setting.yaml (第549-563行)
category_min_scores:
  B: 8.2    # 哲学、宗教
  C: 7.5    # 社会科学总论
  D: 7.1    # 政治、法律
  E: 7.4    # 军事
  F: 7.1    # 经济
  G: 7.3    # 文化、科学、教育、体育
  H: 7.2    # 语言、文字
  I: 7.3    # 文学
  J: 7.7    # 艺术
  K: 8.0    # 历史、地理
  N: 7.6    # 自然科学总论
  S: 7.4    # 农业科学
  T: 7.6    # 工业技术
  default: 7.2  # 其他分类默认值
```

#### 🎯 宽松程度分析
与普通图书筛选相比，新书零借阅的评分阈值相对宽松：

1. **允许无评分书籍**：
   ```python
   # rating_filter.py:51
   "allow_no_rating": True,  # 允许无评分书籍成为候选
   ```

2. **LLM智能筛选**：对于无评分书籍，系统通过LLM进行智能评估，而非直接排除

3. **学科差异化**：不同学科采用不同的评分标准，体现学科特性

### 3. 无评分书籍的LLM提示词逻辑

#### 🤖 LLM评估维度
系统通过 [`prompts/无评分书籍筛选.md`](prompts/无评分书籍筛选.md) 定义了LLM评估的五个维度：

1. **书名吸引力**：书名是否有趣、有深度、有话题性
2. **内容简介质量**：简介是否清晰、有吸引力、能激发阅读兴趣
3. **作者知名度**：作者是否知名或有影响力(基于LLM知识库判断)
4. **出版社信誉**：是否来自知名、专业的出版社
5. **学科价值**：该学科领域是否需要更多推荐，是否有独特价值

#### 📊 评分规则
LLM采用80-100分的评分体系：

```markdown
# 评分规则 (无评分书籍筛选.md:15-18)
- **80-100分**: 强烈推荐,具有明显的阅读价值
- **60-79分**: 可以推荐,有一定价值
- **0-59分**: 不推荐,价值不明显
```

#### 🔄 三层判断逻辑
系统实现了复杂的三层判断逻辑（见 [`rating_filter.py:373-512`](src/core/new_sleeping/rating_filter.py:373)）：

1. **预筛选触发**：
   ```python
   # 无评分候选数 > pre_filter.trigger_threshold → 触发预筛选
   pre_filter_threshold = 100  # 默认阈值
   ```

2. **LLM筛选触发**：
   ```python
   # 预筛选后数量 > llm_trigger_threshold → 触发LLM筛选
   llm_trigger_threshold = 80  # 默认阈值
   ```

3. **批次处理**：
   ```python
   # 分批调用LLM，每批最多通过指定数量
   batch_size = 20
   pass_quota_per_batch = 5  # 每批次最多通过数量
   ```

### 4. "零借阅"状态的验证

#### 🔍 零借阅验证机制
系统通过精确的书目条码匹配验证零借阅状态：

```python
# 零借阅筛选核心逻辑 (filter.py:54-67)
# 统一条码类型，防止数字/字符串混用导致匹配异常
normalized_new_barcodes = self._normalize_barcode_series(new_books_df[self.barcode_column])
normalized_borrow_barcodes = self._normalize_barcode_series(borrowing_df[self.barcode_column])

# 获取借阅数据中的书目条码集合
borrowed_barcodes = set(normalized_borrow_barcodes.dropna().tolist())

# 筛选零借阅图书：在新书中但不在借阅数据中
zero_borrowing_mask = ~normalized_new_barcodes.isin(borrowed_barcodes)
```

#### 🛡️ 数据质量保障
系统实现了多层验证机制确保零借阅状态的准确性：

1. **条码标准化**：
   ```python
   # 条码标准化处理 (filter.py:94-115)
   def _normalize_barcode_series(self, barcode_series: pd.Series) -> pd.Series:
       normalized = barcode_series.astype('string')
       normalized = normalized.str.strip()
       normalized = normalized.replace({
           'nan': pd.NA,
           'NaN': pd.NA,
           'None': pd.NA,
           'NaT': pd.NA,
           '': pd.NA
       })
       return normalized
   ```

2. **无效条码处理**：
   ```python
   # 同时排除书目条码为空的记录
   valid_barcode_mask = normalized_new_barcodes.notna()
   zero_borrowing_mask = zero_borrowing_mask & valid_barcode_mask
   ```

3. **统计信息记录**：
   ```python
   # 详细统计信息 (filter.py:77-83)
   stats = {
       '原始新书数量': original_count,
       '零借阅图书数量': zero_count,
       '有借阅图书数量': borrowed_count,
       '无效条码数量': invalid_barcode_count,
       '零借阅比例': f"{zero_count / original_count * 100:.2f}%"
   }
   ```

#### 📋 验证逻辑说明
1. **精确匹配**：基于书目条码进行精确匹配，避免误判
2. **时间窗口**：使用近四个月的借阅数据，确保足够的验证期
3. **数据清洗**：标准化处理条码数据，确保匹配准确性
4. **异常处理**：处理无效条码，避免数据质量问题

---

## 技术实现亮点

### 🎯 智能筛选机制
- **多维度评估**：从书名、内容、作者、出版社等多角度评估无评分书籍
- **分层筛选**：通过预筛选和LLM筛选的组合，提高筛选效率
- **批次处理**：支持大规模数据的分批处理，避免LLM调用限制

### 📊 数据质量保障
- **条码标准化**：确保匹配的准确性
- **多层验证**：从数据输入到结果输出的全流程验证
- **详细统计**：提供完整的筛选统计信息

### 🔧 灵活配置
- **评分阈值可配置**：不同学科采用不同的评分标准
- **筛选参数可调整**：支持根据实际情况调整筛选参数
- **LLM提示词可优化**：可根据需求调整评估维度和标准

---

## 总结

新书零借阅筛选模块通过精确的零借阅验证、宽松的评分阈值和智能的LLM评估，实现了对"睡美人"图书的有效识别和筛选。该模块的设计体现了"精准唤醒"的理念，通过多维度评估和智能筛选，确保那些被忽视但具有价值的新书能够重新进入推荐流程。

系统的三层判断逻辑和批次处理机制，既保证了筛选的准确性，又提高了处理效率，为图书馆发现优质新书提供了强有力的技术支持。