# 第三章 多层降噪筛选 - 模块1详解

## 模块1：借阅统计分析模块（对应大纲 3.1 借阅行为分析）

### 1. "常温"与"降温"的定量定义

通过对代码的深入分析，发现系统并未明确定义"常温书"与"降温书"的概念，而是通过以下统计指标来描述图书的借阅行为模式：

#### 📊 借阅统计指标
系统通过 [`BorrowingStatisticsCorrected`](src/core/statistics.py:21) 类计算每本书在近三个月内的借阅数据：

```python
# 统计指标（见 statistics.py:26-32）
new_columns = [
    '近三个月总次数',    # 总借阅次数
    '第一个月借阅次数',  # 第一个月借阅次数
    '第二个月借阅次数',  # 第二个月借阅次数
    '第三个月借阅次数',  # 第三个月借阅次数
    '借阅人数'          # 唯一借阅用户数
]
```

#### 📈 时间窗口计算
系统通过 [`TimeUtils.get_recent_three_months_from_config()`](src/utils/time_utils.py:117) 计算近三个月的时间范围：

- **配置驱动**：通过 [`config/setting.yaml`](config/setting.yaml:21) 中的 `target_month` 参数指定目标月份
- **动态计算**：基于目标月份自动计算前三个月的时间范围
- **灵活性**：可通过修改配置文件调整统计时间窗口

#### 🎯 借阅趋势分析
虽然没有明确的"常温"与"降温"定义，但可以通过三个月的借阅次数变化趋势来分析：

1. **稳定型**：三个月借阅次数相对稳定（如 5-5-6）
2. **上升型**：借阅次数逐月增加（如 2-4-8）
3. **下降型**：借阅次数逐月减少（如 8-4-2）
4. **波动型**：借阅次数不规则波动（如 3-7-2）

### 2. 唯一借阅人数的去重细节

#### 🔍 精确去重算法
系统采用 [`groupby()`](src/core/statistics.py:199) 方法进行精确的用户去重：

```python
# 使用groupby一次性计算所有索书号的借阅人数
borrowers_count = borrowing_data.groupby(cleaned_call_column)[user_id_column].nunique().to_dict()
```

#### ⚙️ 异常情况处理
代码中考虑了多种异常情况：

1. **同一读者同日多次借还**：
   - 系统通过 `nunique()` 方法自动去重，确保同一读者只计算一次
   - 不区分借阅和续借行为，均计入借阅统计

2. **用户标识列缺失**：
   - 系统会自动尝试多种可能的用户标识列名（见 [`statistics.py:143-155`](src/core/statistics.py:143)）
   - 如果找不到用户标识列，会创建虚拟用户ID进行统计

3. **数据清洗**：
   - 系统会过滤掉索书号为空的记录（见 [`statistics.py:159`](src/core/statistics.py:159)）
   - 支持使用清理后的索书号进行匹配（见 [`statistics.py:133-138`](src/core/statistics.py:133)）

### 3. 统计时间窗口的灵活性

#### 📅 配置化时间窗口
系统的时间窗口设计具有高度的灵活性：

1. **基于配置的动态调整**：
   ```yaml
   # config/setting.yaml (第18-26行)
   statistics:
     target_month: "2025-11"  # 可指定任意月份
     month_calculation:
       use_target_month_previous: false  # 可切换计算模式
   ```

2. **多种计算模式**：
   - **当前时间模式**：基于当前时间计算近三个月
   - **指定月份模式**：基于配置的目标月份计算
   - **上个月模式**：基于目标月份的上个月计算

3. **自动月份边界处理**：
   - 系统自动处理跨年的月份计算（见 [`time_utils.py:90-99`](src/utils/time_utils.py:90)）
   - 正确计算每个月的天数，确保统计准确性

#### 🔄 实时调整能力
系统支持运行时动态调整时间窗口，无需修改代码：
- 只需修改配置文件中的 `target_month` 参数
- 系统会自动重新计算时间范围和统计数据

---

## 技术实现亮点

### 🚀 性能优化
1. **批量处理**：使用 `groupby()` 替代逐行搜索，大幅提升统计效率
2. **内存优化**：预先过滤有效数据，减少内存占用
3. **并发友好**：支持大规模数据集的快速处理

### 🛡️ 数据质量保障
1. **多层数据验证**：检查必需列、处理空值、标准化数据格式
2. **智能列名匹配**：自动识别不同数据源中的等效列名
3. **详细日志记录**：提供完整的处理过程日志，便于问题排查

### 📊 统计分析能力
1. **多维度统计**：不仅统计借阅次数，还计算借阅人数
2. **时间序列分析**：提供三个月的借阅趋势数据
3. **灵活的时间窗口**：支持多种时间范围计算模式

---

## 总结

借阅统计分析模块通过精确的统计算法和灵活的配置机制，为后续的降噪筛选提供了高质量的基础数据。虽然没有明确定义"常温书"与"降温书"，但通过三个月的借阅次数和借阅人数统计，系统可以准确识别不同借阅行为模式的图书，为智能推荐奠定数据基础。

该模块的设计体现了"数据驱动"的理念，通过配置化的时间窗口和精确的去重算法，确保了统计结果的准确性和灵活性，为整个图书推荐系统提供了可靠的数据支撑。