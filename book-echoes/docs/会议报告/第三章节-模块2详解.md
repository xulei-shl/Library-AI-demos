# ç¬¬ä¸‰ç«  å¤šå±‚é™å™ªç­›é€‰ - æ¨¡å—2è¯¦è§£

## æ¨¡å—2ï¼šæ™ºèƒ½é™å™ªç­›é€‰æ¨¡å—ï¼ˆå¯¹åº”å¤§çº² 3.2 åŠ¨æ€é™å™ªç­–ç•¥ï¼‰

### 1. åŠ¨æ€åˆ†ä½æ•°ç®—æ³•å®ç°

#### ğŸ“Š çƒ­é—¨ä¹¦æ’é™¤ç®—æ³•
ç³»ç»Ÿé€šè¿‡ [`HotBooksFilter`](src/core/filters/hot_books_filter.py:14) ç±»å®ç°åŠ¨æ€åˆ†ä½æ•°ç®—æ³•ï¼š

```python
# æ ¸å¿ƒç®—æ³•å®ç° (hot_books_filter.py:52-82)
def _calculate_dynamic_threshold(self, borrowing_counts: pd.Series) -> int:
    # è·å–éé›¶å€Ÿé˜…æ¬¡æ•°
    non_zero_data = borrowing_counts[borrowing_counts > 0]
    
    if len(non_zero_data) == 0:
        fallback_count = self.config['methods']['percentile']['fallback_count']
        return fallback_count
    
    # åˆ†ä½æ•°æ–¹æ³•
    if self.config['methods']['percentile']['enabled']:
        percentile = self.config['methods']['percentile']['threshold_percentile']
        threshold = np.percentile(non_zero_data, 100 - percentile)
        
        # å¦‚æœåˆ†ä½æ•°ç»“æœè¿‡å°ï¼Œä½¿ç”¨75%åˆ†ä½æ•°
        if threshold < 5:
            threshold = np.percentile(non_zero_data, 75)
        
        return int(threshold)
```

#### ğŸ¯ é…ç½®å‚æ•°è¯¦è§£
ç³»ç»Ÿé€šè¿‡ [`config/setting.yaml`](config/setting.yaml:33-51) æä¾›çµæ´»çš„é…ç½®é€‰é¡¹ï¼š

```yaml
rule_a:
  enabled: true
  target_column: "è¿‘å››ä¸ªæœˆæ€»æ¬¡æ•°"
  methods:
    percentile:
      enabled: true
      threshold_percentile: 15  # æ’é™¤å‰15%æœ€é«˜å€Ÿé˜…æ¬¡æ•°çš„å›¾ä¹¦
      fallback_count: 20        # åå¤‡æ–¹æ¡ˆï¼šå½“æ•°æ®å…¨ä¸º0æ—¶ï¼Œä½¿ç”¨å›ºå®šé˜ˆå€¼20æ¬¡
    absolute_count:
      enabled: false
      threshold_borrowing_count: 20
```

#### ğŸ“ˆ è®¡ç®—èŒƒå›´è¯´æ˜
- **å…¨åº“è®¡ç®—**ï¼šç³»ç»Ÿå¯¹æ•´ä¸ªæ•°æ®é›†è¿›è¡Œåˆ†ä½æ•°è®¡ç®—ï¼Œè€ŒéæŒ‰åˆ†ç±»åˆ†åˆ«è®¡ç®—
- **è‡ªé€‚åº”é˜ˆå€¼**ï¼šæ ¹æ®æ•°æ®åˆ†å¸ƒåŠ¨æ€è°ƒæ•´ï¼Œç¡®ä¿ä¸åŒæ•°æ®é‡ä¸‹çš„ç­›é€‰æ•ˆæœä¸€è‡´
- **åå¤‡æœºåˆ¶**ï¼šå½“æ•°æ®å…¨ä¸º0æˆ–åˆ†ä½æ•°ç»“æœè¿‡å°æ—¶ï¼Œè‡ªåŠ¨ä½¿ç”¨åå¤‡é˜ˆå€¼

### 2. æ­£åˆ™è¡¨è¾¾å¼çš„å…·ä½“è¿‡æ»¤æ¸…å•

#### ğŸ“š é¢˜åå…³é”®è¯è¿‡æ»¤
ç³»ç»Ÿé€šè¿‡ [`config/filters/title_keywords.txt`](config/filters/title_keywords.txt) æ–‡ä»¶å®šä¹‰äº†397ä¸ªè¿‡æ»¤å…³é”®è¯ï¼Œæ¶µç›–å¤šä¸ªç±»åˆ«ï¼š

1. **æŠ€æœ¯ç±»**ï¼ˆç¬¬5-49è¡Œï¼‰ï¼š
   - ç¼–ç¨‹è¯­è¨€ï¼š`Python`, `Java`, `JavaScript`, `C++`ç­‰
   - æŠ€æœ¯æ¡†æ¶ï¼š`PyTorch`, `Django`, `Spring`ç­‰
   - è½¯ä»¶åº”ç”¨ï¼š`Photoshop`, `Excel`, `PPT`ç­‰

2. **æ•™è¾…ç±»**ï¼ˆç¬¬50-80è¡Œï¼‰ï¼š
   - è€ƒè¯•ç›¸å…³ï¼š`è€ƒè¯•`, `æ•™ç¨‹`, `æ•™æ`, `ä¹ é¢˜`, `ç­”æ¡ˆ`ç­‰
   - æ•™è‚²é˜¶æ®µï¼š`å°å­¦`, `åˆä¸­`, `é«˜ä¸­`, `è€ƒç ”`, `é›…æ€`ç­‰

3. **ä¸“ä¸šå·¥å…·ç±»**ï¼ˆç¬¬212-292è¡Œï¼‰ï¼š
   - å‚è€ƒå·¥å…·ï¼š`èµ„æ–™æ±‡ç¼–`, `å¹´é‰´`, `è¯å…¸`, `å­—å…¸`ç­‰
   - å®ç”¨æ‰‹å†Œï¼š`ç”¨æˆ·æ‰‹å†Œ`, `å…¥é—¨æ‰‹å†Œ`, `å®éªŒæŒ‡å¯¼`ç­‰

4. **çº¢è‰²ä¸»é¢˜ç±»**ï¼ˆç¬¬293-310è¡Œï¼‰ï¼š
   - æ”¿æ²»ç›¸å…³ï¼š`å…šå‘˜`, `å¹²éƒ¨`, `çº¢å†›`, `ä¸€å¸¦ä¸€è·¯`ç­‰
   - å…šå»ºå†…å®¹ï¼š`å…šå»º`, `å…šç»„ç»‡`, `é©¬å…‹æ€ä¸»ä¹‰`ç­‰

#### ğŸ·ï¸ ç´¢ä¹¦å·/CLCå·è¿‡æ»¤
ç³»ç»Ÿé€šè¿‡ [`config/filters/call_number_clc.txt`](config/filters/call_number_clc.txt) æ–‡ä»¶å®šä¹‰äº†å¤æ‚çš„ç´¢ä¹¦å·è¿‡æ»¤è§„åˆ™ï¼š

1. **é«˜ä¼˜å…ˆçº§æ’é™¤è§„åˆ™**ï¼š
   ```
   DROP! .*[#*].*  # è¿‡æ»¤åŒ…å«#æˆ–*çš„è®°å½•
   ```

2. **ä¿ç•™è§„åˆ™**ï¼ˆKEEPï¼‰ï¼š
   - ç‰¹å®šåˆ†ç±»æ®µä¿ç•™ï¼šå¦‚ `^D[0-1](?!35).*`, `^F11.*` ç­‰
   - ç‰¹å®šå°¾æ®µä¿ç•™ï¼šå¦‚ `.*?(?:-64|-49|-0\d)\d*(?=.*\/).*(?=\/)`

3. **æ™®é€šæ’é™¤è§„åˆ™**ï¼ˆDROPï¼‰ï¼š
   - å¤§ç±»æ’é™¤ï¼š`DROP ^A.*`, `DROP ^C[5-8].*` ç­‰
   - ç‰¹å®šæ¨¡å¼æ’é™¤ï¼š`DROP ^TS1.*`, `DROP ^T(?!P18|S(?!1))).*` ç­‰

#### ğŸ”§ è¿‡æ»¤å™¨å®ç°
ç³»ç»Ÿé€šè¿‡ [`TitleKeywordsFilter`](src/core/filters/title_keywords_filter.py) å’Œ [`CallNumberFilter`](src/core/filters/call_number_filter.py) å®ç°è¿™äº›è¿‡æ»¤è§„åˆ™ï¼š

```python
# åŒ¹é…ç±»å‹æ”¯æŒ
match_types = ["contains", "starts_with", "ends_with", "regex"]

# ä¼˜å…ˆçº§å¤„ç†
# DROP! > KEEP > DROP
```

### 3. ä¸šåŠ¡æŸ¥é‡é€»è¾‘

#### ğŸ” æ•°æ®åº“æŸ¥é‡æœºåˆ¶
ç³»ç»Ÿé€šè¿‡ [`DbDuplicateFilter`](src/core/filters/db_duplicate_filter.py) å®ç°ä¸šåŠ¡æŸ¥é‡ï¼š

```yaml
# config/setting.yaml (ç¬¬91-103è¡Œ)
rule_db_duplicate:
  enabled: true
  description: "æ•°æ®åº“æŸ¥é‡-è¿‡æ»¤å·²å…¥é€‰ä¹¦ç›®"
  target_column: "ä¹¦ç›®æ¡ç "
  db_table: "recommendation_results"
  db_column: "barcode"
  filter_condition:
    column: "manual_selection"
    value: "é€šè¿‡"
```

#### ğŸ“‹ æŸ¥é‡é€»è¾‘è¯¦è§£
1. **æŸ¥é‡å­—æ®µ**ï¼šåŸºäº `ä¹¦ç›®æ¡ç ` è¿›è¡Œç²¾ç¡®åŒ¹é…
2. **æŸ¥é‡èŒƒå›´**ï¼šæŸ¥è¯¢ `recommendation_results` è¡¨
3. **æŸ¥é‡æ¡ä»¶**ï¼šç­›é€‰ `manual_selection='é€šè¿‡'` çš„è®°å½•
4. **æŸ¥é‡æ–¹å¼**ï¼šç²¾ç¡®åŒ¹é…ï¼Œéæ¨¡ç³ŠåŒ¹é…

#### ğŸ¯ æŸ¥é‡ä¼˜åŠ¿
- **é¿å…é‡å¤æ¨è**ï¼šç¡®ä¿å·²å…¥é€‰çš„å›¾ä¹¦ä¸ä¼šå†æ¬¡è¿›å…¥æ¨èæµç¨‹
- **ä¿æŒæ¨èæ–°é²œåº¦**ï¼šæ¯æ¬¡æ¨èéƒ½æ˜¯æ–°çš„å€™é€‰å›¾ä¹¦
- **æé«˜è¯„é€‰æ•ˆç‡**ï¼šå‡å°‘é‡å¤å¤„ç†çš„å·¥ä½œé‡

### 4. æ™ºèƒ½è¿‡æ»¤åŸå› è¿½è¸ª

#### ğŸ“ è¿‡æ»¤åŸå› ç”Ÿæˆæœºåˆ¶
ç³»ç»Ÿé€šè¿‡ [`_get_filter_reason_description()`](src/core/data_filter.py:102) æ–¹æ³•æ™ºèƒ½ç”Ÿæˆè¿‡æ»¤åŸå› ï¼š

```python
# è¿‡æ»¤åŸå› ç”Ÿæˆé€»è¾‘ (data_filter.py:102-120)
def _get_filter_reason_description(self, filter_name: str, filter_result: Dict[str, Any], filter_instance) -> str:
    # 1. ä¼˜å…ˆä½¿ç”¨é…ç½®ä¸­çš„æè¿°
    config_description = filter_result.get('description') or getattr(filter_instance, 'description', '')
    if config_description:
        return self._enhance_description(config_description, filter_name, filter_result, filter_instance)
    
    # 2. å¦‚æœæ²¡æœ‰é…ç½®æè¿°ï¼Œä½¿ç”¨æ™ºèƒ½æ¨æ–­
    return self._infer_description(filter_name, filter_result, filter_instance)
```

#### ğŸ·ï¸ è¿‡æ»¤åŸå› åˆ†ç±»
ç³»ç»Ÿä¸ºä¸åŒç±»å‹çš„è¿‡æ»¤å™¨ç”Ÿæˆç›¸åº”çš„è¿‡æ»¤åŸå› ï¼š

1. **çƒ­é—¨ä¹¦è¿‡æ»¤**ï¼š
   ```
   "çƒ­é—¨ä¹¦æ’é™¤ï¼ˆå€Ÿé˜…â‰¥Næ¬¡ï¼‰" æˆ– "çƒ­é—¨ä¹¦æ’é™¤ï¼ˆåŠ¨æ€é˜ˆå€¼ï¼‰"
   ```

2. **é¢˜åå…³é”®è¯è¿‡æ»¤**ï¼š
   ```
   "é¢˜åå…³é”®è¯æ’é™¤ï¼ˆNä¸ªå…³é”®è¯ï¼‰"
   ```

3. **ç´¢ä¹¦å·è¿‡æ»¤**ï¼š
   ```
   "ç´¢ä¹¦å·/CLCå·æ¨¡å¼æ’é™¤ï¼ˆNä¸ªæ¨¡å¼ï¼‰"
   ```

4. **åˆ—å€¼è¿‡æ»¤**ï¼š
   ```
   "é™„åŠ ä¿¡æ¯9ä½æ•°å­—æ ¼å¼æ ¡éªŒ" æˆ– "å¤‡æ³¨åˆ—æ’é™¤æŒ‡å®šå…³é”®è¯"
   ```

#### ğŸ“Š è¿‡æ»¤åŸå› å­˜å‚¨
ç³»ç»Ÿé€šè¿‡ [`exclusion_reasons`](src/core/data_filter.py:292) å­—å…¸è®°å½•æ¯æ¡è®°å½•çš„è¿‡æ»¤åŸå› ï¼š

```python
# è®°å½•æ¯æ¡è®°å½•è¢«è¿‡æ»¤çš„åŸå› ï¼š{ç´¢å¼•: è¿‡æ»¤åŸå› åˆ—è¡¨}
exclusion_reasons = {}

# ä¸ºè¢«æ’é™¤çš„è®°å½•æ·»åŠ è¿‡æ»¤åŸå› 
for index in excluded_indices:
    if index not in exclusion_reasons:
        exclusion_reasons[index] = []
    exclusion_reasons[index].append(filter_reason)

# æ·»åŠ åˆ°è¢«è¿‡æ»¤æ•°æ®ä¸­
excluded_data['è¿‡æ»¤åŸå› '] = excluded_data.index.map(
    lambda idx: ' | '.join(exclusion_reasons.get(idx, ['æœªçŸ¥åŸå› ']))
)
```

#### ğŸ“ˆ è¿‡æ»¤ç»Ÿè®¡æŠ¥å‘Š
ç³»ç»Ÿç”Ÿæˆè¯¦ç»†çš„è¿‡æ»¤ç»Ÿè®¡æŠ¥å‘Šï¼ŒåŒ…æ‹¬ï¼š

```python
# è¿‡æ»¤ç»Ÿè®¡ä¿¡æ¯ (data_filter.py:345-353)
summary = {
    'original_count': len(original_data),
    'filtered_count': len(result_data),
    'excluded_count': len(excluded_data),
    'total_excluded': total_excluded,
    'exclusion_ratio': len(excluded_data) / len(original_data),
    'filter_results': self.filter_results,
    'exclusion_reasons': exclusion_reasons
}
```

---

## æŠ€æœ¯å®ç°äº®ç‚¹

### ğŸ¯ åŠ¨æ€é˜ˆå€¼ç®—æ³•
- **è‡ªé€‚åº”æ€§å¼º**ï¼šæ ¹æ®æ•°æ®åˆ†å¸ƒè‡ªåŠ¨è°ƒæ•´é˜ˆå€¼
- **åå¤‡æœºåˆ¶å®Œå–„**ï¼šå¤„ç†å¼‚å¸¸æ•°æ®æƒ…å†µ
- **é…ç½®çµæ´»**ï¼šæ”¯æŒå¤šç§é˜ˆå€¼è®¡ç®—æ–¹æ³•

### ğŸ” æ™ºèƒ½è¿‡æ»¤ç³»ç»Ÿ
- **å¤šå±‚æ¬¡è¿‡æ»¤**ï¼šä»çƒ­é—¨ä¹¦åˆ°å†…å®¹ç±»å‹çš„å…¨æ–¹ä½è¿‡æ»¤
- **è§„åˆ™å¯é…ç½®**ï¼šé€šè¿‡é…ç½®æ–‡ä»¶çµæ´»è°ƒæ•´è¿‡æ»¤è§„åˆ™
- **åŸå› å¯è¿½æº¯**ï¼šè¯¦ç»†è®°å½•æ¯æ¡è®°å½•çš„è¿‡æ»¤åŸå› 

### ğŸ“Š æ•°æ®è´¨é‡ä¿éšœ
- **æŸ¥é‡æœºåˆ¶**ï¼šé¿å…é‡å¤æ¨èå·²å…¥é€‰å›¾ä¹¦
- **ç»Ÿè®¡å®Œå–„**ï¼šæä¾›è¯¦ç»†çš„è¿‡æ»¤ç»Ÿè®¡ä¿¡æ¯
- **æ—¥å¿—è¯¦ç»†**ï¼šè®°å½•å®Œæ•´çš„è¿‡æ»¤è¿‡ç¨‹

---

## æ€»ç»“

æ™ºèƒ½é™å™ªç­›é€‰æ¨¡å—é€šè¿‡åŠ¨æ€åˆ†ä½æ•°ç®—æ³•ã€å¤šå±‚æ¬¡è¿‡æ»¤è§„åˆ™å’Œæ™ºèƒ½åŸå› è¿½è¸ªæœºåˆ¶ï¼Œå®ç°äº†ç²¾å‡†çš„å›¾ä¹¦ç­›é€‰ã€‚è¯¥æ¨¡å—çš„è®¾è®¡ä½“ç°äº†"æ™ºèƒ½é™å™ª"çš„ç†å¿µï¼Œé€šè¿‡æ’é™¤çƒ­é—¨ä¹¦ã€ç‰¹å®šç±»å‹å›¾ä¹¦å’Œå·²æ¨èå›¾ä¹¦ï¼Œç¡®ä¿åç»­å¤„ç†çš„æ•°æ®æ›´åŠ ç²¾å‡†å’Œæœ‰ä»·å€¼ã€‚

ç³»ç»Ÿçš„é«˜åº¦é…ç½®åŒ–å’Œæ¨¡å—åŒ–è®¾è®¡ï¼Œä½¿å¾—è¿‡æ»¤è§„åˆ™å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚çµæ´»è°ƒæ•´ï¼ŒåŒæ—¶è¯¦ç»†çš„è¿‡æ»¤åŸå› è®°å½•å’Œç»Ÿè®¡æŠ¥å‘Šï¼Œä¸ºç³»ç»Ÿçš„ä¼˜åŒ–å’Œæ”¹è¿›æä¾›äº†æ•°æ®æ”¯æŒã€‚