# 第四章节模块1详解：借阅统计分析与图书评选算法

## 概述

本文档详细分析了"书海回响"项目中AI驱动的深度评选与知识发现模块的核心算法实现，特别是三阶段评选流程、配额自适应算法以及LLM提示词策略。这些技术共同构成了系统的"智慧采金"流程，从海量图书中发掘出真正的"智慧遗珠"。

---

## 🏆 锦标赛模式的具体规则

### 三阶段评选流程

系统采用精心设计的三阶段评选流程，每一阶段都有明确的筛选比例和打分阈值设置：

#### 1. 初评阶段（海选）

**筛选规则**：
- 根据主题内书籍数量动态设置推荐配额
- 配额算法（在 `src/core/recommendation/config.py` 中实现）：
  ```python
  def recommend_quota(group_size: int) -> int:
      if group_size > 20: return 6      # 超过20本推荐6本
      if 15 <= group_size <= 20: return 5  # 15-20本推荐5本
      if 10 <= group_size < 15: return 4   # 10-15本推荐4本
      if 5 <= group_size < 10: return 3    # 5-10本推荐3本
      return 2                             # 少于5本推荐2本
  ```

**技术实现**：
- 批次大小：默认20本/批（可通过 `config/llm.yaml` 中的 `max_batch_size` 调整）
- 温度参数：0.45（确保一定创造性同时保持一致性）
- 评分标准：1-5分，可包含一位小数

#### 2. 主题内决选阶段（晋级赛）

**筛选规则**：
- 每个主题最多晋级8本书（可通过配置调整）
- 自动晋级机制：主题内书籍≤8本时，全部自动晋级
- 决选机制：主题内书籍>8本时，调用LLM进行决选

**技术实现**：
```python
# 在 src/core/recommendation/controller.py 中
if theme_count <= quota:
    # 自动晋级，不调用LLM
    logger.info("主题 [%s]: %d 本 <= 配额 %d,自动晋级", theme, theme_count, quota)
    for _, row in gdf.iterrows():
        writer.df.at[idx, "主题内决选结果"] = "自动晋级"
else:
    # 需要决选，调用LLM
    result = executor.runoff(theme, books, quota)
```

#### 3. 终评阶段（决赛圈）

**筛选规则**：
- 目标推荐数量：默认20本（可通过配置调整）
- 自适应批次处理：
  - ≤30本：直接终评
  - >30本：触发海选+终评的锦标赛模式

**锦标赛模式实现**：
```python
# 在 src/core/recommendation/controller.py 的 run_adaptive_final 函数中
if total_candidates <= max_batch_size:
    # 直接终评
    result = executor.final(finalists, top_n)
else:
    # 海选 + 终评
    num_batches = (total_candidates + max_batch_size - 1) // max_batch_size
    quota_per_batch = max_batch_size // num_batches
    # 执行海选...
    # 执行终评...
```

---

## ⚖️ 配额自适应算法 (Quota Adaptive Algorithm)

### 算法设计理念

配额自适应算法旨在确保推荐结果不会过度集中在某一类热门图书上，同时保证各主题都有公平的展示机会。该算法在多个层面实现了动态平衡：

### 1. 主题内配额自适应

**实现位置**：`src/core/recommendation/config.py`

```python
def recommend_quota(group_size: int) -> int:
    quota_cfg = _get_quota_config()
    if group_size > 20:
        return quota_cfg["gt20"]      # 默认6本
    if 15 <= group_size <= 20:
        return quota_cfg["g15_20"]    # 默认5本
    if 10 <= group_size < 15:
        return quota_cfg["g10_15"]    # 默认4本
    if 5 <= group_size < 10:
        return quota_cfg["g5_10"]     # 默认3本
    return quota_cfg["lt5"]           # 默认2本
```

**算法特点**：
- 根据主题内书籍数量动态调整推荐配额
- 避免大主题垄断推荐名额
- 保证小主题也有合理曝光机会

### 2. 主题间平衡机制

**实现位置**：`src/core/recommendation/controller.py` 的 `run_theme_runoff` 函数

```python
# 每个主题最多晋级8本进入终评
quota = get_theme_finalist_quota()  # 默认8本

# 确保各主题都有代表进入终评
for theme, gdf in groups.items():
    theme_count = len(gdf)
    if theme_count <= quota:
        # 自动晋级，保证小主题有代表
        for _, row in gdf.iterrows():
            writer.df.at[idx, "主题内决选结果"] = "自动晋级"
    else:
        # 大主题进行决选，控制晋级数量
        result = executor.runoff(theme, books, quota)
```

### 3. 终评全局平衡

**实现位置**：`src/core/recommendation/controller.py` 的 `run_adaptive_final` 函数

```python
# 动态调整批次大小，避免海选过于激烈
if total_candidates > 100:
    max_batch_size = max(max_batch_size, 50)
elif total_candidates > 200:
    max_batch_size = max(max_batch_size, 80)

# 计算每批晋级名额，确保总晋级数可控
num_batches = (total_candidates + max_batch_size - 1) // max_batch_size
quota_per_batch = max_batch_size // num_batches
quota_per_batch = max(quota_per_batch, 1)  # 至少选1本
```

### 4. 配置化灵活性

所有配额参数都可通过 `config/llm.yaml` 动态调整：

```yaml
tasks:
  theme_initial:
    parameters:
      recommend_quota:
        gt20: 6    # 可动态调整
        g15_20: 5  # 可动态调整
        g10_15: 4  # 可动态调整
        g5_10: 3   # 可动态调整
        lt5: 2     # 可动态调整
  theme_runoff:
    parameters:
      finalist_quota: 8  # 每主题最多晋级8本
  theme_final:
    parameters:
      top_n: 20          # 最终推荐20本
      max_batch_size: 30  # 批次大小上限
```

---

## 🧠 LLM 提示词 (Prompt) 策略

### 人文关怀与智慧遗珠的体现

系统的LLM提示词策略精心设计，旨在发掘那些具有深度价值和人文关怀的"智慧遗珠"。以下是在三个阶段中的关键引导语：

### 1. 初评阶段：发掘潜在价值

**角色定位**（来自 `prompts/书目初评.md`）：
```
你是一位博学、敏锐且深具人文关怀的图书策展人，你的MBTI人格类型是 INFJ。
```

**核心筛选标准**：
1. **愉悦身心**：能带来美的享受、情感的慰藉或内心的平静。看重情感的深度与共鸣、语言的韵律与美感、对生活美学的细腻洞察与呈现、叙事带来的沉浸式体验，以及作品能否提供精神上的慰藉与情感上的净化（Catharsis）。

2. **开阔眼界**：能提供新的视角、跨文化的理解或不同的人生体验。看重能否提供超越个人经验的"他者"视角，促进对不同文化、群体和价值观的共情式理解，并揭示人类经验的共通性与多样性。

3. **激发思维**：能挑战固有观念、引发深度思考或点燃创造力。看重思想的原创性、逻辑的严谨性与论证的勇气。尤其偏爱那些能够挑战思维定式、揭示复杂系统背后隐藏逻辑，或引导读者进行深刻自我反思与道德辨析的作品。

4. **了解新知**：能以通俗易懂的方式介绍某个领域的知识或前沿思想。看重知识的系统性与启发性，以及作者能否将复杂概念转化为清晰、优美的叙述。

### 2. 主题内决选阶段：识别代表性作品

**特别关注点**（来自 `prompts/书目主题内决选.md`）：
```
1. 主题代表性：这本书是否是其所在主题领域的杰出代表？它是否能精准地展现该领域的深度、广度或前沿动态？
2. 内在价值的卓越性：在初评标准的基础上，这本书是否在某个维度上表现得尤为突出，足以在同主题书籍中脱颖而出？
3. 内容的独特性与不可替代性：在这个主题内，这本书是否提供了独特的视角、稀缺的知识或难以替代的阅读体验？
```

### 3. 终评阶段：发现真正的"智慧遗珠"

**遗珠识别标准**（来自 `prompts/书目终评.md`）：
```
1. 卓越的内在价值：它是否在"愉悦身心、开阔眼界、激发思维、了解新知"的某一个或多个维度上达到了卓越而非仅仅是优秀的水平？
2. 独特的视角与稀缺性：在这个已经很出色的书单里，这本书是否提供了不可替代的视角或稀缺的智慧？它是不是一个真正的"遗珠"？
3. 深远的影响力：这本书是否具有足够的力量，能够长久地留在读者的思想和情感中，甚至可能改变他们看待世界的方式？
```

### 4. 评语撰写策略：New Yorker 范式

系统采用独特的评语撰写风格，确保推荐理由既深刻又富有感染力：

**直击本质**：
- 直接定义这本书是什么，或者它做了什么
- 示例："作者将枯燥的档案编织成了一张紧密的叙事网，让19世纪的伦敦在读者眼前潮湿地呼吸。"

**感官与隐喻**：
- 调动INFJ的通感能力，用物理质感、空间结构或化学反应来形容阅读体验
- 示例："阅读此书如同在暴风雨夜饮一杯热朗姆酒，辛辣、温暖且带有某种危险的安抚感。"

**情境化钩子**：
- 将书籍置于更广阔的人类经验或当代焦虑中
- 示例："在算法试图预测我们每一个念头的时代，这本书提供了一份关于'不可预测性'的优雅辩护。"

**微观聚焦**：
- 从一个具体的细节、一个奇怪的论点或一种独特的叙事语调切入
- 示例："作者对真菌菌丝体的痴迷，意外地为我们理解人类社会的互联性提供了一套全新的词汇。"

---

## 🔍 技术创新点

### 1. 多阶段漏斗式筛选

三阶段评选流程形成了一个精心设计的漏斗，从粗到细逐步筛选：
- **初评**：广泛发掘潜在价值
- **决选**：确保主题代表性
- **终评**：全局平衡与最终精选

### 2. 动态配额自适应

系统根据数据分布动态调整各阶段配额：
- 主题内根据书籍数量自适应
- 主题间通过固定配额保证平衡
- 终评阶段通过批次控制确保质量

### 3. 人文AI融合

提示词策略巧妙融合了人文关怀与AI能力：
- INFJ人格设定增强人文洞察
- 多维度评价标准确保全面性
- 独特评语风格提升感染力

### 4. 容错与重试机制

系统实现了完善的容错机制：
```python
def _retry_failed_reviews(excel_path: str, executor, writer) -> int:
    """兜底重试：处理所有失败的初评数据"""
    # 识别失败数据
    # 按主题分组重试
    # 记录重试统计
```

---

## 📊 实际应用效果

### 1. 主题分布平衡

通过配额自适应算法，系统能够确保：
- 各大主题（如文学、历史、科技等）都有合理代表
- 小众主题不会被热门主题完全淹没
- 最终书单呈现多元化、均衡化的特点

### 2. 质量与多样性兼顾

三阶段评选流程既保证了：
- 每本书都经过严格的质量筛选
- 不同主题、不同风格的优秀作品都有机会
- 最终推荐既有深度又有广度

### 3. 人文价值凸显

通过精心设计的提示词策略：
- 能够发掘那些被市场忽视的"智慧遗珠"
- 重视图书的人文关怀和社会价值
- 推荐理由富有感染力和洞察力

---

## 🔮 未来优化方向

### 1. 动态权重调整

未来可以考虑根据图书馆特点和使用者反馈，动态调整各评价维度的权重：
```python
# 可能的实现
evaluation_weights = {
    "愉悦身心": user_preference_weight,
    "开阔眼界": library_mission_weight,
    "激发思维": community_feedback_weight,
    "了解新知": collection_gap_weight
}
```

### 2. 主题聚类优化

可以引入更智能的主题聚类算法，自动识别主题间的关联性，进一步优化主题平衡：
```python
# 可能的实现
def enhanced_theme_clustering(books):
    # 使用向量嵌入进行主题聚类
    # 识别跨主题的关联性
    # 优化主题配额分配
```

### 3. 个性化推荐

在保持全局平衡的基础上，可以增加个性化推荐维度：
```python
# 可能的实现
def personalized_balancing(global_selection, user_profile):
    # 在全局平衡基础上
    # 考虑用户个人偏好
    # 生成个性化推荐列表
```

---

## 结语

"书海回响"项目的三阶段评选流程、配额自适应算法和LLM提示词策略共同构成了一个精密而高效的"智慧采金"系统。它不仅能够从海量图书中发掘出真正的"智慧遗珠"，还能确保最终推荐结果的多样性、平衡性和人文关怀。这种技术创新与人文价值的融合，为图书馆的图书推荐服务提供了一个全新的范式。

通过这套系统，那些被时间沉淀的智慧遗珠得以重新进入读者视野，实现了从"库房静态存储"向"数字动态活化"的转变，真正践行了"书海回响"的项目理念。