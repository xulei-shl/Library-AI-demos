# 混合检索系统实现

**更新日期**: 2025-12-30
**版本**: v2.0
**类型**: 破坏性更新

---

## 概述

本次重构实现了文学情境推荐模块的混合检索系统，按照[数据向量与检索逻辑重构](./数据向量与检索逻辑重构.md)文档的设计要求，完整实现了**并行双路检索 + RRF融合**的架构。

---

## 核心功能

### 1. 并行双路检索

#### 路 A：向量语义检索
- 使用 `synthetic_query`（合成向量查询词）进行语义匹配
- 支持 `filter_conditions` 的 Pre-filter 和 Post-filter：
  - **MUST**: 使用 ChromaDB 的 `where` 参数进行前置过滤
  - **MUST_NOT**: 检索后排除匹配的结果
  - **SHOULD**: 多次检索合并策略（每个值检索一次，取最高分）

#### 路 B：BM25 字面检索
- 使用 `search_keywords` 对书名、作者、简介进行关键词匹配
- 基于 `rank-bm25` 算法 + `jieba` 中文分词
- 支持字段加权：书名(2.0) > 简介(1.5) > 作者(1.0)

### 2. RRF 融合

使用 **Reciprocal Rank Fusion** 算法合并双路结果：

```
score(book_id) = Σ(1 / (k + rank_i))
```

其中 `k=60` 为平滑常数。RRF 对排名敏感而非分数值，更稳健且无需归一化。

### 3. CrossEncoder 重排序（可选）

使用 `BAAI/bge-reranker-v2-m3` 模型对 Top 50 结果进行精细重排序，默认关闭。

---

## 新增文件

| 文件 | 功能 |
|------|------|
| `src/core/literature_fm/bm25_searcher.py` | BM25 全文检索器，懒加载索引 |
| `src/core/literature_fm/hybrid_vector_searcher.py` | 增强向量检索器，支持过滤逻辑 |
| `src/core/literature_fm/rrf_fusion.py` | RRF 融合器 |
| `src/core/literature_fm/cross_encoder_reranker.py` | CrossEncoder 重排序器 |

---

## 修改文件

| 文件 | 修改内容 |
|------|----------|
| `src/core/literature_fm/pipeline.py` | 重构 `generate_theme_shelf()` 方法，使用新的混合检索流程 |
| `src/core/literature_fm/theme_exporter.py` | 新增 `export_theme_batch()` 方法，支持批量主题导出 |
| `src/core/literature_fm/cli.py` | 更新 CLI 接口，支持自然语言和 JSON 文件两种输入方式 |
| `config/literature_fm_vector.yaml` | 新增 BM25、RRF、Reranker 配置项 |
| `requirements.txt` | 新增 rank-bm25、jieba、sentence-transformers、chromadb |

---

## 配置说明

### 新增配置项

```yaml
# BM25 检索配置
bm25:
  enabled: true
  k1: 1.5            # 词频饱和参数 (1.2-2.0)
  b: 0.75            # 长度归一化参数 (0.5-0.75)
  field_weights:     # 字段权重
    title: 2.0
    author: 1.0
    summary: 1.5

# RRF 融合配置
rrf:
  k: 60              # RRF平滑常数

# 重排序配置（可选）
reranker:
  enabled: false     # 默认关闭
  model: "BAAI/bge-reranker-v2-m3"
  top_k: 50
  device: "cpu"

# 检索策略默认值
default:
  use_vector: true
  use_bm25: true
  use_rrf: true
  vector_top_k: 50
  bm25_top_k: 50
  final_top_k: 30
```

---

## 使用方式

### 1. 交互式菜单

```bash
python src/core/literature_fm/cli.py
# 选择 4 - 情境主题检索
# 选择输入方式：
#   1 - 自然语言主题（自动调用 QueryTranslator 转换）
#   2 - 已转换的 JSON 文件
```

### 2. 命令行 - 从 JSON 文件

```bash
python src/core/literature_fm/cli.py shelf \
  --query-json runtime/outputs/theme_shelf/translated/themes_xxx_translated_xxx.json
```

### 3. 命令行 - 自然语言主题

```bash
python src/core/literature_fm/cli.py shelf \
  --theme "冬日暖阳，窝在沙发里阅读"
```

---

## 输入数据格式

`QueryTranslator` 输出的 JSON 格式：

```json
{
  "generated_at": "2025-12-30T12:40:44.871926",
  "source_file": "themes.xlsx",
  "count": 1,
  "queries": [
    {
      "filter_conditions": [
        {
          "field": "reading_context",
          "values": ["精神出走", "正念深读"],
          "operator": "SHOULD"
        },
        {
          "field": "spatial_atmosphere",
          "values": ["都市孤独"],
          "operator": "MUST_NOT"
        }
      ],
      "search_keywords": ["荒野", "星空", "海洋"],
      "synthetic_query": "这本书非常适合那些被信息过载压垮的读者...",
      "original_theme": {
        "theme_name": "大脑重启：格式化你的精神硬盘",
        "slogan": "当你的思绪乱成一团毛线时",
        "description": "当你被信息过载、情绪垃圾...",
        "target_vibe": "辽阔、敬畏、净化、抽离"
      }
    }
  ]
}
```

---

## 输出结果

生成的 Excel 文件包含：

1. **主题汇总** Sheet：所有主题的概览统计
2. **各主题详细推荐** Sheet：每个主题独立一个 Sheet，包含：
   - 序号、书名、作者、索书号
   - RRF 得分、向量得分、BM25 得分
   - 来源（vector/bm25/混合）
   - 向量排名、BM25 排名
   - 重排序得分（如果启用）
3. **元信息** Sheet：生成时间、主题数量、检索方法等

---

## 数据流程图

```
┌─────────────────────────────────────────────────────────────┐
│  输入: QueryTranslator输出                                   │
│  queries = [{filter_conditions, search_keywords, ...}]      │
└─────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┴───────────────────┐
          ▼                                       ▼
┌─────────────────────────┐         ┌─────────────────────────┐
│ HybridVectorSearcher    │         │ BM25Searcher            │
│                         │         │                         │
│ synthetic_query         │         │ search_keywords         │
│ filter_conditions       │         │                         │
│                         │         │ 懒加载索引               │
│ SHOULD: 多次检索合并     │         │ jieba分词               │
│ MUST: Pre-filter        │         │ rank-bm25打分           │
│ MUST_NOT: Post-filter   │         │                         │
└─────────────────────────┘         └─────────────────────────┘
          │                                       │
          └───────────────────┬───────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ RRFFusion.merge(vector_results, bm25_results)              │
│ score = Σ(1 / (k + rank_i))  k=60                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ [可选] CrossEncoderReranker.rerank(merged[:50])            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 输出: Excel文件                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 依赖项

新增 Python 依赖：

```txt
rank-bm25>=0.2.2       # BM25算法
jieba>=0.42.1          # 中文分词
sentence-transformers>=2.2.0  # CrossEncoder重排序
chromadb>=0.4.0        # 向量数据库
```

安装命令：

```bash
pip install -r requirements.txt
```

---

## 破坏性变更

⚠️ **注意**：本次更新为破坏性变更，不向后兼容

1. `generate_theme_shelf()` 方法签名已变更：
   - **旧版**: `generate_theme_shelf(theme_text, use_vector, vector_weight, ...)`
   - **新版**: `generate_theme_shelf(translated_queries, output_dir, config_path)`

2. 输入格式变更：
   - **旧版**: 接受自然语言主题字符串，内部调用 `ThemeParser`
   - **新版**: 接受 `QueryTranslator` 输出的 JSON 格式查询列表

3. 移除的组件：
   - `ThemeMerger` 简单加权融合器 → 被 `RRFFusion` 替代
   - `ThemeParser` 主题解析器 → 被 `QueryTranslator` 替代

---

## 已知问题与限制

1. **ChromaDB 过滤限制**：
   - `where` 参数不支持复杂的 OR 逻辑
   - MUST 条件只能精确匹配单个值
   - SHOULD 条件通过多次检索合并实现，可能影响性能

2. **BM25 索引内存占用**：
   - 首次检索时加载全部书籍数据并构建索引
   - 大量书籍（>10000）可能导致内存压力

3. **中文分词准确性**：
   - `jieba` 可能无法识别文学领域的专有名词
   - 可考虑通过自定义词典优化

---

## 后续优化方向

1. **BM25 索引进化**：
   - 实现增量更新机制
   - 支持索引持久化到磁盘

2. **过滤策略优化**：
   - 探索更高效的 SHOULD 条件合并策略
   - 支持更复杂的布尔逻辑组合

3. **性能优化**：
   - 并行化双路检索（真正的并行）
   - 缓存常见查询的检索结果

4. **重排序模型**：
   - 评估更多 reranker 模型（如 bge-reranker-large）
   - 支持多语言混合场景

---

## 相关文档

- [数据向量与检索逻辑重构](./数据向量与检索逻辑重构.md) - 设计文档
- [主题卡模块向量与检索逻辑参考](./主题卡模块向量与检索逻辑参考/) - 参考实现
