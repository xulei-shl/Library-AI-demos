# 文学策划主题生成功能 - 实现计划

## 概述

为 literature_fm 模块添加**文学策划主题生成**功能，支持通过 LLM 生成创意阅读主题。

## 功能定位

- **Phase 2.5**: 位于 LLM 打标（Phase 2）和情境主题书架（Phase 3）之间
- **用途**: 为图书馆策划人员提供创意阅读主题灵感
- **输出**: JSON 格式的主题列表，包含主题名、标语、描述、氛围等

## 架构设计

### 模块结构

```
src/core/literature_fm/
├── cli.py                 # 统一 CLI 入口（新建）
├── theme_generator.py     # 主题生成器（新建）
├── pipeline.py            # 主流程编排器（保留）
└── llm_tagger.py          # LLM 调用参考（保留）
```

### 核心组件

#### 1. ThemeGenerator（主题生成器）

**职责**: 调用 LLM 生成阅读主题列表

**关键方法**:
- `generate_themes(direction, count)` - 生成主题
- `_build_user_prompt(direction, count)` - 构建提示词
- `_parse_response(response)` - 解析 LLM 响应
- `_validate_themes(themes)` - 验证数据完整性
- `_save_to_json(themes, direction)` - 保存到文件

**LLM 调用模式**:
```python
response = self.llm_client.call(
    task_name='literary_theme_generation',
    user_prompt=user_prompt
)
```

#### 2. LiteratureFMCLI（统一 CLI）

**职责**: 提供交互式菜单和子命令两种使用方式

**支持的功能**:
1. LLM 打标 (Phase 2)
2. 生成策划主题 (Phase 2.5)
3. 情境主题书架 (Phase 3)
4. 数据库向量化

**交互式菜单**:
```
============================================================
Literature_FM 模块 - 功能菜单
============================================================
1. LLM 打标 (Phase 2)
2. 生成策划主题 (Phase 2.5)
3. 情境主题书架 (Phase 3)
4. 数据库向量化
0. 退出
============================================================
```

## 使用示例

### 交互式菜单模式

```bash
python cli.py
```

```
请选择功能 [0-4]: 2

【文学策划主题生成】
1. 随机生成
2. 基于关键词生成

请选择模式 [1-2]: 2
请输入策划方向/关键词: 冬日治愈
生成数量 (默认5): 3

✓ 主题生成成功！
  - 数量: 3
  - 文件: runtime/outputs/literary_theme_generation/themes_20250129_143022_冬日治愈.json

主题预览:

1. 暴雪夜，与伟大的灵魂围炉夜话
   窗外大雪纷飞，屋内思想温暖

2. 周日黄昏，用一本小说对抗焦虑
   肉体在工位，灵魂在流浪

3. 冬至，在文字里寻找春天的线索
   最长的夜，有最温暖的故事相伴
```

### 子命令模式

```bash
# 随机生成 5 个主题
python cli.py theme-gen --random --count 5

# 基于关键词生成
python cli.py theme-gen --direction "夏日逃离" --count 3

# LLM 打标
python cli.py tag

# 情境主题书架
python cli.py shelf --theme "冬日暖阳，窝在沙发里阅读"
```

### 独立调用

```python
from src.core.literature_fm import ThemeGenerator

# 初始化生成器
generator = ThemeGenerator()

# 随机生成
result = generator.generate_themes(direction="", count=5)

# 基于关键词生成
result = generator.generate_themes(direction="冬日治愈", count=3)

print(result['themes'])
```

## 输出格式

### JSON 文件结构

**文件路径**: `runtime/outputs/literary_theme_generation/themes_20250129_143022_冬日治愈.json`

```json
{
  "generated_at": "2025-01-29T14:30:22",
  "direction": "冬日治愈",
  "count": 3,
  "themes": [
    {
      "theme_name": "暴雪夜，与伟大的灵魂围炉夜话",
      "slogan": "窗外大雪纷飞，屋内思想温暖",
      "description": "适合在狂风暴雨的恶劣天气里阅读的书。外界越是喧嚣混乱，书里的世界越要深沉、厚重或极度宁静，形成一种安全的包裹感。",
      "target_vibe": "安全感、沉浸、与世隔绝"
    },
    {
      "theme_name": "周日黄昏，用一本小说对抗焦虑",
      "slogan": "肉体在工位，灵魂在流浪",
      "description": "献给工作疲惫的都市人。不需要说教和鸡汤，需要的是关于流浪、异域探险、或者某种离经叛道的生活方式，通过阅读完成一次短暂的逃离。",
      "target_vibe": "自由、反叛、异域风情"
    }
  ]
}
```

## 配置说明

### LLM 任务配置（config/llm.yaml）

```yaml
literary_theme_generation:
  provider_type: text
  temperature: 0.7          # 较高温度增加创意性
  top_p: 0.95
  prompt:
    type: md
    source: "prompts/literary_theme_generation.md"
  retry:
    max_retries: 3
    base_delay: 1.0
    max_delay: 10
    enable_provider_switch: true
    jitter: true
  json_repair:
    enabled: true
    strict_mode: false
    output_format: json
  langfuse:
    enabled: true
    name: "文学策划主题生成"
    tags: ["book-echoes", "模块8", "主题生成"]
    metadata:
      project: "book-echoes"
      module: "模块8"
```

### 业务配置（config/literature_fm.yaml）

```yaml
theme_generation:
  enabled: true
  default_count: 5
  output:
    output_dir: "runtime/outputs/literary_theme_generation"
    filename_template: "themes_{timestamp}_{direction}.json"
```

## 系统提示词

**文件**: `prompts/literary_theme_generation.md`

**Role**: 资深文学策展人和生活方式主编

**Task**: 根据策划方向生成阅读主题列表

**Output Format**:
```json
[
  {
    "theme_name": "主题名称",
    "slogan": "副标题/推荐语",
    "description": "情境描述",
    "target_vibe": "预期氛围"
  }
]
```

## 技术实现细节

### 1. LLM 调用

复用 `UnifiedLLMClient`，遵循现有模式：

```python
from src.utils.llm.client import UnifiedLLMClient

class ThemeGenerator:
    def __init__(self, config: dict):
        self.llm_client = UnifiedLLMClient()

    def generate_themes(self, direction: str, count: int):
        user_prompt = self._build_user_prompt(direction, count)
        response = self.llm_client.call(
            task_name='literary_theme_generation',
            user_prompt=user_prompt
        )
        return self._parse_response(response)
```

### 2. 提示词构建

根据用户输入动态构建：

```python
def _build_user_prompt(self, direction: str, count: int) -> str:
    if direction:
        return f"""请根据策划方向「{direction}」生成 {count} 个阅读主题。

# Output Format
请严格遵守以下 JSON 格式..."""
    else:
        return f"""请随机生成 {count} 个创意阅读主题...

# Output Format
请严格遵守以下 JSON 格式..."""
```

### 3. 响应解析和验证

```python
def _validate_themes(self, themes: List[Dict]) -> bool:
    required_keys = ['theme_name', 'slogan', 'description', 'target_vibe']

    if not isinstance(themes, list) or len(themes) == 0:
        return False

    for theme in themes:
        if not all(key in theme for key in required_keys):
            return False

    return True
```

### 4. 文件保存

```python
def _save_to_json(self, themes: List[Dict], direction: str) -> str:
    output_data = {
        "generated_at": datetime.now().isoformat(),
        "direction": direction,
        "count": len(themes),
        "themes": themes
    }

    with open(output_path, 'w', encoding='utf-8') as f:
        json.dump(output_data, f, ensure_ascii=False, indent=2)

    return str(output_path)
```

## 关键文件清单

| 文件路径 | 操作 | 说明 |
|---------|------|------|
| [src/core/literature_fm/theme_generator.py](src/core/literature_fm/theme_generator.py) | 新建 | 主题生成器 |
| [src/core/literature_fm/cli.py](src/core/literature_fm/cli.py) | 新建 | 统一 CLI 入口 |
| [config/llm.yaml](config/llm.yaml) | 修改 | 添加 LLM 任务配置 |
| [config/literature_fm.yaml](config/literature_fm.yaml) | 修改 | 添加业务配置 |
| [src/core/literature_fm/__init__.py](src/core/literature_fm/__init__.py) | 修改 | 导出新组件 |

## 未来扩展

### 1. 主题管理
- 历史主题浏览
- 主题收藏和评分
- 主题模板库

### 2. 批量生成
- 一次生成多种方向
- 导出为 Excel 格式
- 保存到数据库

### 3. 质量评估
- 主题质量打分
- 重复度检测
- 人工审核流程

### 4. 与 Phase 3 联动
- 直接用生成的主题调用 `generate_theme_shelf()`
- 自动生成主题书架推荐
- 一站式阅读主题策划方案
