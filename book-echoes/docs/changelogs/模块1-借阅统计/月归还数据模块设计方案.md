# 月归还数据模块设计方案

## 📋 模块概述

本模块是借阅数据分析模块的第一部分，专注于处理月归还数据的初步数据筛选与借阅次数统计。

### 核心功能
1. 读取 `月归还.xlsx` 文件
2. 筛选"中文图书"开头的行数据
3. 标准化索书号（去除#、*、第二个/后的内容）
4. 统计近三个月的总借阅次数和每月借阅次数
5. 生成包含4列新数据的Excel结果文件

## 🔧 技术实现方案

### 1. 数据加载器 (`src/core/data_loader.py`)
**功能**: Excel文件安全读取
- 使用pandas读取Excel文件
- 数据验证和错误处理
- 编码和格式处理

### 2. 数据清洗器 (`src/core/data_cleaner.py`)
**功能**: 数据标准化处理
- 索书号清理算法
- 中文图书筛选逻辑
- 时间格式转换

### 3. 统计模块 (`src/core/statistics.py`)
**功能**: 借阅次数统计
- 时间窗口筛选（近三个月）
- 按清理后索书号分组统计
- 月度数据聚合

### 4. 结果导出器 (`src/core/result_exporter.py`)
**功能**: Excel结果生成
- 新增列数据写入
- 保持原始数据完整性
- 输出文件格式控制

### 5. 工具模块 (`src/utils/`)
**功能**: 通用工具
- 时间处理工具 (`time_utils.py`)
- Excel处理工具 (`excel_utils.py`)
- 配置管理 (`config_manager.py`)

## 📊 核心算法逻辑

### 索书号标准化算法
```python
def clean_call_number(call_number):
    """标准化索书号"""
    if not call_number:
        return ""
    
    # 去除末尾的#和*及后面的数字
    cleaned = re.sub(r'[#*]\d+$', '', str(call_number))
    
    # 如果有两个以上/，保留到第二个/为止
    parts = cleaned.split('/')
    if len(parts) > 2:
        cleaned = '/'.join(parts[:2])
    
    return cleaned.strip()
```

### 借阅统计逻辑
```python
def calculate_borrowing_stats(data, target_date):
    """计算借阅统计数据"""
    # 计算近三个月时间范围
    start_date = target_date - timedelta(days=90)
    
    # 筛选时间范围内的中文图书数据
    filtered_data = filter_chinese_books(data, start_date, target_date)
    
    # 按清理后的索书号分组统计
    stats = {}
    for _, row in filtered_data.iterrows():
        cleaned_call = clean_call_number(row['索书号'])
        if cleaned_call not in stats:
            stats[cleaned_call] = {
                'total_count': 0,
                'monthly_counts': [0, 0, 0]  # 三个月
            }
        
        # 统计逻辑...
    
    return stats
```

## 📁 输出数据结构

### 新增列定义
1. **近三个月总次数**: 该索书号图书近三个月总借阅次数
2. **第一个月借阅次数**: 第一个月的借阅次数
3. **第二个月借阅次数**: 第二个月的借阅次数  
4. **第三个月借阅次数**: 第三个月的借阅次数

### 保持原始数据
- 所有原始列保持不变
- 新增4列统计数据
- 索书号清理仅用于计算，不影响原始数据展示

## 🎯 实施步骤

1. **基础框架搭建**: 创建模块目录结构和基础文件
2. **数据加载开发**: 实现Excel文件读取功能
3. **清洗逻辑开发**: 实现索书号标准化和筛选
4. **统计计算开发**: 实现借阅次数统计算法
5. **输出功能开发**: 实现Excel结果文件生成
6. **集成测试**: 完整流程测试和调试
7. **性能优化**: 添加日志和错误处理

## 📝 注意事项

1. **数据完整性**: 确保所有原始数据都保留在结果中
2. **时间处理**: 提交时间格式：2025-09-30 16:30:56
3. **编码处理**: 处理Excel文件编码问题
4. **异常处理**: 完善的错误捕获和日志记录
5. **性能考虑**: 大数据量处理的内存和速度优化