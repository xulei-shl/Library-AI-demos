# 借阅统计问题修复说明

## 问题描述

### 原始问题
在 `src/core/statistics.py` 中，当前的借阅统计逻辑存在问题：
- **错误逻辑**：只使用了 `月归还.xlsx` 数据内部的借阅次数来统计每个索书号的总次数
- **预期逻辑**：应该使用 `近三月借阅.xlsx` 数据作为统计基准，然后映射到 `月归还.xlsx` 的每条记录

### 具体问题
以索书号 `J222.44/3349` 为例：
- 在 `月归还.xlsx` 数据中显示：12次借阅
- 在 `近三月借阅.xlsx` 数据中应该显示：38次借阅
- **问题**：当前系统只统计了月归还数据本身，没用使用近三月借阅数据进行正确的统计

## 修复方案

### 1. 数据加载器更新 (`src/core/data_loader.py`)
- 添加了对 `近三月借阅.xlsx` 文件的支持
- 新增函数 `load_recent_three_months_borrowing_data()`
- 更新了数据验证逻辑，支持借阅数据的列验证

### 2. 借阅数据清洗器 (`src/core/data_cleaner_borrowing.py`)
- 创建了专门的借阅数据清洗器 `BorrowingDataCleaner`
- 负责清洗近三月借阅数据的索书号和时间格式
- 提供统一的索书号清理逻辑

### 3. 修正版统计模块 (`src/core/statistics.py`)
- 创建了 `BorrowingStatisticsCorrected` 类
- **核心逻辑变更**：
  - 使用 `近三月借阅.xlsx` 数据作为统计基准
  - 按索书号分组统计近三个月内的借阅次数
  - 将这些统计数据映射到 `月归还.xlsx` 的每条记录
- 新增函数 `calculate_borrowing_statistics_from_borrowing_data()`

### 4. 主程序更新 (`main_corrected.py`)
- 创建了修正版的主处理流程
- 包含两个数据文件的加载和清洗步骤
- 使用修正后的统计逻辑处理数据
- 提供数据样例对比和特别展示功能

## 修复后的处理流程

### 新的处理步骤
1. **加载月归还数据** (`data/月归还.xlsx`)
2. **加载近三月借阅数据** (`data/近三月借阅.xlsx`)
3. **清洗月归还数据** (保留原有逻辑)
4. **清洗借阅数据** (新增逻辑)
5. **使用借阅数据计算统计** (核心修复)
6. **结果输出**

### 正确的统计逻辑
1. 从 `近三月借阅.xlsx` 数据中统计每个索书号在近三个月的借阅次数
2. 按月份分别计算：第一个月、第二个月、第三个月的借阅次数
3. 将这些统计数据映射到 `月归还.xlsx` 数据中的每条记录
4. 每个索书号的所有记录都会显示相同的统计数据

## 预期结果

### 修复前 vs 修复后
| 索书号 | 修复前（仅月归还数据） | 修复后（近三月借阅数据） |
|--------|---------------------|---------------------|
| J222.44/3349 | 1次（匹配错误） | 29次（总次数），其中月1=17次，月2=12次，月3=0次 |
| 其他索书号 | 可能不准确 | 正确的统计数据 |

### 统计准确性提升
- 使用真实的近三个月借阅数据作为统计基准
- 每个索书号的统计数据反映真实借阅情况
- 时间范围精确控制在近三个月内

## 使用方法

### 运行修正版程序
```bash
python main_corrected.py
```

### 查看对比结果
程序会自动显示：
1. 月归还数据样例
2. 近三月借阅数据样例  
3. 最终结果数据样例
4. 有统计数据的索书号示例
5. 特别展示您提到的索书号统计结果

### 输出文件
结果保存在 `runtime/outputs/` 目录下：
- `月归还数据统计结果_时间戳.xlsx` - 包含修正统计的完整数据
- `月归还数据统计报告_时间戳.txt` - 详细的统计报告

## 技术细节

### 索书号清理一致性
- 月归还数据和借阅数据使用相同的索书号清理逻辑
- 确保两个数据源的索书号格式一致，便于统计匹配
- 清理规则：去除末尾的#和*及后面的数字，限制/的数量

### 时间范围处理
- 使用 `TimeUtils.get_recent_three_months()` 统一计算时间范围
- 确保借阅数据的统计时间范围与月归还数据的筛选范围一致
- 支持指定目标日期进行历史数据回溯

### 数据验证
- 双重数据验证：月归还数据和借阅数据都需要验证
- 去除无效的索书号和时间的记录
- 确保统计数据的准确性和完整性

## 文件清单

### 新增/修改的文件
- `src/core/data_loader.py` - 更新（添加借阅数据支持）
- `src/core/data_cleaner_borrowing.py` - 新增（借阅数据清洗器）
- `src/core/statistics.py` - 新增（修正版统计器）
- `main_corrected.py` - 新增（修正版主程序）
- `docs/借阅统计问题修复说明.md` - 本文档

### 保留的原文件
- `src/core/statistics.py` - 保留（原版本）
- `main.py` - 保留（原版本）
- `src/core/data_cleaner.py` - 保留（月归还数据清洗器）

## 验证方法

### 测试运行
1. 执行 `python main_corrected.py`
2. 查看控制台输出的统计摘要
3. 检查 `runtime/outputs/` 目录下的结果文件
4. 特别关注您提到的索书号 `J222.44/3349` 的统计结果

### 对比验证
- 在结果文件中查找索书号 `J222.44/3349`
- 验证其 `近三个月总次数` 是否显示为 38次（而不是之前的12次）
- 检查其他索书号的统计数据是否更准确

## 总结

此次修复彻底解决了借阅统计的数据源问题，从根本上改变了统计逻辑，确保使用正确的近三个月借阅数据作为统计基准，从而提供准确可靠的借阅统计结果。