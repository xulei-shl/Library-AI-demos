# 模块5开发文档：图书卡片生成模块

## 1. 模块概述

### 1.1 模块功能
模块5负责根据模块4的终评结果，为通过终评的图书生成精美的HTML图书卡片，并将卡片截图保存为图片。

### 1.2 核心流程
```
Excel数据验证
    ↓
创建输出目录结构
    ↓
复制Logo资源文件
    ↓
下载豆瓣封面图片
    ↓
生成索书号二维码
    ↓
填充HTML模板
    ↓
生成HTML文件
    ↓
HTML转图片
```

### 1.3 输入输出

#### 输入
- **Excel文件**: 模块4生成的终评结果Excel文件（包含终评结果、终评理由等字段）
- **HTML模板**: 图书卡片的HTML模板文件
- **Logo资源**: `data/logo/` 目录下的Logo图片

#### 输出
- **HTML卡片**: 每本书生成一个HTML文件（以书目条码命名）
- **卡片图片**: 每本书生成一张PNG图片（以书目条码命名）
- **目录结构**:
  ```
  runtime/outputs/
  └── {书目条码}/
      ├── {书目条码}.html
      ├── {书目条码}.png
      └── pic/
          ├── logo_shl.png
          ├── logozi_shl.jpg
          ├── cover.jpg (或 cover.png)
          └── qrcode.png
  ```

---

## 2. 技术架构设计

### 2.1 模块结构

```
src/core/card_generator/
├── __init__.py                    # 模块初始化
├── card_main.py                   # 主入口程序
├── validator.py                   # 数据验证器
├── directory_manager.py           # 目录管理器
├── image_downloader.py            # 图片下载器
├── qrcode_generator.py            # 二维码生成器
├── html_generator.py              # HTML生成器
├── html_to_image_converter.py    # HTML转图片转换器
└── models.py                      # 数据模型定义
```

### 2.2 配置文件结构

#### config/setting.yaml 新增配置节
```yaml
# 模块5：图书卡片生成配置
card_generator:
  # HTML模板文件路径
  template_path: "config/card_template.html"

  # 输出配置
  output:
    # 输出根目录
    base_dir: "runtime/outputs"
    # HTML文件扩展名
    html_extension: ".html"
    # 图片文件扩展名
    image_extension: ".png"

  # 图片下载配置
  image_download:
    # 封面图片名称（不含扩展名）
    cover_filename: "cover"
    # 支持的图片格式
    supported_formats: ["jpg", "png", "jpeg"]
    # 请求超时时间（秒）
    timeout: 30
    # 最大重试次数
    max_retries: 3
    # 重试延迟（秒）
    retry_delay: 2
    # User-Agent
    user_agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
    # 豆瓣图片URL替换规则
    url_replacements:
      - old: "subject/s/public"
        new: "subject/l/public"

  # 二维码生成配置
  qrcode:
    # 二维码文件名（固定）
    filename: "qrcode.png"
    # URL模板
    url_template: "https://vufind.library.sh.cn/Search/Results?searchtype=vague&lookfor={call_number}&type=CallNumber"
    # 索书号URL编码规则（特殊字符映射）
    url_encoding:
      "/": "%2F"
      "#": "%23"
      "*": "%2A"
      " ": "%20"
      "+": "%2B"
      "=": "%3D"
      "?": "%3F"
      "&": "%26"
    # 二维码生成参数
    box_size: 10
    border: 4
    error_correction: "H"  # L, M, Q, H

  # HTML转图片配置
  html_to_image:
    # 浏览器设置
    headless: true
    # 视窗宽度
    viewport_width: 1200
    # 视窗高度
    viewport_height: 800
    # 设备缩放因子
    device_scale_factor: 2
    # 图片格式
    image_format: "png"
    # 图片质量（仅用于jpg）
    quality: 90
    # 是否全页截图
    full_page: false
    # 是否裁剪元素
    clip_element: true
    # 圆角半径（像素）
    border_radius: 8
    # 页面加载超时（毫秒）
    timeout: 60000
    # 等待时间（毫秒）
    wait_time: 2000

  # Logo资源配置
  logo:
    # Logo源目录
    source_dir: "data/logo"

  # 字段配置
  fields:
    # 必填字段（缺失则终止处理）
    required:
      - "索书号"
      - "豆瓣评分"
      - "终评理由"
      - "豆瓣封面图片链接"

    # 可选字段（缺失时使用默认值或替代字段）
    optional:
      - "豆瓣作者"
      - "豆瓣出版社"
      - "豆瓣出版年"
      - "豆瓣副标题"

    # 字段替代规则
    fallback:
      "豆瓣书名": "书名"  # 豆瓣书名缺失时使用书名

    # 过滤条件字段
    filter:
      column: "终评结果"
      value: "通过"

    # 字段长度限制
    truncate:
      "终评理由": 30  # 只提取前30个字符
```

#### config/card_template.html
HTML模板文件（从需求描述中的HTML代码复制）

---

## 3. 核心模块设计

### 3.1 数据模型 (models.py)

```python
"""
数据模型定义模块
定义图书卡片所需的数据结构
"""

from dataclasses import dataclass
from typing import Optional


@dataclass
class BookCardData:
    """图书卡片数据模型"""

    # 必填字段
    barcode: str                      # 书目条码
    call_number: str                  # 索书号
    douban_rating: float              # 豆瓣评分
    final_review_reason: str          # 终评理由（截取前30字符）
    cover_image_url: str              # 豆瓣封面图片链接

    # 可选字段（有替代方案）
    title: str                        # 书名（豆瓣书名或原书名）
    author: Optional[str] = None      # 豆瓣作者
    publisher: Optional[str] = None   # 豆瓣出版社
    pub_year: Optional[str] = None    # 豆瓣出版年
    subtitle: Optional[str] = None    # 豆瓣副标题

    @property
    def full_title(self) -> str:
        """
        获取完整书名（书名 + 副标题）
        如果副标题存在，用 " : " 拼接
        """
        if self.subtitle and self.subtitle.strip():
            return f"{self.title} : {self.subtitle}"
        return self.title

    @property
    def truncated_reason(self) -> str:
        """获取截取后的终评理由（前30字符）"""
        return self.final_review_reason[:30]

    def validate(self) -> bool:
        """
        验证必填字段是否完整

        Returns:
            bool: 验证通过返回True，否则返回False
        """
        required_fields = [
            self.barcode,
            self.call_number,
            self.douban_rating,
            self.final_review_reason,
            self.cover_image_url
        ]
        return all(field is not None and str(field).strip() != "" for field in required_fields)


@dataclass
class OutputPaths:
    """输出路径集合"""

    book_dir: str           # 图书输出目录（以条码命名）
    pic_dir: str            # pic子目录
    html_file: str          # HTML文件路径
    image_file: str         # 图片文件路径
    cover_image: str        # 封面图片路径
    qrcode_image: str       # 二维码图片路径
```

### 3.2 数据验证器 (validator.py)

```python
"""
数据验证器模块
负责验证Excel数据的完整性和有效性
"""

功能职责：
1. 验证Excel文件是否存在
2. 验证必填列是否存在
3. 验证必填字段是否有值
4. 筛选终评结果为"通过"的记录
5. 生成验证报告

核心方法：
- validate_excel_file(excel_path: str) -> bool
  验证Excel文件是否存在且可读

- validate_required_columns(df: DataFrame, required_columns: List[str]) -> Tuple[bool, List[str]]
  验证必填列是否存在，返回验证结果和缺失列列表

- validate_row_data(row: Series, required_fields: List[str]) -> Tuple[bool, List[str]]
  验证单行数据的必填字段，返回验证结果和缺失字段列表

- filter_passed_books(df: DataFrame) -> DataFrame
  筛选终评结果为"通过"的图书

- generate_validation_report(results: Dict) -> str
  生成验证报告文本
```

### 3.3 目录管理器 (directory_manager.py)

```python
"""
目录管理器模块
负责创建和管理输出目录结构
"""

功能职责：
1. 根据书目条码创建输出目录
2. 创建pic子目录
3. 复制Logo资源文件到pic目录
4. 生成输出路径集合

核心方法：
- create_book_directory(barcode: str, base_dir: str) -> OutputPaths
  创建图书输出目录结构，返回输出路径集合

- copy_logo_files(logo_source_dir: str, pic_dir: str) -> bool
  复制Logo文件到pic目录

- clean_barcode(barcode: str) -> str
  清理条码字符串（去除非法字符）

- ensure_directory_exists(directory: str) -> bool
  确保目录存在，不存在则创建
```

### 3.4 图片下载器 (image_downloader.py)

```python
"""
图片下载器模块
负责下载豆瓣封面图片
"""

功能职责：
1. 处理豆瓣图片URL（替换s/public为l/public）
2. 下载图片到指定路径
3. 自动检测图片格式
4. 重试机制
5. 错误处理和日志记录

核心方法：
- download_cover_image(url: str, output_path: str, config: Dict) -> Tuple[bool, str]
  下载封面图片，返回成功状态和保存路径

- process_douban_url(url: str) -> str
  处理豆瓣图片URL（替换为大图）

- detect_image_format(content: bytes) -> str
  检测图片格式（jpg/png）

- retry_download(url: str, output_path: str, max_retries: int, retry_delay: int) -> bool
  带重试机制的下载函数
```

### 3.5 二维码生成器 (qrcode_generator.py)

```python
"""
二维码生成器模块
负责将索书号转换为二维码图片
"""

功能职责：
1. 将索书号转换为检索URL
2. URL特殊字符编码
3. 生成透明背景二维码
4. 保存为PNG格式

核心方法：
- generate_qrcode(call_number: str, output_path: str, config: Dict) -> Tuple[bool, str]
  生成二维码，返回成功状态和保存路径

- build_search_url(call_number: str, url_template: str, encoding_rules: Dict) -> str
  构建检索URL（处理特殊字符编码）

- encode_call_number(call_number: str, encoding_rules: Dict) -> str
  对索书号进行URL编码

- create_transparent_qrcode(data: str, box_size: int, border: int, error_correction: str) -> Image
  创建透明背景的二维码图片
```

### 3.6 HTML生成器 (html_generator.py)

```python
"""
HTML生成器模块
负责填充HTML模板并生成HTML文件
"""

功能职责：
1. 读取HTML模板
2. 填充图书数据到模板
3. 处理可选字段（空值处理）
4. 生成HTML文件
5. 验证HTML有效性

核心方法：
- generate_html(template_path: str, book_data: BookCardData, output_path: str) -> Tuple[bool, str]
  生成HTML文件，返回成功状态和输出路径

- load_template(template_path: str) -> str
  加载HTML模板文件

- fill_template(template: str, book_data: BookCardData) -> str
  填充模板数据

- handle_empty_field(value: Optional[str], default: str = "") -> str
  处理空字段（返回默认值）

- save_html(content: str, output_path: str) -> bool
  保存HTML文件
```

模板占位符设计：
```html
<!-- 图书信息占位符 -->
{{AUTHOR}}              <!-- 豆瓣作者 -->
{{TITLE}}               <!-- 完整书名（书名 : 副标题） -->
{{PUBLISHER}}           <!-- 豆瓣出版社 -->
{{PUB_YEAR}}           <!-- 豆瓣出版年 -->
{{CALL_NUMBER}}        <!-- 索书号 -->
{{DOUBAN_RATING}}      <!-- 豆瓣评分 -->
{{RECOMMENDATION}}     <!-- 终评理由（前30字符） -->
```

### 3.7 HTML转图片转换器 (html_to_image_converter.py)

```python
"""
HTML转图片转换器模块
负责将HTML卡片转换为PNG图片
"""

功能职责：
1. 启动Playwright浏览器
2. 加载HTML文件
3. 等待页面渲染完成
4. 截图保存为PNG
5. 应用圆角、裁剪等效果
6. 清理浏览器资源

核心方法：
- convert_html_to_image(html_path: str, output_path: str, config: Dict) -> Tuple[bool, str]
  转换HTML为图片，返回成功状态和输出路径

- setup_browser(config: Dict) -> Tuple[Browser, Page]
  设置并启动浏览器

- load_html_page(page: Page, html_path: str, timeout: int) -> bool
  加载HTML页面

- wait_for_rendering(page: Page, wait_time: int) -> None
  等待页面渲染完成

- take_screenshot(page: Page, output_path: str, config: Dict) -> bool
  截图并保存

- apply_border_radius(page: Page, radius: int) -> bool
  应用圆角效果

- cleanup_browser(browser: Browser) -> None
  清理浏览器资源
```

### 3.8 主控制器 (card_main.py)

```python
"""
图书卡片生成主程序
统筹整个卡片生成流程
"""

功能职责：
1. 加载配置
2. 加载Excel数据
3. 数据验证
4. 批量生成卡片
5. 进度跟踪
6. 错误处理
7. 生成汇总报告

核心流程：
def main(excel_path: str) -> int:
    """
    主函数流程：
    1. 加载配置
    2. 验证Excel数据
    3. 筛选通过的图书
    4. 逐本生成卡片
       4.1 创建目录结构
       4.2 复制Logo文件
       4.3 下载封面图片
       4.4 生成二维码
       4.5 生成HTML
       4.6 HTML转图片
    5. 生成汇总报告
    6. 输出统计信息
    """

核心方法：
- process_single_book(row: Series, config: Dict) -> Tuple[bool, Dict]
  处理单本图书，返回成功状态和处理信息

- generate_summary_report(results: List[Dict]) -> str
  生成汇总报告

- save_report(report: str, output_path: str) -> bool
  保存报告文件
```

---

## 4. 数据流设计

### 4.1 输入数据格式

Excel必需列：
- `终评结果`: 用于筛选（值为"通过"）
- `书目条码`: 用于命名输出目录和文件
- `索书号`: 用于生成二维码和卡片展示
- `豆瓣评分`: 用于卡片展示
- `终评理由`: 用于卡片展示（截取前30字符）
- `豆瓣封面图片链接`: 用于下载封面图片

Excel可选列：
- `豆瓣书名`: 优先使用，缺失则使用`书名`
- `书名`: 豆瓣书名的替代字段
- `豆瓣副标题`: 用于拼接完整书名
- `豆瓣作者`: 用于卡片展示
- `豆瓣出版社`: 用于卡片展示
- `豆瓣出版年`: 用于卡片展示

### 4.2 数据转换规则

#### 4.2.1 书名处理
```python
# 规则：优先使用豆瓣书名，缺失则使用书名
if pd.notna(row['豆瓣书名']) and str(row['豆瓣书名']).strip():
    title = str(row['豆瓣书名']).strip()
else:
    title = str(row['书名']).strip() if pd.notna(row['书名']) else ""

# 副标题拼接
if pd.notna(row['豆瓣副标题']) and str(row['豆瓣副标题']).strip():
    full_title = f"{title} : {row['豆瓣副标题']}"
else:
    full_title = title
```

#### 4.2.2 终评理由截取
```python
# 规则：只提取前30个字符
reason = str(row['终评理由'])[:30]
```

#### 4.2.3 豆瓣图片URL处理
```python
# 规则：替换 subject/s/public 为 subject/l/public
url = row['豆瓣封面图片链接']
if 'subject/s/public' in url:
    url = url.replace('subject/s/public', 'subject/l/public')
```

#### 4.2.4 索书号URL编码
```python
# 规则：特殊字符URL编码
encoding_rules = {
    '/': '%2F',
    '#': '%23',
    '*': '%2A',
    ' ': '%20',
    '+': '%2B',
    '=': '%3D',
    '?': '%3F',
    '&': '%26'
}

def encode_call_number(call_number: str) -> str:
    encoded = call_number
    for char, code in encoding_rules.items():
        encoded = encoded.replace(char, code)
    return encoded
```

### 4.3 输出数据结构

```
runtime/outputs/
└── {书目条码}/               # 例如：54121111149550
    ├── {书目条码}.html       # 例如：54121111149550.html
    ├── {书目条码}.png        # 例如：54121111149550.png
    └── pic/
        ├── logo_shl.png      # Logo（从data/logo复制）
        ├── logozi_shl.jpg    # Logo背景图（从data/logo复制）
        ├── cover.jpg         # 封面图片（从豆瓣下载）
        └── qrcode.png        # 索书号二维码
```

---

## 5. 错误处理策略

### 5.1 数据验证阶段

#### 5.1.1 Excel文件不存在
```python
错误级别: CRITICAL
处理方式: 终止程序运行
日志信息: "错误：Excel文件不存在：{excel_path}"
返回码: 1
```

#### 5.1.2 必填列缺失
```python
错误级别: CRITICAL
处理方式: 终止程序运行
日志信息: "错误：Excel缺少必填列：{missing_columns}"
返回码: 1
```

#### 5.1.3 必填字段缺失
```python
错误级别: WARNING
处理方式: 跳过该记录，继续处理下一条
日志信息: "警告：书目条码 {barcode} 缺少必填字段：{missing_fields}，跳过处理"
统计信息: 记录到失败列表
```

#### 5.1.4 无通过的图书
```python
错误级别: WARNING
处理方式: 正常退出
日志信息: "警告：没有终评结果为'通过'的图书"
返回码: 0
```

### 5.2 文件操作阶段

#### 5.2.1 目录创建失败
```python
错误级别: ERROR
处理方式: 跳过该记录，继续处理下一条
日志信息: "错误：无法创建目录 {directory}：{error_message}"
统计信息: 记录到失败列表
```

#### 5.2.2 Logo文件复制失败
```python
错误级别: WARNING
处理方式: 记录警告，继续执行（可能影响卡片显示）
日志信息: "警告：Logo文件复制失败：{error_message}"
统计信息: 记录到警告列表
```

### 5.3 网络操作阶段

#### 5.3.1 封面图片下载失败
```python
错误级别: ERROR
处理方式: 重试3次，仍失败则跳过该记录
日志信息: "错误：封面图片下载失败（重试 {retry_count}/{max_retries}）：{error_message}"
统计信息: 记录到失败列表
```

#### 5.3.2 网络超时
```python
错误级别: ERROR
处理方式: 重试，使用指数退避策略
日志信息: "错误：网络请求超时，{retry_delay}秒后重试"
重试策略: 第1次等待2秒，第2次等待4秒，第3次等待8秒
```

### 5.4 渲染操作阶段

#### 5.4.1 HTML模板加载失败
```python
错误级别: CRITICAL
处理方式: 终止程序运行
日志信息: "错误：无法加载HTML模板：{template_path}"
返回码: 1
```

#### 5.4.2 HTML生成失败
```python
错误级别: ERROR
处理方式: 跳过该记录，继续处理下一条
日志信息: "错误：HTML生成失败，书目条码：{barcode}，原因：{error_message}"
统计信息: 记录到失败列表
```

#### 5.4.3 Playwright启动失败
```python
错误级别: ERROR
处理方式: 重试3次，仍失败则跳过该记录
日志信息: "错误：浏览器启动失败（重试 {retry_count}/{max_retries}）：{error_message}"
统计信息: 记录到失败列表
```

#### 5.4.4 HTML转图片失败
```python
错误级别: ERROR
处理方式: 跳过该记录，继续处理下一条
日志信息: "错误：HTML转图片失败，书目条码：{barcode}，原因：{error_message}"
统计信息: 记录到失败列表
```

### 5.5 错误汇总报告

程序结束时生成错误汇总报告：

```
模块5执行汇总报告
===================

输入信息：
- Excel文件：{excel_path}
- 总记录数：{total_count}
- 终评通过数：{passed_count}

执行结果：
- 成功生成：{success_count} 张卡片
- 失败记录：{failed_count} 条
- 警告记录：{warning_count} 条

失败详情：
1. 书目条码：{barcode}，原因：{reason}
2. ...

警告详情：
1. 书目条码：{barcode}，警告：{warning}
2. ...

执行时间：{elapsed_time} 秒
```

---

## 6. 日志记录规范

### 6.1 日志级别使用

#### DEBUG
```python
# 详细的变量值、执行路径
logger.debug(f"正在处理书目条码：{barcode}")
logger.debug(f"豆瓣图片URL：{url}")
logger.debug(f"二维码URL：{qr_url}")
```

#### INFO
```python
# 关键流程节点
logger.info("开始模块5：图书卡片生成")
logger.info(f"加载Excel文件：{excel_path}")
logger.info(f"筛选到 {count} 本通过终评的图书")
logger.info(f"成功生成卡片：{barcode}")
logger.info("模块5执行完成")
```

#### WARNING
```python
# 预期之外但不影响主流程
logger.warning(f"Logo文件复制失败：{error}")
logger.warning(f"书目条码 {barcode} 缺少可选字段：豆瓣作者")
```

#### ERROR
```python
# 操作失败，跳过记录
logger.error(f"封面图片下载失败，书目条码：{barcode}，错误：{error}")
logger.error(f"HTML生成失败，书目条码：{barcode}，错误：{error}")
```

#### CRITICAL
```python
# 严重错误，程序终止
logger.critical(f"Excel文件不存在：{excel_path}")
logger.critical(f"HTML模板加载失败：{template_path}")
```

### 6.2 日志格式

使用项目统一的日志格式（`src/utils/logger.py` 配置）：

```
时间=YYYY-MM-DD HH:MM:SS | 级别=INFO | 模块=src.core.card_generator.card_main | 行号=123 | 函数=main | 信息=开始模块5：图书卡片生成
```

### 6.3 上下文信息

每条日志必须包含关键上下文：

```python
# 好的日志
logger.info(f"成功下载封面图片，书目条码：{barcode}，URL：{url}，保存路径：{save_path}")

# 不好的日志
logger.info("下载成功")
```

---

## 7. 性能优化建议

### 7.1 批量处理优化

#### 7.1.1 浏览器复用
```python
# 不要为每个HTML都启动新浏览器
# 建议：启动一个浏览器，复用Page对象

with sync_playwright() as p:
    browser = p.chromium.launch(headless=True)
    page = browser.new_page()

    for book in books:
        # 复用同一个page对象
        convert_html_to_image(page, book.html_path, book.image_path)

    browser.close()
```

#### 7.1.2 并发下载图片
```python
# 使用线程池并发下载封面图片
from concurrent.futures import ThreadPoolExecutor

with ThreadPoolExecutor(max_workers=5) as executor:
    futures = [executor.submit(download_cover_image, url, path)
               for url, path in image_tasks]
    results = [future.result() for future in futures]
```

### 7.2 缓存机制

#### 7.2.1 模板缓存
```python
# 只加载一次HTML模板
template = load_template(template_path)
for book in books:
    html = fill_template(template, book)  # 复用模板
```

#### 7.2.2 二维码缓存（相同索书号）
```python
# 如果索书号相同，复用二维码
qrcode_cache = {}
if call_number in qrcode_cache:
    shutil.copy(qrcode_cache[call_number], output_path)
else:
    generate_qrcode(call_number, output_path)
    qrcode_cache[call_number] = output_path
```

### 7.3 资源管理

#### 7.3.1 及时释放资源
```python
# 使用上下文管理器
with open(file_path, 'r', encoding='utf-8') as f:
    content = f.read()
# 文件自动关闭

# Playwright浏览器
try:
    browser = p.chromium.launch()
    # ... 使用浏览器
finally:
    browser.close()  # 确保关闭
```

#### 7.3.2 限制并发数
```python
# 避免过多并发导致资源耗尽
MAX_CONCURRENT_DOWNLOADS = 5
MAX_CONCURRENT_CONVERSIONS = 2
```

---

## 8. 测试用例设计

### 8.1 单元测试

#### 8.1.1 数据模型测试 (test_models.py)
```python
测试用例：
1. test_book_card_data_validate_success()
   - 验证所有必填字段都有值时返回True

2. test_book_card_data_validate_missing_field()
   - 验证缺少必填字段时返回False

3. test_full_title_with_subtitle()
   - 验证书名和副标题正确拼接

4. test_full_title_without_subtitle()
   - 验证无副标题时只返回书名

5. test_truncated_reason()
   - 验证终评理由正确截取前30字符
```

#### 8.1.2 数据验证器测试 (test_validator.py)
```python
测试用例：
1. test_validate_excel_file_exists()
   - 验证文件存在时返回True

2. test_validate_excel_file_not_exists()
   - 验证文件不存在时返回False

3. test_validate_required_columns_success()
   - 验证所有必填列存在时返回True

4. test_validate_required_columns_missing()
   - 验证缺少必填列时返回False和缺失列表

5. test_filter_passed_books()
   - 验证正确筛选出终评结果为"通过"的记录
```

#### 8.1.3 URL编码测试 (test_qrcode_generator.py)
```python
测试用例：
1. test_encode_call_number_with_slash()
   - 验证 K835.615.6/1122-16 编码为 K835.615.6%2F1122-16

2. test_encode_call_number_with_multiple_special_chars()
   - 验证多个特殊字符正确编码

3. test_build_search_url()
   - 验证完整URL构建正确
```

#### 8.1.4 图片URL处理测试 (test_image_downloader.py)
```python
测试用例：
1. test_process_douban_url_with_s_public()
   - 验证 subject/s/public 正确替换为 subject/l/public

2. test_process_douban_url_without_s_public()
   - 验证不含 s/public 的URL保持不变

3. test_detect_image_format_jpg()
   - 验证正确识别JPG格式

4. test_detect_image_format_png()
   - 验证正确识别PNG格式
```

### 8.2 集成测试

#### 8.2.1 完整流程测试 (test_integration.py)
```python
测试用例：
1. test_single_book_complete_flow()
   - 准备：创建测试Excel，包含一本通过的书
   - 执行：运行完整流程
   - 验证：
     * 目录结构正确创建
     * Logo文件成功复制
     * 封面图片成功下载
     * 二维码成功生成
     * HTML文件成功生成
     * 图片文件成功生成

2. test_multiple_books_batch_processing()
   - 准备：创建包含10本书的测试Excel
   - 执行：批量处理
   - 验证：所有书的卡片都正确生成

3. test_error_handling_missing_fields()
   - 准备：创建包含缺失字段的测试Excel
   - 执行：运行流程
   - 验证：正确跳过有问题的记录，其他记录正常处理

4. test_error_handling_network_failure()
   - 模拟：网络请求失败
   - 验证：正确重试并记录错误
```

### 8.3 性能测试

#### 8.3.1 批量处理性能 (test_performance.py)
```python
测试场景：
1. 小规模测试（10本书）
   - 预期时间：< 1分钟

2. 中等规模测试（50本书）
   - 预期时间：< 5分钟

3. 大规模测试（100本书）
   - 预期时间：< 10分钟

性能指标：
- 单本书平均处理时间
- 峰值内存占用
- 浏览器启动次数
- 网络请求次数
```

---

## 9. 部署和运行

### 9.1 环境依赖

#### 9.1.1 Python依赖包
```
pandas>=1.5.0
qrcode>=7.4.2
pillow>=10.0.0
playwright>=1.40.0
requests>=2.31.0
pyyaml>=6.0
```

#### 9.1.2 系统依赖
```bash
# 安装Playwright浏览器
python -m playwright install chromium
```

### 9.2 配置检查

运行前检查清单：
```
□ config/setting.yaml 已添加 card_generator 配置节
□ config/card_template.html 模板文件已创建
□ data/logo/ 目录包含Logo文件
□ runtime/outputs/ 目录存在（程序会自动创建）
□ Playwright Chromium 浏览器已安装
```

### 9.3 运行方式

#### 9.3.1 独立运行
```bash
# 直接运行模块5
python src/core/card_generator/card_main.py --excel-file "runtime/outputs/月归还数据筛选结果_20250118_142613_豆瓣结果_20250118_152045.xlsx"
```

#### 9.3.2 集成到主程序
在 `main.py` 中添加模块5入口：
```python
def run_module5():
    """运行模块5：图书卡片生成"""
    print("=" * 60)
    print("模块5: 图书卡片生成模块")
    print("=" * 60)

    latest_excel = find_latest_module4_excel()  # 需要实现
    if not latest_excel:
        print("错误: 未找到模块4生成的终评结果 Excel 文件。")
        return 1

    success = run_card_generator_module(excel_file=latest_excel)

    if success:
        print("\n" + "=" * 60)
        print("[成功] 模块5执行完成!")
        print("请查看 runtime/outputs/ 目录下的图书卡片")
        print("=" * 60)
        return 0
    else:
        print("\n" + "=" * 60)
        print("X 模块5执行失败!")
        print("请检查错误日志")
        print("=" * 60)
        return 1
```

### 9.4 输出验证

执行完成后，验证输出：
```bash
# 检查目录结构
ls runtime/outputs/{书目条码}/

# 应包含：
# - {书目条码}.html
# - {书目条码}.png
# - pic/logo_shl.png
# - pic/logozi_shl.jpg
# - pic/cover.jpg (或 cover.png)
# - pic/qrcode.png

# 检查HTML文件
cat runtime/outputs/{书目条码}/{书目条码}.html

# 检查图片文件大小
ls -lh runtime/outputs/{书目条码}/*.png
```

---

## 10. 常见问题和解决方案

### 10.1 Playwright相关问题

#### Q1: 提示 "Executable doesn't exist"
```
原因：未安装Playwright浏览器
解决：python -m playwright install chromium
```

#### Q2: 截图为空白图片
```
原因：页面渲染未完成就截图
解决：增加 wait_time 配置（例如从2000ms增加到5000ms）
```

#### Q3: 浏览器启动超时
```
原因：系统资源不足或防火墙阻止
解决：
1. 增加 browser_startup_timeout
2. 检查防火墙设置
3. 减少并发数
```

### 10.2 图片下载问题

#### Q4: 豆瓣图片下载失败 403
```
原因：请求头不完整或频率过高
解决：
1. 添加完整的User-Agent
2. 增加请求延迟
3. 检查图片URL是否有效
```

#### Q5: 图片格式识别错误
```
原因：服务器返回的Content-Type不准确
解决：使用魔数（Magic Number）检测真实格式
```

### 10.3 数据处理问题

#### Q6: 索书号中的特殊字符未正确编码
```
原因：encoding_rules 不完整
解决：补充缺失的特殊字符映射规则
```

#### Q7: 中文字符在HTML中显示乱码
```
原因：HTML文件编码不是UTF-8
解决：确保保存HTML时指定 encoding='utf-8'
```

### 10.4 性能问题

#### Q8: 批量处理速度太慢
```
原因：浏览器频繁启动和关闭
解决：
1. 复用浏览器实例
2. 使用线程池并发下载图片
3. 缓存HTML模板
```

#### Q9: 内存占用过高
```
原因：浏览器实例未正确释放
解决：
1. 使用 try-finally 确保浏览器关闭
2. 减少并发数
3. 分批处理大量数据
```

---

## 11. 后续优化方向

### 11.1 功能增强
- [ ] 支持自定义HTML模板（配置多套模板）
- [ ] 支持批量导出为PDF
- [ ] 支持自定义卡片尺寸
- [ ] 支持水印添加
- [ ] 支持卡片背景颜色自定义

### 11.2 性能优化
- [ ] 实现增量处理（跳过已生成的卡片）
- [ ] 实现断点续传（中断后可继续）
- [ ] 优化浏览器复用策略
- [ ] 实现分布式处理（多机并行）

### 11.3 用户体验
- [ ] 添加进度条显示
- [ ] 添加预览功能（生成前预览效果）
- [ ] 添加交互式配置界面
- [ ] 支持批量导出为ZIP压缩包

---

## 12. 附录

### 12.1 关键代码片段

#### 12.1.1 从Excel提取数据
```python
def extract_book_data(row: pd.Series) -> BookCardData:
    """从Excel行数据提取图书卡片数据"""

    # 书名处理（优先豆瓣书名）
    if pd.notna(row['豆瓣书名']) and str(row['豆瓣书名']).strip():
        title = str(row['豆瓣书名']).strip()
    else:
        title = str(row['书名']).strip() if pd.notna(row['书名']) else ""

    # 副标题处理
    subtitle = None
    if pd.notna(row['豆瓣副标题']) and str(row['豆瓣副标题']).strip():
        subtitle = str(row['豆瓣副标题']).strip()

    # 可选字段处理
    author = str(row['豆瓣作者']).strip() if pd.notna(row['豆瓣作者']) else None
    publisher = str(row['豆瓣出版社']).strip() if pd.notna(row['豆瓣出版社']) else None
    pub_year = str(row['豆瓣出版年']).strip() if pd.notna(row['豆瓣出版年']) else None

    return BookCardData(
        barcode=str(row['书目条码']).strip(),
        call_number=str(row['索书号']).strip(),
        douban_rating=float(row['豆瓣评分']),
        final_review_reason=str(row['终评理由']).strip(),
        cover_image_url=str(row['豆瓣封面图片链接']).strip(),
        title=title,
        subtitle=subtitle,
        author=author,
        publisher=publisher,
        pub_year=pub_year
    )
```

#### 12.1.2 HTML模板填充
```python
def fill_template(template: str, book_data: BookCardData) -> str:
    """填充HTML模板"""

    # 定义占位符映射
    replacements = {
        '{{AUTHOR}}': book_data.author or '',
        '{{TITLE}}': book_data.full_title,
        '{{PUBLISHER}}': book_data.publisher or '',
        '{{PUB_YEAR}}': book_data.pub_year or '',
        '{{CALL_NUMBER}}': book_data.call_number,
        '{{DOUBAN_RATING}}': str(book_data.douban_rating),
        '{{RECOMMENDATION}}': book_data.truncated_reason
    }

    # 执行替换
    html = template
    for placeholder, value in replacements.items():
        html = html.replace(placeholder, value)

    return html
```

### 12.2 参考资料

- [Playwright官方文档](https://playwright.dev/python/)
- [qrcode库文档](https://pypi.org/project/qrcode/)
- [Pillow文档](https://pillow.readthedocs.io/)
- [pandas文档](https://pandas.pydata.org/docs/)

---

**文档版本**: 1.0
**创建日期**: 2025-01-18
**最后更新**: 2025-01-18
**维护者**: 开发团队
