# 模块6：新书零借阅（睡美人）需求与开发文档

## 1. 模块概述
本模块（模块6）旨在筛选出近期验收的新书在随后几个月内未被借阅的图书（即“睡美人”），并对其进行推荐，以提高馆藏利用率。

## 2. 需求描述
根据 `docs/changelogs/模块6-新书零借阅/初始需求描述.md`，主要流程如下：

1.  **数据源**：
    -   新验收图书：`data/new/验收.xlsx`
    -   借阅数据：`data/new/近四月借阅.xlsx`
2.  **零借阅筛选**：
    -   筛选出在当月及其未来三个月内（共四个月）零借阅的图书。
    -   匹配逻辑：`新书.馆藏条码` == `借阅数据.书目条码`。
    -   **数据预处理**：
        -   将验收Excel的列 `馆藏条码` 改名为 `书目条码`。
        -   将验收Excel的列 `标识号` 改名为 `isbn`。
3.  **常规过滤**：
    -   复用现有的题名过滤（`config/filters/title_keywords.txt`）。
    -   复用现有的分类号过滤（`config/filters/call_number_clc.txt`）。
4.  **信息补全与增强**：
    -   **FOLIO ISBN获取**：检查 `isbn` 列，如果为空，则执行FOLIO ISBN获取逻辑（需复用或新建逻辑），并回写。
    -   **DB查重/Douban信息**：复用模块3逻辑（DB查重 -> 豆瓣ISBN检索 -> 豆瓣API获取完整信息）。
5.  **智能评选**：
    -   复用模块4逻辑（大模型三轮评选）。
6.  **输出**：
    -   生成符合后续模块处理格式的Excel文件。
    -   生成统计分析报告。

## 3. 架构设计

### 3.1 数据流
```mermaid
graph TD
    A[data/new/验收.xlsx] --> B(数据加载与清洗)
    C[data/new/近四月借阅.xlsx] --> B
    B --> D{零借阅筛选}
    D -->|未借阅| E[零借阅书目清单]
    E --> F{常规过滤\n(题名/分类号)}
    F --> G[初选书目清单]
    G --> H[FOLIO ISBN补全]
    H --> I[模块3: 豆瓣信息增强]
    I --> J[模块4: 智能评选]
    J --> K[最终推荐清单]
```

### 3.2 模块复用策略
*   **高度复用**：
    *   `src.core.data_filter.BookFilterFinal`: 用于题名和分类号过滤。
    *   `src.core.douban`: 用于豆瓣信息获取（模块3）。
    *   `src.core.recommendation`: 用于大模型评选（模块4）。
    *   `src.core.card_generator`: 用于生成卡片（模块5）。
*   **新增开发**：
    *   `src.core.data_loader`: 新增加载 `验收.xlsx` 和 `近四月借阅.xlsx` 的函数。
    *   `src.core.new_sleeping`: 新增核心逻辑包。
        *   `data_loader.py`: 专用于本模块的数据加载与预处理（列重命名）。
        *   `filter.py`: 实现零借阅筛选逻辑。
        *   `pipeline.py`: 串联整个流程。

## 4. 开发计划

### 4.1 阶段一：基础架构与数据处理
1.  **修改 `src/core/data_loader.py`**：
    *   添加 `load_new_books_data(file_path)`：加载验收数据。
    *   添加 `load_borrowing_data_4months(file_path)`：加载近四月借阅数据。
2.  **创建 `src/core/new_sleeping/preprocessor.py`**：
    *   实现数据清洗：列重命名 (`馆藏条码` -> `书目条码`, `标识号` -> `isbn`)。
    *   实现ISBN列的清洗和预处理。

### 4.2 阶段二：零借阅筛选逻辑
1.  **创建 `src/core/new_sleeping/filter.py`**：
    *   实现 `ZeroBorrowingFilter` 类。
    *   输入：新书DataFrame，借阅DataFrame。
    *   逻辑：`新书[~新书['书目条码'].isin(借阅['书目条码'])]`。
    *   输出：零借阅图书DataFrame。

### 4.3 阶段三：流程串联与主程序集成
1.  **创建 `src/core/new_sleeping/pipeline.py`**：
    *   实现 `run_new_sleeping_pipeline()` 函数。
    *   调用Loader -> Preprocessor -> ZeroBorrowingFilter -> BookFilterFinal (常规过滤) -> Exporter。
2.  **修改 `main.py`**：
    *   添加“模块6：新书零借阅”菜单项。
    *   调用 `run_new_sleeping_pipeline()`。

### 4.4 阶段四：后续模块对接
1.  确保输出的Excel文件格式（列名）与模块3（豆瓣模块）兼容。
2.  验证模块3、4、5能否无缝处理模块6的输出结果。
    *   *注意*：模块3通常查找 `月归还数据筛选结果_*.xlsx`。模块6输出的文件名应遵循类似规范或修改模块3的查找逻辑。建议模块6输出为 `新书零借阅筛选结果_YYYYMMDD_HHMMSS.xlsx`，并修改 `main.py` 中的文件查找逻辑以支持该前缀，或者让用户手动选择文件。

## 5. 数据结构定义

### 5.1 输入数据
*   **验收数据** (`data/new/验收.xlsx`)：
    *   必需列：`馆藏条码`, `标识号` (将被重命名为 `isbn`), `题名`, `索书号` (用于分类号过滤)。
*   **借阅数据** (`data/new/近四月借阅.xlsx`)：
    *   必需列：`书目条码` (用于匹配)。

### 5.2 输出数据
*   **筛选结果Excel**：
    *   包含列：`书目条码`, `isbn`, `题名`, `索书号`, `作者`, `出版社` 等（保留原验收数据的所有列）。
    *   文件名：`runtime/outputs/新书零借阅筛选结果_{timestamp}.xlsx`。

## 6. 注意事项
*   **代码工艺**：遵循 `agents.md` 中的规范，保持代码简洁，添加中文注释。
*   **配置管理**：在 `config/setting.yaml` (如果存在) 或代码常量中定义文件路径，避免硬编码。
*   **日志记录**：使用 `src.utils.logger` 记录关键步骤和统计信息。
