# 模块6：新书零借阅（睡美人）实现说明

## 概述
模块6已成功实现，用于筛选近期验收但在随后几个月内零借阅的新书（"睡美人"图书）。

## 实现的文件

### 1. 数据加载器扩展
**文件**: `src/core/data_loader.py`
- 新增 `load_new_books_data()` 函数：加载新书验收数据
- 新增 `load_borrowing_data_4months()` 函数：加载近四月借阅数据

### 2. 新书零借阅模块
**目录**: `src/core/new_sleeping/`

#### 2.1 `__init__.py`
模块初始化文件，导出主要功能。

#### 2.2 `preprocessor.py`
数据预处理器，负责：
- 列重命名：`馆藏条码` → `书目条码`
- 列重命名：`标识号` → `isbn`
- ISBN列清洗和数据验证

#### 2.3 `filter.py`
零借阅筛选器，实现核心筛选逻辑：
- `ZeroBorrowingFilter` 类
- 筛选逻辑：`新书[~新书['书目条码'].isin(借阅['书目条码'])]`
- 提供详细的统计信息

#### 2.4 `pipeline.py`
流程管理器，协调整个处理流程：
1. 加载新书验收数据
2. 加载近四月借阅数据
3. 数据预处理（列重命名）
4. 零借阅筛选
5. 常规过滤（复用题名、分类号过滤器）
6. 输出结果和报告

### 3. 主程序集成
**文件**: `main.py`
- 新增 `run_module6()` 函数
- 在主菜单中添加"模块6: 新书零借阅（睡美人）筛选"选项

### 4. 配置文件更新
**文件**: `config/setting.yaml`
- 添加 `new_books_file` 配置项：`data/new/验收.xlsx`
- 添加 `borrowing_4months_file` 配置项：`data/new/近四月借阅.xlsx`

## 数据流程

```
验收.xlsx (新书数据)
    ↓
数据预处理 (列重命名)
    ↓
零借阅筛选 ← 近四月借阅.xlsx
    ↓
常规过滤 (题名、分类号)
    ↓
输出结果
```

## 输出文件

模块6运行后会在 `runtime/outputs/` 目录生成以下文件：

1. **数据筛选结果_{timestamp}.xlsx**
   - **统一命名**：与模块1输出保持一致，以便后续模块自动识别
   - **新增列**：
     - `数据来源`：固定为"新书零借阅"（模块1输出为"月归还借阅"）
     - `评选批次`：默认为当前月份（如2025-12）
   - **内容**：通过所有筛选的零借阅图书清单
   - **用途**：可直接用于后续模块3（豆瓣信息获取）、模块4（评选）、模块5（卡片生成）

2. **新书零借阅_被过滤数据_{timestamp}.xlsx**
   - 被常规过滤器排除的数据
   - 包含过滤原因说明

3. **新书_有借阅图书_{timestamp}.xlsx**
   - 有借阅记录的新书（供参考）

4. **新书零借阅筛选报告_{timestamp}.txt**
   - 详细的统计报告
   - 包含零借阅统计、过滤统计、分类统计等

## 使用方法

### 1. 准备数据文件
将以下文件放置在指定位置：
- `data/new/验收.xlsx`：新书验收数据
- `data/new/近四月借阅.xlsx`：近四月借阅数据

### 2. 运行模块
```bash
python main.py
```
选择菜单项 `8. 模块6: 新书零借阅（睡美人）筛选`

### 3. 后续处理（无缝衔接）
由于采用了统一的文件命名规范（`数据筛选结果_*.xlsx`）和内部标识列（`数据来源`），您可以直接运行后续模块，系统会自动识别并处理：

- **模块3**：豆瓣信息获取
  - 自动读取最新的筛选结果
  - 识别`数据来源`为"新书零借阅"并记录日志
- **模块4**：智能评选
  - 在评选报告中注明数据来源
- **模块5**：图书卡片生成
  - 在卡片生成报告中注明数据来源

## 数据要求

### 验收.xlsx 必需列
- `馆藏条码`（将被重命名为`书目条码`）
- `标识号`（将被重命名为`isbn`）
- `题名`（用于题名过滤）
- `索书号`（用于分类号过滤）

### 近四月借阅.xlsx 必需列
- `书目条码`（用于匹配）

## 特性

1. **高度复用**：复用现有的过滤器（题名、分类号、数据库查重）
2. **完整日志**：详细记录每个步骤的执行情况
3. **统计报告**：生成详细的筛选统计报告
4. **错误处理**：完善的异常处理和错误提示
5. **配置灵活**：通过配置文件管理数据路径

## 注意事项

1. **列重命名**：模块会自动将`馆藏条码`重命名为`书目条码`，`标识号`重命名为`isbn`
2. **空值处理**：书目条码为空的记录会被排除，不参与零借阅筛选
3. **过滤器复用**：使用与模块1/2相同的题名和分类号过滤规则
4. **数据库查重**：如果启用，会自动排除已入选的书目

## 后续优化建议

1. 可以添加FOLIO ISBN获取功能（复用模块3逻辑）
2. 可以添加验收时间范围筛选
3. 可以添加更多统计维度（如出版社、出版年份等）
