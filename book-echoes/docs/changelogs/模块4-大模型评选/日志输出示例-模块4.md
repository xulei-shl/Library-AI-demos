# 模块4 主题推荐评选 - 日志输出示例

## 改进前的日志输出

```
请输入选择 (1-7): 4
============================================================
模块4: 主题推荐评选(初评)
按主题分批调用模型并写回初评结果
============================================================
时间=2025-11-17 14:16:52 | 级别=信息 | 模块=src.utils.llm.prompt_loader | 行号=131 | 函数=_load_from_langfuse | 信息=已从 Langfuse 加载提示词: 书目初评
时间=2025-11-17 14:16:52 | 级别=信息 | 模块=src.utils.llm.retry | 行号=48 | 函数=call_with_retry | 信息=调用LLM | 任务=theme_initial | Provider=oneapi | 尝试=1/3
时间=2025-11-17 14:17:48 | 级别=信息 | 模块=src.utils.llm.retry | 行号=48 | 函数=call_with_retry | 信息=调用LLM | 任务=theme_initial | Provider=oneapi | 尝试=1/3
时间=2025-11-17 14:19:24 | 级别=信息 | 模块=src.utils.llm.retry | 行号=48 | 函数=call_with_retry | 信息=调用LLM | 任务=theme_initial | Provider=oneapi | 尝试=1/3
时间=2025-11-17 14:20:15 | 级别=信息 | 模块=src.utils.llm.retry | 行号=48 | 函数=call_with_retry | 信息=调用LLM | 任务=theme_initial | Provider=oneapi | 尝试=1/3
时间=2025-11-17 14:21:47 | 级别=信息 | 模块=src.utils.llm.retry | 行号=48 | 函数=call_with_retry | 信息=调用LLM | 任务=theme_initial | Provider=oneapi | 尝试=1/3
```

**问题**:
- 不知道候选数据总共有多少条
- 不知道已处理多少、待处理多少
- 不知道有几个主题大类
- 不知道当前处理的是什么主题(只能从时间戳推测进度)
- 不知道每个主题有多少条数据、分成几批
- 不知道正在处理第几批

## 改进后的日志输出

```
请输入选择 (1-7): 4
============================================================
模块4: 主题推荐评选(初评)
按主题分批调用模型并写回初评结果
============================================================
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=已过滤 150 条已有初评结果的数据,剩余 350 条待处理
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=============================================================
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=主题初评任务开始
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=候选数据总数: 500 条
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=已完成数据: 150 条
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=待处理数据: 350 条
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=主题大类总数: 15 个
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=总批次数量: 23 批
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=------------------------------------------------------------
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=主题 [A]: 45 条 -> 3 批 (批次大小: 15, 15, 15)
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=主题 [B]: 28 条 -> 2 批 (批次大小: 14, 14)
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=主题 [C]: 32 条 -> 2 批 (批次大小: 16, 16)
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=主题 [D]: 18 条 -> 1 批 (批次大小: 18)
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=主题 [E]: 55 条 -> 3 批 (批次大小: 19, 18, 18)
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=主题 [F]: 22 条 -> 2 批 (批次大小: 11, 11)
... (其他主题统计)
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=============================================================

时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=开始处理主题 [A] (1/15)
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=主题 [A] 包含 45 条数据,分为 3 批
时间=2025-11-17 14:16:50 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=-> 主题 [A] 第 1/3 批,本批 15 条 | 总进度: 1/23 批, 15/350 条
时间=2025-11-17 14:16:51 | 级别=信息 | 模块=src.core.recommendation.executor | 信息=准备调用LLM | 主题=A | 书目数=15 | 推荐配额=5
时间=2025-11-17 14:16:51 | 级别=信息 | 模块=src.core.recommendation.executor | 信息=正在调用LLM进行初评 | 主题=A | 书目数=15
时间=2025-11-17 14:16:52 | 级别=信息 | 模块=src.utils.llm.prompt_loader | 信息=已从 Langfuse 加载提示词: 书目初评
时间=2025-11-17 14:16:52 | 级别=信息 | 模块=src.utils.llm.retry | 信息=调用LLM | 任务=theme_initial | Provider=oneapi | 尝试=1/3
时间=2025-11-17 14:17:45 | 级别=信息 | 模块=src.core.recommendation.executor | 信息=LLM初评调用成功 | 主题=A | 响应长度=1852
时间=2025-11-17 14:17:45 | 级别=信息 | 模块=src.core.recommendation.executor | 信息=初评完成 | 主题=A | 书目数=15 | 选中=5 | 未选中=10
时间=2025-11-17 14:17:45 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=-> 主题 [A] 第 1/3 批完成,本批选中 5 条

时间=2025-11-17 14:17:45 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=-> 主题 [A] 第 2/3 批,本批 15 条 | 总进度: 2/23 批, 30/350 条
时间=2025-11-17 14:17:46 | 级别=信息 | 模块=src.core.recommendation.executor | 信息=准备调用LLM | 主题=A | 书目数=15 | 推荐配额=5
时间=2025-11-17 14:17:46 | 级别=信息 | 模块=src.core.recommendation.executor | 信息=正在调用LLM进行初评 | 主题=A | 书目数=15
时间=2025-11-17 14:17:46 | 级别=信息 | 模块=src.utils.llm.retry | 信息=调用LLM | 任务=theme_initial | Provider=oneapi | 尝试=1/3
时间=2025-11-17 14:18:52 | 级别=信息 | 模块=src.core.recommendation.executor | 信息=LLM初评调用成功 | 主题=A | 响应长度=1923
时间=2025-11-17 14:18:52 | 级别=信息 | 模块=src.core.recommendation.executor | 信息=初评完成 | 主题=A | 书目数=15 | 选中=4 | 未选中=11
时间=2025-11-17 14:18:52 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=-> 主题 [A] 第 2/3 批完成,本批选中 4 条

时间=2025-11-17 14:18:52 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=-> 主题 [A] 第 3/3 批,本批 15 条 | 总进度: 3/23 批, 45/350 条
时间=2025-11-17 14:18:53 | 级别=信息 | 模块=src.core.recommendation.executor | 信息=准备调用LLM | 主题=A | 书目数=15 | 推荐配额=5
时间=2025-11-17 14:18:53 | 级别=信息 | 模块=src.core.recommendation.executor | 信息=正在调用LLM进行初评 | 主题=A | 书目数=15
时间=2025-11-17 14:18:53 | 级别=信息 | 模块=src.utils.llm.retry | 信息=调用LLM | 任务=theme_initial | Provider=oneapi | 尝试=1/3
时间=2025-11-17 14:20:01 | 级别=信息 | 模块=src.core.recommendation.executor | 信息=LLM初评调用成功 | 主题=A | 响应长度=1795
时间=2025-11-17 14:20:01 | 级别=信息 | 模块=src.core.recommendation.executor | 信息=初评完成 | 主题=A | 书目数=15 | 选中=5 | 未选中=10
时间=2025-11-17 14:20:01 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=-> 主题 [A] 第 3/3 批完成,本批选中 5 条
时间=2025-11-17 14:20:01 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=主题 [A] 处理完成 (1/15)

时间=2025-11-17 14:20:01 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=
时间=2025-11-17 14:20:01 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=开始处理主题 [B] (2/15)
时间=2025-11-17 14:20:01 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=主题 [B] 包含 28 条数据,分为 2 批
时间=2025-11-17 14:20:01 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=-> 主题 [B] 第 1/2 批,本批 14 条 | 总进度: 4/23 批, 59/350 条
... (继续处理其他主题)

时间=2025-11-17 14:45:32 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=
时间=2025-11-17 14:45:32 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=============================================================
时间=2025-11-17 14:45:32 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=所有主题初评完成: 共处理 23 批,350 条数据
时间=2025-11-17 14:45:32 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=============================================================

时间=2025-11-17 14:45:32 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=
时间=2025-11-17 14:45:32 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=============================================================
时间=2025-11-17 14:45:32 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=开始兜底重试失败数据
时间=2025-11-17 14:45:32 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=发现 5 条失败数据
时间=2025-11-17 14:45:32 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=重试主题数: 2 个
时间=2025-11-17 14:45:32 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=重试总批次: 1 批
时间=2025-11-17 14:45:32 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=------------------------------------------------------------
时间=2025-11-17 14:45:32 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=重试主题 [C]: 3 条 -> 1 批
时间=2025-11-17 14:45:32 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=重试主题 [F]: 2 条 -> 1 批
时间=2025-11-17 14:45:32 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=============================================================
时间=2025-11-17 14:45:32 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=
时间=2025-11-17 14:45:32 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=兜底重试主题 [C] (1/2)
时间=2025-11-17 14:45:32 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=-> 兜底重试 [C] 第 1/1 批,本批 3 条 | 总进度: 1/2 批
时间=2025-11-17 14:45:33 | 级别=信息 | 模块=src.core.recommendation.executor | 信息=准备调用LLM | 主题=C | 书目数=3 | 推荐配额=2
时间=2025-11-17 14:45:33 | 级别=信息 | 模块=src.core.recommendation.executor | 信息=正在调用LLM进行初评 | 主题=C | 书目数=3
时间=2025-11-17 14:45:33 | 级别=信息 | 模块=src.utils.llm.retry | 信息=调用LLM | 任务=theme_initial | Provider=oneapi | 尝试=1/3
时间=2025-11-17 14:46:15 | 级别=信息 | 模块=src.core.recommendation.executor | 信息=LLM初评调用成功 | 主题=C | 响应长度=856
时间=2025-11-17 14:46:15 | 级别=信息 | 模块=src.core.recommendation.executor | 信息=初评完成 | 主题=C | 书目数=3 | 选中=2 | 未选中=1
时间=2025-11-17 14:46:15 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=-> 兜底重试 [C] 第 1/1 批完成,成功更新 3 条
... (继续重试其他失败数据)

时间=2025-11-17 14:47:22 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=
时间=2025-11-17 14:47:22 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=============================================================
时间=2025-11-17 14:47:22 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=兜底重试完成: 共处理 2 批,成功更新 5 条数据
时间=2025-11-17 14:47:22 | 级别=信息 | 模块=src.core.recommendation.controller | 信息=============================================================

[成功] 模块4初评执行完成!
请查看筛选结果Excel的初评列
============================================================
```

## 改进点总结

### 1. 任务开始时的总体统计
- 候选数据总数
- 已完成数据数量
- 待处理数据数量
- 主题大类总数
- 总批次数量
- 每个主题的详细统计(数据条数、批次数、批次大小)

### 2. 主题处理进度
- 当前处理的主题名称和序号(如 "主题 [A] (1/15)")
- 主题包含的数据条数和批次数
- 每批的详细进度(当前批次/总批次)
- 总体进度(已处理批次/总批次,已处理条数/总条数)

### 3. LLM调用详情
- 调用前:主题、书目数、推荐配额
- 调用中:正在调用、主题、书目数
- 调用成功:主题、响应长度
- 调用完成:主题、书目数、选中数、未选中数

### 4. 批次完成信息
- 每批完成后立即输出选中数量
- 主题完成后输出主题序号

### 5. 兜底重试详情
- 失败数据总数
- 重试主题数和总批次
- 每个重试主题的详细统计
- 重试进度和成功更新的数据条数

### 6. 任务完成汇总
- 总共处理的批次数
- 总共处理的数据条数
- 重试处理的批次数和成功更新的数据条数

## 对用户的价值

1. **透明度**: 用户可以清楚地知道整个任务的规模和当前进度
2. **可预测性**: 根据已处理批次的时间,可以估算剩余任务的完成时间
3. **可追溯性**: 每个主题、每批的处理情况都有详细记录
4. **问题诊断**: 如果某个批次耗时特别长,可以快速定位到具体主题和批次
5. **进度监控**: 在长时间运行的任务中,用户可以实时了解进展,而不是只看到一些看似重复的"调用LLM"日志
