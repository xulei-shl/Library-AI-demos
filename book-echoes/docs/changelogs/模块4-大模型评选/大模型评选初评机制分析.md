# 大模型评选初评机制分析报告

## 问题1: 初评阶段是否按照索书号首字母分组？

**答案：是的，确实按照索书号首字母分组。**

### 证据分析：

1. **分组逻辑** (`theme_grouper.py`):
```python
def group_by_theme(df: pd.DataFrame) -> Dict[str, pd.DataFrame]:
    groups: Dict[str, List[int]] = {}
    for idx, row in df.iterrows():
        theme = normalize_theme(str(row.get('索书号', '')))  # 关键：使用索书号
        groups.setdefault(theme, []).append(idx)
    result: Dict[str, pd.DataFrame] = {}
    for theme, indices in groups.items():
        result[theme] = df.loc[indices]
    return result
```

2. **主题标准化函数** (`config.py`):
```python
def normalize_theme(code: str) -> str:
    if not code:
        return "Other"
    ch = str(code).strip()[0]  # 获取索书号第一个字符
    if ch.isalpha():
        return ch.upper()      # 转为大写字母作为主题标识
    return "Other"
```

3. **分组效果**:
   - 索书号以A开头的 → 主题"A"
   - 索书号以B开头的 → 主题"B" 
   - 索书号以数字开头的 → 主题"Other"
   - 索书号为空或无效 → 主题"Other"

## 问题2: 每个主题大类的初选结果是否立刻写入Excel？

**答案：不是立刻写入。每个主题处理完成后才写入一次。**

### 详细分析：

1. **处理流程** (`run_theme_recommendation_initial`):

```python
for theme_idx, (theme, gdf) in enumerate(groups.items(), 1):  # 按主题循环
    books = [_to_book_dict(row) for _, row in gdf.iterrows()]
    batches = split_batches(books, batch_size)  # 将该主题数据分批

    # 处理该主题的所有批次
    for batch_idx, batch in enumerate(batches, 1):
        result = executor.initial(theme, batch)  # 调用大模型初评
        writer.write_initial(result)             # 立即写入本批结果
        
        # ... 处理选中结果 ...
    
    # 主题处理完毕，保存Excel
    writer.save()  # 在每个主题完成后才统一保存
```

2. **关键特点**:
   - **批次内立即写入**: 每批数据调用大模型后，结果立即通过 `writer.write_initial(result)` 写入内存中的DataFrame
   - **主题完成后保存**: 只有当一个主题的所有批次都处理完后，才调用 `writer.save()` 将数据写入Excel文件
   - **内存缓存机制**: 使用 `ExcelRecommendationWriter` 在内存中维护数据，避免频繁的Excel文件I/O操作

3. **写入时机对比**:
   ```python
   # 每批处理后：写入内存DataFrame
   writer.write_initial(result)  # 立即更新内存数据
   
   # 主题完成后：写入Excel文件
   writer.save()                # 批量写入磁盘
   ```

## 总结

1. **分组机制**: 按照索书号首字母分组，A-Z分别对应不同主题，数字和其他字符归为"Other"
2. **写入策略**: 采用"批次内立即写入内存 + 主题完成后批量写入磁盘"的双层写入机制
   - 优点：避免频繁的Excel文件操作，提升性能
   - 特点：每个主题处理完成后统一保存一次，中间结果缓存在内存中

这种设计在大规模数据处理时能够有效平衡性能和数据安全性。
