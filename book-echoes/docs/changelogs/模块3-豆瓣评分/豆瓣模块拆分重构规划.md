# 模块3-豆瓣评分：FOLIO ISBN 与豆瓣爬取拆分重构规划

> 目标：保留现有爬取与数据库策略，实现“FOLIO ISBN 流程”和“豆瓣评分流程”**串行解耦**，提升稳定性并降低互相阻断风险。

## 背景与痛点
- 现状：`douban_main.py` 及 `isbn_async_processor.py` 将 FOLIO 与豆瓣流程混合异步执行，任一失败会拖垮另一条流水线。
- 典型问题：豆瓣端失败率高（超时 / 403 / captcha 等），导致 FOLIO ISBN 浏览器会话提前中断，Excel 写入与 DB 入库都被迫回滚。
- 诉求：保证 FOLIO 爬取和数据库写回可以在豆瓣完全执行前就稳定完成；豆瓣阶段仅处理“仍需补全”的记录，并在结束时单独生成报告。

## 重构目标
1. **流程拆分**：FOLIO ISBN 流程与豆瓣流程在入口与实现层完全解耦，可独立触发与重试。
2. **数据库优先**：两阶段都必须先查 DB，命中后直接落地 Excel，减少重复爬取。
3. **失败重试闭环**：各阶段结束时收集失败清单 → 自动重试 → 仍失败则带场景信息写回日志 / 报告。
4. **结果持久化**：阶段输出要么更新 Excel，要么写入 DB，杜绝“半程成功但未持久化”的状态。
5. **旧逻辑备份**：所有混合异步实现迁移至 `src/core/douban/async/`，保持可回滚能力。

## 目标流程概览
```
模块3启动（main.py 触发）
┌─ 阶段A：FOLIO ISBN 流程
│   1. Excel -> DataFrame
│   2. DB 查重（条码 / isbn 列）
│   3. 命中：直接写回 Excel 并记录命中来源
│   4. 未命中：调用 FOLIO 爬虫（可继续沿用现有 browser controller）
│   5. 当批完成：失败列表自动重试（保持原重试策略）
│   6. 最终新增/更新写回 DB，更新 Excel
└─ 阶段B：豆瓣评分流程
    1. 读取同一 Excel / DB
    2. DB 查重（按 isbn）
    3. 命中或最近成功：写回 Excel，标记“来源=DB”
    4. 仅对 “超时 / 豆瓣失败 / DB 无记录” 的条目执行爬虫
    5. 阶段结束再次重试失败条目
    6. 成功数据写回 DB & Excel，生成豆瓣结果报告 txt
```

## 模块拆分建议
| 模块 | 新职责 | 复用资产 |
|------|--------|----------|
| `folio_isbn_pipeline.py`（新增） | 聚合 Excel 读取、DB 查重、FOLIO 浏览器调度、Excel 更新、失败重试 | `crawler/`、`database/`、`progress_manager.py`、`report_generator.py`（部分） |
| `douban_rating_pipeline.py`（新增） | 豆瓣查重、爬虫调度、Excel 更新、txt 报告、失败重试 | `douban_rating_processor.py`、`report_generator.py` |
| `pipeline_runner.py`（新增） | 将两个 pipeline 以同步流程编排，可被 `douban_main.py` 和 `main.py` 复用 | `douban_main.py` 中现有 CLI / 配置解析逻辑 |
| `async/` 目录 | 迁移旧的 `isbn_async_processor.py`, `douban_rating_processor_async.py`, 以及任何混合调用入口，保留说明文档 | 原文件本体 |

## 入口与 CLI 调整
- `src/core/douban/douban_main.py`
  - `isbn` 命令仅触发 **FOLIO 流程**。
  - 新增 `douban`/`douban-rating` 命令时，仅触发 **豆瓣流程**。
  - `pipeline_runner` 提供 `run_full_pipeline(excel, options)`，在 `main.py` 模块3选项中顺序执行 `folio -> douban`。
- `main.py`
  - 模块3（以及全流程）调用顺序：先跑 FOLIO pipeline，待成功/失败都入库后再跑豆瓣 pipeline。
  - 若第二阶段失败，不再影响第一阶段的结果。

## 数据库交互准则
1. **统一入口**：通过 `database/process_controller.py` 暴露 `fetch_from_db`, `write_back`, `mark_failed` 等方法，避免 pipeline 直接写 SQL。
2. **命中逻辑**：
   - FOLIO 阶段：若 DB 中存在非空 ISBN，对应 Excel 行直接更新并跳过爬虫。
   - 豆瓣阶段：优先查 `books` 表的豆瓣字段；若存在且未过期则直接写回。
3. **写入时机**：每阶段完成后一次性批量写 DB；失败重试后才最终提交。
4. **状态字段**：建议补充 `folio_status`, `douban_status`, `last_folio_sync`, `last_douban_sync`（如已有则复用），用于第二阶段过滤。

## 失败重试策略
- 阶段内部沿用 `progress_manager` 的失败收集与重试框架。
- FOLIO/豆瓣分别维护 `retry_queue`，重试策略相互独立。
- 仍失败的条目：
  - Excel 中保留原值，新增“失败原因”列或写入日志列。
  - `runtime/logs/` 写入结构化日志，并在豆瓣报告 txt 中给出统计。

## 文件与目录调整清单
1. **迁移备份**
   - `src/core/douban/isbn_async_processor.py` ➜ `src/core/douban/async/isbn_async_processor.py`
   - `src/core/douban/douban_rating_processor_async.py` ➜ `src/core/douban/async/douban_rating_processor_async.py`
   - 若 `douban_main.py` 中存在异步专用函数，也需复制旧版本到 `async` 目录保留。
2. **新增文件**
   - `src/core/douban/pipelines/folio_isbn_pipeline.py`
   - `src/core/douban/pipelines/douban_rating_pipeline.py`
   - `src/core/douban/pipelines/pipeline_runner.py`
3. **更新文件**
   - `src/core/douban/douban_main.py`：CLI、配置解析、串行调度。
   - `main.py`：模块3流程顺序化，提供明确的阶段状态输出。
   - 相关 `__init__.py`、`README.md`、配置文档。

## 测试与验证
1. **单元测试（test/）**
   - `test/douban/test_folio_pipeline.py`：模拟命中/未命中/失败重试。
   - `test/douban/test_douban_pipeline.py`：覆盖 DB 命中、爬虫回写、报告生成。
   - `test/douban/test_pipeline_runner.py`：验证串行执行顺序、异常隔离。
2. **集成验证**
   - CLI：`python main.py` 选择模块3，全流程串行完成。
   - 独立运行：`python src/core/douban/douban_main.py isbn ...`、`python ... douban-rating ...`
   - Excel/DB 差异化测试：① 全新数据；② 部分已存在；③ 强制更新。
3. **回归保证**
   - `async/` 目录保存旧实现，可通过临时 CLI 参数（如 `--legacy-async`）回切，方便比较。

## 风险与注意事项
- **浏览器 Session 管理**：FOLIO 流程结束后应显式关闭浏览器实例，防止豆瓣阶段误用旧 session。
- **配置继承**：保持 `config/setting.yaml` 中的结构不变，只新增 `pipelines.*` 或复用现有字段，避免破坏历史部署。
- **Excel 字段冲突**：新增状态/说明列需在文档中备案，避免覆盖用户自定义列。
- **日志语种**：按照 `.rules/agents.md` 要求，新增日志与注释统一使用中文。

## 里程碑
1. **准备阶段**：迁移旧文件 -> 建 pipeline 目录 -> 补文档（本文件）。
2. **实现阶段**：完成两个 pipeline + runner + CLI 调整。
3. **验证阶段**：补测试、手动跑样例 Excel、生成豆瓣报告。
4. **验收阶段**：更新 changelog、README、通知使用方操作变化。

## 2025-11-11 更新说明
1. **管线交付**：新增 Folio_isbn_pipeline.py、douban_rating_pipeline.py、pipeline_runner.py，douban_main.py/main.py CLI 改为串行调度并加入 Full 命令；旧异步实现统一迁入 src/core/douban/async/ 目录，保留回退能力。
2. **处理器升级**：DoubanRatingProcessor 支持 enable_isbn_pipeline，豆瓣阶段可按需跳过 FOLIO 登录；所有 sync 子模块改为 import_module 加载，解决相对导入失效；CLI 增加状态列、保存间隔、报告开关等参数。
3. **测试补齐**：新增 	est/douban/test_folio_pipeline.py、	est_douban_pipeline.py、	est_pipeline_runner.py，通过 monkeypatch 验证命中、报告与串联逻辑，pytest test/douban 已通过。

## 使用说明
### 仅执行 FOLIO ISBN 流程
`
python src/core/douban/douban_main.py isbn ^
  --excel-file runtime/outputs/待处理.xlsx ^
  --barcode-column 书目条码 ^
  --output-column ISBN ^
  --config-name balanced ^
  --save-interval 5
`

### 仅执行豆瓣评分流程
`
python src/core/douban/douban_main.py douban-rating ^
  --excel-file runtime/outputs/待处理.xlsx ^
  --isbn-column ISBN ^
  --status-column 处理状态 ^
  --disable-report ^
  --enable-isbn-resolution
`

### 串行跑完两阶段
`
python src/core/douban/douban_main.py full ^
  --excel-file runtime/outputs/待处理.xlsx ^
  --config-name balanced ^
  --db-path data/books_history.db
`
> --disable-database / --force-update / --db-path 会同时作用于两阶段；main.py 的模块 3 入口已经默认触发 ull。

---
此规划文档将作为后续开发与 Code Review 的依据，后续如需变更请在同目录追加补丁说明。


