# è±†ç“£è¯„åˆ†æ¨¡å—æ•°æ®åº“åŠŸèƒ½å¼€å‘æ–‡æ¡£ï¼ˆé›†æˆç‰ˆï¼‰

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°è±†ç“£è¯„åˆ†æ¨¡å—æ•°æ®åº“åŠŸèƒ½çš„å¼€å‘è®¾è®¡ï¼Œé€šè¿‡**æ— ç¼é›†æˆ**åˆ°ç°æœ‰çš„ `douban-rating` ä¸»æµç¨‹ä¸­ï¼Œå®ç°ï¼š
1. **æ™ºèƒ½æŸ¥é‡** - æ ¹æ®barcodeè‡ªåŠ¨æ£€æŸ¥æ•°æ®åº“ï¼Œé¿å…é‡å¤çˆ¬å–
2. **è‡ªåŠ¨æ›´æ–°** - æ ¹æ®æ•°æ®åˆ›å»ºæ—¶é—´æ™ºèƒ½åˆ·æ–°è±†ç“£ä¿¡æ¯
3. **æµç¨‹é›†æˆ** - åœ¨ISBNè·å–â†’è±†ç“£çˆ¬å–â†’Excelæ›´æ–°çš„å®Œæ•´æµç¨‹ä¸­è‡ªåŠ¨åµŒå…¥æ•°æ®åº“æ“ä½œ
4. **çµæ´»é…ç½®** - é€šè¿‡ `config/setting.yaml` é…ç½®æŸ¥é‡å’Œåˆ·æ–°ç­–ç•¥

## ä¸šåŠ¡æµç¨‹å›¾

```mermaid
graph TD
    A[è¯»å–Excelæ•°æ®] --> B[å¯åŠ¨douban-ratingæµç¨‹]
    B --> C[åˆå§‹åŒ–æ•°æ®åº“è¿æ¥]
    C --> D[æ‰¹é‡æŸ¥é‡ï¼šæ ¹æ®barcodeæŸ¥è¯¢æ•°æ®åº“]
    D --> E{æ•°æ®çŠ¶æ€åˆ¤æ–­}
    E -->|å·²å­˜åœ¨ä¸”æœªè¿‡æœŸ| F[ä»æ•°æ®åº“è·å–è±†ç“£ä¿¡æ¯]
    E -->|å·²å­˜åœ¨ä½†è¿‡æœŸ| G[æ‰§è¡ŒISBNçˆ¬å–]
    E -->|ä¸å­˜åœ¨| G
    G --> H[æ‰§è¡Œè±†ç“£çˆ¬å–]
    F --> I[æ ‡è®°éœ€è¦æ›´æ–°Excel]
    H --> I
    I --> J[å®æ—¶æ›´æ–°Excelè±†ç“£å­—æ®µ]
    J --> K[æ‰€æœ‰æ•°æ®å¤„ç†å®Œæˆï¼Ÿ]
    K -->|å¦| D
    K -->|æ˜¯| L[æ‰¹é‡å†™å…¥æ•°æ®åº“]
    L --> M[å®Œæˆ]
```

## ä¸ç°æœ‰æ¨¡å—çš„é›†æˆç‚¹

### ä¸»å…¥å£å‘½ä»¤

é€šè¿‡ `douban-rating` å‘½ä»¤å®ç°å®Œæ•´æµç¨‹ï¼š

```bash
# å®Œæ•´æµç¨‹ï¼ˆæ¨èï¼‰
python src/core/douban/douban_main.py douban-rating --excel-file "å€Ÿé˜…æ•°æ®.xlsx"

# å¸¦æµ‹è¯•æ¨¡å¼
python src/core/douban/douban_main.py douban-rating --excel-file "å€Ÿé˜…æ•°æ®.xlsx" --test

# æŒ‡å®šåˆ·æ–°ç­–ç•¥
python src/core/douban/douban_main.py douban-rating --excel-file "å€Ÿé˜…æ•°æ®.xlsx" --force-update
```

## æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚

### 1. æ•°æ®åº“æŸ¥é‡åŠŸèƒ½ï¼ˆå¢é‡æ›´æ–°ï¼‰

- **åŠŸèƒ½æè¿°**ï¼šæ ¹æ® `barcode`ï¼ˆä¹¦ç›®æ¡ç ï¼‰æ‰¹é‡æŸ¥è¯¢æ•°æ®åº“
- **è¿”å›ç»“æœ**ï¼š
  - `existing_valid`ï¼šå·²å­˜åœ¨ä¸”æœ‰æ•ˆçš„æ•°æ®ï¼ˆç›´æ¥ä½¿ç”¨æ•°æ®åº“è±†ç“£ä¿¡æ¯ï¼‰
  - `existing_stale`ï¼šå·²å­˜åœ¨ä½†è¿‡æœŸéœ€è¦æ›´æ–°çš„æ•°æ®ï¼ˆé‡æ–°çˆ¬å–ï¼‰
  - `new`ï¼šæ•°æ®åº“ä¸­ä¸å­˜åœ¨çš„æ–°æ•°æ®ï¼ˆå®Œæ•´æµç¨‹ï¼šISBNçˆ¬å–+è±†ç“£çˆ¬å–ï¼‰

- **åˆ·æ–°ç­–ç•¥é…ç½®**ï¼š
```yaml
# config/setting.yaml
douban:
  database:
    refresh_strategy:
      enabled: true
      # è¶…è¿‡è¯¥å¤©æ•°çš„æ•°æ®éœ€è¦é‡æ–°çˆ¬å–ï¼ˆè±†ç“£è¯„åˆ†å¯èƒ½æ›´æ–°ï¼‰
      stale_days: 30  # é»˜è®¤30å¤©
      # å¼ºåˆ¶æ›´æ–°æ¨¡å¼ï¼ˆå¿½ç•¥æ—¶é—´é™åˆ¶ï¼‰
      force_update: false
```

### 2. æ•°æ®å†™å…¥åŠŸèƒ½
å°†ä»¥ä¸‹ä¸‰ç±»æ•°æ®å†™å…¥æ•°æ®åº“ï¼š
- **booksè¡¨**ï¼šåŸºç¡€ä¿¡æ¯ + è±†ç“£ä¿¡æ¯ï¼ˆ1:1å…³ç³»ï¼‰
- **borrow_recordsè¡¨**ï¼šå€Ÿé˜…è®°å½•ï¼ˆ1:å¤šå…³ç³»ï¼‰
- **borrow_statisticsè¡¨**ï¼šç»Ÿè®¡ä¿¡æ¯ï¼ˆ1:å¤šå…³ç³»ï¼ŒæŒ‰æœˆåº¦ï¼‰

### 3. Excelæ›´æ–°åŠŸèƒ½
æ ¹æ®æŸ¥é‡ç»“æœæ›´æ–°Excelï¼š
- **å·²å­˜åœ¨ä¸”æœ‰æ•ˆæ•°æ®**ï¼šä»æ•°æ®åº“æå–è±†ç“£å­—æ®µï¼Œå†™å…¥Excel
- **è¿‡æœŸ/æ–°æ•°æ®**ï¼šå°†çˆ¬å–çš„è±†ç“£ä¿¡æ¯å†™å…¥Excel

### 4. æµç¨‹æ§åˆ¶ï¼ˆæ— ç¼é›†æˆï¼‰

åœ¨ç°æœ‰ `isbn_async_processor.py` ä¸­é›†æˆæ•°æ®åº“åŠŸèƒ½ï¼š
- åœ¨å¼‚æ­¥å¤„ç†å‰æ‰§è¡ŒæŸ¥é‡
- åœ¨Excelæ›´æ–°æ—¶åµŒå…¥æ•°æ®åº“æ“ä½œ
- å®Œæˆåæ‰¹é‡å†™å…¥æ•°æ®åº“

## é…ç½®æ–‡ä»¶è®¾è®¡ï¼ˆconfig/setting.yamlï¼‰

### æ•°æ®åº“é…ç½®

```yaml
douban:
  # æ•°æ®åº“ç›¸å…³é…ç½®
  database:
    # æ•°æ®åº“æ–‡ä»¶è·¯å¾„
    db_path: "runtime/outputs/books_history.db"

    # æŸ¥é‡ç­–ç•¥
    duplicate_check:
      enabled: true
      # æŸ¥è¯¢å­—æ®µï¼šåŸºäºbarcodeæŸ¥é‡
      key_field: "barcode"
      # æ˜¯å¦å¯ç”¨æ‰¹é‡æŸ¥è¯¢ï¼ˆæ¨èï¼štrueï¼Œæ€§èƒ½æ›´å¥½ï¼‰
      batch_query: true

    # æ•°æ®åˆ·æ–°ç­–ç•¥
    refresh_strategy:
      enabled: true
      # è¶…è¿‡è¯¥å¤©æ•°çš„æ•°æ®éœ€è¦é‡æ–°çˆ¬å–ï¼ˆè±†ç“£è¯„åˆ†å¯èƒ½æ›´æ–°ï¼‰
      stale_days: 30  # é»˜è®¤30å¤©
      # å¼ºåˆ¶æ›´æ–°æ¨¡å¼ï¼ˆå¿½ç•¥æ—¶é—´é™åˆ¶ï¼‰
      force_update: false
      # æ›´æ–°æ–¹å¼ï¼šmergeï¼ˆä¿ç•™åŸè®°å½•å…¶ä»–å­—æ®µï¼‰æˆ– overwriteï¼ˆå®Œå…¨è¦†ç›–ï¼‰
      update_mode: "merge"

    # å†™å…¥ç­–ç•¥
    write_strategy:
      # æ‰¹é‡å†™å…¥å¤§å°ï¼ˆæé«˜æ€§èƒ½ï¼‰
      batch_size: 100
      # æ˜¯å¦å¯ç”¨äº‹åŠ¡ï¼ˆä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰
      use_transaction: true
      # å†™å…¥å®Œæˆåæ˜¯å¦åˆ›å»ºå¤‡ä»½
      create_backup: true

    # æ—¥å¿—ç­–ç•¥
    logging:
      # æ˜¯å¦è®°å½•è¯¦ç»†çš„SQLæ“ä½œ
      log_sql: false
      # æ˜¯å¦è®°å½•æ€§èƒ½ç»Ÿè®¡
      log_performance: true
```

## Pythonæ–‡ä»¶è®¾è®¡

### 1. `database_manager.py` - æ•°æ®åº“ç®¡ç†å™¨

**èŒè´£**ï¼šå°è£…æ‰€æœ‰æ•°æ®åº“æ“ä½œ

**ä¸»è¦åŠŸèƒ½**ï¼š
- åˆå§‹åŒ–æ•°æ®åº“ï¼ˆåˆ›å»ºè¡¨ã€ç´¢å¼•ï¼‰
- æ‰¹é‡æŸ¥é‡ï¼ˆæ ¹æ®barcodeåˆ—è¡¨+åˆ·æ–°ç­–ç•¥ï¼‰
- æ‰¹é‡å†™å…¥ä¸‰ç±»æ•°æ®
- æŸ¥è¯¢å®Œæ•´çš„ä¹¦ç±ä¿¡æ¯

**å…³é”®æ–¹æ³•**ï¼š
```python
class DatabaseManager:
    def init_database(self, db_path: str = "books_history.db")
    def batch_check_duplicates(self, barcodes: List[str], stale_days: int = 30) -> Dict:
        """
        æ‰¹é‡æŸ¥é‡ï¼Œè¿”å›åˆ†ç±»ç»“æœ

        Returns:
        {
            'existing_valid': [{'barcode': 'B001', 'data': book_data}, ...],
            'existing_stale': [{'barcode': 'B002', 'data': book_data}, ...],
            'new': ['B003', 'B004', ...]
        }
        """
    def batch_save_data(self, books_data, borrow_records_list, statistics_list)
    def get_book_by_barcode(self, barcode: str)
    def update_book_douban_info(self, barcode: str, douban_data: Dict)
    def close(self)
```

---

### 2. `data_checker.py` - æŸ¥é‡å¤„ç†å™¨

**èŒè´£**ï¼šå°è£…æŸ¥é‡é€»è¾‘ï¼Œä¸å¼‚æ­¥å¤„ç†å™¨åä½œ

**ä¸»è¦åŠŸèƒ½**ï¼š
- è°ƒç”¨DatabaseManagerè¿›è¡Œæ‰¹é‡æŸ¥é‡
- æ ¹æ®åˆ·æ–°ç­–ç•¥åˆ†ç±»æ•°æ®
- è¿”å›åˆ†ç±»ç»“æœä¾›ä¸Šå±‚ä½¿ç”¨

**å…³é”®æ–¹æ³•**ï¼š
```python
class DataChecker:
    def __init__(self, db_manager: DatabaseManager, refresh_config: Dict)

    def check_and_categorize_books(self, excel_data: List[Dict]) -> Dict:
        """
        æ£€æŸ¥å¹¶åˆ†ç±»ä¹¦ç±

        è¿”å›:
        {
            'existing_valid': [book_data1, book_data2, ...],  # ä»DBç›´æ¥è·å–
            'existing_stale': [book_data3, book_data4, ...],  # éœ€è¦é‡æ–°çˆ¬å–
            'new': [book_data5, book_data6, ...]              # éœ€è¦å®Œæ•´æµç¨‹
        }
        """
```

---

### 3. `excel_updater.py` - Excelæ›´æ–°å™¨

**èŒè´£**ï¼šå°†æŸ¥è¯¢ç»“æœæ›´æ–°åˆ°Excelæ–‡ä»¶

**ä¸»è¦åŠŸèƒ½**ï¼š
- è¯»å–Excelæ–‡ä»¶
- æ ¹æ®æŸ¥é‡ç»“æœæ›´æ–°è±†ç“£å­—æ®µ
- å†™å…¥Excelæ–‡ä»¶
- æ”¯æŒå¤šç§è±†ç“£å­—æ®µæ˜ å°„

**å…³é”®æ–¹æ³•**ï¼š
```python
class ExcelUpdater:
    def __init__(self, excel_path: str)

    def update_from_database(self, books_data: List[Dict])
    def update_from_crawler(self, books_data: List[Dict])
    def save(self, output_path: str = None)
```

**è±†ç“£å­—æ®µæ˜ å°„**ï¼š
```python
DOUBAN_FIELDS_MAPPING = {
    'douban_url': 'douban_url',
    'douban_rating': 'douban_rating',
    'douban_title': 'douban_title',
    'douban_subtitle': 'douban_subtitle',
    'douban_original_title': 'douban_original_title',
    'douban_author': 'douban_author',
    'douban_translator': 'douban_translator',
    'douban_publisher': 'douban_publisher',
    'douban_pages': 'douban_pages',
    'douban_binding': 'douban_binding',
    'douban_pub_year': 'douban_pub_year',
    'douban_rating_count': 'douban_rating_count',
    'douban_summary': 'douban_summary',
    # ... æ›´å¤šå­—æ®µ
}
```

---

### 3. åœ¨ `isbn_async_processor.py` ä¸­é›†æˆæ•°æ®åº“

**æ–°å¢åŠŸèƒ½**ï¼š
- åœ¨å¼‚æ­¥å¤„ç†å™¨ä¸­é›†æˆæ•°æ®åº“æŸ¥é‡å’Œä¿å­˜
- åœ¨å¤„ç†è¿‡ç¨‹ä¸­è‡ªåŠ¨ä»æ•°æ®åº“è·å–æœ‰æ•ˆæ•°æ®
- åœ¨Excelæ›´æ–°æ—¶è‡ªåŠ¨å†™å…¥æ•°æ®åº“

**é›†æˆç‚¹**ï¼š
```python
class ISBNAsyncProcessor:
    def __init__(self, ..., enable_database: bool = False, db_config: Dict = None):
        # ... ç°æœ‰é€»è¾‘
        self.database_enabled = enable_database
        if enable_database:
            self.db_manager = DatabaseManager()
            self.data_checker = DataChecker(self.db_manager, db_config)

    async def process_isbn_async(..., save_to_database: bool = False):
        """æ–°å¢ï¼šsave_to_databaseå‚æ•°"""

        # æ­¥éª¤1ï¼šæŸ¥é‡ï¼ˆä»…å½“å¯ç”¨æ•°æ®åº“ä¸”save_to_database=Trueæ—¶ï¼‰
        if self.database_enabled and save_to_database:
            categories = self.data_checker.check_and_categorize_books(excel_data)

            # å¤„ç†å·²æœ‰æœ‰æ•ˆæ•°æ®ï¼ˆç›´æ¥ä»æ•°æ®åº“è·å–ï¼‰
            await self._process_existing_valid_books(categories['existing_valid'], ...)

            # å¤„ç†è¿‡æœŸæ•°æ®å’Œæ–°æ•°æ®ï¼ˆå®Œæ•´æµç¨‹ï¼šISBNçˆ¬å–+è±†ç“£çˆ¬å–ï¼‰
            stale_and_new = categories['existing_stale'] + categories['new']
            await self._process_stale_and_new_books(stale_and_new, ...)

        else:
            # åŸæœ‰é€»è¾‘ï¼ˆç›´æ¥å¤„ç†æ‰€æœ‰æ•°æ®ï¼‰
            await self._process_all_books(excel_data, ...)

        # æ­¥éª¤2ï¼šä¿å­˜åˆ°æ•°æ®åº“ï¼ˆæ‰€æœ‰æ•°æ®å¤„ç†å®Œæˆåï¼‰
        if self.database_enabled and save_to_database:
            await self._batch_save_to_database()

    async def _process_existing_valid_books(self, books, ...):
        """å¤„ç†å·²æœ‰æœ‰æ•ˆæ•°æ®ï¼ˆä»æ•°æ®åº“è·å–ï¼Œä¸çˆ¬å–ï¼‰"""

    async def _process_stale_and_new_books(self, books, ...):
        """å¤„ç†è¿‡æœŸæ•°æ®å’Œæ–°æ•°æ®ï¼ˆå®Œæ•´çˆ¬å–æµç¨‹ï¼‰"""

    async def _batch_save_to_database(self):
        """æ‰¹é‡ä¿å­˜åˆ°æ•°æ®åº“"""
```

---

### 4. `process_controller.py` - æµç¨‹æ§åˆ¶å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰

**èŒè´£**ï¼šåè°ƒæ•°æ®åº“åŠŸèƒ½ä¸ç°æœ‰æµç¨‹

**å…³é”®æ–¹æ³•**ï¼š
```python
class DoubanRatingProcessController:
    def __init__(self, excel_path: str, enable_db: bool = True, db_config: Dict = None):
        self.excel_path = excel_path
        self.db_enabled = enable_db
        if enable_db:
            self.db_manager = DatabaseManager()
            self.db_manager.init_database(db_config.get('db_path'))

    async def run_full_process(self):
        """æ‰§è¡Œå®Œæ•´æµç¨‹ï¼šISBNè·å–+è±†ç“£çˆ¬å–+æ•°æ®åº“ä¿å­˜"""

        # è°ƒç”¨å¼‚æ­¥å¤„ç†å™¨ï¼ˆé›†æˆæ•°æ®åº“åŠŸèƒ½ï¼‰
        output_file, stats = await process_isbn_async(
            excel_file_path=self.excel_path,
            enable_database=self.db_enabled,
            save_to_database=self.db_enabled,
            db_config=self.db_config,
            # ... å…¶ä»–å‚æ•°
        )

        return output_file, stats
```

---

## æ•°æ®åº“è¡¨è®¾è®¡ï¼ˆSQLiteï¼‰

### 1. booksè¡¨ï¼ˆåŸºç¡€ä¿¡æ¯+è±†ç“£ä¿¡æ¯ï¼‰

```sql
CREATE TABLE books (
    id INTEGER PRIMARY KEY AUTOINCREMENT,   -- è‡ªå¢ä¸»é”®
    barcode TEXT UNIQUE NOT NULL,           -- ä¹¦ç›®æ¡ç ï¼ˆå”¯ä¸€ç´¢å¼•ï¼‰

    -- ============ ä¹¦ç±åŸºç¡€ä¿¡æ¯ï¼ˆä¸å˜ï¼‰===========
    call_no TEXT NOT NULL,                  -- ç´¢ä¹¦å·
    book_title TEXT NOT NULL,               -- ä¹¦å
    additional_info TEXT,                   -- é™„åŠ ä¿¡æ¯
    isbn TEXT,                              -- ISBNå·

    -- ============ è±†ç“£ä¿¡æ¯ï¼ˆ1å¯¹1ï¼Œä¸å˜ï¼‰===========
    douban_url TEXT,                        -- è±†ç“£é“¾æ¥
    douban_rating REAL,                     -- è±†ç“£è¯„åˆ†
    douban_title TEXT,                      -- è±†ç“£ä¹¦å
    douban_subtitle TEXT,                   -- è±†ç“£å‰¯æ ‡é¢˜
    douban_original_title TEXT,             -- è±†ç“£åŸä½œå
    douban_author TEXT,                     -- è±†ç“£ä½œè€…
    douban_translator TEXT,                 -- è±†ç“£è¯‘è€…
    douban_publisher TEXT,                  -- è±†ç“£å‡ºç‰ˆç¤¾
    douban_producer TEXT,                   -- è±†ç“£å‡ºå“æ–¹
    douban_series TEXT,                     -- è±†ç“£ä¸›ä¹¦
    douban_series_link TEXT,                -- è±†ç“£ä¸›ä¹¦é“¾æ¥
    douban_price TEXT,                      -- è±†ç“£å®šä»·
    douban_isbn TEXT,                       -- è±†ç“£ISBN
    douban_pages INTEGER,                   -- è±†ç“£é¡µæ•°
    douban_binding TEXT,                    -- è±†ç“£è£…å¸§
    douban_pub_year INTEGER,                -- è±†ç“£å‡ºç‰ˆå¹´
    douban_rating_count INTEGER,            -- è±†ç“£è¯„ä»·äººæ•°
    douban_summary TEXT,                    -- è±†ç“£å†…å®¹ç®€ä»‹
    douban_author_intro TEXT,               -- è±†ç“£ä½œè€…ç®€ä»‹
    douban_catalog TEXT,                    -- è±†ç“£ç›®å½•
    douban_cover_image TEXT,                -- è±†ç“£å°é¢å›¾ç‰‡é“¾æ¥

    -- ============ å…ƒæ•°æ® ============
    data_version TEXT DEFAULT '1.0',        -- æ•°æ®ç‰ˆæœ¬
    created_at TEXT NOT NULL,               -- åˆ›å»ºæ—¶é—´
    updated_at TEXT                         -- æ›´æ–°æ—¶é—´
);

-- ç´¢å¼•
CREATE INDEX idx_books_barcode ON books(barcode);
CREATE INDEX idx_books_isbn ON books(isbn);
CREATE INDEX idx_books_douban_isbn ON books(douban_isbn);
CREATE INDEX idx_books_title ON books(book_title);
```

### 2. borrow_recordsè¡¨ï¼ˆå€Ÿé˜…è®°å½•ï¼‰

```sql
CREATE TABLE borrow_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,   -- è‡ªå¢ä¸»é”®
    barcode TEXT NOT NULL,                  -- å¤–é”®ï¼Œå…³è”booksè¡¨

    -- ============ å€Ÿé˜…è®°å½•ä¿¡æ¯ ============
    reader_card_no TEXT NOT NULL,           -- è¯»è€…å¡å·
    submit_time TEXT,                       -- æäº¤æ—¶é—´
    return_time TEXT,                       -- å½’è¿˜æ—¶é—´
    storage_time TEXT,                      -- å…¥åº“æ—¶é—´

    -- ============ å…ƒæ•°æ® ============
    created_at TEXT NOT NULL,               -- è®°å½•åˆ›å»ºæ—¶é—´

    FOREIGN KEY (barcode) REFERENCES books(barcode) ON DELETE CASCADE
);

-- ç´¢å¼•
CREATE INDEX idx_borrow_records_barcode ON borrow_records(barcode);
CREATE INDEX idx_borrow_records_reader ON borrow_records(reader_card_no);
CREATE INDEX idx_borrow_records_return_time ON borrow_records(return_time);
```

### 3. borrow_statisticsè¡¨ï¼ˆç»Ÿè®¡ä¿¡æ¯ï¼‰

```sql
CREATE TABLE borrow_statistics (
    id INTEGER PRIMARY KEY AUTOINCREMENT,   -- è‡ªå¢ä¸»é”®
    barcode TEXT NOT NULL,                  -- å¤–é”®ï¼Œå…³è”booksè¡¨

    -- ============ ç»Ÿè®¡å‘¨æœŸä¿¡æ¯ ============
    stat_period TEXT NOT NULL,              -- ç»Ÿè®¡å‘¨æœŸæ ‡è¯†ï¼ˆå¦‚"2024-10"ï¼‰
    stat_year INTEGER NOT NULL,             -- ç»Ÿè®¡å¹´ä»½
    stat_month INTEGER NOT NULL,            -- ç»Ÿè®¡æœˆä»½ï¼ˆ1-12ï¼‰
    period_start TEXT,                      -- å‘¨æœŸå¼€å§‹æ—¶é—´
    period_end TEXT,                        -- å‘¨æœŸç»“æŸæ—¶é—´

    -- ============ å€Ÿé˜…æ¬¡æ•°ç»Ÿè®¡ ============
    borrow_count_3m INTEGER,                -- è¿‘ä¸‰ä¸ªæœˆæ€»æ¬¡æ•°
    borrow_count_m1 INTEGER,                -- ç¬¬ä¸€æœˆå€Ÿé˜…æ¬¡æ•°
    borrow_count_m2 INTEGER,                -- ç¬¬äºŒæœˆå€Ÿé˜…æ¬¡æ•°
    borrow_count_m3 INTEGER,                -- ç¬¬ä¸‰æœˆå€Ÿé˜…æ¬¡æ•°

    -- ============ å…ƒæ•°æ® ============
    created_at TEXT NOT NULL,               -- è®°å½•åˆ›å»ºæ—¶é—´
    updated_at TEXT,                        -- è®°å½•æ›´æ–°æ—¶é—´

    FOREIGN KEY (barcode) REFERENCES books(barcode) ON DELETE CASCADE,
    UNIQUE(barcode, stat_year, stat_month)  -- ç¡®ä¿åŒä¸€æœ¬ä¹¦åœ¨åŒä¸€ç»Ÿè®¡å‘¨æœŸåªæœ‰ä¸€æ¡è®°å½•
);

-- ç´¢å¼•
CREATE INDEX idx_borrow_statistics_barcode ON borrow_statistics(barcode);
CREATE INDEX idx_borrow_statistics_period ON borrow_statistics(stat_year, stat_month);
CREATE INDEX idx_borrow_statistics_barcode_period ON borrow_statistics(barcode, stat_year, stat_month);
```

## æ•°æ®æµå‘è¯¦ç»†è¯´æ˜

### 1. æŸ¥é‡é˜¶æ®µ
```
Excel.barcode â†’ database_manager.batch_check_duplicates()
                â†“
             booksè¡¨WHERE barcode IN (...) AND created_at > datetime('now', '-30 days')
                â†“
           è¿”å›: [å·²æœ‰æœ‰æ•ˆæ•°æ®åˆ—è¡¨, å·²æœ‰è¿‡æœŸæ•°æ®åˆ—è¡¨, æ–°æ•°æ®åˆ—è¡¨]
```

### 2. æ›´æ–°é˜¶æ®µï¼ˆå·²æœ‰æœ‰æ•ˆæ•°æ®ï¼‰
```
booksè¡¨ â† SELECT douban_* FROM books WHERE barcode = ?
    â†“
æå–è±†ç“£å­—æ®µï¼ˆdouban_url, douban_rating, ...ï¼‰
    â†“
Excelæ–‡ä»¶ â† ç›´æ¥æ›´æ–°å¯¹åº”è¡Œï¼ˆä¸çˆ¬å–ï¼Œä¸è°ƒç”¨ISBNè·å–ï¼‰
```

### 3. æ›´æ–°é˜¶æ®µï¼ˆè¿‡æœŸ/æ–°æ•°æ®ï¼‰
```
ISBNçˆ¬å– â†’ è·å¾—isbn
    â†“
è±†ç“£çˆ¬å– â†’ è·å¾—douban_xxxä¿¡æ¯
    â†“
æ ‡è®°åˆ°"å¾…å†™å…¥æ•°æ®åº“"åˆ—è¡¨
    â†“
Excelæ–‡ä»¶ â† æ›´æ–°è±†ç“£å­—æ®µ
```

### 4. å†™å…¥é˜¶æ®µï¼ˆæ‰€æœ‰æ•°æ®å¤„ç†å®Œæˆåï¼‰
```
ä¸‰ç±»æ•°æ®:
â”œâ”€ booksè¡¨ â† åŸºç¡€ä¿¡æ¯ + è±†ç“£ä¿¡æ¯ï¼ˆINSERT OR REPLACEï¼‰
â”œâ”€ borrow_recordsè¡¨ â† å€Ÿé˜…è®°å½•
â””â”€ borrow_statisticsè¡¨ â† ç»Ÿè®¡ä¿¡æ¯

æ‰§è¡Œæ—¶æœºï¼šæ‰€æœ‰Excelæ•°æ®å¤„ç†å®Œæ¯•åï¼Œæ‰¹é‡æäº¤
å†™å…¥ç­–ç•¥ï¼šREPLACE INTOï¼ˆå­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™æ’å…¥ï¼‰
```

## å¼‚å¸¸å¤„ç†ç­–ç•¥

### 1. æ•°æ®åº“å¼‚å¸¸
```python
try:
    db_manager.batch_save_data(...)
except sqlite3.Error as e:
    logger.error(f"æ•°æ®åº“æ“ä½œå¤±è´¥: {e}")
    # å›æ»šäº‹åŠ¡
    conn.rollback()
    # è®°å½•å¤±è´¥çš„barcodesï¼Œé‡è¯•æˆ–è·³è¿‡
```

### 2. çˆ¬å–å¼‚å¸¸
```python
try:
    douban_info = crawler.crawl(isbn)
except CrawlerException as e:
    logger.warning(f"çˆ¬å–å¤±è´¥ï¼Œè·³è¿‡: {e}")
    # è·³è¿‡è¯¥æ¡è®°å½•ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€æ¡
    continue
```

### 3. Excelå†™å…¥å¼‚å¸¸
```python
try:
    excel_updater.save(output_path)
except Exception as e:
    logger.error(f"Excelä¿å­˜å¤±è´¥: {e}")
    # ä¿å­˜å¤‡ä»½æ–‡ä»¶
    excel_updater.save_backup()
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ‰¹é‡æ“ä½œ
- **æŸ¥é‡**ï¼š`IN (...)` æ‰¹é‡æŸ¥è¯¢ï¼Œé¿å…å¾ªç¯å•æ¡æŸ¥è¯¢
- **å†™å…¥**ï¼šä½¿ç”¨`executemany()`æ‰¹é‡æ’å…¥
- **äº‹åŠ¡**ï¼šåˆå¹¶å¤šä¸ªæ“ä½œä¸ºä¸€ä¸ªäº‹åŠ¡ï¼ˆé»˜è®¤batch_size=100ï¼‰

### 2. ç´¢å¼•ä¼˜åŒ–
- `books.barcode`ï¼šæŸ¥é‡å…³é”®å­—æ®µï¼Œ**å¿…é¡»ç´¢å¼•**ï¼ˆUNIQUEï¼‰
- `books.created_at`ï¼šæ•°æ®åˆ·æ–°æŸ¥è¯¢
- `borrow_records.barcode`ï¼šæŸ¥è¯¢å€Ÿé˜…è®°å½•
- `borrow_statistics(barcode, stat_year, stat_month)`ï¼šå¤åˆç´¢å¼•
- `books.isbn` + `books.douban_isbn`ï¼šISBNæŸ¥è¯¢ä¼˜åŒ–

### 3. ç¼“å­˜ç­–ç•¥
- **å·²æœ‰æœ‰æ•ˆæ•°æ®**ï¼šç›´æ¥ä»æ•°æ®åº“è·å–ï¼Œä¸çˆ¬å–ï¼ˆå¤§å¹…èŠ‚çœæ—¶é—´ï¼‰
- **ç»“æœç¼“å†²åŒº**ï¼šå¼‚æ­¥å¤„ç†ä¸­çš„ç»“æœç¼“å†²åŒºï¼ˆé¿å…å¹¶å‘å†²çªï¼‰

### 4. å¹¶å‘æ§åˆ¶
- **æ•°æ®åº“è¿æ¥æ± **ï¼šå•ä¸ªæ•°æ®åº“è¿æ¥ï¼Œå¤šçº¿ç¨‹å®‰å…¨è®¿é—®
- **é”æœºåˆ¶**ï¼šæ•°æ®åº“å†™å…¥æ—¶ä½¿ç”¨äº‹åŠ¡é”

## å¼‚å¸¸å¤„ç†ç­–ç•¥

### 1. æ•°æ®åº“å¼‚å¸¸
```python
try:
    db_manager.batch_save_data(...)
except sqlite3.Error as e:
    logger.error(f"æ•°æ®åº“æ“ä½œå¤±è´¥: {e}")
    # å›æ»šäº‹åŠ¡
    conn.rollback()
    # è®°å½•å¤±è´¥çš„barcodesï¼Œé‡è¯•æˆ–è·³è¿‡
```

### 2. æŸ¥é‡å¼‚å¸¸
```python
try:
    categories = data_checker.check_and_categorize_books(...)
except Exception as e:
    logger.warning(f"æŸ¥é‡å¤±è´¥ï¼Œè·³è¿‡æ•°æ®åº“åŠŸèƒ½: {e}")
    # é™çº§åˆ°åŸæœ‰æµç¨‹ï¼ˆä¸ä½¿ç”¨æ•°æ®åº“ï¼‰
    await self._process_all_books_without_db(...)
```

### 3. Excelå†™å…¥å¼‚å¸¸
```python
try:
    excel_updater.save(output_path)
except Exception as e:
    logger.error(f"Excelä¿å­˜å¤±è´¥: {e}")
    # ä¿å­˜å¤‡ä»½æ–‡ä»¶
    excel_updater.save_backup()
    # æ•°æ®åº“å†™å…¥ä¸å—å½±å“ï¼ˆç»§ç»­æ‰§è¡Œï¼‰
```

## ä¸ç°æœ‰æ¨¡å—çš„é›†æˆ

### åœ¨ `douban_main.py` ä¸­æ–°å¢å‘½ä»¤

```python
def process_douban_rating_command(args):
    """å¤„ç†douban-ratingå‘½ä»¤"""
    if not validate_excel_file(args.excel_file):
        return

    # è·å–æ•°æ®åº“é…ç½®
    db_config = {}
    if not args.disable_database:
        config_manager = get_config_manager()
        douban_config = config_manager.get_douban_config()
        db_config = douban_config.get('database', {})
        db_config['refresh_strategy']['force_update'] = args.force_update

    print(f"ğŸ¯ è±†ç“£è¯„åˆ†æµç¨‹å¼€å§‹")
    print(f"ğŸ“„ æºæ–‡ä»¶: {args.excel_file}")
    print(f"ğŸ’¾ æ•°æ®åº“åŠŸèƒ½: {'å¯ç”¨' if not args.disable_database else 'ç¦ç”¨'}")
    if not args.disable_database:
        print(f"   åˆ·æ–°ç­–ç•¥: {db_config['refresh_strategy']['stale_days']}å¤©")

    # è°ƒç”¨æµç¨‹æ§åˆ¶å™¨ï¼ˆé›†æˆæ•°æ®åº“åŠŸèƒ½ï¼‰
    controller = DoubanRatingProcessController(
        excel_path=args.excel_file,
        enable_db=not args.disable_database,
        db_config=db_config
    )

    # æ‰§è¡Œå®Œæ•´æµç¨‹
    output_file, stats = controller.run_full_process()

    # æ˜¾ç¤ºç»“æœ
    print(f"\nâœ… æµç¨‹å®Œæˆ!")
    print(f"ğŸ“ è¾“å‡ºæ–‡ä»¶: {output_file}")
    print(f"ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯: {stats}")

    # æ˜¾ç¤ºæ•°æ®åº“ç»Ÿè®¡ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if not args.disable_database:
        db_stats = controller.get_database_stats()
        print(f"ğŸ’¾ æ•°æ®åº“æ“ä½œ:")
        print(f"   æŸ¥é‡å‘ç°: {db_stats['existing_count']}æ¡å·²å­˜åœ¨")
        print(f"   çˆ¬å–æ–°å¢: {db_stats['new_count']}æ¡æ–°æ•°æ®")
        print(f"   åˆ·æ–°æ›´æ–°: {db_stats['stale_count']}æ¡è¿‡æœŸæ›´æ–°")
        print(f"   DBè·¯å¾„: {db_config['db_path']}")
```

### æ–°å¢å‘½ä»¤è¡Œå‚æ•°

```python
parser.add_argument('--excel-file', required=True, help='Excelæ–‡ä»¶è·¯å¾„')
parser.add_argument('--disable-database', action='store_true', help='ç¦ç”¨æ•°æ®åº“åŠŸèƒ½ï¼ˆä»…çˆ¬å–å’Œæ›´æ–°Excelï¼‰')
parser.add_argument('--force-update', action='store_true', help='å¼ºåˆ¶æ›´æ–°æ‰€æœ‰æ•°æ®ï¼ˆå¿½ç•¥æ—¶é—´é™åˆ¶ï¼‰')
parser.add_argument('--db-path', help='æ•°æ®åº“æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä»é…ç½®è¯»å–ï¼‰')
```

## æ—¥å¿—å’Œç›‘æ§

### 1. æ—¥å¿—çº§åˆ«
- `INFO`ï¼šæ­£å¸¸æµç¨‹ä¿¡æ¯ï¼ˆå¼€å§‹ã€ç»“æŸã€å¤„ç†æ•°é‡ï¼‰
- `WARNING`ï¼šå¯æ¢å¤çš„å¼‚å¸¸ï¼ˆæŸæ¡è®°å½•å¤±è´¥ï¼Œç»§ç»­å¤„ç†ï¼‰
- `ERROR`ï¼šä¸¥é‡é”™è¯¯ï¼ˆæ•°æ®åº“è¿æ¥å¤±è´¥ã€éœ€è¦äººå·¥å¤„ç†ï¼‰

### 2. å…³é”®æŒ‡æ ‡
- æ€»å¤„ç†è®°å½•æ•°
- æˆåŠŸ/å¤±è´¥æ•°é‡
- æŸ¥é‡æ¯”ä¾‹ï¼ˆé‡å¤ vs æ–°æ•°æ®ï¼‰
- çˆ¬å–æˆåŠŸç‡
- å¤„ç†è€—æ—¶
- æ•°æ®åº“å†™å…¥ç»Ÿè®¡ï¼ˆå†™å…¥æ•°é‡ã€å›æ»šæ¬¡æ•°ï¼‰

### 3. è¿›åº¦è·Ÿè¸ª
```python
logger.info(f"è¿›åº¦: {processed}/{total} ({processed/total*100:.1f}%)")
logger.info(f"æ•°æ®åº“çŠ¶æ€: {existing_valid}æ¡æœ‰æ•ˆï¼Œ{existing_stale}æ¡è¿‡æœŸï¼Œ{new}æ¡æ–°æ•°æ®")
```

## ä½¿ç”¨ç¤ºä¾‹

### 1. å®Œæ•´æµç¨‹ï¼ˆæ¨èï¼‰
```bash
# è‡ªåŠ¨æŸ¥é‡+çˆ¬å–+æ•°æ®åº“ä¿å­˜
python src/core/douban/douban_main.py douban-rating --excel-file "å€Ÿé˜…æ•°æ®.xlsx"
```

### 2. æµ‹è¯•æ¨¡å¼ï¼ˆéªŒè¯æµç¨‹ï¼‰
```bash
# ä»…å¤„ç†å‰5æ¡è®°å½•ï¼ŒéªŒè¯æµç¨‹æ­£ç¡®æ€§
python src/core/douban/douban_main.py douban-rating --excel-file "å€Ÿé˜…æ•°æ®.xlsx" --test
```

### 3. å¼ºåˆ¶åˆ·æ–°æ¨¡å¼
```bash
# å¿½ç•¥æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œå¼ºåˆ¶é‡æ–°çˆ¬å–æ‰€æœ‰è®°å½•
python src/core/douban/douban_main.py douban-rating --excel-file "å€Ÿé˜…æ•°æ®.xlsx" --force-update
```

### 4. ç¦ç”¨æ•°æ®åº“åŠŸèƒ½
```bash
# ä»…æ‰§è¡ŒISBNè·å–å’Œè±†ç“£çˆ¬å–ï¼Œä¸ä½¿ç”¨æ•°æ®åº“
python src/core/douban/douban_main.py douban-rating --excel-file "å€Ÿé˜…æ•°æ®.xlsx" --disable-database
```

### 5. è‡ªå®šä¹‰æ•°æ®åº“è·¯å¾„
```bash
# æŒ‡å®šæ•°æ®åº“æ–‡ä»¶è·¯å¾„
python src/core/douban/douban_main.py douban-rating --excel-file "å€Ÿé˜…æ•°æ®.xlsx" --db-path "/path/to/custom.db"
```

## é…ç½®æ–‡ä»¶ç¤ºä¾‹ï¼ˆå®Œæ•´ç‰ˆï¼‰

```yaml
# config/setting.yaml
douban:
  # æ•°æ®åº“ç›¸å…³é…ç½®
  database:
    # æ•°æ®åº“æ–‡ä»¶è·¯å¾„
    db_path: "runtime/outputs/books_history.db"

    # æŸ¥é‡ç­–ç•¥
    duplicate_check:
      enabled: true
      key_field: "barcode"
      batch_query: true

    # æ•°æ®åˆ·æ–°ç­–ç•¥ï¼ˆé‡è¦ï¼‰
    refresh_strategy:
      enabled: true
      # è¶…è¿‡30å¤©çš„æ•°æ®éœ€è¦é‡æ–°çˆ¬å–ï¼ˆè±†ç“£è¯„åˆ†å¯èƒ½æ›´æ–°ï¼‰
      stale_days: 30
      force_update: false  # è®¾ç½®ä¸ºtrueåˆ™å¿½ç•¥æ—¶é—´é™åˆ¶ï¼Œå¼ºåˆ¶æ›´æ–°æ‰€æœ‰
      update_mode: "merge"  # mergeä¿ç•™åŸè®°å½•ï¼Œoverwriteå®Œå…¨è¦†ç›–

    # å†™å…¥ç­–ç•¥
    write_strategy:
      batch_size: 100
      use_transaction: true
      create_backup: true

    # æ—¥å¿—ç­–ç•¥
    logging:
      log_sql: false
      log_performance: true

  # å¼‚æ­¥å¤„ç†å™¨é…ç½®ï¼ˆç°æœ‰ï¼‰
  isbn_processor:
    strategy: "balanced"
    max_concurrent: 3
    save_interval: 1
```

## ç›®å½•ç»“æ„

```
src/core/douban/
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ database_manager.py    # æ•°æ®åº“ç®¡ç†å™¨
â”‚   â”œâ”€â”€ data_checker.py        # æŸ¥é‡å¤„ç†å™¨
â”‚   â”œâ”€â”€ excel_updater.py       # Excelæ›´æ–°å™¨
â”‚   â””â”€â”€ process_controller.py  # æµç¨‹æ§åˆ¶å™¨
â”œâ”€â”€ isbn_async_processor.py    # å¼‚æ­¥å¤„ç†å™¨ï¼ˆé›†æˆæ•°æ®åº“åŠŸèƒ½ï¼‰
â””â”€â”€ douban_main.py             # ä¸»ç¨‹åºï¼ˆæ–°å¢douban-ratingå‘½ä»¤ï¼‰

# æ•°æ®åº“å·¥å…·è„šæœ¬
src/tools/
â””â”€â”€ init_database.py           # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ï¼ˆå·²å­˜åœ¨ï¼‰
```

## æ•°æ®åº“åˆå§‹åŒ–

åœ¨é¦–æ¬¡ä½¿ç”¨æ•°æ®åº“åŠŸèƒ½å‰ï¼Œéœ€è¦å…ˆåˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„ï¼š

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆä»config/setting.yamlè¯»å–ï¼‰
python src/tools/init_database.py

# æŒ‡å®šè‡ªå®šä¹‰æ•°æ®åº“è·¯å¾„
python src/tools/init_database.py --db-path "runtime/outputs/books_history.db"

# å¼ºåˆ¶é‡æ–°åˆ›å»ºï¼ˆè¦†ç›–å·²å­˜åœ¨çš„æ•°æ®åº“ï¼‰
python src/tools/init_database.py --db-path "runtime/outputs/books_history.db" --force
```

åˆå§‹åŒ–å®Œæˆåå°†åˆ›å»ºï¼š
- `books` è¡¨ï¼šä¹¦ç±åŸºç¡€ä¿¡æ¯å’Œè±†ç“£ä¿¡æ¯
- `borrow_records` è¡¨ï¼šå€Ÿé˜…è®°å½•å†å²
- `borrow_statistics` è¡¨ï¼šæ¯æœˆç»Ÿè®¡æ±‡æ€»

æ‰€æœ‰è¡¨å°†è‡ªåŠ¨åˆ›å»ºå¿…è¦çš„ç´¢å¼•å’Œå¤–é”®çº¦æŸã€‚

## ç‰ˆæœ¬ä¿¡æ¯

- **ç‰ˆæœ¬**ï¼š2.0ï¼ˆé›†æˆç‰ˆï¼‰
- **åˆ›å»ºæ—¶é—´**ï¼š2025-11-05
- **ä½œè€…**ï¼šè±†ç“£è¯„åˆ†æ¨¡å—å¼€å‘ç»„
- **æ–‡æ¡£çŠ¶æ€**ï¼šå¾…å¼€å‘

## åç»­å·¥ä½œé¡¹

- [ ] å®ç°database_manager.pyï¼ˆæ•°æ®åº“ç®¡ç†å™¨ï¼‰
- [ ] å®ç°data_checker.pyï¼ˆæŸ¥é‡å¤„ç†å™¨ï¼‰
- [ ] é›†æˆæ•°æ®åº“åŠŸèƒ½åˆ°isbn_async_processor.py
- [ ] åœ¨douban_main.pyä¸­æ–°å¢douban-ratingå‘½ä»¤
- [ ] æ›´æ–°é…ç½®æ–‡ä»¶ï¼ˆconfig/setting.yamlï¼‰æ·»åŠ æ•°æ®åº“é…ç½®
- [ ] å•å…ƒæµ‹è¯•ç¼–å†™
- [ ] é›†æˆæµ‹è¯•éªŒè¯
- [ ] æ€§èƒ½ä¼˜åŒ–å’Œè°ƒä¼˜
- [ ] éƒ¨ç½²å’Œæ–‡æ¡£å®Œå–„

## å‚è€ƒæ–‡æ¡£

- [å†å²æ•°æ®æŸ¥é‡æ•°æ®åº“è®¾è®¡](./å†å²æ•°æ®æŸ¥é‡æ•°æ®åº“è®¾è®¡.md)
- [ç¬¬ä¸€æ¨¡å—æ–‡æ¡£](./ç¬¬ä¸€æ¨¡å—æ–‡æ¡£.md)
- [ç¬¬äºŒæ¨¡å—æ–‡æ¡£](./ç¬¬äºŒæ¨¡å—æ–‡æ¡£.md)
- [è±†ç“£çˆ¬è™«æ¥å£æ–‡æ¡£](../è±†ç“£çˆ¬è™«æ¥å£æ–‡æ¡£.md)
