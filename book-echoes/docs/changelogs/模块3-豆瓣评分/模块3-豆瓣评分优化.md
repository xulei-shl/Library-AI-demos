# 模块 3 · 豆瓣评分流程优化指引

## 当前痛点
- `src/core/douban/douban_rating_processor_async.py` 的 `_save_progress` 仅记录日志，真实的 Excel 与 DB 写入集中在流程尾部；一旦 FOLIO/豆瓣链路在中途被反爬或浏览器异常打断，之前已经完成的行既不会落盘，也无法复用，下次运行不得不重复抓取。
- `_isbn_task` 与 `_douban_task` 的异常会直接冒泡到 `asyncio.gather`，缺乏“自动重启浏览器 / 达到上限后安全落盘退出”的策略；`AsyncBrowserWorker`、`DoubanCrawlerAdapter` 也只在各自方法内局部重试，不会向调度层报告“需要整体重启”。
- 豆瓣遭遇 “搜索访问太频繁” 时虽然会重启浏览器，但没有强制执行顶部 `登录/注册` 的登录流程，仍以匿名身份继续检索，导致持续命中反爬。
- FOLIO 侧 Playwright 会话异常时只会在当前 `get_isbn` 内重试，无法彻底重建浏览器，也不会触发“保存已完成结果并退出”的流程。

## 建议的结构化方案（KISS）

### 1. 引入真正的进度持久化
1. 扩展 `_save_progress`，按阶段把 `df` 写入 `runtime/outputs/<原文件>_partial.xlsx`，并在启用数据库时调用现有 `ExcelToDatabaseWriter` 将已完成记录刷入 DB。  
2. 为每行增加简易状态（如 `处理状态` 列或单独 JSON 记录已完成的 `index`），重跑时直接跳过已完成条目，避免重复爬取。  
3. 在最终产物生成（`_generate_output_path`）前检测是否存在 partial 文件，成功收尾后重命名/覆盖；异常退出前也调用同一套落盘逻辑，这样后续运行始终可以“续跑”。

### 2. 统一的浏览器恢复与终止策略
1. 在 `DoubanRatingProcessorAsync.process_excel_async` 外层包裹 `try/except/finally`，`asyncio.gather` 使用 `return_exceptions=True`；当 `_isbn_task` 或 `_douban_task` 抛出自定义异常（如 `FolioFatalError`、`DoubanFatalError`）时，集中处理。  
2. 新增轻量级 `ProgressManager`（负责 Excel/DB flush）与 `BrowserRecoveryMixin`（跟踪重启次数、执行 `_graceful_shutdown`）。超过 3 次重启仍失败时，调用 `_graceful_shutdown(df, categories, reason)` 保存 partial 并返回，视为一次“正常结束”。  
3. `_isbn_task`/`_douban_task` 捕获底层异常后不要直接退出：  
   - 首次失败 → 关闭并重建浏览器实例，记录一次重启。  
   - 达到上限 → 抛出 `*FatalError`，由上层触发 `graceful_shutdown`。

### 3. 反爬后的登录流程
1. 在 `DoubanCrawlerAdapter.crawl_by_isbn` 检测到页面含 “搜索访问太频繁” 时，除了重启浏览器，还要执行 `_relogin_after_anti_bot`：  
   - 打开 `https://book.douban.com`，定位 `a.nav-login` / `a[href*="passport/login?source=book"]`，点击后等待跳转。  
   - 复用 `_handle_login_situation`：先尝试自动填充账号/密码，若需要验证码则提示人工输入 `y` 确认，再继续 `_search_after_login`。  
2. 把该逻辑也挂到 `_search_by_isbn` 的异常分支（`PlaywrightTimeoutError` 或检测到反爬提示文本）中，避免无意义的 URL 重试。

### 4. FOLIO `AsyncBrowserWorker` 的重启封装
1. 新增 `_restart_browser()`：关闭当前 `browser/context/page`，重新 `start()` 并 `_login()`；在 `get_isbn` 捕获 `TimeoutError`、`TargetClosed`、`context destroyed` 等异常时调用。  
2. 通过抛出 `FolioNeedsRestart` 将失败信息上抛给 `_isbn_task`；调度层累计重启次数，超过阈值时触发 `graceful_shutdown`。  
3. `get_isbn` 每成功解析一条就立即调用 `_save_progress(df, "isbn", index)`，确保任何时刻都能续跑。

### 5. 代码组织
- 所有新增类/函数独立成小模块（例如 `src/core/douban/progress_manager.py`、`src/core/douban/browser_recovery.py`），主流程保持 300 行以内，符合 “Keep it simple”。
- 复用现有 `ExcelToDatabaseWriter`，避免复制业务逻辑；仅在需要时补充小范围注释，注释统一使用中文。

## 实施顺序建议
1. **先做可恢复进度**：实现 partial Excel + DB flush，验证中断后能续跑。  
2. **再加容错框架**：引入 `ProgressManager`、`BrowserRecoveryMixin`、自定义异常，完成统一的重启/终止策略。  
3. **最后完善登录链路**：补齐豆瓣反爬后的登录流程与 FOLIO 浏览器重启，结合 20~30 条测试数据演练“中断 → 恢复 → 登录 → 续跑”的完整闭环。

以上步骤完成后，模块 3 将在大规模 ISBN/豆瓣抓取场景下具备可恢复性和反爬自愈能力，后续的编码工作可直接以本指引为蓝本逐项落实。

## 2025-11-09 实施记录
- `src/core/douban/douban_rating_processor_async.py` 接入 `ProgressManager` 与 `BrowserRecoveryMixin`：处理过程实时写入 `runtime/outputs/<原文件>_partial.xlsx`，并在 `处理状态` 列标记 `ISBN完成/豆瓣完成`，异常退出前强制落盘；任务重启次数达到 3 次即抛出 `FolioFatalError` / `DoubanFatalError`，由统一的 `_graceful_shutdown` 收尾。
- 新增 `src/core/douban/progress_manager.py`、`browser_recovery.py`、`exceptions.py`，补充 `ExcelToDatabaseWriter.build_single_payload`，实现单行刷库，确保续跑时数据库与 Excel 一致。
- `AsyncBrowserWorker.get_isbn` 遇到 `TimeoutError`/`TargetClosed`/`context destroyed` 时通过 `_handle_worker_restart` 整体重启浏览器并抛出 `FolioNeedsRestart`，上层可复用同一条码继续排队。
- `DoubanCrawlerAdapter` 扩展 `_auto_click_login_link` 选择器，新增 `_relogin_after_anti_bot` + `_is_anti_bot_page`，当页面出现“搜索访问太频繁/行为异常”或 `_search_by_isbn` 触发超时时强制重新登录再检索。

### 复盘与排障指引
- **查看续跑状态**：若任务异常终止，检查 `runtime/outputs/<原文件>_partial.xlsx` 中 `处理状态` 列，`ISBN完成` 表示待豆瓣阶段可重用，`豆瓣完成` 表示该行已落库（启用数据库时）。下一次运行自动读取该文件并跳过已完成行。
- **识别致命异常**：日志中若出现 `FolioFatalError` 或 `DoubanFatalError`，说明对应浏览器已超过 3 次重启。定位 `logger.error([GracefulShutdown])` 的 reason 即可确定触发点，再结合 `queue` 中未消费的 index 定向重试。
- **数据库同步验证**：启用数据库模式时，可在日志中搜索 `数据库增量刷写完成`；缺失该日志代表 `ProgressManager.flush_row_to_database` 未触发，需确认 `categories` 中是否将该行标记为 `existing_stale/new`。
- **反爬恢复**：若豆瓣登录页验证失败或验证码输入错误，`_relogin_after_anti_bot` 会再次调用 `_handle_login_situation`；可在日志中检索 `重新登录后未立即获取到结果`，对应的 ISBN 会重新入队，集中排查验证码/登录配置。
