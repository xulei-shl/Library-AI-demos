# 豆瓣模块主程序使用说明

## 概述

豆瓣模块主程序 (`douban_main.py`) 是整个豆瓣模块的统一入口程序，负责管理所有功能模块的注册、初始化和调用。它提供了一个统一的命令行接口，支持功能的模块化扩展。

## 主要功能

### 1. 模块管理
- **模块注册**：自动注册所有可用的功能模块
- **模块初始化**：根据配置初始化启用的模块
- **模块状态**：查看各模块的启用状态和实例化状态

### 2. 配置管理
- **配置管理**：自动生成和更新配置文件
- **模块控制**：通过配置文件控制各功能的启用/禁用
- **参数设置**：集中管理各模块的运行参数

### 3. 功能扩展
- **模块化设计**：后续新功能可以轻松接入
- **配置驱动**：通过配置文件控制各功能的启用/禁用
- **统一接口**：提供一致的使用接口

## 当前支持的功能

### ISBN获取功能
- **功能描述**：从FOLIO流通系统根据书目条码获取ISBN号
- **输入**：Excel文件（包含书目条码列）
- **输出**：更新后的Excel文件（新增ISBN号列）
- **状态**：✅ 已启用

### 待开发功能
- **豆瓣评分功能**：根据ISBN获取豆瓣评分和评论
- **数据分析功能**：图书借阅趋势分析
- **报告生成功能**：生成综合分析报告
- **状态**：⏳ 待开发（可通过配置启用）

## 使用方法

### 1. 查看模块状态

查看当前已注册的模块和它们的状态：

```bash
cd f:/Github/Library-AI-demos/book-echoes
python src/core/douban/douban_main.py list
```

输出示例：
```
已注册的模块:
  ✓ isbn_resolver (启用状态: ✓, 实例化: ✓)
  ✗ douban_rating (启用状态: ✗, 实例化: ✗)
```

### 2. 使用ISBN获取功能

处理Excel文件，获取ISBN号：

```bash
python src/core/douban/douban_main.py isbn --excel-file "月归还数据筛选结果_20251101_183318.xlsx"
```

#### 高级用法

指定列名：
```bash
python src/core/douban/douban_main.py isbn \
    --excel-file "数据.xlsx" \
    --barcode-column "条码" \
    --output-column "ISBN"
```

### 3. 交互式使用

不提供参数时，程序会进入交互模式：

```bash
python src/core/douban/douban_main.py
```

交互模式提供：
- 快速开始功能
- 模块状态查看
- 功能执行选择

### 4. 查看帮助

获取详细的使用帮助：

```bash
python src/core/douban/douban_main.py help
```

### 5. 通过主程序调用

豆瓣模块也可以通过项目主程序调用：

```bash
cd f:/Github/Library-AI-demos/book-echoes
python main.py
# 选择 "模块3: 豆瓣模块（ISBN获取等）"
```

## 配置文件说明

配置文件位于 `config/douban_config.json`，包含以下部分：

### ISBN解析器配置
```json
{
  "isbn_resolver": {
    "enabled": true,
    "username": "sl_dczx01",
    "password": "LTcx@01",
    "timeout": 30,
    "delay": 2.0
  }
}
```

### 未来功能配置（预留）
```json
{
  "douban_rating": {
    "enabled": false,
    "api_key": "",
    "rate_limit": 1.0
  }
}
```

### 通用配置
```json
{
  "general": {
    "max_retry": 3,
    "log_level": "INFO"
  }
}
```

## 命令行参数说明

### list 命令
- **功能**：列出所有已注册的模块
- **参数**：无
- **示例**：`python douban_main.py list`

### isbn 命令
- **功能**：执行ISBN获取功能
- **必选参数**：
  - `--excel-file`：Excel文件路径
- **可选参数**：
  - `--barcode-column`：条码列名（默认：书目条码）
  - `--output-column`：输出ISBN列名（默认：ISBN号）
- **示例**：
  ```bash
  python douban_main.py isbn --excel-file "数据.xlsx"
  python douban_main.py isbn --excel-file "数据.xlsx" --barcode-column "条码" --output-column "ISBN"
  ```

### help 命令
- **功能**：显示帮助信息
- **参数**：无
- **示例**：`python douban_main.py help`

## 扩展新功能

### 1. 创建功能模块

创建一个新的功能模块类：

```python
# src/core/douban/new_feature.py
class NewFeature:
    def __init__(self, config_key, **kwargs):
        self.config = kwargs
        # 初始化代码
        
    async def process(self, data):
        # 功能实现代码
        pass
```

### 2. 注册模块

在 `douban_main.py` 中注册新模块：

```python
from .new_feature import NewFeature

# 注册模块
manager.register_module('new_feature', NewFeature, 'new_feature')
```

### 3. 添加配置

在配置文件中添加新功能的配置：

```json
{
  "new_feature": {
    "enabled": true,
    "param1": "value1",
    "param2": "value2"
  }
}
```

### 4. 更新CLI

在main()函数中添加新命令的处理逻辑：

```python
elif args.command == 'new_feature':
    # 新功能处理逻辑
    pass
```

## 最佳实践

### 1. 配置管理
- 为不同环境使用不同配置文件
- 定期检查和更新配置
- 备份重要配置

### 2. 日志监控
- 查看程序运行日志
- 监控模块状态
- 记录错误信息

### 3. 错误处理
- 使用try-catch处理异常
- 记录详细的错误信息
- 提供友好的错误提示

## 故障排除

### 常见问题

1. **配置文件不存在**
   - 运行交互模式会自动创建默认配置
   - 检查config目录权限

2. **ISBN获取失败**
   - 检查网络连接
   - 验证FOLIO系统凭据
   - 查看详细日志信息

3. **模块注册失败**
   - 检查模块文件是否存在
   - 验证模块类定义
   - 确认配置文件格式

4. **文件路径问题**
   - 确保Excel文件存在
   - 检查文件路径格式
   - 验证列名是否正确

### 日志查看

程序运行日志可通过以下方式查看：
- 查看控制台输出
- 检查 `runtime/logs/` 目录下的日志文件
- 使用日志配置工具

## 版本历史

### v1.0.0
- 初始版本发布
- 支持ISBN获取功能
- 基础配置管理
- 命令行接口
- 主程序集成

### 未来计划
- 添加豆瓣评分功能
- 支持更多数据格式
- 改进用户界面
- 添加Web界面支持

## 技术支持

如遇到问题，请：
1. 查看此文档的故障排除部分
2. 检查程序运行日志
3. 验证配置文件设置
4. 联系开发团队