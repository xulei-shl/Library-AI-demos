# 豆瓣图书功能使用示例

## 📋 快速开始

### 1. 环境准备

首先确保已安装必要的依赖：
```bash
pip install playwright beautifulsoup4 pandas openpyxl asyncio
playwright install chromium
```

### 2. 配置环境变量

在 `config/.env` 文件中配置账号密码：

```bash
# FOLIO系统账号（用于从条码获取ISBN）
FOLIO_USERNAME=your_folio_username
FOLIO_PASSWORD=your_folio_password

# 豆瓣账号（用于豆瓣爬取）
DOUBAN_USERNAME=your_douban_username
DOUBAN_PASSWORD=your_douban_password
```

### 3. 准备Excel文件

确保Excel文件包含以下列：
- `书目条码`: 图书的唯一条码
- `ISBN号`: 可选，如有则直接使用，无则从FOLIO系统获取

### 4. 执行处理

基本用法：
```bash
python src/core/douban/douban_main.py douban-rating --excel-file "数据.xlsx"
```

### 5. 查看结果

处理完成后，在 `data/outputs/douban/` 目录下会生成新文件：
- 文件名格式: `{原始文件名}_豆瓣信息_{时间戳}.xlsx`
- 新增列包括：豆瓣链接、豆瓣评分、豆瓣书名、豆瓣作者、豆瓣出版社等16个字段

## 🎯 详细示例

### 示例1: 基本处理
```bash
# 处理Excel文件，使用默认配置
python src/core/douban/douban_main.py douban-rating \
    --excel-file "data/月归还.xlsx" \
    --barcode-column "书目条码" \
    --isbn-column "ISBN号"
```

### 示例2: 测试模式（推荐首次使用）
```bash
# 仅处理前几条记录，验证功能是否正常
python src/core/douban/douban_main.py douban-rating \
    --excel-file "data/月归还.xlsx" \
    --config-name test
```

### 示例3: 生产环境（无头模式）
```bash
# 使用无头模式，更快但看不到浏览器
python src/core/douban/douban_main.py douban-rating \
    --excel-file "data/月归还.xlsx" \
    --config-name production
```

### 示例4: 指定账号密码
```bash
# 如果不想使用.env文件中的配置，可以直接指定
python src/core/douban/douban_main.py douban-rating \
    --excel-file "data/月归还.xlsx" \
    --username "your_username" \
    --password "your_password"
```

## 📊 处理流程说明

### 整体流程
1. **读取Excel** - 加载数据文件
2. **检查ISBN** - 对于每条记录：
   - 如果没有ISBN或ISBN无效，从FOLIO系统获取
   - 如果有有效ISBN，直接使用
3. **豆瓣爬取** - 使用ISBN从豆瓣获取图书信息
4. **实时保存** - 每处理10条记录保存一次进度
5. **生成报告** - 显示处理统计信息

### 进度跟踪
处理过程中会显示类似以下的进度信息：
```
🚀 豆瓣评分同步处理开始
📄 源文件: data/月归还.xlsx
⚙️  配置方案: 默认
🔄 保存间隔: 10条/次

📈 预估处理: 1000条记录
   预计耗时: 50.0分钟 (3秒/条)
   预计成功率: 85-95%

进度: 50/1000 (5.0%) - ISBN: 45, 豆瓣: 42/3
进度: 100/1000 (10.0%) - ISBN: 89, 豆瓣: 85/8
...
✅ 处理完成!
📁 输出文件: data/outputs/douban/月归还_豆瓣信息_20251104_143022.xlsx

📈 处理统计:
   总记录数: 1000
   成功获取ISBN: 950
   成功豆瓣爬取: 920
   豆瓣失败: 30
   成功率: 92.00%
   处理时间: 3120.50秒
   平均速度: 19.2条/分钟
```

## ⚙️ 配置说明

### 配置文件位置
- 主配置: `config/setting.yaml`
- 环境变量: `config/.env`

### 主要配置项

#### douban_crawler 配置
```yaml
douban:
  douban_crawler:
    enabled: true
    base_url: "https://book.douban.com"
    headless: false  # 是否无头模式
    delay: 1.0  # 请求间隔（秒）

    login:
      auto_login: false  # 是否自动登录
      timeout: 30  # 登录超时

    crawl:
      retry_times: 3  # 失败重试次数
      timeout: 15  # 页面加载超时
      enable_stealth: true  # 启用反检测

    fields:
      title: "豆瓣书名"
      rating: "豆瓣评分"
      # ... 其他字段映射

    save_interval: 10  # 进度保存间隔
```

#### 预设配置方案
- **test**: 测试模式，headless=true, delay=0.5, save_interval=1
- **small**: 小数据模式，headless=false, delay=1.0, save_interval=10
- **production**: 生产模式，headless=true, delay=2.0, save_interval=20

## 🔍 故障排除

### 常见问题

#### 1. 浏览器启动失败
```
错误: playwright 浏览器未安装
解决: 运行 `playwright install chromium`
```

#### 2. 登录失败
```
错误: FOLIO登录失败
解决: 检查 config/.env 中的 FOLIO_USERNAME 和 FOLIO_PASSWORD
```

#### 3. 豆瓣爬取失败
```
错误: 豆瓣需要登录
解决:
1. 检查 config/.env 中的 DOUBAN_USERNAME 和 DOUBAN_PASSWORD
2. 首次使用时可能需要手动登录
3. 尝试使用 --config-name test 进行测试
```

#### 4. 数据格式错误
```
错误: Excel文件缺少必需的列
解决: 确保Excel文件包含 '书目条码' 列
```

#### 5. 网络超时
```
错误: 页面加载超时
解决: 检查网络连接，或增加配置文件中的 timeout 值
```

### 调试模式

如果遇到问题，可以：
1. 使用 `--config-name test` 进行小规模测试
2. 查看详细日志：日志文件位于 `runtime/logs/`
3. 设置 `log_level: "DEBUG"` 在配置文件中

## 📝 输出字段说明

处理完成后，Excel文件中会新增以下列：

| 字段名 | 说明 |
|--------|------|
| 豆瓣链接 | 豆瓣图书详情页链接 |
| 豆瓣评分 | 图书评分（0-10分） |
| 豆瓣书名 | 图书标题 |
| 豆瓣作者 | 图书作者 |
| 豆瓣出版社 | 出版社名称 |
| 豆瓣出品方 | 出品方名称 |
| 豆瓣丛书 | 丛书名称 |
| 豆瓣定价 | 图书定价 |
| 豆瓣ISBN | ISBN号码 |
| 豆瓣页数 | 页数 |
| 豆瓣装帧 | 装帧类型（平装/精装等） |
| 豆瓣出版年 | 出版年份 |
| 豆瓣评价人数 | 评价人数 |
| 豆瓣内容简介 | 图书内容简介 |
| 豆瓣作者简介 | 作者简介 |
| 豆瓣目录 | 图书目录 |

## 💡 最佳实践

1. **首次使用**: 建议先使用 `--config-name test` 测试少量数据
2. **数据备份**: 处理前请备份原始Excel文件
3. **网络稳定**: 确保网络连接稳定，避免频繁超时
4. **分批处理**: 对于大量数据（>5000条），建议分批处理
5. **监控进度**: 关注控制台输出，及时发现和处理异常
6. **定期清理**: 定期清理 `runtime/outputs/douban/` 目录中的临时文件

## 📞 技术支持

如遇到问题，请检查：
1. 日志文件: `runtime/logs/douban_*.log`
2. 临时文件: `data/outputs/douban/*_processing_*.xlsx`
3. 配置文档: `docs/模块3-豆瓣评分/`

---

**最后更新**: 2025年11月4日
**适用版本**: v1.0.0
