# 模块3 - 豆瓣评分：Link 阶段主题统计与流程控制

## 背景
- Link 阶段已经拿到豆瓣评分、评价人数与原始索书号，但此前直接进入 Subject API，缺少对主题／推荐维度的快速反馈。
- 新需求要求在 Link 阶段结束后生成 “豆瓣评分 vs 主题” 的统计，并在进入 API 阶段前给操作者一个明确的交互选项。

## 新增能力概览
1. **主题评分统计报告**  
   - 新增 `src/core/douban/analytics/theme_rating_analyzer.py`，负责把评分、索书号映射成 “主题首字母” 与 “首字母+前三位” 两层统计。  
   - 逻辑：索书号取 `/` 之前的部分，提取首字母作为一级主题，并抓取首字母后的前三位数字作为二级主题（不足三位按实际数字）。  
   - 统计指标：样本量、均值/中位数、≥8/≥9 占比、极值、评价人数均值，并各自输出 TopN（首字母 Top10，主题主类 Top15）。  
   - 产物：`runtime/outputs/{Excel文件名}_主题评分统计_YYYYMMDD_HHMMSS.txt`，路径也会写入 `stage_stats["link_resolver"]["theme_report_file"]` 与总流水线 `stats["link_theme_report"]`，方便 CLI 展示或后续排查。

2. **阶段确认提示**  
   - `DoubanRatingPipeline` 在 Link 阶段完成后不再直接继续 Subject API，而是根据交互终端状态提示操作者：  
     ```
     1. 继续调用 Subject API
     2. 暂停/中止
     ```  
   - 交互为阻塞式输入（支持 `1/2`、`继续/停止`、`Y/N` 等），`Ctrl+C` 也视为“停止”。  
   - 若脚本运行在非 TTY 环境（CI、计划任务等），自动记录“继续”，避免阻塞。
   - 用户若选择“停止”，`subject_api` 阶段会被跳过，并在最终统计中追加 `subject_stage_skipped`/`subject_api_skipped` 标记，方便后续恢复。

3. **可配置项与上下文增强**  
   - `DoubanRatingPipelineOptions` 新增：
     - `call_number_column`（默认 `索书号`）：供主题分析使用，`_ensure_required_columns` 会自动补列，保持兼容。
     - `prompt_post_link_action`: 控制是否在 Link→API 之间提示（默认 `True`，批处理可设为 `False`）。
   - `StageContext` 新增 `call_number_column` 与 `excel_path`，方便复用源文件信息及在多处共享。

## 运行提示
- **默认 CLI 流程**：完成 Link → 自动生成主题评分报告 → 控制台提示下一步 → 继续则进入 API → 末尾生成原有 `report_generator` 报告。
- **如何跳过提示**：运行在非交互环境即可自动继续；或在构建 `DoubanRatingPipelineOptions` 时把 `prompt_post_link_action=False`。
- **如何定位报告**：输出目录固定为 `runtime/outputs`，文件名包含原 Excel 名 + `_主题评分统计_时间戳`，总流程统计 `stats["link_theme_report"]` 也会带上绝对路径。

## 影响面
- Link 阶段：统计逻辑只依赖评分、评分人数与索书号，对原有链接解析流程无副作用。
- Subject API：仅在执行前新增决策点；实际 API 调度、进度保存、数据库刷写逻辑保持不变。
- 兼容性：无须修改既有配置文件即可启用；如果数据表缺少 `索书号`，统计会提示“无可用数据”并继续。

> 建议把新的主题报告与最终推荐名单同时评审，可快速判断高分图书是否覆盖到足够的学科/主题带，避免单一主题霸榜。若后续需要更细颗粒度（如二级主题 TopN+示例书目），可以在 `ThemeRatingAnalyzer` 里扩展聚合字段或导出 CSV。
