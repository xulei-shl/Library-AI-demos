# 豆瓣模块配置优化说明

## 概述

本次优化主要针对豆瓣模块的配置管理进行了全面改进，解决了配置分散、硬编码敏感信息等问题，提供了更加安全、灵活和统一的配置管理方案。

## 优化内容

### 1. 配置统一化管理
- **优化前**: 配置分散在 `douban_config.json` 和代码硬编码中
- **优化后**: 统一在主配置文件 `config/setting.yaml` 中管理豆瓣模块配置
- **优势**: 集中管理，减少配置错误，提高可维护性

### 2. 敏感信息安全化管理
- **优化前**: 用户名密码硬编码在代码中 (`sl_dczx01`, `LTcx@01`)
- **优化后**: 通过 `.env` 文件和环境变量安全管理敏感信息
- **优势**: 提高安全性，支持多环境部署，避免敏感信息泄露

### 3. 向下兼容性
- 保持原有API接口不变
- 提供默认值向后兼容
- 渐进式迁移，无缝升级

## 文件结构

### 新增文件

```
config/
├── .env.example           # 环境变量示例文件
└── .env                   # 环境变量文件（需要手动创建）

src/utils/
└── config_manager.py      # 新配置管理器

docs/模块3-豆瓣评分/
└── 豆瓣模块配置优化说明.md  # 本说明文档
```

### 修改文件

```
config/
└── setting.yaml          # 新增豆瓣模块配置

src/core/douban/
├── douban_main.py        # 更新配置管理逻辑
└── isbn_resolver.py      # 移除硬编码，支持配置文件

config/
└── douban_config.json    # 保留但弃用（可用于备份）
```

## 配置详解

### 1. 主配置文件 (config/setting.yaml)

豆瓣模块配置位于主配置文件的 `douban` 部分：

```yaml
# 第三模块豆瓣配置
douban:
  # ISBN获取器配置
  isbn_resolver:
    enabled: true                    # 是否启用ISBN解析功能
    base_url: "https://circ-folio.library.sh.cn/shlcirculation-query/literatureHistory"
    timeout: 30                      # 请求超时时间（秒）
    delay: 2.0                       # 请求间隔时间（秒）
    # 敏感信息将通过环境变量获取
    username_env_var: "FOLIO_USERNAME"     # 环境变量名：用户名
    password_env_var: "FOLIO_PASSWORD"     # 环境变量名：密码
    
  # 豆瓣评分配置
  douban_rating:
    enabled: false                   # 是否启用豆瓣评分功能
    rate_limit: 1.0                  # API调用频率限制（秒）
    api_key_env_var: "DOUBAN_API_KEY" # 环境变量名：豆瓣API密钥
    
  # 通用配置
  general:
    max_retry: 3                     # 最大重试次数
    log_level: "INFO"                # 日志级别
    backup_enabled: true             # 是否启用备份
    backup_interval: 24              # 备份间隔（小时）
```

### 2. 环境变量文件 (config/.env)

敏感信息通过 `.env` 文件管理：

```bash
# 豆瓣模块环境变量配置文件示例
# 复制此文件为 .env 并填入实际值

# FOLIO系统登录凭据（用于ISBN获取）
FOLIO_USERNAME=your_username_here
FOLIO_PASSWORD=your_password_here

# 豆瓣API配置（如需要豆瓣评分功能）
DOUBAN_API_KEY=your_douban_api_key_here

# 数据库配置（可选）
DOUBAN_DB_PATH=./runtime/database/

# 其他敏感配置（如需要）
SECRET_KEY=your_secret_key_here
```

## 迁移步骤

### 步骤1: 创建环境变量文件

```bash
# 复制示例文件
cp config/.env.example config/.env

# 编辑.env文件，填入实际的敏感信息
nano config/.env
```

### 步骤2: 更新配置文件

在 `config/setting.yaml` 中添加豆瓣模块配置（如已存在则无需修改）。

### 步骤3: 验证配置

运行以下命令验证配置是否正确：

```python
from src.utils.config_manager import get_config_manager

# 测试配置管理器
config_manager = get_config_manager()
douban_config = config_manager.get_douban_config()
print("豆瓣配置:", douban_config)
```

### 步骤4: 测试功能

运行豆瓣模块测试功能是否正常：

```bash
# 测试ISBN获取功能
python src/core/douban/douban_main.py list
python src/core/douban/douban_main.py isbn --excel-file "your_test_file.xlsx"
```

## 使用说明

### 1. 基本使用

```python
from src.core.douban.isbn_resolver import resolve_isbn_from_excel

# 自动从配置文件读取用户名密码
output_file, stats = resolve_isbn_from_excel(
    excel_file_path="月归还数据.xlsx",
    barcode_column="书目条码",
    output_column="ISBN号"
)
```

### 2. 自定义配置覆盖

```python
# 自定义用户名密码（覆盖配置文件）
output_file, stats = resolve_isbn_from_excel(
    excel_file_path="月归还数据.xlsx",
    username="custom_user",
    password="custom_pass"
)

# 更复杂的配置覆盖
config_override = {
    'timeout': 60,
    'delay': 1.5,
    'base_url': 'https://custom.folio.com'
}
output_file, stats = resolve_isbn_from_excel(
    excel_file_path="月归还数据.xlsx",
    config_override=config_override
)
```

### 3. 环境变量管理

```bash
# 方式1: .env文件
echo "FOLIO_USERNAME=your_user" > config/.env
echo "FOLIO_PASSWORD=your_pass" >> config/.env

# 方式2: 临时环境变量
export FOLIO_USERNAME=your_user
export FOLIO_PASSWORD=your_pass

# 方式3: 配置文件中的默认值（用于调试）
# 在setting.yaml中直接设置（非推荐，用于测试）
```

## API变更

### 新增功能

1. **配置管理器**: `src/utils/config_manager.py`
   - `ConfigManager`: 主配置管理器类
   - `get_douban_config()`: 获取豆瓣模块完整配置
   - `get_secure()`: 安全获取敏感配置

2. **环境变量支持**: 
   - 支持 `.env` 文件加载
   - 支持系统环境变量
   - 支持配置覆盖机制

3. **便捷函数增强**: 
   - `config_override` 参数支持
   - 向后兼容的参数处理
   - 配置验证和错误处理

### 废弃功能

1. **配置文件参数**: `DoubanModuleManager` 的 `config_file` 参数
2. **配置保存功能**: `save_config()` 方法（显示警告）
3. **硬编码敏感信息**: 不再推荐使用

## 安全性说明

### 敏感信息管理原则

1. **生产环境**: 使用 `.env` 文件或安全的环境变量管理系统
2. **开发环境**: 可使用 `.env` 文件，但要确保不提交到版本控制
3. **测试环境**: 可以使用默认配置，但要确保测试完成后清除

### 安全建议

1. **文件权限**: 确保 `.env` 文件权限设置为 600（只有所有者可读写）
   ```bash
   chmod 600 config/.env
   ```

2. **版本控制**: 确保 `.env` 文件在 `.gitignore` 中排除
   ```bash
   echo "config/.env" >> .gitignore
   ```

3. **部署环境**: 在生产环境中使用环境变量而不是 `.env` 文件
   ```bash
   # 生产环境示例
   export FOLIO_USERNAME="prod_user"
   export FOLIO_PASSWORD="prod_password"
   ```

## 故障排除

### 常见问题

1. **配置文件不存在**
   ```
   错误: 环境变量 FOLIO_USERNAME 未设置
   解决: 检查 config/.env 文件是否存在且包含正确配置
   ```

2. **权限问题**
   ```
   错误: Permission denied
   解决: 检查 config/.env 文件权限
   ```

3. **配置格式错误**
   ```
   错误: yaml.scanner.ScannerError
   解决: 检查 config/setting.yaml YAML格式是否正确
   ```

### 调试技巧

1. **启用详细日志**
   ```python
   import logging
   logging.basicConfig(level=logging.DEBUG)
   ```

2. **检查配置加载**
   ```python
   from src.utils.config_manager import get_config_manager
   config_manager = get_config_manager()
   print("加载的配置:", config_manager.config)
   ```

3. **测试环境变量**
   ```python
   import os
   print("环境变量:", {k: v for k, v in os.environ.items() if 'FOLIO' in k})
   ```

## 最佳实践

### 1. 配置管理

- 统一使用主配置文件 `config/setting.yaml`
- 敏感信息通过 `.env` 文件管理
- 定期检查和更新配置

### 2. 开发流程

- 开发阶段使用默认配置或 `.env` 文件
- 测试阶段验证配置正确性
- 生产环境使用安全的环境变量

### 3. 维护建议

- 定期备份配置文件
- 监控配置变更的影响
- 记录配置相关的故障和解决方案

## 版本兼容性

- **Python版本**: 3.7+
- **依赖包**: pyyaml, python-dotenv
- **向后兼容**: 完全兼容旧版本API
- **升级路径**: 可平滑升级，无需修改现有代码

## 更新日志

### v1.1.0 (2025-11-02)
- 新增配置管理器 `ConfigManager`
- 支持 `.env` 文件环境变量管理
- 移除硬编码敏感信息
- 整合豆瓣模块配置到主配置文件
- 保持向后兼容性
- 提供配置验证和错误处理

---

**注意**: 本文档描述的配置优化适用于图书馆AI演示项目。如需在其他项目中使用，请根据实际情况调整配置。