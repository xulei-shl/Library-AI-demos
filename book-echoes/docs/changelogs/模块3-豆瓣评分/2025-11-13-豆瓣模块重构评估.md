# 模块3 - 豆瓣评分重构评估

## 背景与目标
- 现有豆瓣模块把「ISBN 回补」「豆瓣网页抓取」「Excel/DB 写回」揉进单一同步流程（`src/core/douban/douban_rating_processor.py`），耦合度高、维护困难。
- 新需求拆成三阶段：① 通过数据库查重直接把可复用的豆瓣字段写回 Excel；② 仅依据 ISBN 检索出豆瓣图书详情页链接并写入 `豆瓣链接` 列；③ 依据链接中的 `subject_id` 调用豆瓣 API（参考 `docs/refs/douban-spider/douban_api.py`）再写回 Excel/数据库。
- 全流程必须保留原有的异常处理、重试、登录托管、反爬限速、Excel 断点续跑，以及「全部爬取结束后写回数据库并生成 TXT 报告」的收尾动作（`src/core/douban/report_generator.py`）。
- 配置、日志、注释等需遵循 `agents.md`：模块化、单一职责、中文注释、可测试性优先，每个 py 文件尽量 <300 行。

## 现有模块测绘
| 能力 | 主要文件 | 现状摘要 |
| --- | --- | --- |
| Excel/进度托管 | `src/core/douban/progress_manager.py` | 管理 partial Excel、状态列、DB 刷写；可继续复用。 |
| 数据库与查重 | `src/core/douban/database/*.py` | `DatabaseManager` + `DataChecker` + `ExcelToDatabaseWriter`，支持批量查重/写入，但需扩展字段映射。 |
| ISBN 补全 (FOLIO) | `src/core/douban/folio_isbn_async_processor.py`、`pipelines/folio_isbn_pipeline.py` | Playwright 异步抓取，可继续提供 ISBN。 |
| 豆瓣处理器 | `src/core/douban/douban_rating_processor.py`、`async/douban_rating_processor_async.py` | 单体流程包含 Excel、FOLIO、豆瓣、DB，难以维护。 |
| 豆瓣爬虫 | `src/core/douban/crawler/douban_crawler_adapter.py` | 1750+ 行 DOM 解析，新方案仅需“获取详情页链接”。 |
| CLI/编排 | `src/core/douban/douban_main.py`、`src/core/douban/pipelines/*.py` | 只支持 Folio→豆瓣串联，缺少阶段化执行模式。 |

## 核心痛点
1. `DoubanRatingProcessor`、`douban_crawler_adapter.py` 等文件体积庞大且职责混乱，导致小改动需要动大块代码。
2. 流程顺序固定，无法执行“全量拿链接→再跑 API”这种阶段化策略，也不能单独重试某个阶段。
3. 豆瓣爬虫同时承担登录、检索、字段解析，逻辑冗余且难以与 API 调用解耦。
4. 同步/异步处理器重复同一套逻辑，维护成本翻倍。
5. `setting.yaml` 缺少链接检索/Subject API 专属配置项，无法细化限速、并发、重试策略。
6. 几乎没有单元/集成测试，变更无法快速回归。

## 文件级保留/删除建议
| 文件 | 建议 | 原因 |
| --- | --- | --- |
| `src/core/douban/douban_rating_processor.py` | 拆分/替换 | Excel & DB 写回改由新 orchestrator；豆瓣字段解析改走 API。 |
| `src/core/douban/async/douban_rating_processor_async.py` | 删除 | 与同步版本重复，新架构需重建异步协同。 |
| `src/core/douban/crawler/douban_crawler_adapter.py` | 彻底重写 | 仅保留“登录 + ISBN 搜索获取链接”能力。 |
| `src/core/douban/douban_main.py` | 重构 | CLI 需暴露三阶段入口，可单独或串行执行。 |
| `src/core/douban/pipelines/douban_rating_pipeline.py` | 重构 | 新 pipeline 负责 orchestrator、状态机与阶段调度。 |
| `src/core/douban/folio_isbn_async_processor.py` | 保留 | 继续由模块1提供 ISBN，仅需收敛接口以供阶段②调用。 |
| `src/core/douban/database/*.py` | 保留 | 扩展映射/写入策略即可，仍是查重与写库核心。 |
| `docs/refs/douban-spider/douban_api.py` | 迁移为正式模块 | 拆成 `api/subject_client.py` + `api/subject_mapper.py`，便于单测与配置。 |
| `src/core/douban/progress_manager.py` | 保留 + 扩展 | 新增“豆瓣链接完成/Subject API 完成”状态，支撑断点续跑。 |

## 重构蓝图
### 1. 三阶段 orchestrator
```
Excel -> [阶段① DB 查重写回] -> Excel' -> [阶段② ISBN->链接] -> Excel'' -> [阶段③ Subject API 填充] -> Excel_final + DB + TXT
```
- 三个阶段实现统一 `PipelineStep` 接口（`prepare -> run -> finalize`），由改造后的 `DoubanRatingPipeline` 串联。
- 每个阶段可通过 CLI / 配置启用或跳过，支持断点续跑与失败重试。

### 2. 阶段①：数据库查重与写回
- 复用 `DataChecker`、`ExcelToDatabaseWriter`，并严格执行 `docs/changelogs/模块3-豆瓣评分/db查重性能优化方案开放说明.md` 中的优化：批量查重、barcode 索引、`barcode -> row_index` 预映射、批量 flush、`save_interval` 调整等，确保查重写回性能稳定。
- `ProgressManager` 新增状态枚举：`待处理`、`已写库`、`待补链接`、`待补API`、`完成`，并记录字段来源（DB / Link / API）。
- 输出：更新 Excel（已有豆瓣字段即时写入），并返回进入阶段②的记录集合。

### 3. 阶段②：豆瓣链接采集
- 新建 `src/core/douban/link_resolver/`，拆成原子模块：
  - `login_session.py`：Playwright 会话与登录状态管理。
  - `isbn_searcher.py`：根据 ISBN 检索、解析第一条书籍链接。
  - `link_pipeline.py`：调度 session、处理重试、写回 Excel。
- 继续复用 `BrowserRecoveryMixin`、延迟/重试策略，但 DOM 解析范围缩减为搜索表单、结果列表、异常提示。
- Excel 写回通过 `fields_mapping.douban.url` 完成；支持对已有但为空的链接进行多次重试，并记录失败原因。

### 4. 阶段③：豆瓣 Subject API
- 新建 `src/core/douban/api/subject_client.py`（封装 headers、节流、重试）与 `subject_mapper.py`（迁移 `process_douban_data` 逻辑）。支持同步或异步模式，可配置 `max_concurrent`、`qps`、`timeout`、`retry_backoff`。
- `subject_pipeline.py`：读取 Excel 中的 `豆瓣链接`，提取 `subject_id`，批量调用 API，把结果写入 Excel 并通过 `ExcelToDatabaseWriter` 增量刷入数据库。
- 阶段③完整结束后，继续执行：TXT 报告生成（`DoubanReportGenerator`）+ 数据库备份，保持旧版交付物。

### 5. 配置与可观测性
- `config/setting.yaml` 增补：
  ```yaml
  douban:
    link_resolver:
      max_concurrent: 2
      headless: false
      search_delay: 1.2
      retry_times: 3
    subject_api:
      base_url: "https://m.douban.com/rexxar/api/v2/subject"
      max_concurrent: 5
      qps: 2
      timeout: 10
      retry:
        max_times: 3
        backoff: [1, 3, 5]
  ```
- 日志依旧来自 `src/utils/logger.py`，阶段②/③ 记录结构化字段（`isbn`, `douban_url`, `subject_id`, `attempt`, `latency_ms`），便于排查。

### 6. 目录规划
- `src/core/douban/link_resolver/`
  - `__init__.py`
  - `login_session.py`
  - `isbn_searcher.py`
  - `link_pipeline.py`
  - `exceptions.py`
- `src/core/douban/api/`
  - `subject_client.py`
  - `subject_mapper.py`
  - `rate_limiter.py`
- `src/core/douban/pipelines/`
  - `douban_link_pipeline.py`
  - `douban_subject_pipeline.py`
  - 更新 `__init__.py` 与 `douban_rating_pipeline.py`

## 测试与验证
1. **单元测试**（`tests/douban/`）：
   - `test_subject_mapper.py`：覆盖完整/缺字段/空列表/多作者等场景。
   - `test_subject_client.py`：mock 200/429/500，验证限流与重试。
   - `test_link_service.py`：mock Playwright Page，覆盖登录失效、无结果、成功路径。
2. **集成测试**：构建小型 Excel，含数据库命中、缺链接、缺 API 三类行，顺序跑三阶段，校验状态列与字段写入。
3. **性能回归**：提供 `--dry-run` 或统计开关，测量阶段②/③ QPS，确保不触发反爬；阶段① 需对比 `db查重性能优化方案` 指标。

## 实施顺序
1. 新建目录与配置项，编写阶段接口/空壳，确保 import 关系稳定。
2. 迁移 Subject API 逻辑（client + mapper + 单测），先验证阶段③ 独立跑通。
3. 实现阶段③ pipeline（含 DB 写回 + TXT 报告），验证对旧 Excel 的兼容性。
4. 实现阶段② link resolver，确保登录、搜索、写回完整链路。
5. 重构 `DoubanRatingPipeline` 与 `douban_main.py`，让 CLI 支持三阶段串行/单跑，同时保留 PipelineRunner 组合能力。
6. 清理旧处理器、旧 crawler 冗余代码，并补充 README/开发说明。

完成后，模块3 将具备阶段化可重跑、配置化限速、API 驱动的数据可靠性，并保留历史的数据库写回与报告产物，为后续扩展打下基础。

## 2025-11-13 模块重构落地概览
- 已完成 `src/core/douban/pipelines/douban_db_stage.py` 以及 ProgressManager 扩展，覆盖“已写库 / 待补链接 / 待补 API / 完成”等状态，并打通与数据库刷写的联动逻辑，为阶段化执行提供基础。
- 新增 `src/core/douban/api/subject_client.py`、`subject_mapper.py`、`rate_limiter.py`，封装 Subject API 的请求、映射与限流，并通过 `douban_subject_pipeline.py` 注入为独立的 API 阶段。
- 新建 `src/core/douban/link_resolver/`（Playwright 会话、登录、检索）与 `douban_link_pipeline.py`，支持自动化补链、失败重试以及 Excel 回写。
- 评分流水线改造成 orchestrator：`src/core/douban/pipelines/douban_rating_pipeline.py` 负责调度三阶段，CLI (`src/core/douban/douban_main.py`) 与 `config/setting.yaml` 也新增了相关开关与限流配置。
- 配套更新依赖（引入 httpx）与测试用例（`test/douban/test_douban_pipeline.py`、`test/douban/test_pipeline_runner.py`），并通过 `pytest test/douban/test_douban_pipeline.py test/douban/test_pipeline_runner.py` 验证。
