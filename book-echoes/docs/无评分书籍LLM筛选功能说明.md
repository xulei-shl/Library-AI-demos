# 无评分书籍LLM智能筛选功能说明

## 📋 功能概述

当启用 `allow_no_rating: true` 时,所有无豆瓣评分的书籍都会被保留为候选。但这可能导致候选数量过多(如300条无评分候选)。

本功能通过**LLM智能筛选**对无评分候选书籍进行二次评估,从而控制最终候选数量,提高推荐质量。

---

## 🎯 核心特性

### 1. **智能触发机制**
- 只有当无评分候选数量超过配置的阈值时才启动LLM筛选
- 避免不必要的LLM调用,节省成本

### 2. **分批处理**
- 将大量书籍分批次送入LLM评估
- 每批次可配置书籍数量和通过配额
- 支持断点续传和错误重试

### 3. **多维度评估**
LLM会综合考虑以下因素:
- 书名吸引力
- 内容简介质量
- 作者知名度
- 出版社信誉
- 学科价值

### 4. **可选预筛选**
在LLM前可先应用预筛选策略:
- 优先保留有指定字段值的书籍(AND逻辑:所有字段都有值才保留,任一字段为空则过滤)
- 优先保留特定学科的书籍(OR逻辑)
- 支持留空配置,留空则不执行该条件

---

## ⚙️ 配置说明

### 1. 主配置文件 (`config/setting.yaml`)

```yaml
rating_filter:
  new_sleeping:
    allow_no_rating: true  # 必须为true才会有无评分候选
    
    # 无评分书籍LLM智能筛选配置
    # 三层判断逻辑:
    # 1. 无评分候选数 > pre_filter.trigger_threshold → 触发预筛选
    # 2. 预筛选后数量 > llm_trigger_threshold → 触发LLM筛选
    no_rating_llm_filter:
      enabled: true                    # 总开关:是否启用整个LLM筛选功能
      
      # 预筛选策略(可选,在LLM前进一步缩小范围)
      pre_filter:
        enabled: true                  # 是否启用预筛选
        trigger_threshold: 150         # 预筛选触发阈值:无评分候选数>此值时才启动预筛选
        # 优先保留有指定字段值的书籍(AND逻辑,所有字段都有值才保留,任一字段为空则过滤)
        # 留空[]则不执行该条件
        prefer_with_fields: ["豆瓣目录", "豆瓣作者简介"]
        # 优先保留的学科分类(OR逻辑)
        # 留空[]则不执行该条件
        priority_categories: []
      
      # LLM筛选触发阈值(判断预筛选后的数量)
      llm_trigger_threshold: 100       # LLM触发阈值:(预筛选后)无评分候选数>此值时启动LLM筛选
      
      batch_processing:
        batch_size: 20                 # 每批书籍数量
        pass_quota_per_batch: 5        # 每批最多通过数
      
      llm_task_name: "no_rating_book_filter"
```

**参数说明:**

| 参数 | 说明 | 默认值 | 建议值 |
|------|------|--------|--------|
| `enabled` | 是否启用整个LLM筛选功能 | true | 根据需求 |
| `pre_filter.enabled` | 是否启用预筛选 | true | 根据需求 |
| `pre_filter.trigger_threshold` | 预筛选触发阈值 | 150 | 100-300 |
| `llm_trigger_threshold` | LLM筛选触发阈值 | 100 | 50-200 |
| `batch_size` | 每批书籍数量 | 20 | 15-30 |
| `pass_quota_per_batch` | 每批最多通过数 | 5 | batch_size的40-60% |

**配额计算示例:**
- 300条无评分候选,batch_size=20,pass_quota=10
- 总批次: 300÷20 = 15批
- 预期通过: 15批 × 10本 = 150本
- 实际通过: 取决于LLM评估结果,可能少于150本

### 2. LLM配置文件 (`config/llm.yaml`)

已自动添加 `no_rating_book_filter` 任务配置:

```yaml
tasks:
  no_rating_book_filter:
    provider_type: text
    temperature: 0.4
    top_p: 0.9
    prompt:
      type: file
      source: "prompts/无评分书籍筛选.md"
    
    retry:
      max_retries: 3
      enable_provider_switch: true
    
    json_repair:
      enabled: true
    
    langfuse:
      enabled: true
      name: "无评分书籍筛选"
      tags: ["book-echoes", "模块6", "新书筛选"]
```

### 3. 提示词文件 (`prompts/无评分书籍筛选.md`)

提示词要求LLM返回JSON数组,每个元素包含:
- `barcode`: 书目条码
- `decision`: "通过" 或 "不通过"
- `score`: 0-100分数
- `reason`: 评估理由(30字以内)

---

## 📊 工作流程

```
1. 基础规则过滤
   ↓
2. 评分过滤(保留无评分书籍)
   ↓
3. 统计无评分候选数量(如300条)
   ↓
4. 判断是否触发预筛选
   ├─ 否(≤150) → 跳过预筛选,直接进入步骤5
   └─ 是(>150) → 启动预筛选
       ├─ 优先保留有指定字段的书籍
       ├─ 优先保留特定学科
       └─ 预筛选后可能剩余200条
   ↓
5. 判断(预筛选后的)数量是否触发LLM筛选
   ├─ 否(≤100) → 跳过LLM筛选
   └─ 是(>100) → 启动LLM筛选
       ↓
   6. 分批调用LLM
       ├─ 构建提示词
       ├─ 调用LLM API
       ├─ 解析JSON响应
       └─ 收集通过的条码
       ↓
   7. 更新候选状态
       ├─ 通过的保留"候选"
       └─ 未通过的清空状态
```

**关键逻辑说明:**
- ✅ **三层智能判断**: 无评分候选数 → 预筛选阈值判断 → LLM阈值判断
- ✅ **预筛选智能触发**: 只有当无评分候选数超过 `pre_filter.trigger_threshold` 时才启动预筛选
- ✅ **LLM智能触发**: 只有当(预筛选后)数量超过 `llm_trigger_threshold` 时才启动LLM
- ✅ **成本优化**: 两层阈值判断,避免不必要的预筛选和LLM调用

---

## 📈 日志输出示例

### 场景1: 无评分候选数超过预筛选阈值,预筛选后仍超过LLM阈值

```
【新书评分过滤统计】
  总记录数: 1394
  候选数量: 180
  排除数量: 1214
    - 必填字段缺失: 50
    - 出版年不符合: 100
    - 题名关键词: 30
    - 索书号规则: 20
    - 评分不达标: 894
    - LLM智能筛选: 120

检测到无评分候选书籍: 300 条
无评分候选数(300) > 预筛选阈值(150),启动预筛选
预筛选后剩余: 200 条
无评分候选数(200) > LLM阈值(100),启动LLM智能筛选
开始分批LLM筛选: 共10批,每批20本,每批最多通过5本
处理第1/10批...
第1批完成: 4/20 通过
处理第2/10批...
第2批完成: 5/20 通过
...
LLM筛选完成: 45/200 通过, 155 被排除
```

### 场景2: 无评分候选数超过预筛选阈值,但预筛选后低于LLM阈值

```
检测到无评分候选书籍: 200 条
无评分候选数(200) > 预筛选阈值(150),启动预筛选
预筛选后剩余: 80 条
预筛选后无评分候选数(80) ≤ LLM阈值(100),跳过LLM筛选
```

### 场景3: 无评分候选数未达到预筛选阈值,但超过LLM阈值

```
检测到无评分候选书籍: 120 条
无评分候选数(120) ≤ 预筛选阈值(150),跳过预筛选
无评分候选数(120) > LLM阈值(100),启动LLM智能筛选
开始分批LLM筛选: 共6批,每批20本,每批最多通过5本
...
LLM筛选完成: 28/120 通过, 92 被排除
```

### 场景4: 无评分候选数未达到预筛选阈值,也未达到LLM阈值

```
检测到无评分候选书籍: 80 条
无评分候选数(80) ≤ 预筛选阈值(150),跳过预筛选
无评分候选数(80) ≤ LLM阈值(100),跳过LLM筛选
```

---

## 🔧 使用方法

### 运行模块6(新书零借阅筛选)

```bash
# 在main.py中选择对应的模块
python main.py
# 选择: 模块6 - 新书零借阅数据分析 + 智能筛选
```

### 调整配置

**场景1: 候选太多,需要更严格筛选**
```yaml
no_rating_llm_filter:
  trigger_threshold: 50              # 降低阈值,更早触发
  batch_processing:
    pass_quota_per_batch: 5          # 减少每批通过数
```

**场景2: 候选太少,需要放宽筛选**
```yaml
no_rating_llm_filter:
  trigger_threshold: 200             # 提高阈值,减少触发
  batch_processing:
    pass_quota_per_batch: 15         # 增加每批通过数
```

**场景3: 完全禁用LLM筛选**
```yaml
no_rating_llm_filter:
  enabled: false                     # 关闭功能
```

---

## 💡 最佳实践

### 1. **阈值设置**
- 建议设置为预期候选数的1.5-2倍
- 例如:期望最终100本候选,设置阈值为150-200

### 2. **批次配置**
- `batch_size`: 建议15-30,太小效率低,太大可能超时
- `pass_quota_per_batch`: 建议为batch_size的40-60%

### 3. **预筛选策略**
- **何时启用**: 当无评分候选数特别多(>500)时,建议启用预筛选
- **执行顺序**: 预筛选在阈值判断**之前**执行,可以避免不必要的LLM调用
- **字段检查(AND逻辑)**: 可配置多个字段(如豆瓣内容简介、豆瓣目录、豆瓣作者简介),所有字段都有值才保留,任一字段为空则过滤
- **学科检查(OR逻辑)**: 根据图书馆需求,优先保留重点学科,满足任一学科即保留
- **留空逻辑**: 将字段列表或学科列表设为空 `[]` 时,该条件不参与筛选

**预筛选效果示例:**
```
原始无评分候选: 300条
↓ 预筛选(保留有简介 OR I/K/B学科)
预筛选后: 150条
↓ 判断阈值(80)
150 > 80 → 启动LLM筛选
```

**过滤逻辑:**
- **字段检查(AND逻辑)** 与 **学科检查(OR逻辑)** 之间使用 **OR** 组合:
  - (所有字段都有值) **OR** (属于优先学科) → 保留
  - 既不满足字段条件又不属于优先学科 → 排除
- 如果两个条件都留空 `[]`,保留所有书籍

**字段配置示例(AND逻辑):**
```yaml
prefer_with_fields: ["豆瓣目录", "豆瓣作者简介"]
# 必须同时满足以下所有条件才保留:
# - 豆瓣目录有值 AND
# - 豆瓣作者简介有值
# 任一字段为空则过滤
```

**学科配置示例(OR逻辑):**
```yaml
priority_categories: ["I", "K", "B"]
# 满足以下任一条件即保留:
# - 索书号首字母为 I OR
# - 索书号首字母为 K OR
# - 索书号首字母为 B
```

### 4. **成本控制**
- 每批LLM调用约消耗1000-2000 tokens
- 300本书分15批,总消耗约15000-30000 tokens
- 建议监控Langfuse中的token使用情况

---

## 🐛 故障排查

### 问题1: LLM筛选未触发
**检查:**
1. `no_rating_llm_filter.enabled` 是否为 `true`
2. 无评分候选数是否超过 `trigger_threshold`
3. 查看日志中的"检测到无评分候选书籍"信息

### 问题2: JSON解析失败
**原因:** LLM返回格式不符合要求
**解决:**
1. 检查 `prompts/无评分书籍筛选.md` 提示词
2. 启用 `json_repair` 功能(已默认启用)
3. 查看日志中的"原始响应"内容

### 问题3: 通过率异常
**情况1: 通过率太低(<20%)**
- 可能是LLM评估标准过严
- 建议调整提示词,降低评分要求

**情况2: 通过率太高(>80%)**
- 可能是LLM评估标准过松
- 建议调整提示词,提高评分要求
- 或减少 `pass_quota_per_batch`

---

## 📝 技术细节

### 代码结构

```
src/core/new_sleeping/rating_filter.py
├─ NewSleepingFilterResult (数据类)
│  └─ llm_filtered_count: int  # 新增字段
│
├─ NewSleepingRatingFilter (主类)
│  ├─ apply_filter()           # 主入口,调用LLM筛选
│  ├─ _apply_no_rating_llm_filter()  # LLM筛选核心逻辑
│  ├─ _format_books_for_llm()        # 格式化书籍信息
│  └─ _apply_pre_filter()            # 预筛选逻辑
```

### 关键方法说明

**`_apply_no_rating_llm_filter()`**
- 输入: DataFrame, 候选掩码, 评分列名
- 输出: (更新后的掩码, LLM筛选排除数)
- 逻辑:
  1. 识别无评分候选
  2. 判断是否触发
  3. 应用预筛选(可选)
  4. 分批调用LLM
  5. 更新候选状态

**`_format_books_for_llm()`**
- 提取关键字段: 条码、书名、作者、出版社、简介等
- 清理空值和"nan"字符串
- 格式化为JSON字符串数组

---

## 🔄 版本历史

### v1.0 (2025-12-05)
- ✅ 初始版本发布
- ✅ 支持基于阈值的智能触发
- ✅ 支持分批处理和配额控制
- ✅ 支持可选的预筛选策略
- ✅ 完整的日志和统计输出
- ✅ 集成Langfuse监控

---

## 📞 支持

如有问题或建议,请查看:
- 代码: `src/core/new_sleeping/rating_filter.py`
- 配置: `config/setting.yaml` 和 `config/llm.yaml`
- 提示词: `prompts/无评分书籍筛选.md`
- 日志: `runtime/logs/` 目录
