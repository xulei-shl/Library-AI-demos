# 图像处理全流程分析

本文档基于对代码库的分析，详细梳理了针对 A、B、C 三种不同图像组织方式的全流程处理过程。

## 核心概念

- **图像分组 (Image Grouping)**: 系统首先通过 `src/core/image_grouping.py` 中的 `discover_image_groups` 函数，根据文件目录结构将输入图片划分为不同的组。
  - **A 类型**: 位于子目录中，且该子目录包含一个名为 `series` 的子目录。
    - `a_series`: `series` 文件夹内的图片，作为系列样本。
    - `a_object`: `series` 文件夹外的图片，作为系列中的独立对象。
  - **B 类型**: 位于子目录中，但**不包含** `series` 子目录。该目录下的所有图片被视为一个系列。
  - **C 类型**: 直接位于输入根目录下。每个图片（或根据前缀分组的图片组）被视为独立的、无系列关联的对象。

- **处理流程分派**: 系统通过检查一个图像组是否需要“系列共识”来决定其处理流程。
  - **A/B 类型**的组位于子目录中，会生成一个共识文件路径（如 `pic/S1/.series_consensus.json`），因此会进入**系列处理流程**。
  - **C 类型**的组位于根目录，无法生成共识文件路径，因此进入**非系列处理流程**。

- **处理阶段 (Stages)**: 每个图像组会依次通过一系列处理阶段，每个阶段负责提取特定的元数据。`art_style` 和 `function_type` 阶段的提示词支持动态词表注入。

---

## A 类型处理流程 (系列处理)

**结构示例**: `pic/S1/series/` (系列样本) 和 `pic/S1/id-1.jpg` (对象图像)

**目标**: 识别系列信息，并对系列中的每个对象进行详细描述，同时确保系列级别字段的一致性。

处理流程遵循“先生成、后共识”的两阶段模式：

### 阶段 1: 初始 JSON 生成

在此阶段，系统为系列中的所有相关图片生成初始的元数据 JSON 文件，并统一输出到 `runtime/outputs/`。

1.  **系列样本处理 (`a_series`)**:
    - **输入**: `pic/S1/series/` 目录下的图片。
    - **操作**:
        - 执行 `fact_description` 阶段 (仅提取系列级事实字段)。
        - 执行 `art_style` 阶段。
        - **合并结果**，生成系列元数据。
    - **输出**: 生成一个系列 JSON 文件（如 `S_S1_series.json`）。

2.  **对象图像处理 (`a_object`)**:
    - **输入**: `pic/S1/` 目录下的每个对象图片（如 `id-1.jpg`）。
    - **操作**: 对每个对象依次执行 `fact_description` -> `art_style` -> `function_type` 阶段，生成基础元数据。
    - **输出**: 为每个对象生成一个 JSON 文件（如 `id-1.json`）。

### 阶段 2: 共识、应用与修正

当一个系列的所有初始 JSON 文件都生成完毕后，系统启动第二阶段。

1.  **系列共识 (`series_consensus`)**:
    - **触发**: 同一子文件夹（如 `pic/S1/`）的所有初始 JSON 文件均已生成。
    - **输入**:
        - 系列样本 JSON 文件。
        - 从该系列的对象 JSON 文件中至多抽取 3 个作为样本。
    - **操作**: 执行 `series_consensus` 阶段，对系列级字段（如 `manufacturer`, `country`, `art_style`）进行投票，形成共识。
    - **输出**: 在原始图像目录（`pic/S1/`）下生成一个 `.series_consensus.json` 文件。

2.  **共识应用与修正 (Consensus Application & Correction)**:
    - **操作**:
        - 系统读取 `.series_consensus.json` 的内容。
        - **批量更新**:
            - **系列样本 JSON**（如 `S_S1_series.json`）：从共识更新 4 个字段：
                - `name` ← `series_name`
                - `manufacturer` ← `manufacturer`
                - `country` ← `country`
                - `art_style` ← `art_style`
                - 注意：系列样本**不包含** `inferred_era` 字段
            - **对象 JSON**：从共识更新 5 个字段：
                - `series.name` ← `series_name`
                - `manufacturer` ← `manufacturer`
                - `country` ← `country`
                - `art_style` ← `art_style`
                - `inferred_era` ← `inferred_era`
        - **修正阶段跳过**: A 类型在应用共识字段后**跳过 `correction` 阶段**，因为系列级字段已通过共识确保一致性。
    - **输出**: 更新了共识字段的最终 JSON 文件（包括系列样本和对象）。

---

## B 类型处理流程 (系列处理)

**结构示例**: `pic/S2/id-1.jpg`, `pic/S2/id-2.jpg`

**目标**: 将同一子目录下的图片视为一个系列，提取系列共识，并对每个对象进行描述。

B 类型的处理流程与 A 类型相似，因为它同样属于系列处理流程，但由于没有独立的系列样本，流程稍有不同。

### 阶段 1: 初始 JSON 生成

1.  **对象图像处理**:
    - **输入**: `pic/S2/` 目录下的每个对象图片。
    - **操作**: 对每个对象依次执行 `fact_description` -> `art_style` -> `function_type` 阶段。
        - `fact_description` 阶段会尝试从图片中直接提取系列信息（`series.name` 和 `series.no`）。
    - **输出**: 为每个对象生成一个初始 JSON 文件。

### 阶段 2: 共识、应用与修正

1.  **系列共识 (`series_consensus`)**:
    - **触发**: 同一子文件夹（如 `pic/S2/`）的所有初始 JSON 文件均已生成。
    - **输入**: 从该系列的所有对象 JSON 文件中至多抽取 3 个作为样本。
    - **操作**: 执行 `series_consensus` 阶段，对系列级字段进行投票，形成共识。
    - **输出**: 在原始图像目录（`pic/S2/`）下生成一个 `.series_consensus.json` 文件。

2.  **共识应用与修正 (Consensus Application & Correction)**:
    - **操作**:
        - 系统读取 `.series_consensus.json` 的内容。
        - **批量更新**: 将共识字段更新至该系列在 `runtime/outputs/` 中的**全部**对象 JSON 文件。
            - B 类型**没有**系列样本 JSON，只更新对象 JSON
            - 对象 JSON 从共识更新 5 个字段：`series.name`, `manufacturer`, `country`, `art_style`, `inferred_era`
        - **修正阶段跳过**: 与 A 类型相同，B 类型在应用共识字段后也会**跳过 `correction` 阶段**。
    - **输出**: 更新了共识字段的最终对象 JSON 文件。

---

## C 类型处理流程 (非系列处理)

**结构示例**: `id-1.jpg`, `id-2.jpg` (位于根目录)

**目标**: 将根目录下的每张图片视为独立的、无系列关联的对象进行处理。

### 流程

C 类型的处理流程是一个简化的独立对象处理流水线，**完全跳过**了所有与系列相关的步骤（如 `series_consensus`）。

对根目录下的每个对象（如 `id-1.jpg`）执行以下操作：

1.  **事实描述 (Fact Description)**
    - **操作**:
        - `noseries` 参数设置为 `True`，因为这些对象被假定为无系列关联。
        - 调用 LLM，使用 `src/prompts/fact_description-noseries.md` 提示词。
    - **输出**: 基础元数据 JSON。

2.  **艺术风格 (Art Style)**
    - **输入**: 对象图片。
    - **操作**: 同 A/B 类型。
    - **输出**: `art_style` 字段被合并。

3.  **功能类型 (Function Type)**
    - **输入**: 对象图片和第一步生成的 JSON。
    - **操作**: 同 A/B 类型。
    - **输出**: `function_type` 字段被合并。

4.  **修正 (Correction)**
    - **输入**: 已合并所有阶段信息的 JSON。
    - **操作**: 在流程的最后，对生成的 JSON 进行字段校验和修正。
    - **输出**: 最终的对象元数据 JSON 文件，如 `id-1.json`。

**总结**: C 类型流程最简单，它将每个图像组视为一个独立的实体，依次通过 `fact_description` -> `art_style` -> `function_type` -> `correction` 四个核心阶段，无系列共识环节。