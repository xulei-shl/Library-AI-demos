# 图像处理流程中的大模型调用分析 (修正版)

本文档分析了在处理图像并生成最终JSON文件的过程中，对大语言模型（LLM）的调用次数和每次调用的具体作用。

**核心机制澄清**:
在开始分析前，最重要的一点是明确代码如何处理图片：
- **图像分组**: 系统会根据文件名自动分组。例如，`ID-1.jpg` 和 `ID-2.jpg` 会被识别为属于同一个对象 `ID` 的两张图片。
- **批量处理**: 在调用大模型时，**同一组的所有图片会作为一个整体，在单次API调用中被一并传入**。因此，后续分析中的“调用次数”是基于**图像组**的数量，而非单个图片文件的数量。

---

## 场景一：系列处理流程 (Series Processing)

此流程适用于有关联的、可构成一个系列的图像组。我们以一个典型的系列为例，该系列包含 **1个系列样本组** (a_series) 和 **3个不同的对象组** (a_object/b)。

### 阶段1：初步处理 (10次 LLM 调用)

此阶段为系列中的每个组生成独立的描述信息。

1.  **`series` 阶段 (1次调用)**
    *   **作用**: 识别整个系列的共同名称。此调用处理**系列样本组** (`a_series` 类型) 的所有图片。
    *   **调用模块**: `src/core/stages/series.py`

2.  **`fact_description` 阶段 (3次调用)**
    *   **作用**: 为 **3个对象组** 中的 **每一个组** 提取基础事实元数据。每次调用都会传入该组的全部图片。
    *   **调用模块**: `src/core/stages/fact_description.py`

3.  **`art_style` 阶段 (3次调用)**
    *   **作用**: 为 **3个对象组** 中的 **每一个组** 识别其艺术风格。
    *   **调用模块**: `src/core/stages/art_style.py`

4.  **`function_type` 阶段 (3次调用)**
    *   **作用**: 为 **3个对象组** 中的 **每一个组** 判断其功能类型。
    *   **调用模块**: `src/core/stages/function_type.py`

### 阶段2：系列共识生成 (7次 LLM 调用)

此阶段为整个系列生成统一的元数据。假设从3个对象组中取样进行共识。

1.  **`art_style` 阶段 (3次调用)**
    *   **作用**: 在生成共识前，为 **3个样本组** 中的 **每一个组** 重新提取艺术风格，作为共识投票的输入。
    *   **调用模块**: `src/core/stages/art_style.py`

2.  **`fact_description` 阶段 (3次调用)**
    *   **作用**: 同样，为 **3个样本组** 中的 **每一个组** 重新提取事实元数据。
    *   **调用模块**: `src/core/stages/fact_description.py`

3.  **`series_consensus` 阶段 (1次调用)**
    *   **作用**: 最终的“投票”环节。LLM接收来自多个样本组的所有元数据，并提炼出整个系列的最终共识字段。这是一个纯文本任务。
    *   **调用模块**: `src/core/stages/series_consensus.py`

**总计**: 对于一个包含1个系列样本组和3个对象组的系列，大约会发生 1 + (3*3) + (3*2) + 1 = **17次** LLM调用。

---

## 场景二：非系列处理流程 (Non-Series Processing)

此流程适用于独立的、无系列归属的图像组。对于 **3个独立的图像组**，总共会发生 **12次** LLM调用。

对于这3个图像组中的**每一个组**，都会独立执行以下4次LLM调用（总计 3 * 4 = 12次）。每次调用都会包含该组内的所有图片。

1.  **`fact_description` 阶段 (3次调用)**
    *   **作用**: 为每个组提取基础事实元数据（使用 `noseries=True` 的特定提示）。
    *   **调用模块**: `src/core/stages/fact_description.py`

2.  **`art_style` 阶段 (3次调用)**
    *   **作用**: 为每个组识别艺术风格。
    *   **调用模块**: `src/core/stages/art_style.py`

3.  **`function_type` 阶段 (3次调用)**
    *   **作用**: 为每个组判断功能类型。
    *   **调用模块**: `src/core/stages/function_type.py`

4.  **`correction` 阶段 (3次调用)**
    *   **作用**: 对为该组生成的JSON数据进行最终的校验和修正。
    *   **调用模块**: `src/core/stages/correction.py`