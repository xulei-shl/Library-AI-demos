# Matchbox: AI 驱动的图像资料编目系统

Matchbox 是一个基于大型视觉语言模型（LVLM）的 AI 系统，专用于分析和编目“火花”（火柴盒标签）等图像资料。系统通过一个复杂的多阶段分析管道，自动为每张图像生成详细、结构化的元数据。

## 核心功能

- **多阶段元数据提取**: 对图像进行深度分析，提取包括事实描述（物理特征、文本内容）、艺术风格和功能类型在内的丰富信息。
- **系列共识机制**: 两阶段处理流程，识别图像系列，并通过 LLM 投票形成系列级别的共识，确保同一系列下所有资料元数据的一致性（如制造商、国家、艺术风格等）。
- **模块化管道架构**: 采用高度模块化的架构，将系列处理与非系列处理分离，并由专门的处理器和管理器负责编排、共识与更新，提高了处理效率和可维护性。

## 主要处理流程

系统根据图像的目录结构自动选择不同的处理流程：

#### 1. 系列处理流程 (针对 A/B 类型)

当图像被组织在子目录中时，系统会将其识别为一个“系列”，并启动两阶段处理：

- **阶段一：初始 JSON 生成**
  - 系统首先对系列中的每张图片（或系列样本）独立进行分析，执行 `fact_description` -> `art_style` -> `function_type` 等初始阶段。
  - 为每张图片在 `runtime/outputs/` 目录下生成一个临时的元数据 JSON 文件。

- **阶段二：共识、应用与修正**
  - 当一个系列的所有初始 JSON 文件生成完毕后，系统会抽取样本，调用 LLM 对系列级的核心字段（如 `series_name`, `manufacturer`, `art_style`）进行投票，形成共识。
  - 共识结果被保存在源图像目录下的一个隐藏文件 `.series_consensus.json` 中。
  - 最后，系统读取共识结果，并将其批量更新到该系列的所有 JSON 文件中，以确保系列内数据的高度一致性。此阶段完成后，会跳过最终的 `correction` 修正环节。

#### 2. 非系列处理流程 (针对 C 类型)

当图像直接位于输入根目录下时，系统将其视为独立的、无系列关联的对象。

- **线性流水线**:
  - 每张图片会依次通过一个简化的线性处理流程：`fact_description` -> `art_style` -> `function_type` -> `correction`。
  - 所有处理在一个步骤内完成，直接在 `runtime/outputs/` 目录下生成最终的 JSON 文件。此流程不涉及任何系列共识。

## 如何使用

#### 1. 环境配置

- **Python**: 确保已安装 Python 3.x 环境。
- **依赖**: 运行 `pip install -r requirements.txt` 来安装所需依赖。
- **API 密钥**: 在项目根目录创建 `.env` 文件，并配置所需的 LLM API 密钥。
  ```
  OPENAI_API_KEY="sk-..."
  DASHSCOPE_API_KEY="sk-..."
  # 其他服务商的密钥
  ```
- **项目设置**: `config/settings.yaml` 文件包含了处理流程的详细配置，例如速率限制、样本数量、是否强制重新生成等，可根据需求进行调整。

#### 2. 准备图像

将需要处理的图像放入一个输入文件夹（例如 `my_images/`）。请遵循以下目录结构，以确保系统能正确识别处理类型：

```
my_images/
├── S1/                  # A 类型: 包含 series 子目录
│   ├── series/
│   │   └── sample.jpg
│   └── object1.jpg
│
├── S2/                  # B 类型: 子目录中的所有图片被视为一个系列
│   ├── image1.jpg
│   └── image2.jpg
│
└── image3.jpg           # C 类型: 根目录下的独立图片
```

#### 3. 运行程序

通过 `main.py` 启动处理流程。使用 `--input_path` 参数指定包含图像的目录。

```bash
python main.py --input_path my_images/
```

#### 4. 查看结果

- **JSON 元数据**: 所有处理完成的元数据 JSON 文件将保存在 `runtime/outputs/` 目录中。
- **系列共识文件**: 对于 A/B 类型的系列，可以在其原始目录（如 `my_images/S1/`）下找到 `.series_consensus.json` 文件，其中记录了系列的核心共识信息。
- **日志**: 详细的运行日志记录在 `runtime/logs/app.log` 中，便于追踪和调试。
- **最终表格**: 程序运行结束后，会在 `runtime/outputs/` 目录下生成一个 `results.csv` 文件，汇总了所有图像的关键元数据。

## 项目结构

```
.
├── config/              # 配置文件 (settings.yaml)
├── docs/                # 项目设计与分析文档
├── main.py              # 主程序入口
├── openspec/            # oepnspec vibe coding文档
├── runtime/             # 运行时生成的文件
│   ├── logs/            # 日志文件
│   └── outputs/         # 输出的 JSON 和 CSV 文件
├── src/                 # 核心源代码
│   ├── core/            # 核心处理逻辑与管道
│   ├── utils/           # 工具模块 (LLM API, 日志等)
│   └── ...
└── README.md            
```
