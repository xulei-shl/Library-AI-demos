## 步骤

1. 数据筛选
   1. 全量历史验收数据初始化过滤
   2. F:\Github\Library-AI-demos\book-echoes\src\scripts\data_filter.py
      1. 有独立的配置文件：config\data_filter.yaml
      2. 输入路径："data/new/2025"， # 目录路径，将扫描该目录下的所有Excel文件
   3. 独立运行的数据过滤脚本，用于批量处理图书馆书目 Excel 数据。根据配置的过滤规则（索书号、题名关键词）筛选数据，并输出符合条件和被过滤的数据集。
   4. 运行
      1. python src/scripts/data_filter.py
2. 使用主程序的命令4，执行豆瓣API，并写入DB
   1. 配置：
      1. dynamic_filter_enabled: false
      2. isbn_supplement: enabled: false
   2. 4️⃣. 🔗 模块3-B-公共模块: 豆瓣模块（FOLIO ISBN（新书需配置） + 豆瓣 ISBN API + 配置是否启用动态评分过滤）:
3. 如果写入db失败
   1. 代码路径：src\tools\excel_import_with_version.py
   2. 则执行：python src/tools/excel_import_with_version.py runtime/outputs/数据筛选结果_20251214_093840_ISBN_API结果_20251217_183619.xlsx
4. 数据向量化
   1. 代码在 F:\Github\Library-AI-demos\rss-fetcher\scripts\vectorize_books.py
      1. 独立的配置文件：config\book_vectorization.yaml
   2. 运行
      1. python scripts/vectorize_books.py。只将embedding_status = pedding的数据向量化
5. 独立的向量检索（含检索结果从db中获取完整元数据）
   1. F:\Github\Library-AI-demos\rss-fetcher\scripts\retrieve_books.py
   2. 运行：python scripts/retrieve_books.py --interactive
6. 初评与导语
   1. python scripts/retrieve_books.py --interactive

7. 检索API启动
  1. uvicorn scripts.api.book_retrieval_api:app --reload

---

# 图书向量检索工具 - 交互式模式操作指南

本指南详细介绍了交互式图书检索工具的六种检索模式的完整操作流程，帮助普通用户了解每种模式的功能、输入输出和执行过程。

## 命令启动

```bash
python scripts/retrieve_books.py --interactive
```

启动后将显示欢迎界面和六种检索模式菜单。

---

## 模式一：文本检索 - 根据关键词搜索相似书籍

### 功能说明
通过输入的关键词或文本，在图书数据库中搜索语义相似的书籍。系统会将关键词转换为数学向量，通过向量相似度计算找到最相关的书籍。

### 输入内容
- **直接输入文本**：用户输入具体的关键词或短语
- **从文件读取**：提供包含查询文本的文件路径（UTF-8编码）
- **返回结果数量**：用户指定要显示的书籍数量（默认5本）
- **最低豆瓣评分过滤**：可选的评分筛选条件（不输入则不过滤）

### 执行过程
1. **文本向量化**：将用户输入的关键词转换为数学向量表示
2. **向量检索**：在图书向量数据库中搜索相似向量
3. **数据库补充**：从SQLite数据库中获取每本书的完整信息
4. **去重处理**：基于书籍ID和索书号进行智能去重，保留最新记录
5. **结果排序**：按照相似度分数从高到低排序

### 输出结果
- 书籍列表，包含书名、作者、评分、简介、索书号等完整信息
- 每本书显示相似度分数和embedding_id
- 结果同时保存为JSON和Markdown格式文件

---

## 模式二：分类检索 - 按索书号分类浏览高评分书籍

### 功能说明
按照图书馆索书号分类系统，快速浏览某个学科分类下的高评分书籍。不使用向量检索，直接从数据库查询。

### 输入内容
- **索书号首字母**：输入A-Z的字母，对应不同学科分类
  - A - 马克思主义、哲学、宗教
  - B - 社会科学总论
  - C - 政治、法律
  - D - 军事
  - E - 经济
  - F - 文化、科学、教育、体育
  - G - 语言、文字
  - H - 文学
  - I - 艺术
  - J - 历史、地理
  - K - 综合性图书
  - N - 自然科学总论
  - O - 数理科学和化学
  - P - 天文学、地球科学
  - Q - 生物科学
  - R - 医药、卫生
  - S - 农业科学
  - T - 工业技术
  - U - 交通运输
  - V - 航空、航天
  - X - 环境科学、安全科学
  - Z - 综合性图书
- **返回结果数量**：指定显示的书籍数量（默认10本）

### 执行过程
1. **直接数据库查询**：根据索书号首字母直接从SQLite数据库查询
2. **按评分排序**：查询结果按豆瓣评分从高到低排序
3. **结果返回**：返回该分类下评分最高的书籍

### 输出结果
- 特定分类的书籍列表，显示书名、作者、评分、年份、索书号
- 结果保存为JSON和Markdown格式

---

## 模式三：多查询检索 - 从Markdown文件生成多个子查询

### 功能说明
从已生成的文章交叉分析Markdown报告中自动提取多个查询关键词，分别进行检索，然后智能融合结果。支持高级重排序功能。

### 输入内容
- **Markdown文件路径**：提供文章交叉分析报告的文件路径
- **每个子查询候选数量**：每个查询返回的候选书籍数量（默认15本）
- **最终返回结果数量**：最终融合后返回的书籍数量（默认15本）
- **最低豆瓣评分过滤**：可选的评分筛选条件
- **是否启用重排序**：可选择使用SiliconFlow Reranker进行结果重排序

### 执行过程
1. **Markdown解析**：自动解析交叉分析报告，提取四类信息：
   - **主要查询**：从"共同母题"部分提取核心主题
   - **标签**：从标签表格中提取相关标签
   - **洞察**：从"深度洞察"部分提取深度分析内容
   - **书籍**：从"提及书籍"表格中提取直接提到的书名
2. **多轮检索**：对每个提取的查询分别进行向量检索
3. **结果融合**：使用加权算法将所有查询结果融合成一个有序列表
4. **精确匹配**（可选）：如果启用，对关键词进行精确匹配搜索
5. **重排序**（可选）：使用高级AI模型对融合结果重新排序
6. **去重合并**：将向量检索和精确匹配结果智能合并

### 输出结果
- 融合后的书籍列表，包含相似度分数、融合分数、精确匹配标注
- 显示每个结果来自哪个查询类型（主要查询、标签、洞察等）
- 启用重排序时显示最终分数
- 自动询问是否继续导出完整Excel文件

---

## 模式四：Excel导出 - 从JSON结果导出完整书籍信息到Excel

### 功能说明
将之前检索生成的JSON结果文件中的书籍ID提取出来，从数据库查询完整的书籍信息并导出为格式化的Excel文件。

### 输入内容
- **JSON结果文件路径**：之前检索操作生成的JSON文件路径

### 执行过程
1. **文件验证**：检查JSON文件是否存在且格式正确
2. **ID提取**：从JSON文件中提取所有书籍的ID列表
3. **数据库查询**：根据书籍ID列表从SQLite数据库批量查询完整信息
4. **数据过滤**：过滤掉不需要导出的技术字段（如嵌入状态、创建时间等）
5. **字段映射**：将数据库字段名转换为友好的中文列名
6. **Excel生成**：创建格式化的Excel文件，自动调整列宽
7. **文件保存**：保存到指定路径（默认为runtime/outputs/excel目录）

### 输出结果
- 包含完整书籍信息的Excel文件，字段包括：
  - 基本信息：ID、书目条码、索书号、书名、ISBN等
  - 豆瓣信息：书名、作者、评分、简介、作者简介、目录等
  - 出版信息：出版社、出版年份、页数、装帧、定价等
- 列宽自动调整，便于阅读

---

## 模式五：大模型主题筛选 - 基于文章主题分析报告筛选书籍

接着上述的第四步，我们已经导出了包含所有书籍信息的Excel文件。现在，我们将使用大模型来评估每本书与文章主题（md文档）的匹配度，并筛选出最相关的书籍。

### 功能说明
使用人工智能大语言模型，根据文章主题分析报告的深度内容，智能评估每本书与文章主题的匹配度，筛选出最相关的书籍。

### 输入内容
- **文章主题分析报告文件路径**：包含深度文章分析内容的Markdown文件
- **图书元数据Excel文件路径**：包含书籍基本信息的Excel文件

### 执行过程
1. **报告读取**：读取并解析文章主题分析报告内容
2. **书籍数据加载**：从Excel文件中加载所有书籍的元数据信息
3. **批量评估**：使用LLM对每本书进行智能评估：
   - 分析书籍与文章主题的相关性
   - 评估维度的契合度
   - 生成New Yorker风格的评语
4. **结果整理**：将评估结果添加到Excel文件中，包括：
   - 是否通过筛选（布尔值）
   - 1-5分评分
   - 主题相关性描述
   - 维度契合度描述
   - 详细评语
5. **统计报告**：生成评估统计信息，显示成功率、通过率等
6. **失败处理**：对评估失败的书籍生成摘要报告

### 输出结果
- 增强后的Excel文件，包含所有原始书籍信息和新增的AI评估结果
- 评估统计报告，显示总体筛选情况
- 失败书籍摘要（如果存在）

---

## 模式六：大模型推荐导语 - 根据文章分析报告和筛选书籍生成推荐导语

### 功能说明
基于文章主题分析报告和经过筛选的书籍列表，使用大语言模型生成专业水准的推荐导语，包含标题、策展人手记、阅读谱系和结语等完整内容。

### 输入内容
- **文章分析报告文件路径**：包含文章深度分析内容的Markdown文件
- **图书元数据Excel文件路径**：包含经过主题筛选的书籍信息的Excel文件

### 执行过程
1. **文章报告加载**：读取并解析文章主题分析报告
2. **筛选书籍加载**：从Excel文件中加载已通过主题筛选的书籍数据
3. **内容构建**：将文章分析和书籍信息整合成结构化的提示词
4. **AI生成**：调用大语言模型生成专业的推荐导语
5. **文件保存**：将生成的推荐导语保存为Markdown文件

### 推荐导语结构
- **标题**：吸引人的推荐标题
- **策展人手记**：基于文章主题的专业解读
- **阅读谱系**：推荐的阅读顺序和关联性说明
- **结语**：总结性的推荐理由

### 输出结果
- 专业的推荐导语Markdown文件，包含完整的策展内容和推荐理由
- 文件保存在与Excel文件相同的目录下
- 文件名格式：原文件名_推荐导语_时间戳.md

---

## 准备工作和数据流程

### 完整数据处理流程
1. **数据筛选**：使用独立脚本处理图书馆Excel数据，配置过滤规则
2. **豆瓣API补充**：获取书籍的豆瓣评分、简介等补充信息
3. **数据向量化**：将书籍信息转换为数学向量表示
4. **交互式检索**：使用六种模式进行各种类型的图书检索
5. **深度筛选和推荐**：使用AI进行主题筛选和推荐导语生成

### 技术优势
- **向量检索**：基于语义相似度的智能搜索
- **多维度融合**：综合考虑主题、标签、洞察等多个角度
- **AI增强**：使用大语言模型提供专业评估和推荐
- **智能去重**：自动处理重复数据，确保结果质量