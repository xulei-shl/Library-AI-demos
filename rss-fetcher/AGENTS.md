## 代码工艺标准 (Code Craftsmanship Standards)

**这是你在执行任何协议时，必须遵循的详细技术规范和最佳实践。**

### 代码哲学 (Code Philosophy): 简洁至上 (Simplicity First)
- **KISS原则**: 优先保证代码简洁易懂 (Keep It Simple, Stupid)。
- **避免过度设计**: 拒绝不必要的复杂性，选择简单、实用的方案。
- **全局视野**: 在进行任何修改或解释前，必须先理解项目的所有相关代码，避免产生副作用。
- **最小化修改**: 实施改动时，应以最小化为原则，尽可能不影响其他模块。

### 代码工艺 (Code Craftsmanship): 高内聚, 低耦合
- **模块化**: 积极使用设计模式进行模块化设计，确保代码结构清晰。
- **函数设计**: 保持函数短小精悍，功能单一，注重可复用性，严格避免重复代码 (DRY - Don't Repeat Yourself)。
- **代码行数**: 对于 Python、JavaScript、TypeScript 等动态语言，每个代码文件**建议**控制在200行以内。如果超出，应有充分理由（如逻辑高度内聚），并在文档中说明。
- **可测试性设计与验证 (Design for Testability & Verification)**:
	- **测试先行**: 在开发新功能、修复复杂Bug或重构逻辑时，必须优先考虑如何对其进行测试。
	- **提供单元测试**: 对于所有新增或被显著修改的核心函数/模块，必须提供具体的单元测试代码。
	- **代码文件位置**: 测试代码文件保存于 `test/` 目录下。
	- **明确测试场景**: 单元测试应至少覆盖：
		- **正常用例 (Happy Path):** 验证功能在预期输入下的正确行为。
		- **边界用例 (Boundary Cases):** 验证功能在临界值下的表现。
		- **异常用例 (Error Cases):** 验证功能在无效输入或内部错误时能按预期处理。

#### 代码注释 (Code Comments):
	-   **语言规范**: 所有注释，包括文档字符串（Docstrings）、行内注释和 `TODO/FIXME` 标记，**必须**使用**中文**编写，以确保团队内部沟通的一致性和清晰性。
	-   **注释的黄金法则**: 优先通过编写更清晰、自解释的代码来避免不必要的注释。只有当代码无法解释其背后的意图时，才添加注释。
	-   **公开API/函数文档字符串 (Docstrings)**:
	    -   所有非私有的（public）模块、类和函数都**必须**包含文档字符串。
	    -   文档字符串应遵循统一的格式（如Google Style或reStructuredText for Python），并至少包含：
	        -   **摘要**: 一句话概括其功能。
	        -   **参数 (Args)**: 对每个参数的描述、类型及是否必需。
	        -   **返回 (Returns)**: 对返回值的描述和类型。
	        -   **抛出异常 (Raises)**: 描述可能抛出的异常及其原因。
	-   **解释复杂逻辑**: 对于复杂的算法、正则表达式或特定的业务规则，应在代码上方添加注释，解释其设计思路或选择该方案的原因。
	    -   **坏例子**: `# i = i + 1  // 递增i` (代码已经说明了“做什么”)
	    -   **好例子**: `# 补偿上游API返回的从0开始的索引，使其与我们系统中从1开始的ID对齐`
	-   **待办事项注释 (TODO/FIXME)**:
	    -   使用 `TODO:` 标记已知需要实现但尚未完成的功能。
	    -   使用 `FIXME:` 标记已知存在问题但暂时无法修复的代码。
	    -   所有此类注释都应包含责任人（或提出者）和简要说明，最好关联到具体的任务/工单ID，例如：`# TODO(user@example.com, TICKET-123): Add pagination support.`
	-   **禁止垃圾注释**: **严禁** 将大段不再使用的代码注释掉。这些历史记录应交由版本控制系统（如Git）管理。

#### 日志记录 (Logging): 系统可观测性的基石

日志是生产环境中诊断问题、监控系统状态的唯一窗口。日志记录必须是结构化、有意义且可配置的。
- **语言规范**: 日志消息内容**必须**使用**中文**编写。这有助于在生产环境中快速定位和理解问题，特别是对于非开发人员（如运维团队）。
- **集中化配置与共享**:

  -   日志配置是典型的**全局辅助功能**。项目的日志初始化和配置代码**必须**放在 `src/utils/logger.py` (或类似) 的共享模块中。
  -   应用中的其他任何模块都**不应**自行配置日志器（Logger），而应从这个共享模块中获取已经配置好的实例。这完美契合了【项目结构】中对 `src/utils/` 目录的定义。

- **使用标准日志级别**: 严格遵循标准的日志级别，并正确使用它们：

  -   **`DEBUG`**: 仅用于开发和诊断。包含详细的变量值、执行路径等信息。**绝不**应在生产环境中开启。
  -   **`INFO`**: 记录应用生命周期中的关键事件。例如：服务启动、配置加载、用户成功登录等。
  -   **`WARNING`**: 发生了预期之外但不会立即影响服务运行的事情。例如：使用了即将废弃的API、配置项缺失但有默认值。
  -   **`ERROR`**: 发生了错误，导致某次操作失败，但应用本身还能继续运行。例如：处理单个请求失败、数据库事务回滚。
  -   **`CRITICAL`**: 发生了严重错误，可能导致整个应用停止服务。例如：数据库连接丢失、关键组件无法启动。

- **结构化日志 (Structured Logging)**:
  - **推荐**使用**键值对（Key-Value Pair）**或其他易于机器解析的格式进行日志记录，以替代纯文本字符串。这种格式在保持结构化的同时，也具备良好的人类可读性。
  - 每条日志都应包含标准字段，如 `timestamp`, `level`, `module_name`, `message`。
  - **附带上下文信息**: 日志的核心价值在于上下文。记录日志时，**必须**包含关键的上下文变量，如 `user_id`, `request_id`, `order_id` 等。这使得日志不仅是孤立的事件记录，而是可追踪、可聚合的数据点。
- **严禁记录敏感信息**: **绝不**能在日志中记录任何敏感数据，包括但不限于：密码、API密钥、Token、身份证号、银行卡号等。
- **日志文件管理**:
  -   所有日志文件都应输出到 `runtime/logs/` 目录，该目录已在 `.gitignore` 中被忽略。
  -   应配置日志轮转（Log Rotation）策略，以防止日志文件无限增长，例如按天或按大小分割。