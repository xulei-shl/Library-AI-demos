# 开发变更记录
- **日期**: 2025-12-14
- **对应设计文档**: [docs/书目数据向量化/检索相关性优化实践.md](../书目数据向量化/检索相关性优化实践.md)

## 1. 变更摘要
- 新增 Markdown 检索资产解析、查询包管理、结果融合与 rerank 支撑模块，完成多子查询检索闭环。
- 扩展 `BookRetriever` 与 CLI，支持 `--from-md` 自动解析、按配置执行多轮检索、可选 SiliconFlow reranker。
- 同步更新配置与单元测试，确保新参数与流程可回归验证。

## 2. 文件清单
- `config/book_vectorization.yaml`: 新增 multi_query / fusion / reranker 配置块。
- `config/llm.yaml`: 增补 `query_assets_expansion` 任务占位。
- `src/core/book_vectorization/query_assets.py`: 新增 Markdown 解析与查询包构建模块。
- `src/core/book_vectorization/fusion.py`: 新增多子查询结果融合工具。
- `src/core/book_vectorization/reranker.py`: 新增 SiliconFlow reranker 客户端封装。
- `src/core/book_vectorization/retriever.py`: 接入多子查询、融合与 rerank 流程。
- `scripts/retrieve_books.py`: CLI 支持 `--from-md`、`--per-query-top-k`、`--final-top-k`、`--enable-rerank` 等参数。
- `tests/test_book_vectorization/test_retrieve_books_cli.py`: 更新并新增多查询回归测试。

## 3. 测试结果
- [x] 单元测试通过：`pytest tests/test_book_vectorization/test_retrieve_books_cli.py`
- [ ] 核心路径验证通过

## 4. Markdown 解析失败兜底（LLM Recovery）
为避免 Markdown 结构变动或标记缺失导致检索完全空跑，在 `build_query_package_from_md`（`src/core/book_vectorization/query_assets.py:193-203`）中新增 LLM 兜底流程。

### 4.1 触发条件
- Markdown 文件存在且读取成功。
- 正常解析后 `QueryPackage.count()==0`（`query_assets.py:61-64`）。
- CLI 未显式关闭兜底（新增 `--disable-llm-fallback`，默认关闭为 False）。

### 4.2 执行流程
1. `MarkdownAssetParser` 解析 Markdown；若四个桶均为空，记录 `logger.warning("Markdown 解析结果为空，触发 LLM 兜底")`。
2. 通过 `UnifiedLLMClient` 调用新增任务 `query_assets_recovery`（配置见 `config/llm.yaml`），输入为原 Markdown 全文及需要生成的字段说明。
3. LLM 返回 JSON：`{"keywords": [...], "query_sentences": [...], "tags": [...?]}`。
4. 结果映射回新的 `QueryPackage`：
   - `keywords` → `primary`
   - `query_sentences` → `insight`
   - `tags`（可选）→ `tags`
   - `books` 由 LLM 可选生成，若缺省则保持空列表。
5. 为便于 CLI 提示，`QueryPackage` 增加 `origin` 或 `metadata` 字段，标记 `parsed` / `llm_recovered`。
6. 若 LLM 调用失败（异常或空 JSON），保持空包并继续沿用现有“返回空结果”逻辑，同时记录 warning。

### 4.3 Prompt 与配置
- `config/llm.yaml` 中新增 `tasks.query_assets_recovery`，参数以 `query_assets_expansion` 为模板，允许 Langfuse 观测与 provider 故障转移。
- Prompt 目标：在 Markdown 缺少结构化标题的情况下，抽取核心主题和可检索短语；必须输出 JSON。建议引用示例片段，说明“若无法提取请返回空数组”。

### 4.4 CLI & 日志
- `_run_multi_query_flow` 在解析统计日志后检查 `query_package.origin`，若为 `llm_recovered`，打印：`⚠️ Markdown 结构未匹配，已调用 LLM 兜底生成查询`。
- 追加日志字段：LLM 回传的各桶数量、耗时、是否命中重试。

### 4.5 测试
- 构造 Markdown（缺少“共同母题”等 block），mock LLM 返回固定 JSON，断言 CLI 最终得到非空结果并输出兜底提示。
- 增加异常场景测试：LLM 抛错 → 回退到空结果并打印 warning。

## 5. 关键词 / 书名精确匹配 + 向量检索并行
在 Markdown 或 LLM 生成的 queries 进入多子查询流程后，同时执行“向量检索（旧流程）”与“数据库精确匹配（新增）”，最终融合 dedupe。

### 5.1 数据源与匹配策略
- `DatabaseReader`（`src/core/book_vectorization/database_reader.py:17-191`）新增方法 `search_books_by_terms`：
  - 入参：`terms: List[str]`, `match_fields=('douban_title','douban_author','custom_keywords')`, `limit`。
  - SQL：对每个 term 构造 `LIKE` 查询，使用 `LOWER(field) LIKE LOWER(?)`，并限制 `embedding_status='completed'` 以确保有向量数据。
  - 评分：根据匹配字段赋予基础分，例如标题命中 1.0，关键词命中 0.8。结果返回 `{'book_id': id, 'exact_match_score': score, 'match_source': field}`。
- Terms 来源：
  - Markdown/LLM 的 `books` 列表（书名直接匹配标题）。
  - `primary`/`tags` 中识别长度 ≤ 10 的短语作为关键词匹配候选（可通过简单 heuristics）。

### 5.2 Retriever 并行执行
- `BookRetriever.search_multi_query` 拆分流程：
  1. **向量检索分支**（既有，实现于 `retriever.py:133-188`）。
  2. **精确匹配分支**：新方法 `_search_exact_matches(query_package, min_rating, exact_match_top_k)` 调用 `DatabaseReader.search_books_by_terms` 并封装成检索结果格式，补齐 `title/author/rating`。
- 两个分支可串行实现，但需在日志中标记“正在执行精确匹配”，并统计返回条数。

### 5.3 结果融合与去重
- 在 `fuse_query_results` 之后，增加 `merge_exact_matches(vector_results, exact_matches)`：
  - 用 `book_id` 作为主键，若某本书同时出现在两路结果中，合并字段：保留向量侧 `fused_score` 与 rerank 分数，同时新增 `exact_match_score`。
  - 新增最终评分策略：`final_score = max(existing_final, exact_match_weight * exact_match_score)`，默认 `exact_match_weight=1.1`，确保直接命中不会被覆盖。
  - 为仅存在于精确匹配的条目构造基础结果（相似度字段缺省，使用 `exact_match_score`）。

### 5.4 CLI / 配置
- `config/book_vectorization.yaml` 中补充 `exact_match` 配置块：
  ```yaml
  exact_match:
    enabled: true
    top_k: 20
    title_weight: 1.0
    keyword_weight: 0.8
  ```
- CLI 新增 `--disable-exact-match`（默认 False），并在结果输出里标注 `match_source`（如“标题精确命中”）。

### 5.5 测试与验证
- 单元测试：mock `DatabaseReader.search_books_by_terms`，验证融合逻辑在重复 book_id 时只输出一条并包含 `exact_match_score`。
- 集成测试：构建包含已知书名的 Markdown，确认 CLI 输出既包含向量结果也包含精确命中，并验证排序优先级。
- 监控：在日志中统计精确匹配触发率、平均命中条数，为后续调参提供依据。
