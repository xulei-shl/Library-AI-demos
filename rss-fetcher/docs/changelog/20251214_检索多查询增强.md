# 开发变更记录
- **日期**: 2025-12-14
- **对应设计文档**: [docs/书目数据向量化/20251214_检索多查询增强.md](../书目数据向量化/20251214_检索多查询增强.md)

## 1. 变更摘要
- 新增 Markdown 解析失败后的 LLM 兜底恢复机制，确保即使结构变动也能产生有效检索词。
- 新增关键词/书名精确匹配分支，并行执行并在最终融合阶段去重，提升命中覆盖率。
- 完善多查询检索容错与监控日志，CLI 提供开关以控制兜底与精确匹配的启用。

## 2. 文件清单
- `src/core/book_vectorization/query_assets.py`: 
  - 为 `QueryPackage` 增加 `origin`、`metadata` 字段。
  - 新增 `recover_with_llm` 方法及配套 `_normalize_recovery_payload`/`_ensure_list`。
  - 更新 `build_query_package_from_md` 支持触发兜底。
- `src/core/book_vectorization/database_reader.py`:
  - 新增 `search_books_by_terms` 方法，支持多字段 LIKE 精确匹配并计算匹配分。
- `src/core/book_vectorization/fusion.py`:
  - 新增 `merge_exact_matches` 方法，完成向量结果与精确匹配结果的合并、去重、最终得分计算。
- `src/core/book_vectorization/retriever.py`:
  - 在 `__init__` 中读取 `exact_match` 配置块。
  - 在 `search_multi_query` 中增加 `_search_exact_matches` 分支与 `merge_exact_matches` 调用。
- `config/book_vectorization.yaml`:
  - 新增 `exact_match` 块（默认禁用），包含字段与权重参数。
- `config/llm.yaml`:
  - 新增 `query_assets_recovery` 任务，提供兜底 Prompt 与监控标签。
- `scripts/retrieve_books.py`:
  - 新增 `--disable-llm-fallback`、`--disable-exact-match` CLI 参数。
  - 更新 `_run_multi_query_flow` 记录 `origin` 并输出兜底与精确命中提示。
  - 增强 `_print_text_results` 显示融合得分与精确匹配来源标注。
- `tests/test_book_vectorization/test_retrieve_books_cli.py`:
  - 新增 `test_llm_fallback_when_md_parsing_empty`、`test_exact_match_disabled_when_flag_set`。

## 3. 测试结果
- [x] 单元测试通过：`pytest tests/test_book_vectorization/test_retrieve_books_cli.py`
- [x] 新增兜底逻辑覆盖：模拟 Markdown 空解析并触发 LLM 恢复。
- [x] CLI 标记传递与日志验证通过。

## 4. 核心逻辑说明
- 兜底触发条件：`package.count() == 0` 且 `enable_llm_fallback=True`，调用 `UnifiedLLMClient` 执行 `query_assets_recovery` 任务。
- 精确匹配来源：从 `books` 与 `primary/tags`（长度 ≤10）提取 terms，在 `douban_title/author/custom_keywords` 做 LIKE 查询并赋予基础分。
- 融合优先级：保留原有 `fused_score`，若存在 `exact_match_score`，最终分按 `final_score = max(fused_score, exact_match_weight * exact_match_score)` 计算，确保直接命中不会被压制。

## 5. 配置示例与使用
```bash
# 启用精确匹配，禁用兜底
python scripts/retrieve_books.py --query-mode multi \
    --from-md file.md \
    --per-query-top-k 20 --final-top-k 15 \
    --disable-llm-fallback

# 观察兜底日志
python scripts/retrieve_books.py --query-mode multi --from-md bad.md
# 应输出 “⚠️ Markdown 结构未匹配，已调用 LLM 兜底生成查询” 与耗时
```
```yaml
# config/book_vectorization.yaml
exact_match:
  enabled: true
  top_k: 20
  match_fields: [douban_title, douban_author, custom_keywords]
  title_weight: 1.0
  keyword_weight: 0.8
  final_weight: 1.1
```