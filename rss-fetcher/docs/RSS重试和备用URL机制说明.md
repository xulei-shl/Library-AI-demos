# RSS抓取器重试和备用URL机制

## 功能概述

RSS抓取器现已增强，支持多种故障处理机制，确保在RSS源出现问题时仍能稳定获取数据：

1. **自动重试机制** - 当RSS源临时不可用时自动重试
2. **备用URL切换** - 主URL失败时自动尝试备用URL
3. **详细错误日志** - 提供清晰的错误诊断信息
4. **可配置重试策略** - 支持自定义重试次数、延迟和超时时间

## 配置方法

### 1. 备用URL配置

在`config/subject_bibliography.yaml`中为每个RSS源添加`backup_urls`字段：

```yaml
rss_feeds:
  - name: "澎湃思想市场"
    url: "http://wechat2rss.vip.cpolar.top/feed/3587489630.xml"  # 主URL
    backup_urls:  # 备用URL列表
      - "https://rss.buzzer.cc/3587489630.xml"     # 备用源1
      - "https://feed.madewith.cn/3587489630"      # 备用源2
    retry_config:
      max_retries: 3      # 最大重试次数
      retry_delay: 2      # 重试间隔（秒）
      timeout: 30         # 单次请求超时时间（秒）
    enabled: true
    extractor: "pengpai"
```

### 2. 重试配置参数

`retry_config`支持以下参数：

- **max_retries**: 最大重试次数（默认：3）
- **retry_delay**: 重试间隔时间，秒（默认：2）
- **timeout**: 单次请求超时时间，秒（默认：30）

### 3. 可选配置

备用URL和重试配置都是可选的：

```yaml
- name: "稳定的RSS源"
  url: "https://example.com/rss.xml"
  # 没有backup_urls和retry_config，使用默认值
  enabled: true
```

## 工作流程

1. **尝试主URL** - 首先尝试配置的RSS源主URL
2. **重试机制** - 如果主URL失败，按照重试配置自动重试
3. **备用URL** - 如果主URL和重试都失败，依次尝试备用URL
4. **成功处理** - 找到可用的RSS源后继续抓取文章
5. **失败处理** - 如果所有URL都失败，记录详细错误信息并跳过该源

## 错误处理和日志

系统会记录详细的日志信息，包括：

- **重试过程**: 记录每次重试的尝试
- **URL切换**: 记录从主URL切换到备用URL的过程
- **错误详情**: 记录具体的错误原因（超时、连接错误、解析失败等）
- **成功状态**: 记录成功使用的URL和数据量

示例日志：
```
时间=2025-12-04 09:54:30 | 级别=信息 | 模块=src.core.rss_fetcher | 信息=正在抓取 RSS: 澎湃思想市场
时间=2025-12-04 09:54:45 | 级别=警告 | 模块=src.core.rss_fetcher | 信息=RSS 澎湃思想市场 请求超时: 请求超时 (15秒)
时间=2025-12-04 09:55:17 | 级别=信息 | 模块=src.core.rss_fetcher | 信息=RSS 澎湃思想市场 使用备用URL成功: https://bigthink.buzzing.cc/feed.xml
```

## 实际效果

根据测试结果，新机制能够：

1. **处理超时问题** - 当RSS源响应缓慢时自动重试
2. **自动故障转移** - 主URL失败后无缝切换到备用URL
3. **保持数据完整性** - 即使部分RSS源失败，也能获取其他源的正常数据
4. **提高系统稳定性** - 减少因单个RSS源问题导致的整体抓取失败

## 适用场景

这种重试和备用URL机制特别适用于：

- **RSS源不稳定** - 网络环境或服务器问题导致的临时不可用
- **定期维护** - RSS源服务器维护期间的故障转移
- **地理限制** - 部分地区可能无法访问某些RSS源
- **高可用性需求** - 确保关键RSS源始终能够获取数据

## 最佳实践

1. **配置多个备用URL** - 建议为重要RSS源配置2-3个备用URL
2. **合理设置重试参数** - 根据网络环境和RSS源稳定性调整参数
3. **监控日志** - 定期检查日志以发现频繁失败的RSS源
4. **定期更新备用URL** - 保持备用URL的有效性和多样性

## 兼容性

新功能与现有系统完全兼容：
- 不影响现有RSS源配置
- 向后兼容，只增加新功能
- 不改变输出数据格式
- 现有的提取器和分析器正常工作