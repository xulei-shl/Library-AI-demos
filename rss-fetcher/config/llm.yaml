# ----------------------------------------------------------------------------------
# LLM 统一配置文件
# ----------------------------------------------------------------------------------
# 本文件集中管理所有对大语言模型 (LLM) 的调用配置。
#
# 核心机制:
# 1. ConfigLoader 读取本文件，解析 env:VAR 环境变量。
# 2. UnifiedLLMClient (src/utils/llm/client.py) 根据任务名加载配置。
# 3. 业务代码 (src/core/recommendation/config.py) 通过 helper 函数读取 parameters 中的业务参数。
#
# 结构说明:
# - api_providers: 定义底层模型服务商 (OneAPI, Cerebras 等)。
# - tasks: 定义各个业务场景的具体配置 (如初评、终评)。
# - defaults: 全局默认配置，会被 tasks 继承。
# - langfuse: 全局 Langfuse 监控配置。
# ----------------------------------------------------------------------------------

api_providers:
  # 文本生成模型服务商配置
  # RetryManager 会根据 primary -> secondary 的顺序进行故障转移
  # text:
  #   primary:
  #     name: "oneapi-qwen3"
  #     api_key: env:ONEAPI_API_KEY
  #     base_url: "http://47.103.50.106:3000/v1"
  #     model: "qwen3-max"
  #     timeout_seconds: 120
  #   secondary:
  #     name: "oneapi-4.1"
  #     api_key: env:ONEAPI_API_KEY
  #     base_url: "http://47.103.50.106:3000/v1"
  #     model: "gpt-4.1"
  #     timeout_seconds: 120

  text:
    primary:
      name: "oneapi-4.1"
      api_key: env:ONEAPI_API_KEY
      base_url: "http://47.103.50.106:3000/v1"
      model: "gpt-4.1"
      timeout_seconds: 120        
    secondary:
      name: "oneapi-qwen3"
      api_key: env:ONEAPI_API_KEY
      base_url: "http://47.103.50.106:3000/v1"
      model: "qwen3-max"
      timeout_seconds: 120  

  text-small:
    primary:
      name: "oneapi-4o-mini"
      api_key: env:ONEAPI_API_KEY
      base_url: "http://47.103.50.106:3000/v1"
      model: "gpt-4o-mini"
      timeout_seconds: 120        
    secondary:
      name: "oneapi-gemini-flash"
      api_key: env:ONEAPI_API_KEY
      base_url: "http://47.103.50.106:3000/v1"
      model: "gemini-2.5-flash"
      timeout_seconds: 120

tasks:
  # ----------------------------------------------------------------------------
  # 任务: 主题书目文章分析 (subject_bibliography_analysis)
  # 逻辑位置: 废弃
  # ----------------------------------------------------------------------------
  network_article_initial_review:
    provider_type: text
    temperature: 0.3
    top_p: 0.8
    prompt:
      # type: md
      # source: "prompts/网络文章主题初评.md"
      type: langfuse
      langfuse_name: "网络文章主题初评"     
    retry:
      max_retries: 3
      base_delay: 1.0
      max_delay: 10
      enable_provider_switch: true
    json_repair:
      enabled: true
      strict_mode: false
      output_format: json
    langfuse:
      enabled: true
      name: "网络文章主题初评"
      tags: ["book-echoes", "文章初评"]
      metadata:
        module: "模块7"

  # ----------------------------------------------------------------------------
  # 任务: Agent 1 - 文章初筛守门员
  # 逻辑位置: src/core/analysis/filter.py
  # ----------------------------------------------------------------------------
  article_filter:
    provider_type: text-small
    temperature: 0.3
    prompt:
      # type: md
      # source: "prompts/article_filter.md"
      type: langfuse
      langfuse_name: "article_filter"  
    json_repair:
      enabled: true
      output_format: json
    langfuse:
      enabled: true
      name: "文章初筛"
      tags: ["book-echoes"]
      metadata:
        project: "book-echoes"
        module: "模块7"

  # ----------------------------------------------------------------------------
  # 任务: Agent 2 - 全文总结
  # 逻辑位置: src/core/analysis/summary_agent.py
  # ----------------------------------------------------------------------------
  article_summary:
    provider_type: text
    temperature: 0.4
    prompt:
      # type: md
      # source: "prompts/article_summary.md"
      type: langfuse
      langfuse_name: "article_summary"
    retry:
      max_retries: 3
      base_delay: 1.0
      max_delay: 10
      enable_provider_switch: true
    json_repair:
      enabled: true
      output_format: json
    langfuse:
      enabled: true
      name: "文章总结"
      tags: ["book-echoes"]
      metadata:
        project: "book-echoes"
        module: "模块7"

  # ----------------------------------------------------------------------------
  # 任务: Agent 3 - 深度分析师
  # 逻辑位置: src/core/analysis/analyst.py
  # ----------------------------------------------------------------------------
  article_analysis:
    provider_type: text
    temperature: 0.5
    prompt:
      # type: md
      # source: "prompts/article_analysis.md"
      type: langfuse
      langfuse_name: "article_analysis"        
    json_repair:
      enabled: true
      output_format: json
    langfuse:
      enabled: true
      name: "文章深度分析"
      tags: ["book-echoes"]
      metadata:
        project: "book-echoes"
        module: "模块7"

  # ----------------------------------------------------------------------------
  # 任务: 文章交叉主题分析
  # 逻辑位置: src/core/cross_analysis/theme_cluster.py
  # ----------------------------------------------------------------------------
  article_cross_analysis:
    provider_type: text
    temperature: 0.3
    prompt:
      # type: md
      # source: "prompts/article_cross_analysis.md"
      type: langfuse
      langfuse_name: "article_cross_analysis"        
    retry:
      max_retries: 3
      base_delay: 1.0
      max_delay: 10
      enable_provider_switch: true
    json_repair:
      enabled: true
      output_format: json
    langfuse:
      enabled: true
      name: "文章交叉主题分析"
      tags: ["book-echoes"]
      metadata:
        project: "book-echoes"
        module: "模块7"

  query_assets_expansion:
    provider_type: text-small
    temperature: 0.35
    prompt:
      type: langfuse
      langfuse_name: "query_assets_expansion"
    json_repair:
      enabled: true
      output_format: json
    langfuse:
      enabled: true
      name: "检索资产扩写"
      tags: ["book-echoes", "retrieval"]
      metadata:
        project: "book-echoes"
        module: "检索优化"

  query_assets_recovery:
    provider_type: text-small
    temperature: 0.2
    prompt:
      type: dict
      content:
        content: |
          你是 Markdown 解析兜底助手。输入为 JSON，其中 markdown 字段包含原文，requirements 字段描述需要提取的内容。
          请从原文中抽取图书检索所需的核心字段并严格返回 JSON，结构如下：
          {
            "keywords": ["共同母题或关键词，长度<=10"],
            "query_sentences": ["可直接用于语义向量检索的句子"],
            "tags": ["主题标签或领域词"],
            "books": ["书名，可为空"]
          }
          若无法提取，请使用空数组。禁止输出额外文本。
    json_repair:
      enabled: true
      output_format: json
    langfuse:
      enabled: true
      name: "检索资产兜底"
      tags: ["book-echoes", "retrieval", "fallback"]
      metadata:
        project: "book-echoes"
        module: "检索优化"

  # ----------------------------------------------------------------------------
  # 任务: 主题筛选
  # 逻辑位置: src/core/book_vectorization/theme_screener.py
  # ----------------------------------------------------------------------------
  theme_screening:
    provider_type: text
    temperature: 0.3
    prompt:
      type: langfuse
      langfuse_name: "主题筛选"
    retry:
      max_retries: 3
      base_delay: 1.0
      max_delay: 10
      enable_provider_switch: true
    json_repair:
      enabled: true
      strict_mode: false
      output_format: json
    langfuse:
      enabled: true
      name: "根据主题报告筛选图书"
      tags: ["book-echoes", "主题筛选"]
      metadata:
        module: "图书向量化"

  # ----------------------------------------------------------------------------
  # 任务: 推荐导语生成
  # 逻辑位置: src/core/book_vectorization/recommendation_writer.py
  # ----------------------------------------------------------------------------
  recommendation_writer:
    provider_type: text
    temperature: 0.4
    prompt:
      type: langfuse
      langfuse_name: "推荐导语"
    retry:
      max_retries: 3
      base_delay: 1.0
      max_delay: 10
      enable_provider_switch: true
    langfuse:
      enabled: true
      name: "推荐导语生成"
      tags: ["book-echoes", "推荐导语"]
      metadata:
        module: "图书向量化"

defaults:
  temperature: 0.45
  top_p: 0.9

langfuse:
  enabled: true
  host: env:LANGFUSE_HOST
  public_key: env:LANGFUSE_PUBLIC_KEY
  secret_key: env:LANGFUSE_SECRET_KEY
  debug: false
