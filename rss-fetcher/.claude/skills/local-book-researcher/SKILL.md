---
name: local-book-researcher
description: 本地智能图书检索专家，支持简单检索模式，以及包含"搜索-分析-草稿-迭代-执行"闭环的深度研究模式。
---

## 模式选择逻辑
当用户输入问题后，必须首先判断模式：
- **简单检索**：用户询问具体书籍、特定作者或简单的关键词查询。
- **深度研究**：用户问题模糊、涉及跨学科概念、需要最新背景信息或明确要求"深度搜索"。

---

## 模式 A：简单检索 (Simple Search)
1. **API 调用**：调用 `scripts/book_api_client.py simple "{query}"` 获取本地图书数据。
2. **提示词应用**：读取 `resources/simple_search_prompt.md`。
3. **输出**：根据提示词要求，结合 API 返回数据，直接生成回答。

---

## 模式 B：深度研究 (Deep Research Workflow)
必须严格按照以下顺序执行，不得跳过：

### Step 1: 外部信息采集 (DuckDuckGo)
- 使用 `duckduckgo_search` 工具搜索与用户问题相关的最新文章、深度评论或学术背景。
- 至少获取 3-5 个高质量结果的摘要或全文。

### Step 2: 单篇分析 (article_analysis)
- **提示词应用**：针对 Step 1 获取的每一篇文章，读取 `resources/article_analysis.md`。
- **操作**：提取文章中的核心观点、关键书籍提及和研究维度。

### Step 3: 交叉分析与草稿生成 (article_cross_analysis)
- **提示词应用**：读取 `resources/article_cross_analysis.md`。
- **操作**：整合信息，生成一份 **Markdown 格式的"检索草案"**（包含检索主题、核心关键词、背景上下文）。
- **关键动作**：将此草案完整展示给用户。

### Step 4: 人在环交互与迭代 (Iterative Loop)
**此步骤是一个循环节点，直到用户明确"确认"为止。**

根据用户的反馈，执行以下分支逻辑：

#### 分支 A：用户提出修改意见 (Refine)
- **触发条件**：用户说"把关键词 X 换成 Y"、"增加关于 Z 的权重"、"太宽泛了，聚焦在..."。
- **操作**：
    1. 理解用户的修改意图。
    2. 保持 `article_cross_analysis` 定义的结构格式。
    3. **修改草案内容**。
    4. **重新展示**修改后的 Markdown 草案。
    5. **返回** Step 4 开头，继续等待用户确认。

#### 分支 B：用户要求重新调研 (Restart/Re-search)
- **触发条件**：用户说"这个方向不对"、"我想找的是另一个话题"、"重新搜一下..."。
- **操作**：
    1. 清空当前草案上下文。
    2. 根据用户的新指令，**跳转回 Step 1** (外部信息采集)。

#### 分支 C：用户确认 (Confirm)
- **触发条件**：用户说"可以"、"没问题"、"执行"、"开始检索"。
- **操作**：
    1. **锁定**当前版本的 Markdown 草案。
    2. **跳转至 Step 5**。

### Step 5: 本地深度检索 (Execution)
- **前置检查**：确保草案已获得用户（分支 C）的明确确认。
- **API 调用**：调用 `scripts/book_api_client.py deep "{final_markdown_draft}"`。
- **说明**：将最终定稿的 Markdown 文本传给本地 API 进行多路检索。

### Step 6: 最终合成 (recommendation_intro)
- **提示词应用**：读取 `resources/recommendation_intro.md`。
- **操作**：
    1. 获取 API 返回的书籍列表。
    2. 结合 Step 3/4 中积累的调研背景。
    3. 生成深度推荐导语。

---

## 交互注意事项
1. **草稿可见性**：每次修改草案后，必须将完整的 Markdown 内容打印出来，以便用户检查。
2. **拒绝执行**：如果用户未确认草案直接要求推荐书籍，必须礼貌拒绝，并引导其先确认检索方向："为了保证检索精度，请先确认上述检索草案是否符合您的预期。"