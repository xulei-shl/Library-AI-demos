# L1-客观知识层：结构化信息抽取 需求文档

## 1. 功能简介

本功能 (L1) 旨在将非结构化的文本信息转化为结构化的、机器可读的数据。它处理由 L0-媒介内容层生成的图像长描述，并结合档案馆提供的原始元数据文本（如题名、说明等），利用大语言模型（LLM）从中抽取出核心的知识实体，并以规范的 JSON 格式进行输出。

此功能是连接原始视觉材料与后续知识图谱构建（L2）、深度分析（L3）的关键桥梁，旨在实现元数据的自动化、标准化与知识增强。

## 2. 需求列表

### 2.1. 核心信息抽取

- **用户故事:** 作为一名数字人文研究员，我希望能自动从关于历史图像的描述和元数据文本中提取出关键信息（如剧名、人物、时间、地点），以便快速获得用于分析和检索的结构化数据。

- **验收标准 (EARS):**
    1.  **当** 系统处理一行数据时，**它应** 优先使用元数据表格中的“题名”、“说明”等文本字段作为信息抽取的主要来源。
    2.  **系统可** 将 L0 生成的“长描述”作为辅助上下文，用于补充或澄清主要来源中的信息，但不作为必须的原始文本。
    3.  **系统应** 通过已有的 `llm_api.py` 工具模块，调用一个可配置的文本大语言模型（LLM）来执行信息抽取任务。
    4.  **系统应** 仅从给定的文本源中客观地抽取出以下实体（不进行任何推理或补全）：
        - 剧名 (Play Name)
        - 作者 (Author)
        - 首演时间 (Premiere Date)
        - 首演地点 (Premiere Venue)
        - 演出团体 (Performing Group)
        - 核心人员 (Core Personnel)，并进一步区分其姓名、角色（如导演）和扮演的角色。
    5.  **系统应** 将所有抽取的实体整合，并输出为一个严格合法的 JSON 对象字符串。

### 2.2. 与现有工作流集成

- **用户故事:** 作为一名系统操作员，我希望 L1 的抽取过程能无缝集成到现有的 Excel 文件处理流程中，以便我可以一键式地对整批数据进行处理，并将结果写回原文件。

- **验收标准 (EARS):**
    1.  **系统应** 使用已有的 `excel_io` 工具模块，根据 `config/settings.yaml` 中定义的列名，从 `metadata.xlsx` 文件中读取每行所需的输入数据。
    2.  **系统应** 将生成的结构化信息 JSON 字符串，写回到该行一个新指定的列中（例如，`结构化信息JSON`）。
    3.  **系统应** 严格遵守 `config/settings.yaml` 中定义的 `write_policy.skip_if_present` 策略，即如果目标单元格已有数据，则跳过该行的处理，以支持幂等性。
    4.  **当** LLM 返回的输出不是一个严格合法的 JSON 时，**系统应** 将模型的原始字符串返回结果直接写入目标单元格，并**通过已有的 `logger.py` 工具**记录一条 `WARNING` 级别的日志，以避免数据丢失。

### 2.3. 可配置性与可维护性

- **用户故事:** 作为一名开发与维护人员，我希望能通过配置文件轻松地调整 L1 任务的模型、提示词和相关参数，以便在不修改代码的情况下，对抽取效果进行优化和迭代。

- **验收标准 (EARS):**
    1.  **系统应** 在 `config/settings.yaml` 的 `tasks` 部分，包含一个专门用于此功能的配置块，例如 `structured_extraction`。
    2.  **该配置块应** 允许定义 `provider_type` ("text"), `model`, `temperature` 等 API 参数，以及 `system_prompt_file` 的路径。
    3.  **系统应** 从一个新的、专门为该任务设计的提示词文件（路径：`src/prompts/structured_extraction_system.md`）加载系统提示。
    4.  **系统应** 在 `config/settings.yaml` 的 `data.excel.columns` 部分，允许配置用于存储 L1 产出结果的列名，例如 `structured_info_col: "结构化信息JSON"`。
