# L2 知识关联模块开发计划（分阶段实施）

Status: Proposal  
日期: 2025-10-03  
作者: 项目组

---

## Objective / Summary
本计划围绕 L2 知识关联模块的分阶段落地与扩展，目标是：
- 先以“Wiki优先”的方式快速实现端到端流程（Wikidata + Wikipedia），完成从实体任务清单到URI消歧与写回；
- 后续按插件式架构无缝集成内部权威API，保持核心流程与提示词稳定；
- 严格遵守“原始数据可追溯”原则，同时针对 Wikipedia 的 FullText 采用“MD落盘”策略，避免在JSON中占用`_raw_api_responses`的过多空间；
- 提供清晰的模块边界、日志与测试策略，确保可维护性与可扩展性。

---

## Scope
预估新增/修改文件与模块如下（最终以实现为准）：
- src/core/l2_knowledge_linking/
  - main.py（行级前置检查与行遍历，Step 0）
  - task_builder.py（统一实体任务列表构建，Step 1）
  - entity_processor.py（外部/内部知识关联与消歧核心逻辑，Step 2 & Step 4）
  - api_clients.py（插件式数据源客户端：WikidataClient、WikipediaClient、InternalApiClient）
  - result_writer.py（聚合与写回 L2知识关联JSON；Wikipedia FullText MD落盘）
- src/prompts/
  - l2_entity_classification.md（实体类型分类）
  - l2_entity_disambiguation.md（与数据源无关的通用消歧系统提示词，核心）
- src/utils/
  - excel_io.py（复用）
  - llm_api.py（复用）
  - metadata_conlabel.py（复用）
  - logger.py（复用，集中化结构化日志）
- tests/
  - tests/core/l2_knowledge_linking/test_task_builder.py
  - tests/core/l2_knowledge_linking/test_entity_processor.py
  - tests/core/l2_knowledge_linking/test_result_writer.py
  - tests/core/l2_knowledge_linking/test_api_clients.py
- runtime/
  - runtime/logs/（结构化日志输出）
  - runtime/outputs/（Wikipedia FullText与信息的MD落盘文件）

---

## Detailed Plan

### 架构原则
1) 插件式API客户端（低耦合、高内聚）
- 在`api_clients.py`中为每个知识源实现独立客户端，并统一接口约定：
  - `search(entity_label: str, type_hint: Optional[str]) -> Dict | List[Dict]`
  - 返回结构可被通用消歧提示词统一整合。
- 初始客户端列表：`[WikidataClient, WikipediaClient]`；后续扩展为`[InternalApiClient, WikidataClient, WikipediaClient]`。

2) 通用消歧提示词（数据源无关）
- `l2_entity_disambiguation.md`负责在给定原始上下文和多源候选中，为每个来源选择最匹配的一项并返回其核心标识符（如wikidata_id -> URI、wikipedia_title/url -> URI、内部API id -> URI）。
- 提示词输入包含：原始元数据上下文（由`metadata_conlabel.py`构造）、各源候选列表（统一格式）、实体类型提示（如已知）。

3) 原始数据持久化与例外处理
- 所有外部/内部API的“完整原始返回结果”应保存至`entity_obj["_raw_api_responses"][source]`，以保证可追溯与二次挖掘。
- 例外：Wikipedia 的 FullText 不进入`_raw_api_responses`，而是写入`runtime/outputs/`的MD文件。JSON中保留必要元信息（title、summary截断、canonicalurl等），不含全文。
- MD文件命名规则：`{编号列值}-{实体名}.md`（编号来自Excel元数据中的“编号”列；列名可在 `settings.yaml` 配置，默认为“编号”；实体名为任务清单的`label`）。需对文件名做非法字符清洗（空格转下划线、去除`/:*?"<>|`等）。

### 分阶段实施

#### 阶段A：Wiki优先的端到端实现
- Step 0（main.py）
  - 针对每行执行行级前置检查：是否存在`L2知识关联JSON`列且非空？如非空则跳过并记录INFO日志。
- Step 1（task_builder.py）
  - 从`关键词JSON`与`L1结构化JSON`构建`unique_entity_map`并去重，生成`task_list`。
  - 优先用`L1结构化JSON`的明确字段设置类型；缺失类型时进入分类环节。
- Step 2（entity_processor.py）
  - 初始化节点字段：`wikidata_uri`, `wikipedia_uri`, `status`, `_raw_api_responses`。
  - 实体类型分类：当`type`为null时调用`l2_entity_classification.md`完成类型判定。
  - 迭代API客户端：
    - WikidataClient：使用`langchain_community.tools.wikidata.tool`（`WikidataAPIWrapper`, `WikidataQueryRun`）搜索。提取候选的`id（Qxxxx）`、`label`、`description`、`aliases`等。保存在`_raw_api_responses["wikidata"]`。
    - WikipediaClient：使用`wikipediaapi`检索页面。保存`title`、`canonicalurl`、`summary（截断至 1000 字符，page.summary[0:1000]）`等基础信息到`_raw_api_responses["wikipedia"]`。将`page.text`全文与相关信息（title、url、summary）写入`runtime/outputs/{编号}-{实体名}.md`；`_raw_api_responses`不包含`full_text`。
  - 统一消歧：将各源候选与元数据上下文交由`l2_entity_disambiguation.md`，分别选出每源的最优项并输出URI。
  - 原地更新：写回`wikidata_uri`与`wikipedia_uri`，更新`status`（如`SUCCESS_WIKI`、`SUCCESS_BOTH`、`NOT_FOUND`），保留`_raw_api_responses`（不含Wikipedia FullText）。
- Step 3（result_writer.py）
  - 读取当前行`L1结构化JSON`，将`task_list`中丰富后的实体数据合并注入对应节点。
  - 序列化并写回`L2知识关联JSON`列（如不存在则新增列）。
- 日志与错误处理
  - 统一使用`src/utils/logger.py`的结构化日志：`timestamp`, `level`, `module`, `row_id`, `entity_label`, `source`, `message`。
  - 正确区分`WARNING`与`ERROR`，严禁记录敏感信息。
- 产出
  - 每个相关实体将有：`wikidata_uri`、`wikipedia_uri`（若存在）、`status`与`_raw_api_responses`（无FullText）。
  - 对应的MD文件落盘：`runtime/outputs/{编号}-{实体名}.md`，内容包含Wikipedia返回的全部信息（详见“MD内容规范”）。

#### 阶段B：质量优化与稳健性增强
- 去重与缓存：对已处理的实体做行内/全表层面的去重与缓存，减少重复API/LLM调用。
- 异常健壮性：对网络超时、未检索到、API限流进行重试与退避（指数退避），明确失败状态与回写策略。
- 性能与并发：合理批处理，避免过度并发导致限流；在日志中记录API耗时。

#### 阶段C：内部API扩展（不改核心流程）
- 新增`InternalApiClient`并加入客户端列表：
  - 列表更新为`[InternalApiClient, WikidataClient, WikipediaClient]`（可在配置或常量中维护）。
- `entity_processor.py`与消歧提示词无需改动：内部API返回的候选将与外部候选一并进入通用消歧流程。
- 输出扩展：在`entity_obj`中新增`shl_uri`或其他内部标识字段，并在写回JSON中体现。

### 数据约束与MD内容规范
- `_raw_api_responses`：
  - wikidata: 保存候选的结构化要点（id、label、description、aliases……）。
  - wikipedia: 保存基础元信息（title、canonicalurl、summary 摘要片段，截断至 1000 字符），不保存`full_text`。
  - internal_api: 保存内部候选的结构化字段（id、name、bio……）。
- MD落盘文件（runtime/outputs/{编号}-{实体名}.md）：
  - 元信息区：标题（title）、URL（canonicalurl）、摘要（summary，截断至 1000 字符）、生成时间戳、实体类型、Excel编号。
  - 全文区：完整`page.text`。
  - 其他可用信息：若有页面分类、章节标题，可附录列出；一切来自`wikipediaapi.page`可检索到的信息尽量保留。
- 文件名清洗：将空格转为下划线，移除或替换Windows不允许的字符（`\\ / : * ? " < > |`），避免过长文件名，必要时截断实体名至安全长度。

---

## Visualization
```mermaid
flowchart TD
    A[Excel 行遍历/Step 0] -->|检查 L2列 非空跳过| B[构建任务清单/Step 1]
    B --> C{实体类型为空?}
    C -->|是| D[LLM 类型分类]
    C -->|否| E[保留既有类型]
    D --> F[迭代API客户端/Step 2]
    E --> F
    subgraph G[API客户端列表]
      F1[WikidataClient]:::api --> H1[候选结果收集]
      F2[WikipediaClient]:::api --> H2[候选元信息收集/_raw不含FullText]
      H2 --> I[写MD: runtime/outputs/{编号}-{实体名}.md]
      style I fill:#223,stroke:#fff,stroke-width:1,color:#fff
    end
    F --> J[通用LLM消歧 (l2_entity_disambiguation)]
    J --> K[写回实体URI与状态]
    K --> L[聚合回 L1结构化JSON/Step 3]
    L --> M[写回 Excel 的 L2知识关联JSON 列]
    classDef api fill:#0b6,stroke:#063,color:#fff
```

---

## 运行方式（CLI任务制）与主入口编排对齐

为与“主入口任务编排-20251002.md”保持一致，L2 知识关联模块的运行形态遵循命令行任务制：

- 入口与参数：
  - 基本入口：`python main.py`
  - 任务选择：通过 `--tasks` 指定需要执行的任务集合，支持简名与命名空间（`module:task`）。
  - 限流调试：保留 `--limit`。
  - 路径来源：Excel/图片等路径统一从配置文件读取（如 `settings.yaml`），不在CLI中直接传参。

- 默认流水线关系：
  - 默认无参数执行：L0 全部任务 → L1 结构化抽取 → L2 知识关联。
  - 同时支持通过 `--tasks` 单独触发 L2。

- L2 触发方式（建议）：
  - 标准任务名：`l2:knowledge_linking`（命名空间形式）
  - 简名/别名（建议映射）：`knowledge_linking|l2|l2_link`
  - 示例：
    - `python main.py --tasks "l2:knowledge_linking"`（仅运行 L2）
    - `python main.py --tasks "alt_text,structured,l2:knowledge_linking"`（L0:alt_text → L1 → L2）

- 与主入口的接口约定（对齐“主入口任务编排-20251002.md”）：
  - `run_l2(excel_path=None, images_dir=None, limit=...)`（路径由配置读取）
  - 任务解析：未知任务记录 WARNING 不中断；命名空间优先于简名。
  - 日志：统一结构化中文日志，记录任务选择与执行状态。

- 安全与日志一致性：
  - 不记录敏感信息；日志仅记录任务选择、行号、实体名、源与耗时等上下文。
  - 输出日志至 `runtime/logs/`，支持轮转。

> 注意：以上任务别名与是否纳入默认流水线为本计划建议，最终以主入口实现与配置为准。若你有既定命名，请告知以便我更新映射。

## Testing Strategy
- 测试结构镜像`src/`：
  - test_task_builder.py：去重、类型优先策略、关键词与L1融合。
  - test_entity_processor.py：分类提示词调用、客户端迭代、消歧结果整合、状态更新。
  - test_api_clients.py：对Wikidata、Wikipedia的封装适配（模拟返回/桩），错误与空结果分支。
  - test_result_writer.py：JSON注入与写回；Wikipedia FullText不进`_raw_api_responses`而写MD；文件名清洗与落盘。
- 场景覆盖：
  - 正常用例：实体可在两个Wiki源均找到，消歧一致返回URI。
  - 边界用例：仅一个源命中；摘要缺失；编号为空或非法字符处理。
  - 异常用例：网络异常、限流、无候选、行已处理跳过。
- 约束验证：
  - 断言`_raw_api_responses["wikipedia"]`不含`full_text`字段。
  - 断言MD文件存在且内容包含Title、URL、Summary与FullText。

---

## Logging & Observability
- 集中化日志：`src/utils/logger.py`，输出到`runtime/logs/`，支持轮转。
- 中文日志消息，结构化字段：`timestamp`, `level`, `module`, `row_id`, `entity_label`, `source`, `event`, `elapsed_ms`。
- 级别使用规范：DEBUG（开发诊断）、INFO（关键事件）、WARNING（异常但可继续）、ERROR（操作失败但不中断主进程）、CRITICAL（不可恢复）。

---

## Security Considerations
- 不记录敏感信息（如凭据、个人隐私数据）。
- 对第三方API的速率限制与重试机制，避免被封禁。
- 文件名与内容过滤，防止路径注入与非法字符导致的IO异常。

---

## Risks & Mitigations
- Wikipedia页面不存在或重名：通过消歧提示词结合上下文降低误选风险；记录NOT_FOUND状态。
- 返回结果格式变化：客户端适配层隔离变化，提示词保持数据源无关。
- 大量MD文件：日志与轮转管理；按编号归档策略可选（后续优化）。

---

## Implementation Notes（待实现阶段更新）
- 阶段A完成后，将补充实现细节与与原计划偏差，标明测试覆盖与已知限制。

---

## Definition of Done
- 阶段A：Wiki优先端到端打通，MD落盘策略生效；测试通过；日志合规。
- 阶段C：内部API加入客户端列表且端到端打通，提示词与核心流程无需改动。
- 文档从Proposal更新至Implemented，Scope与实现一致。