Status: In Progress

Title: 将 L1 结构化抽取从多模态切换为纯文本模型（仅传入元数据）

Objective / Summary
- 将 L1 结构化抽取流程从“图片+元数据”的多模态调用，切换为“仅元数据”的纯文本大模型调用。
- 移除 l1 模块中对图片路径扫描、base64 编码、视觉消息构造的依赖；保留公共工具以兼容其他模块。
- 更新系统提示词以适配纯文本抽取语义，明确仅输出 JSON。

Scope
- 修改
  - src/core/l1_structured_extraction/main.py
- 新增
  - src/prompts/l1_structured_text_system_prompt.md（纯文本版系统提示词）
- 配置更新（由配置文件或 settings 源决定）
  - tasks.l1_extraction.system_prompt_file 指向新提示词文件
- 不变
  - .../utils 内的通用工具（image_to_base64 等）保留，不在 l1 使用

Detailed Plan
1) 移除/调整依赖
   - 从 l1 的 main 中移除对以下逻辑的使用：
     - _scan_images(images_dir, exts)
     - _build_vision_messages(system_prompt, image_b64, user_text)
     - image_to_base64(img_path)
   - run(...) 的签名允许保留 excel_path/limit；删除 images_dir 的实际使用（不再扫描/匹配图片）。

2) 纯文本消息构造
   - messages = [
       {"role":"system","content": system_prompt},
       {"role":"user","content": user_text}
     ]
   - user_text 由两部分组成：
     - build_metadata_context(...) 产出的元数据上下文
     - 明确的输出指令：例如“请仅基于上述元数据抽取结构化信息，并仅输出JSON（无多余说明/代码块）。”
   - 去除“基于图像与元数据”的表述。

3) 提示词文件（文本版）
   - 新增 src/prompts/l1_structured_text_system_prompt.md，建议内容要点：
     - 角色：资深信息抽取器，仅依据提供的“元数据上下文”抽取信息
     - 输出：严格 JSON（UTF-8，无代码块围栏），键名/结构遵循项目规范（由现有下游消费决定）
     - 稳健性：当信息缺失时填 null 或空字符串，不编造，不输出除 JSON 外的任何文本
     - 语言：按字段定义语言输出（如需要中文）
     - 兼容：支持字段留空策略与可选字段
   - settings.tasks.l1_extraction.system_prompt_file 指向上述文件名。

4) 其他流程保持不变
   - Excel 读取/写入、目标列自动创建、skip_if_present 策略、_strip_json_code_fence 清理与 json.loads 校验（失败则原样写入，保留日志）。

5) MVP 原则的微优化
   - 用户提示中显式强调“仅输出JSON，无解释/无Markdown围栏”
   - 日志中保留模型名/任务名/行ID 的输出预览；长度过长时截断
   - 对于空 meta_ctx 时仍构建最小 user_text，避免空消息

Visualization
```mermaid
flowchart TD
  A[Excel 行数据] --> B[build_metadata_context]
  B --> C[构造 user_text(仅元数据 + JSON输出指令)]
  C --> D[构造 messages(system+user, 纯文本)]
  D --> E[invoke_model(task=l1_extraction, 文本模型)]
  E --> F[_strip_json_code_fence 清理]
  F --> G[json.loads 尝试解析]
  G -->|成功或失败原样| H[写回 Excel 指定列]
  H --> I[保存 Excel]
```

Testing Strategy
- 单元测试（建议新增，范围可控）：
  - 测试 _strip_json_code_fence：带/不带围栏、包含多余文本的清理行为
  - 测试消息构造：在无图模式下 messages 的结构与内容（system/user）符合预期
  - 测试当 meta_ctx 为空时的最低限度 user_text 不为空
- 集成冒烟（手动/脚本）：
  - 准备最小 Excel（2-3 行），运行 limit=1/2，验证能够产出 JSON，且 skip_if_present 生效
- 若为纯文本大模型难以稳定模拟完整响应，可对 invoke_model 进行简单桩替换测试（可选）。

Security Considerations
- 不记录敏感信息；日志中仅输出必要上下文与截断预览
- 严禁在提示词或日志中包含密钥或个人隐私数据
- 保持对异常的健壮处理（解析失败不崩溃，原样写回并告警）

Out-of-Scope
- 视觉与多模态能力保留在其他模块；本次不影响其他任务
- 复杂的 JSON Schema 验证与强校验本次不纳入，实现以 MVP 为主

Rollout & Backout
- 回滚：将 main.py 恢复到切换前版本，并将 settings 指回旧的 system_prompt_file
- 该改动为增量且集中，易于回滚

Open Points
- JSON 字段的精确定义与下游消费契约（若已有，请提供文档链接；若缺失，将按当前提示词中的“示例结构”执行）
- system_prompt 的最终文案是否需要你方给出特定字段说明

Requested Approval
- 请批准本 Proposal。我将：
  1) 将 Status 更新为 In Progress
  2) 修改 src/core/l1_structured_extraction/main.py 为纯文本流程
  3) 新增 src/prompts/l1_structured_text_system_prompt.md（并提供初版内容）
  4) 协助你更新 settings.tasks.l1_extraction.system_prompt_file 指向新文件
  5) 自测后更新文档为 Implemented，并补充 Implementation Notes