# Wikidata 实体消歧管线重构（先行落地 Wikidata）

Status: In Progress
Date: 2025-10-04
Owner: l2_knowledge_linking

## Objective / Summary
- 目标：将 Wikidata 检索结果在进入 LLM 判定前进行“标准化格式化”，零候选时跳过 LLM 并直接产出统一 JSON 结果；有候选时再调用 LLM，并由与工具一一对应的解析器解析 LLM 输出，得到统一结果。先只落地 Wikidata 流程，Wikipedia 暂不变。
- 价值：
  - 避免非 JSON 可序列化对象进入 LLM 入参（提升稳定性）。
  - 零候选跳过 LLM，节省成本与时间。
  - 明确“一工具一解析器”的扩展点，降低后续维护成本。

## Scope
- 新增
  - src/core/l2_knowledge_linking/parsers/wikidata_parser.py
  - tests/core/l2_knowledge_linking/parsers/test_wikidata_parser.py
- 修改（最小化）
  - src/core/l2_knowledge_linking/entity_matcher.py（接入 parser：format_candidates/parse_llm_output/fallback_zero_candidates；仅限 Wikidata 分支）
- 不改动
  - src/core/l2_knowledge_linking/tools/wikidata_tool.py（保持检索逻辑不变）
  - Wikipedia 相关文件暂不修改

## Detailed Plan

### 数据契约（统一 Schema）
1) Wikidata 格式化候选（传入 LLM 的候选最小集合）
- 字段（每个候选）：
  - id: "Qxxxxx"
  - url: "https://www.wikidata.org/wiki/Qxxxxx"
  - label: string（若可得；wbsearchentities 可用 it.label）
  - description: string（若可得；wbsearchentities 可用 it.description）
  - aliases: [string]（可选，若来源为 LC 段落文本可解析；wbsearchentities 暂无时略）
  - key_props_excerpt: string（可选，从 LC 文本解析 P31、国别、职业、出生/逝世日期等关键信息拼接）
- 限长策略（默认）：
  - aliases 最多 5 个
  - key_props_excerpt 最多 512 字节（超长截断并加省略）
  - 整个候选序列化 JSON 字符数上限 1KB/候选（通过字段截断实现）
- 候选数量：
  - 以工具返回为准，传入 LLM 的 Top-M 上限可配置（默认 2，保持当前 wbsearchentities 行为一致）

2) 统一判定结果（JudgeOutput）
```
{
  "source": "wikidata",
  "entity": { "label": <str>, "type_hint": <str|null> },
  "matched": <bool>,
  "confidence": <float 0..1>,
  "reason": <str>,
  "selection": null | {
    "id": <str QID>,
    "url": <str>,
    "label": <str|null>,
    "description": <str|null>,
    "aliases": <list|null>,
    "key_props_excerpt": <str|null>
  },
  "model": <str|null>
}
```

### 模块职责与接口

1) 新增 parser：src/core/l2_knowledge_linking/parsers/wikidata_parser.py
- 函数签名
  - format_candidates(raw: List[Dict[str, Any]], cfg: Dict[str, Any]) -> List[Dict[str, Any]]
    - 输入：wikidata_tool 原样输出（两种来源：wbsearchentities 简短结构；或 LC 文本段落结构）
    - 行为：抽取 label/description/aliases/key_props_excerpt，统一为可序列化/限长的候选列表
  - parse_llm_output(txt: str, candidates: List[Dict[str, Any]]) -> Dict[str, Any]  # 返回 JudgeOutput
    - 兼容以下 LLM 输出结构：
      - 顶层：{matched, confidence, reason, selection}
      - choices.wikidata = {candidate: {...}, reason, confidence}
      - 回退字段：wikidata_uri / wikidata_qid（若仅有 QID/URI，则在 candidates 中匹配补全 selection）
    - 置信度与理由的默认与边界处理（clamp 到 0..1；reason 为空则兜底描述）
  - fallback_zero_candidates(label: str, type_hint: Optional[str]) -> Dict[str, Any]
    - 直接返回 matched=false, confidence=0.0, reason="无候选", selection=null

- 解析 LC 文本样例（参考 docs/tools/wiki_api_usage.md 中样例）：
  - 结果块以 "Result Qxxxx:" 开头；后续 "Label:", "Description:", "Aliases:", 以及若干属性行（如 instance of, occupation, date of birth ...）
  - 提取规则：
    - QID：行首正则 /Result\s+(Q\d+):/
    - 键值对：以冒号分隔，前半为键，后半为值，去除多余空白
    - key_props_excerpt：仅保留少量关键字段（例如：instance of, country/country of citizenship, occupation, date of birth/death），拼接为 "k1: v1; k2: v2; ..."
    - 控制长度

2) entity_matcher 接入
- 流程（wikidata 分支）：
  1. 调用 wikidata_tool.search_wikidata 得到 raw_candidates
  2. candidates = wikidata_parser.format_candidates(raw_candidates, cfg)
  3. 若 candidates 为空：result = wikidata_parser.fallback_zero_candidates(...)，写回并结束
  4. 否则：构造 messages（复用 DIS_PROMPT_PATH ），将 candidates 作为 payload.candidates.wikidata 传入
  5. LLM 调用完成后：result = wikidata_parser.parse_llm_output(txt, candidates)
  6. 写回最终 JSON 结果
- 注意：
  - 不在 LLM 入参中传递非 JSON 对象
  - model 名称可由 settings.tasks.l2_disambiguation.model 补充到 result.model

### 错误处理与健壮性
- 对格式化阶段进行 try/except，遇到异常时记录 source=wikidata、label、异常信息，回退为空候选路径
- parse_llm_output 遇到非 JSON 文本时，返回 matched=false, confidence=0.0, reason="输出解析失败"
- 对信心度进行 0..1 clamp

### 配置项（可选）
- settings.tasks.l2_disambiguation.candidate_limits.wikidata:
  - max_candidates: int（默认 2）
  - per_candidate_max_bytes: int（默认 1024）
  - key_props_max_bytes: int（默认 512）
  - include_aliases: bool（默认 True，若可解析）

### 不在本次范围的事项
- Wikipedia 检索与解析（后续阶段）
- 扩展检索（批量属性拉取）与并发优化
- 结构化日志统一改造

## Visualization

```mermaid
flowchart TD
  A[search_wikidata raw_candidates] --> B{raw_candidates > 0?}
  B -- 否 --> C[fallback_zero_candidates] --> H[写回 JSON 结果]
  B -- 是 --> D[format_candidates -> JSON安全/限长]
  D --> E[build_messages (entity + context + candidates.wikidata)]
  E --> F[invoke_model l2_disambiguation]
  F --> G[parse_llm_output (candidates-aware)]
  G --> H[写回 JSON 结果]
```

## Testing Strategy
- 单元测试：tests/core/l2_knowledge_linking/parsers/test_wikidata_parser.py
  - 正常用例（Happy Path）
    - 输入：包含 LC 文本解析到的 label/description/aliases/属性行
    - 验证：format_candidates 提取字段正确、限长生效
    - LLM 输出结构1：顶层 selection 完整对象；解析为 JudgeOutput
  - 结构2（choices.wikidata）
    - 输入：choices.wikidata = {candidate:{id/url/...}, reason, confidence}
    - 验证：能取到 candidate 作为 selection，保留 reason/confidence
  - 回退路径（URI/QID）
    - 输入：仅 wikidata_qid 或 wikidata_uri
    - 验证：在 candidates 中匹配补全 selection
  - 异常/错误用例
    - LLM 输出非 JSON：返回未匹配，reason="输出解析失败"
    - 空候选：fallback_zero_candidates 返回未匹配
  - 边界用例
    - 超长 aliases/key_props：截断不报错；总字节数不超过 per_candidate_max_bytes

- 未来回归（后续阶段）
  - 与 entity_matcher 的集成测试：模拟 settings 与 LLM 响应，验证零候选跳过行为与成功路径

## Security Considerations
- 不记录敏感信息；日志仅含通用上下文（source, label, elapsed_ms, count 等）
- 外部文本解析需防御恶意构造（稳健的分隔与长度限制）

## Implementation Notes（占位，交付时填写）
- 待编码后更新