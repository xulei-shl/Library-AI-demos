Status: Implemented
Date: 2025-10-08
Owner: l3_deep_analysis

Objective / Summary:
- 将 L3 deep_analysis 的检索执行从 Jina 全面切换为 Zhipu GLM（glm-4-assistant，流式输出）。
- 仅支持 deep_glm（命令、阶段名、数据键），彻底移除/停止使用 deep_jina 与 "jina" 键的读写。
- 立即迁移配置项到 settings.deep_analysis.glm.*，不再读取 deep_analysis.jina.*。
- 业务流程、数据结构与幂等/聚合策略保持不变，仅替换接口调用与命名标识：
  - 子题逐题执行 + 题目级幂等 + metadata.glm 数组聚合 + s["glm"]["meta"] 聚合。
  - 模型标识固定 "glm-4-assistant"；API Key 从环境变量 ZHIPUAI_API_KEY 读取。
  - 流式输出在执行器内部聚合为最终 content 字符串，保持上层落盘一次的行为一致。

Scope:
- 修改文件：
  - src/core/l3_deep_analysis/orchestrator.py
    - 将所有 "jina" 节点写入与读取替换为 "glm"（s["glm"], children[*].glm, metadata.glm）
    - 调用从 call_jina → call_glm
    - 子主题级聚合键改为 s["glm"]["meta"]
  - src/core/l3_deep_analysis/json_schema.py
    - 将针对 "jina" 的完成度/幂等判断改为 "glm"
  - src/core/l3_deep_analysis/report_writer.py
    - 汇总/展示时从 s["glm"] 判断成功状态
  - src/core/l3_deep_analysis/executors/glm_executor.py（新增）
    - 实现 call_glm(query, settings)，对接 Zhipu SDK/HTTP 流式接口，流式拼接并返回统一格式
    - 读取 settings.deep_analysis.glm.* 与 ZHIPUAI_API_KEY
    - 实现指数退避重试逻辑（max_retries / delay_seconds / backoff_factor）
  - src/core/l3_deep_analysis/executors/jina_executor.py
    - 保留文件但不再被导入调用（或移除引用）；如需可标记为废弃
  - main.py
    - 增加/重命名 _task_deep_glm，移除 deep_jina 分支
    - 任务解析仅识别 "deep_glm"（以及 deep_planning/deep_dify/deep_report/deep_all 的既有路径）
- 测试：
  - tests/core/l3_deep_analysis 下对应的 Jina 用例复制/重命名为 GLM 版本，改用流式 mock
- 文档：
  - 添加本变更文档；必要时在 README/specs 中补充分支与配置说明

Detailed Plan:
- 数据结构不变，仅将键名从 "jina" 全量替换为 "glm"：
  - children[i].glm:
    - 成功：
      {
        "content": "...",
        "meta": {
          "executed_at": "ISO-8601",
          "status": "success",
          "task_type": "web_search",
          "search_query": "原始问题文本",
          "llm_model": "glm-4-assistant",
          "error": null
        }
      }
    - 失败/未命中：
      {
        "content": null,
        "meta": {
          "executed_at": "ISO-8601",
          "status": "error" | "not_found",
          "task_type": "web_search",
          "search_query": "原始问题文本",
          "llm_model": "glm-4-assistant",
          "error": "失败原因"
        }
      }
  - metadata.glm（数组聚合）：
    - {
        "executed_at": "ISO-8601",
        "status": "error" | "not_found",
        "error": "...",
        "task_type": "web_search",
        "question": "...",
        "subtopic": "..."
      }
  - s["glm"]["meta"]（子主题级聚合）：
    - {"executed_at":"ISO-8601","status":"success|error|not_found","task_type":"web_search"}

- 执行流程（与现有 Jina 分支一致，仅改名与调用）：
  - orchestrator.run_row：
    1) 初始化 children，确保与 questions 一一对应
    2) 幂等检查：children[*].glm.meta.status ∈ {"success","timeout_recovered"} 跳过
    3) 调用 call_glm(question, settings)，内部含重试/退避与流式聚合
    4) 写回 children[*].glm；非成功追加到 metadata.glm
    5) 聚合 s["glm"]["meta"].status：
       - 至少一个成功 => "success"
       - 否则若发生异常 => "error"
       - 否则若存在非成功 => "not_found"

- 执行器设计（glm_executor.py）：
  - 读取配置：conf = settings["deep_analysis"]["glm"]（立即迁移，不再读取 jina）
    - base_url（若 SDK 不需要可忽略）、timeout_seconds、retry_policy
  - 环境变量：ZHIPUAI_API_KEY（缺失则抛出异常）
  - 请求固定参数：model="glm-4-assistant", stream=True
  - 流式处理：消费增量 tokens，聚合文本为 content 字符串；记录中间错误
  - 返回统一 payload：
    - 成功：content=完整文本，meta.status="success"
    - 失败：content=None，meta.status="error" 或 "not_found"
  - 重试：指数退避（max_retries, delay_seconds, backoff_factor），仍失败则抛出 RuntimeError

- 任务/入口：
  - main.py 仅支持 deep_glm；_task_deep_glm 复用 orchestrator 的相同逐题逻辑
  - CLI 日志与提示使用 "deep_glm" 与 "glm" 标识；严禁打印 API Key

Visualization:
```mermaid
flowchart TD
  A[读取 {row_id}_deep.json] --> B{遍历 subtopics}
  B --> C[确保 children 与 questions 对齐]
  C --> D{逐题幂等检查 children[i].glm.meta.status}
  D -->|已成功/恢复| E[跳过该题]
  D -->|未执行或失败| F[call_glm(question)]
  F -->|success| G[写入 children[i].glm 成功 + 成功计数+1]
  F -->|error/not_found| H[写入 children[i].glm 失败占位 + 追加 metadata.glm]
  G --> I{子主题聚合}
  H --> I{子主题聚合}
  I -->|success>0| J[s["glm"].meta.status=success]
  I -->|error发生| K[s["glm"].meta.status=error]
  I -->|否则| L[s["glm"].meta.status=not_found]
```

Testing Strategy:
- 使用 pytest + requests-mock / SDK mock（流式增量）：
  - 正常路径：多题 success → children[*].glm 均 success，s["glm"].meta.status=success，metadata.glm 为空
  - 混合路径：部分 success、部分 not_found → 状态与聚合正确，meta 为 success
  - 全部 not_found → metadata.glm 有 N 条，s["glm"].meta.status=not_found
  - 网络异常 + 重试后失败 → 最终 error；children[*].glm.meta.status=error；metadata.glm 追加 error 条目；子主题聚合 meta=error
  - 幂等：预置 children[*].glm.success 后执行不再请求
  - 兼容性：不再读取/写入 "jina"；Dify 相关逻辑未改动

Security Considerations:
- 仅从环境变量读取 ZHIPUAI_API_KEY；不落盘、不记录到日志
- 超时/重试防止阻塞；错误集中记录在 metadata.glm

Migration Notes:
- 立即迁移：移除 deep_jina 任务解析与任何 "jina" 键的读写；旧数据不做自动迁移
- settings：使用 settings.deep_analysis.glm.*，移除/忽略 settings.deep_analysis.jina.*

Implementation Notes:
- 已实现：
  - 新增 executors/glm_executor.py：使用 Zhipu zai SDK，固定 model="glm-4-assistant" 与 stream=True；内部聚合流式增量为完整 content；读取环境变量 ZHIPUAI_API_KEY；实现指数退避（max_retries/delay_seconds/backoff_factor）。
  - orchestrator.py：将 "jina" 全量替换为 "glm"（children[*].glm、metadata.glm、s["glm"]["meta"]），并改为调用 call_glm；llm_model 改为 "glm-4-assistant"。
  - main.py：新增 _task_deep_glm，解析支持 "deep_glm"，移除 "deep_jina" 分支；导入 call_glm；所有任务日志提示改为 GLM。
  - report_writer.py：渲染 s["glm"] 为 “GLM 检索结果”。
  - json_schema.py：文档说明改为 glm（函数逻辑仍按 key 通用处理）。
- 配置：
  - 立即迁移为 settings.deep_analysis.glm.*；不再读取 deep_analysis.jina.*。
- 安全：
  - 严格从 .env 读取 ZHIPUAI_API_KEY，不打印敏感信息。
- 注意：
  - 旧数据中 "jina" 键不再读取；请按需迁移或重新执行 deep_planning + deep_glm。
- 测试建议：
  - 使用 SDK/mock 模拟流式分片，覆盖多题成功/混合/not_found/异常重试/幂等与聚合。