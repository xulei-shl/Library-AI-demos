# 机构API响应解析优化

## 状态 (Status)
Implemented

## 目标概述 (Objective / Summary)
优化机构API的响应解析逻辑，解决以下问题：
1. 机构API返回的name字段为数组格式，包含多语言版本（@en, @chs, @cht），需要特殊处理
2. place字段需要只提取city信息，而非完整的place对象
3. 当前通用解析器无法处理这些特殊格式
4. 需要创建独立的解析器来处理机构API特殊的返回格式

## 变更范围 (Scope)
- 新增文件：`src/core/l2_knowledge_linking/tools/internal_apis/organization_response_parser.py`
- 修改文件：`src/core/l2_knowledge_linking/tools/internal_apis/base.py`
- 修改文件：`config/settings.yaml`
- 新增文件：`tests/core/l2_knowledge_linking/test_organization_response_parser.py`

## 详细方案 (Detailed Plan)

### 1. 创建独立的机构API响应解析器
创建 `organization_response_parser.py` 文件，专门处理机构API的特殊响应格式：
- 解析name数组，提取@chs和@cht后缀的值
- 从place对象中只提取city字段
- 保持与其他API解析器的完全解耦

### 2. 修改通用解析器
在 `base.py` 的 `ResponseParser` 中添加对机构API的特殊处理调用：
- 检测到organization_api时，调用专用解析器
- 不影响其他API的解析逻辑

### 3. 更新配置文件
修改 `settings.yaml` 中机构API的字段配置：
- 更新字段映射以支持多语言label
- 添加place字段的特殊处理配置

## 可视化 (Visualization)

```mermaid
graph TB
    A[机构API调用] --> B[返回原始数据]
    B --> C{检测API类型}
    C -->|organization_api| D[OrganizationResponseParser]
    C -->|其他API| E[通用ResponseParser]
    D --> F[解析name数组]
    F --> G[提取@chs/@cht标签]
    D --> H[解析place对象]
    H --> I[提取city字段]
    G --> J[生成多语言label]
    I --> J
    J --> K[返回标准化结果]
    E --> K
```

## 测试策略 (Testing Strategy)
1. 单元测试：测试OrganizationResponseParser的name数组解析逻辑
2. 单元测试：测试place对象的city提取逻辑
3. 集成测试：确保不影响其他API的解析流程
4. 端到端测试：使用真实机构API返回数据验证完整流程

## 安全考虑 (Security Considerations)
- 输入验证：确保解析器能够安全处理异常格式的返回数据
- 错误处理：当解析失败时优雅降级，记录警告但不中断流程

## 实现说明 (Implementation Notes)

### 已完成的修改

1. **创建独立解析器**
   - 新增 `organization_response_parser.py`，专门处理机构API的特殊响应格式
   - 实现了name数组的多语言解析（@chs和@cht后缀）
   - 实现了place对象的city字段提取
   - 添加了完善的错误处理和日志记录

2. **修改通用解析器**
   - 在 `ResponseParser.parse` 中添加了机构API的特殊处理逻辑
   - 优化了 `_extract_items` 方法，增加了通用的数据提取逻辑
   - 保持了其他API的解析逻辑不受影响

3. **更新配置文件**
   - 启用了机构API（设置 `enabled: true`）
   - 更新了字段配置，移除了 `placeUri` 从 extract 列表
   - 添加了注释说明专用解析器的作用

4. **添加单元测试**
   - 创建了完整的单元测试文件
   - 测试覆盖了正常流程、边界情况和错误处理
   - 所有测试都通过

### 确认的符合官方规范

1. **API调用参数**：已验证 `organization_api.py` 中的参数完全符合官方示例
2. **响应解析**：按照您提供的返回结果格式进行解析
3. **字段提取**：正确处理了name数组和place对象的特殊格式

### 质量保证

- 代码通过了所有语法检查
- 所有单元测试通过
- 集成测试验证了与其他系统的兼容性
- 遵循了项目的编码规范和架构设计原则