Status: Implemented

Objective / Summary
- 将 Excel 列配置分为两类：元数据列（用于提示词上下文）与输出列（用于写回模型结果）。
- 在长描述任务中，将行级元数据上下文自动拼接进用户提示，从而提高描述的贴合度与一致性，并支持后续灵活调整列。
- 新增“字段选择机制”：默认使用全部 metadata 字段；如指定列表，则仅使用列表中的字段，并按列表顺序输出。

Scope
- config/settings.yaml（新增 columns.metadata 与 columns.outputs；新增 tasks.long_description.metadata_fields；保留兼容旧扁平键）
- src/core/l0_image_description/main.py（新增 build_metadata_context；在 _run_long_description 使用该上下文拼接 user_text）
- tests/core/l0_image_description/test_metadata_context.py（新增单元测试）
- tests/conftest.py（新增，将项目根目录加入 sys.path，确保 tests 可导入 src 模块）

Detailed Plan
1) 配置结构调整（示例草案）：
   data:
     excel:
       columns:
         metadata:
           id: "编号"
           title: "题名"
           desc: "说明"
           persons: "相关人物"
           topic: "所属专题"
           # 可选预留：
           year: "年代"
           location: "地点"
           author: "作者"
           source: "来源"
         outputs:
           long_desc: "长描述"
           alt_text: "替换文本"
           keywords_json: "关键词JSON"
       # 兼容旧键（id_col、title_col、desc_col、persons_col、topic_col、long_desc_col、alt_text_col、keywords_col）
   tasks:
     long_description:
       system_prompt_file: "l0-long-description-system.txt"
       # 可选字段选择：若提供则只使用并按此顺序输出；未提供默认使用全部 metadata 字段
       metadata_fields: ["id", "title", "desc", "persons", "topic", "year", "location"]

2) 字段选择与顺序策略
   - 默认：使用 columns.metadata 中的所有键，推荐输出顺序为：
     ["id", "title", "desc", "persons", "topic", "year", "location", "author", "source"]
     其余未在推荐序列但存在的键，按自然顺序追加。
   - 指定列表：若 settings.tasks.long_description.metadata_fields 存在，按列表顺序输出；跳过列表中不存在于 columns.metadata 的键，并记录日志。
   - 运行日志：记录最终采用的字段集合与非空输出的字段名（不记录值），便于审计。

3) 代码改动
   - 新增函数 build_metadata_context(row_cells, cols, xio, settings):
     * 读取 columns.metadata 映射（或旧键回退），形成“键 -> 列头”的字典。
     * 根据 metadata_fields（如有）或默认推荐顺序，遍历并用 xio.get_value(row_cells, 列头) 获取值；跳过空值。
     * 渲染为分层文本：
       [元数据]
       - 题名: ...
       - 说明: ...
       - 相关人物: ...
       - 所属专题: ...
       - 年代: ...
       - 地点: ...
       - 作者: ...
       - 来源: ...
       - 编号: ...
     * 返回字符串供拼接。
   - 在 _run_long_description:
     * metadata_block = build_metadata_context(...)
     * user_text = f"{metadata_block}\n\n请生成详尽、客观、分层的图像长描述。"
     * messages = _build_vision_messages(sys_prompts["long_description"], image_b64, user_text)

4) 兼容性与回退
   - 无 columns.metadata 时，使用旧扁平键进行最小上下文构建（id/title/desc/persons/topic），并支持 metadata_fields 中能映射到旧键的部分。
   - ExcelIO 接口无需更改。

Visualization
```mermaid
flowchart TD
  A[Excel 行: row_cells] --> B[读取 columns.metadata (或旧键回退)]
  B --> C{metadata_fields 指定?}
  C -- 是 --> D[按列表顺序过滤+遍历]
  C -- 否 --> E[按推荐顺序+其余自然顺序遍历]
  D --> F{值非空?}
  E --> F
  F -- 是 --> G[追加到元数据文本块]
  F -- 否 --> D
  G --> H[构建 user_text: 元数据块 + 任务指令]
  H --> I[_build_vision_messages(system, image, user)]
  I --> J[invoke_model(long_description)]
  J --> K[写回 outputs: 长描述列]
```

Testing Strategy
- 单元测试（tests/core/l0_image_description/test_metadata_context.py）：
  1. 默认用例：不指定 metadata_fields，完整列值；断言包含所有键且顺序遵循推荐序列。
  2. 指定用例：提供 metadata_fields，断言仅输出指定键且顺序与列表一致。
  3. 缺失/为空：部分列缺失或空值；断言仅输出非空项；不报错。
  4. 兼容回退：无 columns.metadata；回退到旧扁平键；断言能输出基础字段。

Security Considerations
- 不记录敏感信息；日志仅记录字段名，不含值。
- 纯文本拼接，避免注入与执行风险。

Implementation Notes
- 已实现内容：
  1) 配置：更新 config/settings.yaml，新增 data.excel.columns.metadata / outputs 结构与 tasks.long_description.metadata_fields；保留旧扁平键以兼容现有表。
  2) 代码：在 src/core/l0_image_description/main.py 新增 build_metadata_context；于 _run_long_description 将元数据上下文拼接入 user_text；修复一次字符串拼接语法错误。
  3) 测试：新增 tests/core/l0_image_description/test_metadata_context.py，覆盖默认顺序、指定列表、缺失/空值、旧键回退四类用例；新增 tests/conftest.py 以配置 sys.path。
- 结果与验证：
  - 元数据上下文按指定或推荐顺序输出，仅包含非空字段，并记录字段名日志（不含值）。
  - 单元测试通过：test_metadata_context 共 4 项均通过。
- 兼容性：
  - 无 columns.metadata 时自动回退到旧扁平键（id/title/desc/persons/topic）。
- 安全与日志：
  - 日志仅记录字段名，未记录敏感值；遵循现有 logger 风格。