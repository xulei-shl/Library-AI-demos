# L1 结构化信息抽取 (MVP - 最小可行产品版)

Status: Implemented
Date: 2025-10-02
Owner: TBD
Version: 0.4 (MVP)

## Objective / Summary
面向“话剧”类图片，基于图像初始元数据，利用大语言模型（LLM）直接抽取核心的结构化信息。此版本为最小可行产品（MVP），专注于实现核心抽取功能。

需抽取的实体字段：
- 地点（location）
- 剧院（architecture）
- 团体（organization）
- 时间（date/time）
- 演出作品（work_title）
- 演出事件（event_title，事件名称；event_type，事件类型）
- 演员及其演出的角色（cast: actor + role）
- 其他相关人员及其职责（persons，选填）
- 其他相关实体，类型与原始文本说明（entities，选填）

## Scope (MVP)
- **新增**
  - `src/core/l1_structured_extraction/main.py` (主脚本，包含所有处理逻辑)
  - `src/prompts/l1_extract_prompt.md` (用于指导LLM输出的提示词)
- **复用的内部组件 (Reused Components)**                                                                                   
  - `src/utils/excel_io.py`: 用于读取输入Excel（`metadata.xlsx`）以及将抽取的结构化数据写回新列。
  - `src/utils/metadata_context.py`: 用于从Excel读取元数据，并将其转换为LLM可接受的上下文。
  - `src/utils/llm_api.py`: 用于与大语言模型API交互，获取结构化JSON输出。
  - `src/utils/logger.py`: 用于记录程序运行日志
  - `config/settings.yaml`: 用于管理所有配置，如文件路径、API密钥、模型名称等，避免硬编码。  

## Processing Flow (MVP)
1.  **加载数据**: 脚本必要的初始元数据。
2.  **LLM 抽取**: 脚本调用大语言模型，将图片和元数据作为上下文，通过精心设计的提示词（Prompt）指示模型直接生成符合上述目标格式的JSON对象。
3.  **保存输出**: 脚本将从LLM收到的原始JSON响应直接保存到metadata.xlsx的对应列中。

## Testing Strategy
- 单元测试建议（后续补充）：
  - 元数据上下文构建：无元数据、有部分字段、字段顺序覆盖。
  - Excel 写回：缺失列自动新增；已有值时在 skip_if_present=true 下跳过。
  - JSON 清洗：代码块围栏剥离；无效 JSON 时保留原文并记录警告。
- 手动回归：
  - 少量样本运行 limit=3，验证跳过策略与新增列生效。
  - 检查日志包含：base_url、model、system/user 提示词长度与预览、response 预览、耗时。

## Implementation Notes
- 日志增强：
  - 新增函数：_extract_system_text、_extract_user_text；从 settings.logging 读取 system/user/response 截断长度（默认 1000/300/2000）。
  - 调用前记录 llm_call_start（含 base_url、model、system/user 长度与预览）；成功记录 llm_call_success（响应长度、预览、耗时）；保留原审计日志兼容检索。
- L1 抽取流程：
  - 新增 src/core/l1_structured_extraction/main.py：构建视觉消息（system + image + user 文本），仅输出 JSON；Excel 目标列“L1结构化JSON”如缺失自动创建；已存在值且策略开启则跳过。
  - 新增 src/prompts/l1_extract_prompt.md：输出字段规范化（location、architecture、organization、datetime、work_title、event_title、event_type、cast、persons、entities），仅输出 JSON，无解释。
- 配置：
  - config/settings.yaml 新增 tasks.l1_extraction 与 columns.outputs.l1_structured_json；新增 logging 截断配置项。