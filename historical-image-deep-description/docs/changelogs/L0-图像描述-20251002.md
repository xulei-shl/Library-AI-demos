---
Status: In Progress
Objective / Summary: 构建“历史图像多维深度描述框架”的L0-媒介内容层。此模块接收一张历史图像，利用大模型生成详细描述、替换文本（Alt Text）和关键词，为后续分析提供初始上下文。设计需确保模块化、可配置性和健壮性。
Scope:
  - 新增文件:
    - `config/settings.yaml`
    - `docs/changelogs/l0-图像描述模块设计-20251002.md`
    - `src/core/l0_image_description/__init__.py`
    - `src/core/l0_image_description/main.py`
    - `src/prompts/alt_text_system.md`
    - `src/prompts/keywords_system.md`
    - `src/prompts/long_desc_system.md`
    - `src/utils/__init__.py`
    - `src/utils/llm_api.py`
    - `src/utils/logger.py`
    - `src/__init__.py`
    - `main.py`
    - `tests/core/l0_image_description/test_main.py`
    - `tests/utils/test_llm_api.py`
---

### Detailed Plan

#### 1. 项目结构 (已更新)

```
historical-image-deep-description/
├── config/
│   └── settings.yaml           # 核心配置文件
├── docs/
│   └── changelogs/
│       └── l0-图像描述模块设计-20251002.md
├── src/
│   ├── core/
│   │   └── l0_image_description/
│   │       ├── __init__.py
│   │       └── main.py             # L0模块主入口
│   ├── prompts/                  # <-- 新增: 存放提示词模板
│   │   ├── long_desc_system.md
│   │   ├── alt_text_system.md
│   │   ├── keywords_system.md
│   ├── utils/
│   │   ├── __init__.py
│   │   ├── llm_api.py            # 封装API交互
│   │   └── logger.py             # 日志配置
│   └── __init__.py
├── runtime/
│   ├── logs/
│   └── outputs/
├── tests/
│   ├── core/
│   │   └── l0_image_description/
│   │       └── test_main.py
│   └── utils/
│       └── test_llm_api.py
├── examples/
│   └── sample_image.jpg
└── main.py                       # 项目总入口
```

#### 2. 核心配置文件 (`config/settings.yaml`) (已更新)

配置已按模型能力 (`vision`, `text`) 进行分层，并改为引用独立的提示词文件。

```yaml
# API供应商配置，按能力类型划分
api_providers:
  vision: # 用于处理图像的模型
    primary:
      name: "Primary_Vision_Provider"
      api_key: "env:PRIMARY_VISION_API_KEY"
      base_url: "https://api.vision-provider.com/v1"
    secondary:
      name: "Secondary_Vision_Provider"
      api_key: "env:SECONDARY_VISION_API_KEY"
      base_url: "https://api.backup-vision.com/v1"
  text: # 用于处理文本的模型
    primary:
      name: "Primary_Text_Provider"
      api_key: "env:PRIMARY_TEXT_API_KEY"
      base_url: "https://api.text-provider.com/v1"
    secondary:
      name: "Secondary_Text_Provider"
      api_key: "env:SECONDARY_TEXT_API_KEY"
      base_url: "https://api.backup-text.com/v1"

# API调用重试策略
retry_policy:
  max_retries: 3
  delay_seconds: 5

# 任务配置
tasks:
  long_description:
    provider_type: "vision" # 指定使用vision API
    model: "gpt-4-vision-preview"
    temperature: 0.5
    top_p: 1.0
    system_prompt_file: "long_desc_system.md"

  alt_text:
    provider_type: "vision" # 指定使用vision API
    model: "gpt-4-vision-preview"
    temperature: 0.7
    top_p: 1.0
    system_prompt_file: "alt_text_system.md"

  keywords:
    provider_type: "text" # 指定使用text API
    model: "gpt-4-turbo"
    temperature: 0.2
    top_p: 1.0
    system_prompt_file: "keywords_system.md"
```

#### 3. 健壮的API调用 (`src/utils/llm_api.py`)

核心函数 `invoke_model` 将会：
1.  根据任务指定的 `provider_type` (`vision` 或 `text`) 选择正确的API配置块。
2.  在选定的配置块内，实现主API的重试逻辑。
3.  若主API最终失败，则切换到备用API并重复重试逻辑。

### Visualization

工作流程图保持不变，其内部逻辑已通过上述配置更新得到增强。

```mermaid
flowchart TD
    subgraph L0 Module: process_image(image_path)
        A[开始: 接收图像路径] --> B{读取图像文件};
        B --> C[加载 config/settings.yaml 配置];
        
        subgraph 并行任务
            C --> D[任务一: 生成长描述];
            C --> E[任务二: 生成替换文本];
        end

        D --> F{任务三: 提取关键词};
        E -- (仅为流程展示，实际不直接关联) --> F;

        subgraph "src/utils/llm_api.py: invoke_model"
            D -- 调用 --> G{尝试主API};
            E -- 调用 --> G;
            F -- 调用 --> G;
            G -- 失败 --> H{重试 N 次};
            H -- 仍然失败 --> I{切换至备用API};
            I -- 失败 --> J{重试 N 次};
            J -- 仍然失败 --> K[记录严重错误并抛出异常];
            G -- 成功 --> L[返回结果];
            H -- 成功 --> L;
            I -- 成功 --> L;
            J -- 成功 --> L;
        end

        L --> M[收集所有任务结果];
        M --> N[保存到 runtime/outputs/];
        N --> O[结束: 返回结构化结果];
    end

    style G fill:#cde4f9,stroke:#8ab4f8
    style I fill:#f9e0c9,stroke:#f9ab00
    style K fill:#f9c9c9,stroke:#f28b82
```

### 设计补充（依据反馈）

- Excel I/O 抽象与复用
  - 将 Excel 读写、列名映射与“已有值跳过”幂等策略抽象为通用工具模块，路径：`src/utils/excel_io.py`，以便后续其他模块复用。
  - 能力包含：按列名读取/写回、存在性校验、备份生成、行级/单元格级跳过策略。

- 匹配与告警策略
  - 图片与元数据按“图片名（不含后缀）= 编号”匹配；大小写不敏感，自动去除两端空白。
  - 无匹配的图片或无对应图片的元数据行：跳过，记录 WARNING 日志并继续处理其他行。

- 关键词JSON处理策略
  - 仅做 JSON 合法性校验（严格解析）。
  - 若解析失败：将模型原始返回值直接写入 Excel 对应单元格，并记录 WARNING 日志，避免数据丢失。

- 配置增补（settings.yaml 增补段）
  ```yaml
  data:
    paths:
      images_dir: "pics"
      metadata_excel: "metadata.xlsx"
      supported_exts: [".jpg", ".jpeg", ".png"]
    excel:
      sheet_name: ""  # 为空表示第一个工作表
      columns:
        id_col: "编号"
        title_col: "题名"
        topic_col: "所属专题"
        persons_col: "相关人物"
        desc_col: "说明"
        long_desc_col: "长描述"
        alt_text_col: "替换文本"
        keywords_col: "关键词JSON"
    write_policy:
      skip_if_present: true
      create_backup: true
  ```

- 项目结构补充
  - 新增：`src/utils/excel_io.py`（通用Excel工具模块）
  - `src/prompts/keywords_system.md` 将强调“仅输出严格JSON对象（不含额外文本）”。

### Visualization（增补）

```mermaid
flowchart TD
    A[开始: 读取 config/settings.yaml] --> B[加载 metadata.xlsx (sheet)]
    B --> C[扫描 pics/ 构建 编号↔图片 映射(去空白,不区分大小写)]
    C --> D{逐行处理}
    D -->|图片/元数据未匹配| W[WARNING: 记录并跳过此行] --> N
    D -->|目标列已有值| E[跳过该项, 记录INFO] --> N
    D -->|缺失长描述/替换文本/关键词| F[按缺失项调用 LLM 任务]
    F --> G[llm_api.invoke_model 重试/主备切换]
    G -->|成功| H[写入Excel(长文本/Alt/关键词JSON)]
    G -->|关键词JSON解析失败| Y[写入原始返回, 记录WARNING]
    G -->|调用失败| I[记录ERROR并跳过写入]
    H --> N[继续下一行]
    Y --> N
    I --> N
    N --> J[处理完成: 保存Excel(可备份)]
    J --> K[结束]

    style W fill:#fff3cd,stroke:#ffec99
    style Y fill:#fff3cd,stroke:#ffec99
    style I fill:#f8d7da,stroke:#f5c2c7
```

### Testing Strategy
- `tests/utils/test_llm_api.py`
  - 继续覆盖 `invoke_model` 的成功/失败/重试/主备切换路径（保持不变）。
- `tests/utils/test_excel_io.py`（新增）
  - 列名映射读取/写回的正确性（含中文列名）。
  - `skip_if_present=true` 时的单元格跳过行为。
  - `create_backup=true` 时备份文件的生成。
- `tests/core/l0_image_description/test_main.py`（扩展）
  - 按“图片名=编号”的匹配行为（去空白、不区分大小写）。
  - 无匹配图片或无对应图片的元数据行：应跳过并记录 WARNING。
  - 仅对缺失项调用相应任务（长描述/Alt/关键词），已有值不触发调用。
  - 关键词任务：当模型输出为非法JSON时，应将原始返回写入Excel并记录 WARNING；合法JSON则以字符串形式写入单元格。
  - 端到端流程在 `excel_io` 和 `llm_api` 均 mock 情况下的编排正确性与日志断言。

### Implementation Notes
(将在实现阶段填写)