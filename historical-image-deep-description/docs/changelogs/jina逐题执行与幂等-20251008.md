Status: Implemented
Date: 2025-10-08
Owner: l3_deep_analysis

Objective / Summary:
- 将 L3 deep_analysis 的 Jina 阶段从“子主题合并请求写回 s['jina']”调整为“逐题执行（questions 下每题）并写回 children[].jina”，与 Dify 的落盘风格保持一致：
  - 每题调用 Jina API，结果写到对应 children[i].jina（成功写 content，失败 content 为 null，并在 meta 标注 status、error 等）
  - 子主题级聚合：在 s["jina"]["meta"] 写入聚合状态（success / error / not_found）
  - 错误聚合：将每个失败/未命中的题写入 deep_data.metadata.jina（数组），包含 executed_at / status / error / task_type / question / subtopic
  - 幂等：题目级幂等（children[i].jina.meta.status in {"success","timeout_recovered"} 则跳过）
  - 加入重试/退避：使用 settings.deep_analysis.jina.retry_policy（max_retries / delay_seconds / backoff_factor）
- 绝对不影响已有的 Dify 功能与数据结构；如需共用功能，将在 Jina 自身实现，避免改动 Dify 代码。

Scope:
- 受影响文件：
  - src/core/l3_deep_analysis/orchestrator.py（仅修改 Jina 分支：逐题执行、题目级幂等、metadata.jina 数组聚合、s["jina"]["meta"] 聚合）
  - src/core/l3_deep_analysis/executors/jina_executor.py（新增重试/退避；不改 Dify 执行器）
  - main.py（_task_deep_jina：与 orchestrator 的 Jina 分支保持一致的逐题实现）
- 不修改文件：
  - src/core/l3_deep_analysis/executors/dify_executor.py
  - 与 Dify 相关的任何模块与配置项

Detailed Plan:
- 数据结构与落盘规范（与 Dify 对齐）：
  - children[i].jina:
    - 成功：
      {
        "content": "...",
        "meta": {
          "executed_at": "ISO-8601",
          "status": "success",
          "task_type": "web_search",
          "search_query": "原始问题文本",
          "llm_model": "jina-deepsearch-v1",
          "error": null
        }
      }
    - 失败/未命中：
      {
        "content": null,
        "meta": {
          "executed_at": "ISO-8601",
          "status": "error" | "not_found",
          "task_type": "web_search",
          "search_query": "原始问题文本",
          "llm_model": "jina-deepsearch-v1",
          "error": "失败原因"
        }
      }
  - metadata.jina（数组聚合）：
    - {
        "executed_at": "ISO-8601",
        "status": "error" | "not_found",
        "error": "...",
        "task_type": "web_search",
        "question": "...",
        "subtopic": "..."
      }
  - s["jina"]["meta"]（子主题级聚合）：
    - {"executed_at":"ISO-8601","status":"success|error|not_found","task_type":"web_search"}

- 执行流程调整：
  - orchestrator.run_row：
    1) 初始化 children，确保与 questions 一一对应（无则创建 {question} 占位）
    2) 读取每题的已执行状态（children[*].jina.meta.status）
       - 若 status ∈ {"success","timeout_recovered"} 则跳过该题
    3) 调用 call_jina(question, settings)，加入重试/退避（在执行器内部实现）
    4) 写回 children[*].jina；若非成功，追加到 metadata.jina
    5) 聚合 s["jina"]["meta"].status：
       - 成功计数 > 0 => "success"
       - 否则，若发生异常 => "error"
       - 否则，若存在非成功 => "not_found"
  - main.py/_task_deep_jina：
    - 使用与 orchestrator 相同的逐题逻辑，保持两处行为一致
  - executors/jina_executor.py：
    - 读取 settings.deep_analysis.jina.retry_policy 实现指数退避重试（不改动 Dify）
    - 宽松解析响应；短期以 str(payload) 作为 content；后续可在不破坏外部结构的前提下增强解析 choices[0].message.content

- 幂等策略：
  - 仅对题目级“成功/timeout_recovered”跳过
  - 暂不引入 skip_if_executed（Jina），保持最小一致；如未来需要，可在 deep_analysis.jina 下新增同名键

- 配置项：
  - 复用现有 deep_analysis.jina 块（base_url/endpoint/api_key/timeout_seconds/retry_policy）
  - 不新增/变更 Dify 配置项

Visualization:
```mermaid
flowchart TD
  A[读取 {row_id}_deep.json] --> B{遍历 subtopics}
  B --> C[确保 children 与 questions 对齐]
  C --> D{逐题幂等检查 children[i].jina.meta.status}
  D -->|已成功/恢复| E[跳过该题]
  D -->|未执行或失败| F[call_jina(question)]
  F -->|success| G[写入 children[i].jina 成功 + 成功计数+1]
  F -->|error/not_found| H[写入 children[i].jina 失败占位 + 追加 metadata.jina]
  G --> I{子主题聚合}
  H --> I{子主题聚合}
  I -->|success>0| J[s["jina"].meta.status=success]
  I -->|error发生| K[s["jina"].meta.status=error]
  I -->|否则| L[s["jina"].meta.status=not_found]
```

Testing Strategy:
- 使用 pytest + requests-mock：
  - 正常路径：多题成功 → children[*].jina 均 success，s["jina"].meta.status=success，metadata.jina 为空
  - 混合路径：部分 success、部分 not_found → children 对应状态正确，metadata.jina 聚合 not_found 条目，聚合 meta 为 success
  - 全部 not_found → metadata.jina 有 N 条，聚合 meta 为 not_found
  - 网络异常 + 重试后失败 → 最终 error；children[*].jina.meta.status=error；metadata.jina 追加 error 条目；聚合 meta 为 error
  - 幂等：预置 children[*].jina.success，执行后不再调用；仅对未成功题发起请求
  - 兼容性：Dify 胶水逻辑未被调用/变更；Dify 现有测试全部通过
- 边界：
  - 无 questions 或 children 非法结构时自动补齐 children
  - 缺失 metadata.jina 时自动初始化为数组
  - API Key 缺失时抛错并按 error 处理

Security Considerations:
- API Key 仅通过 env 解析，不落盘；日志不打印敏感信息
- 超时与重试防止长时间阻塞；失败统一聚合到 metadata.jina

Implementation Notes:
- 已实现 Jina 逐题执行：children[*].jina 按题写回，聚合 s["jina"].meta，并将非成功写入 metadata.jina（数组）
- 幂等：children[*].jina.meta.status ∈ {"success","timeout_recovered"} 的题目会被跳过
- 重试：executors/jina_executor.py 读取 settings.deep_analysis.jina.retry_policy，实现指数退避；最终失败抛出，由上层写入 metadata.jina
- 兼容性：未修改任何 Dify 相关代码或共享组件；Dify 行为保持不变
- main.py 与 orchestrator 的 Jina 分支逻辑一致；命令 python main.py --tasks "l3:deep_jina" 支持单编号与Excel批量模式

Please Approve:
- 已实现并交付，如无其它调整需求，可关闭本变更。